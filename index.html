<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIRUS - Le Centre Commercial est Infecte</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    @font-face {
      font-family: 'GameFont';
      src: local('Impact'), local('Arial Black');
    }

    body {
      background: #0f0f1a;
      font-family: Arial, sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      user-select: none;
    }
    /* Permettre la saisie sur mobile */
    input, textarea { user-select: text; -webkit-user-select: text; }

    /* ============================== */
    /* ECRANS                         */
    /* ============================== */
    .screen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      transition: opacity 0.4s ease;
    }
    .screen.active {
      display: flex;
    }

    /* ============================== */
    /* FOND COMMUN                    */
    /* ============================== */
    .bg-mall {
      background:
        repeating-conic-gradient(#18223a 0% 25%, #141b2d 0% 50%) 0 0 / 60px 60px,
        linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      background-blend-mode: overlay;
    }

    /* ============================== */
    /* MENU PRINCIPAL                 */
    /* ============================== */
    #menu-principal {
      justify-content: center;
      gap: 0;
    }

    .titre-virus {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: clamp(60px, 12vw, 130px);
      color: #e74c3c;
      text-shadow:
        0 0 20px rgba(231,76,60,0.6),
        0 0 60px rgba(231,76,60,0.3),
        4px 4px 0 #000000;
      letter-spacing: 15px;
      margin-bottom: 5px;
      position: relative;
    }
    .titre-virus::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 3px;
      background: linear-gradient(90deg, transparent, #e74c3c, transparent);
    }

    .virus-icons {
      display: flex;
      align-items: center;
      gap: clamp(100px, 20vw, 350px);
      margin-bottom: 10px;
    }

    .virus-icon {
      width: 50px;
      height: 50px;
      opacity: 0.6;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 30px;
    }

    /* ============================== */
    /* BOUTONS                        */
    /* ============================== */
    .btn {
      border: none;
      cursor: pointer;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 3px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 40%;
      background: rgba(255,255,255,0.07);
      border-radius: inherit;
    }
    .btn:hover {
      transform: translateY(-3px);
      filter: brightness(1.15);
    }
    .btn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }

    .btn-online {
      width: clamp(300px, 40vw, 440px);
      height: 80px;
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      color: white;
      font-size: clamp(24px, 4vw, 38px);
      border-radius: 15px;
      border: 2px solid #ff6b6b;
      box-shadow: 0 4px 20px rgba(231,76,60,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .btn-online .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #fad7d3;
      letter-spacing: 2px;
      font-weight: normal;
    }

    .btn-horsline {
      width: clamp(250px, 35vw, 370px);
      height: 60px;
      background: linear-gradient(180deg, #576574, #4a5568, #2d3436);
      color: #ecf0f1;
      font-size: clamp(16px, 2.5vw, 24px);
      border-radius: 12px;
      border: 1.5px solid #7f8c8d;
      box-shadow: 0 3px 15px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .btn-horsline .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 10px;
      color: #95a5a6;
      letter-spacing: 1px;
      font-weight: normal;
    }

    .btn-boutique {
      width: clamp(250px, 35vw, 370px);
      height: 60px;
      background: linear-gradient(180deg, #f39c12, #e67e22, #d35400);
      color: white;
      font-size: clamp(16px, 2.5vw, 24px);
      border-radius: 12px;
      border: 1.5px solid #f5b041;
      box-shadow: 0 3px 15px rgba(243,156,18,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .btn-boutique .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 10px;
      color: #fdebd0;
      letter-spacing: 1px;
      font-weight: normal;
    }

    .btn-casier {
      width: clamp(250px, 35vw, 370px);
      height: 60px;
      background: linear-gradient(180deg, #8e44ad, #7d3c98, #6c3483);
      color: white;
      font-size: clamp(16px, 2.5vw, 24px);
      font-weight: bold;
      letter-spacing: 3px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      box-shadow: 0 4px 15px rgba(142,68,173,0.4);
    }
    .btn-casier::before { display: none; }
    .btn-casier .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 10px;
      color: #d7bde2;
      letter-spacing: 1px;
      font-weight: normal;
    }
    .btn-param {
      width: 170px;
      height: 40px;
      background: transparent;
      color: #95a5a6;
      font-size: 14px;
      border-radius: 10px;
      border: 1.5px solid #566573;
      font-family: Arial, sans-serif;
      letter-spacing: 2px;
    }
    .btn-param::before { display: none; }

    /* ============================== */
    /* BOUTIQUE DE SKINS              */
    /* ============================== */
    #boutique-skins {
      justify-content: flex-start;
      padding-top: 60px;
      gap: 20px;
    }
    .boutique-titre {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: clamp(36px, 8vw, 60px);
      color: #f39c12;
      text-shadow: 0 0 20px rgba(243,156,18,0.5), 3px 3px 0 #000;
      letter-spacing: 5px;
    }
    .boutique-sous-titre {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #95a5a6;
      letter-spacing: 2px;
      margin-top: -10px;
    }
    .boutique-grille {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 10px;
      max-width: 98vw;
      padding: 15px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .boutique-gold-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(243,156,18,0.15);
      border: 1px solid #f39c12;
      border-radius: 10px;
      padding: 5px 14px;
    }
    .boutique-gold-bar .gold-icon { font-size: 18px; }
    .boutique-gold-bar .gold-val {
      color: #f39c12;
      font-size: 18px;
      font-weight: bold;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 1px;
    }
    .skin-carte {
      background: rgba(26,26,46,0.9);
      border: 2px solid #566573;
      border-radius: 12px;
      padding: 8px;
      width: auto;
      text-align: center;
      transition: transform 0.2s, border-color 0.2s;
    }
    .skin-carte:hover {
      transform: translateY(-4px);
      border-color: #f39c12;
    }
    .skin-carte-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 8px;
    }
    .skin-carte-nom {
      color: #ecf0f1;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      margin-bottom: 6px;
    }
    .skin-carte-prix {
      color: #f39c12;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 14px;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    .skin-carte-prix .prix-icon { margin-right: 3px; }
    .skin-carte-btn {
      width: 100%;
      padding: 8px 0;
      border: none;
      border-radius: 8px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 13px;
      letter-spacing: 2px;
      cursor: pointer;
      transition: filter 0.2s;
    }
    .skin-carte-btn:hover { filter: brightness(1.2); }
    .skin-carte-btn.acheter {
      background: linear-gradient(180deg, #f39c12, #e67e22);
      color: white;
    }
    .skin-carte-btn.acheter.desactive {
      background: #566573;
      color: #95a5a6;
      cursor: not-allowed;
    }
    .skin-carte-btn.acheter.desactive:hover { filter: none; }
    .skin-carte-btn.possede {
      background: linear-gradient(180deg, #2ecc71, #27ae60);
      color: white;
    }
    .skin-carte-btn.equipe {
      background: #566573;
      color: #ecf0f1;
      cursor: default;
    }
    .skin-carte-btn.equipe:hover { filter: none; }

    /* Onglets boutique */
    .boutique-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 10px;
      border-bottom: 2px solid #34495e;
      width: clamp(300px, 50vw, 500px);
    }
    .boutique-tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #7f8c8d;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }
    .boutique-tab:hover { color: #bdc3c7; }
    .boutique-tab.active { color: #f39c12; border-bottom-color: #f39c12; }
    .boutique-tab-content { display: none; }
    .boutique-tab-content.active { display: block; }

    /* Carte musique boutique */
    .musique-carte {
      background: rgba(26,26,46,0.9);
      border: 2px solid #566573;
      border-radius: 12px;
      padding: 8px;
      width: auto;
      text-align: center;
      transition: transform 0.2s, border-color 0.2s;
    }
    .musique-carte:hover {
      transform: translateY(-4px);
      border-color: #f39c12;
    }
    .musique-carte-img {
      width: 100%;
      height: auto;
      aspect-ratio: 1;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .musique-carte-nom {
      color: #ecf0f1;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      margin-bottom: 6px;
    }
    .musique-carte-prix {
      color: #f39c12;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 14px;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    .musique-carte-prix .prix-icon { margin-right: 3px; }

    /* ============================== */
    /* PANNEAU REGLES                 */
    /* ============================== */
    .regles-panneau {
      width: clamp(340px, 55vw, 580px);
      background: linear-gradient(180deg, #2c3e50, #1a252f);
      border-radius: 12px;
      border: 1.5px solid rgba(243,156,18,0.5);
      margin-top: 25px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.4);
    }

    .regles-header {
      background: #34495e;
      border-radius: 12px 12px 0 0;
      padding: 10px 20px;
      text-align: center;
    }
    .regles-header h3 {
      color: #f39c12;
      font-size: 16px;
      letter-spacing: 4px;
      font-weight: bold;
    }

    .regles-liste {
      padding: 12px 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #f39c12 transparent;
    }
    .regles-liste::-webkit-scrollbar { width: 6px; }
    .regles-liste::-webkit-scrollbar-track { background: transparent; }
    .regles-liste::-webkit-scrollbar-thumb { background: #f39c12; border-radius: 3px; }

    .regle-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .regle-num {
      min-width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: bold;
      margin-top: 1px;
    }
    .regle-texte h4 {
      color: #ecf0f1;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .regle-texte p {
      color: #95a5a6;
      font-size: 11px;
      line-height: 1.3;
    }

    .version {
      position: absolute;
      bottom: 10px;
      color: #566573;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      letter-spacing: 1px;
    }

    /* ============================== */
    /* MENU ONLINE                    */
    /* ============================== */
    #menu-online {
      justify-content: center;
      gap: 0;
    }

    .btn-retour {
      position: absolute;
      top: 30px;
      left: 30px;
      width: 120px;
      height: 42px;
      background: transparent;
      color: #95a5a6;
      font-size: 14px;
      border-radius: 8px;
      border: 1.5px solid #7f8c8d;
      font-family: Arial, sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-retour:hover {
      border-color: #bdc3c7;
      color: #bdc3c7;
    }

    .online-titre {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: clamp(40px, 8vw, 80px);
      color: #e74c3c;
      text-shadow: 0 0 15px rgba(231,76,60,0.5), 3px 3px 0 #000;
      letter-spacing: 10px;
    }
    .online-sous-titre {
      color: #f39c12;
      font-size: 16px;
      letter-spacing: 6px;
      margin-bottom: 30px;
      opacity: 0.8;
    }

    .panneau-central {
      background: rgba(26,26,46,0.85);
      border-radius: 20px;
      border: 2px solid #2c3e50;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-top: 15px;
    }

    .btn-creer {
      width: clamp(300px, 40vw, 460px);
      height: 120px;
      background: linear-gradient(180deg, #e74c3c, #c0392b, #96281b);
      color: white;
      border-radius: 16px;
      border: 2px solid #ff6b6b;
      box-shadow: 0 4px 25px rgba(231,76,60,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 0 25px;
    }
    .btn-creer .btn-icon {
      width: 50px;
      height: 50px;
      border: 2.5px solid rgba(255,255,255,0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      flex-shrink: 0;
    }
    .btn-creer .btn-content {
      text-align: left;
    }
    .btn-creer .btn-content .btn-label {
      font-size: clamp(18px, 3vw, 28px);
      display: block;
    }
    .btn-creer .btn-content .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #fad7d3;
      letter-spacing: 1px;
      font-weight: normal;
    }

    .separateur-ou {
      display: flex;
      align-items: center;
      gap: 15px;
      width: clamp(300px, 40vw, 460px);
    }
    .separateur-ou .ligne {
      flex: 1;
      height: 1px;
      background: #566573;
      opacity: 0.4;
    }
    .separateur-ou .ou-cercle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #1a1a2e;
      border: 1.5px solid #566573;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #95a5a6;
      font-size: 14px;
      font-weight: bold;
    }

    .btn-trouver {
      width: clamp(300px, 40vw, 460px);
      height: 120px;
      background: linear-gradient(180deg, #2e86c1, #2471a3, #1a5276);
      color: white;
      border-radius: 16px;
      border: 2px solid #5dade2;
      box-shadow: 0 4px 25px rgba(46,134,193,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 0 25px;
    }
    .btn-trouver .btn-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      flex-shrink: 0;
    }
    .btn-trouver .btn-content {
      text-align: left;
    }
    .btn-trouver .btn-content .btn-label {
      font-size: clamp(18px, 3vw, 28px);
      display: block;
    }
    .btn-trouver .btn-content .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #d4e6f1;
      letter-spacing: 1px;
      font-weight: normal;
    }

    .info-bas {
      background: rgba(44,62,80,0.5);
      border-radius: 10px;
      padding: 12px 20px;
      color: #bdc3c7;
      font-size: 11px;
      text-align: center;
      line-height: 1.5;
      margin-top: 10px;
      max-width: 420px;
    }

    /* ============================== */
    /* SALLE D'ATTENTE                */
    /* ============================== */
    #salle-attente {
      background:
        repeating-conic-gradient(#f0e6dc 0% 25%, #e8ddd3 0% 50%) 0 0 / 60px 60px;
      flex-direction: row;
      flex-wrap: wrap;
    }

    .sa-mur-haut {
      width: 100%;
      height: 48px;
      background: linear-gradient(180deg, #8b7355, #6b5740);
      position: relative;
    }
    .sa-mur-haut::after {
      content: '';
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 6px;
      background: #a08060;
    }

    .sa-content {
      width: 100%;
      height: calc(100% - 96px);
      display: flex;
      position: relative;
    }

    .sa-mur-bas {
      width: 100%;
      height: 48px;
      background: linear-gradient(180deg, #6b5740, #8b7355);
      position: relative;
    }
    .sa-mur-bas::before {
      content: '';
      position: absolute;
      top: 0;
      width: 100%;
      height: 6px;
      background: #a08060;
    }

    /* Zone gauche - Cabines */
    .sa-gauche {
      width: 45%;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panneau-cabines {
      background: #2c3e50;
      border-radius: 5px;
      padding: 6px 15px;
      text-align: center;
      align-self: flex-start;
    }
    .panneau-cabines h3 {
      color: #f1c40f;
      font-size: 14px;
      letter-spacing: 3px;
    }
    .panneau-cabines span {
      color: #ecf0f1;
      font-size: 8px;
      letter-spacing: 2px;
    }

    .cabines-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .cabine {
      width: clamp(80px, 10vw, 110px);
      background: linear-gradient(180deg, #5c4a3a, #3e3028);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .cabine:hover {
      transform: scale(1.05);
    }

    .cabine-interieur {
      height: 90px;
      margin: 4px;
      border-radius: 3px;
      position: relative;
    }
    .cabine-miroir {
      width: 55%;
      height: 40px;
      background: #d4e6f1;
      border: 2px solid #8b7355;
      border-radius: 3px;
      margin: 6px auto 0;
      position: relative;
      overflow: hidden;
    }
    .cabine-miroir::after {
      content: '';
      position: absolute;
      top: 5px; left: 8px;
      width: 50%;
      height: 70%;
      background: rgba(234,242,248,0.4);
      border-radius: 50%;
    }

    .cabine-rideau {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border-radius: 3px;
      opacity: 0.85;
    }
    .rideau-rouge { background: repeating-linear-gradient(90deg, #c0392b, #e74c3c 30%, #c0392b 50%, #e74c3c 70%, #c0392b); }
    .rideau-bleu { background: repeating-linear-gradient(90deg, #2471a3, #2e86c1 30%, #2471a3 50%, #2e86c1 70%, #2471a3); }
    .rideau-vert { background: repeating-linear-gradient(90deg, #1e8449, #27ae60 30%, #1e8449 50%, #27ae60 70%, #1e8449); }
    .rideau-violet { background: repeating-linear-gradient(90deg, #7d3c98, #9b59b6 30%, #7d3c98 50%, #9b59b6 70%, #7d3c98); }

    .cabine-footer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 6px;
    }
    .cabine-statut {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .statut-libre { background: #2ecc71; border: 1px solid #27ae60; }
    .statut-occupe { background: #e74c3c; border: 1px solid #c0392b; }
    .cabine-num {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    /* Zone droite - UI */
    .sa-droite {
      width: 55%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px;
    }

    /* Enseigne VIRUS */
    .sa-enseigne {
      background: #1a1a2e;
      border: 2px solid #e74c3c;
      border-radius: 10px;
      padding: 8px 25px;
      text-align: center;
      align-self: center;
      box-shadow: 0 0 15px rgba(231,76,60,0.3);
    }
    .sa-enseigne h2 {
      font-family: 'Impact', 'Arial Black', sans-serif;
      color: #e74c3c;
      font-size: 28px;
      letter-spacing: 8px;
      text-shadow: 0 0 10px rgba(231,76,60,0.5);
    }
    .sa-enseigne span {
      color: #f39c12;
      font-size: 9px;
      letter-spacing: 4px;
    }

    /* Panneau joueurs */
    .sa-panneau-joueurs {
      background: #1a1a2e;
      border: 2px solid #f39c12;
      border-radius: 8px;
      overflow: hidden;
      max-width: 280px;
    }
    .sa-panneau-joueurs-header {
      background: #2c3e50;
      padding: 6px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sa-panneau-joueurs-header h4 {
      color: #f39c12;
      font-size: 13px;
      letter-spacing: 2px;
    }
    .sa-panneau-joueurs-header .compteur {
      color: #e74c3c;
      font-size: 12px;
    }
    .sa-joueurs-liste {
      padding: 8px 12px;
    }
    .sa-joueur-item {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 2px 0;
    }
    .sa-joueur-item.connecte { color: #2ecc71; }
    .sa-joueur-item.attente { color: #7f8c8d; }

    /* Chat */
    .sa-chat {
      background: #1a1a2e;
      border: 1.5px solid #566573;
      border-radius: 8px;
      overflow: hidden;
      max-width: 360px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .sa-chat-header {
      background: #2c3e50;
      padding: 5px 15px;
      text-align: center;
    }
    .sa-chat-header h4 {
      color: #ecf0f1;
      font-size: 11px;
      letter-spacing: 2px;
    }
    .sa-chat-messages {
      flex: 1;
      padding: 8px 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chat-msg {
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .chat-msg .pseudo { font-weight: bold; }
    .chat-msg .texte { color: #bdc3c7; white-space: pre-wrap; }
    .sa-chat-input {
      display: flex;
      padding: 6px;
      gap: 4px;
    }
    .sa-chat-input input {
      flex: 1;
      background: #2c3e50;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      color: #ecf0f1;
      font-size: 12px;
      outline: none;
    }
    .sa-chat-input input::placeholder { color: #7f8c8d; }
    .sa-chat-input button {
      width: 28px;
      height: 28px;
      background: #3498db;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }

    /* Notifications salle d'attente (bas gauche) */
    .sa-notifs {
      position: absolute;
      bottom: 15px;
      left: 15px;
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
    }
    .sa-notif {
      background: rgba(0,0,0,0.7);
      color: #ecf0f1;
      padding: 6px 14px;
      border-radius: 8px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 13px;
      letter-spacing: 1px;
      animation: saNotifIn 0.3s ease;
      white-space: nowrap;
    }
    .sa-notif.join { border-left: 3px solid #2ecc71; }
    .sa-notif.leave { border-left: 3px solid #e74c3c; }
    .sa-notif.fade-out { opacity: 0; transition: opacity 0.4s; }
    @keyframes saNotifIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Zone centrale - fontaine + bancs */
    .sa-centre {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .fontaine {
      width: 120px;
      height: 90px;
      background: radial-gradient(ellipse, #85c1e9, #5dade2, #3498db);
      border-radius: 50%;
      border: 3px solid #7f8c8d;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      position: relative;
    }
    .fontaine::after {
      content: '';
      position: absolute;
      top: 20%;
      left: 30%;
      width: 40%;
      height: 30%;
      background: rgba(174,214,241,0.4);
      border-radius: 50%;
    }

    /* Bouton demarrer */
    .btn-demarrer {
      width: clamp(140px, 15vw, 180px);
      height: 55px;
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      color: white;
      font-size: 18px;
      border-radius: 12px;
      border: 3px solid #c0392b;
      box-shadow: 0 4px 15px rgba(231,76,60,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .btn-demarrer .btn-sub {
      font-family: Arial, sans-serif;
      font-size: 8px;
      color: #fad7d3;
      font-weight: normal;
      letter-spacing: 0;
    }

    /* Zone spawn */
    .sa-spawn {
      position: absolute;
      bottom: 15%;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 100px;
      border: 1.5px dashed rgba(243,156,18,0.4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sa-spawn span {
      color: rgba(243,156,18,0.4);
      font-size: 10px;
      letter-spacing: 2px;
    }

    /* Entree */
    .sa-entree {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 180px;
      background: #d5c4a1;
      border-left: 3px solid #566573;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .sa-entree span {
      color: #27ae60;
      font-size: 8px;
      font-weight: bold;
      writing-mode: vertical-lr;
      letter-spacing: 2px;
    }
    .sa-entree .fleche {
      color: #27ae60;
      font-size: 16px;
      opacity: 0.5;
    }

    /* Plantes */
    .plante {
      position: absolute;
      width: 50px;
      height: 70px;
    }
    .plante-pot {
      width: 40px;
      height: 30px;
      background: #a0522d;
      border-radius: 0 0 5px 5px;
      margin: 0 auto;
      position: relative;
    }
    .plante-pot::before {
      content: '';
      position: absolute;
      top: -6px;
      left: -4px;
      width: 48px;
      height: 10px;
      background: #8b4513;
      border-radius: 3px;
    }
    .plante-feuilles {
      width: 45px;
      height: 40px;
      background: radial-gradient(ellipse, #2ecc71, #27ae60);
      border-radius: 50%;
      margin: 0 auto -8px;
    }

    .plante-1 { top: 10px; right: 60px; }
    .plante-2 { bottom: 10px; left: 15px; }

    /* Distributeur */
    .distributeur {
      position: absolute;
      top: 10px;
      right: 140px;
      width: 65px;
      height: 105px;
      background: #34495e;
      border-radius: 5px;
      border: 2px solid #2c3e50;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
    }
    .distributeur-vitre {
      margin: 6px 6px 0;
      height: 55px;
      background: #2c3e50;
      border-radius: 3px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2px;
      padding: 4px;
    }
    .canette {
      border-radius: 2px;
      height: 18px;
    }
    .distributeur-fente {
      width: 30px;
      height: 6px;
      background: #1a252f;
      border-radius: 2px;
      margin: 8px auto 4px;
    }
    .distributeur span {
      display: block;
      text-align: center;
      color: #ecf0f1;
      font-size: 7px;
    }

    /* ============================== */
    /* LISTE DES PARTIES              */
    /* ============================== */
    #liste-parties {
      justify-content: center;
      gap: 0;
    }

    .lp-conteneur {
      width: clamp(380px, 70vw, 750px);
      background: rgba(26,26,46,0.92);
      border-radius: 16px;
      border: 2px solid #2c3e50;
      overflow: hidden;
      margin-top: 15px;
    }

    .lp-header {
      background: #2c3e50;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .lp-header h3 {
      color: #f39c12;
      font-size: 15px;
      letter-spacing: 3px;
    }
    .lp-header .lp-count {
      color: #95a5a6;
      font-size: 12px;
    }

    .lp-tableau {
      width: 100%;
      border-collapse: collapse;
    }
    .lp-tableau thead th {
      background: #1a252f;
      color: #bdc3c7;
      font-size: 11px;
      letter-spacing: 2px;
      padding: 10px 15px;
      text-align: left;
      font-weight: normal;
      border-bottom: 1px solid #34495e;
    }
    .lp-tableau thead th:last-child {
      text-align: center;
    }

    .lp-tableau tbody tr {
      border-bottom: 1px solid rgba(52,73,94,0.4);
      transition: background 0.15s;
      cursor: pointer;
    }
    .lp-tableau tbody tr:hover {
      background: rgba(46,134,193,0.1);
    }

    .lp-tableau tbody td {
      padding: 12px 15px;
      font-size: 13px;
      color: #ecf0f1;
    }

    .lp-nom-partie {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .lp-icone-partie {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #2c3e50;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .lp-nom-texte {
      display: flex;
      flex-direction: column;
    }
    .lp-nom-texte .nom {
      font-weight: bold;
      font-size: 13px;
    }
    .lp-nom-texte .host {
      font-size: 10px;
      color: #7f8c8d;
    }

    .lp-joueurs {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .lp-barre-joueurs {
      width: 60px;
      height: 6px;
      background: #1a252f;
      border-radius: 3px;
      overflow: hidden;
    }
    .lp-barre-remplissage {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }
    .lp-joueurs-texte {
      font-size: 12px;
      color: #bdc3c7;
      min-width: 35px;
    }

    .lp-mechants {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .lp-virus-icone {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(231,76,60,0.2);
      border: 1px solid #e74c3c;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #e74c3c;
    }
    .lp-mechants-texte {
      font-size: 12px;
      color: #e74c3c;
      font-weight: bold;
    }

    .btn-rejoindre {
      padding: 6px 16px;
      background: linear-gradient(180deg, #27ae60, #1e8449);
      color: white;
      border: 1.5px solid #2ecc71;
      border-radius: 6px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 12px;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-rejoindre:hover {
      filter: brightness(1.15);
      transform: translateY(-1px);
    }

    .lp-vide {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
      font-size: 13px;
    }
    .lp-vide .lp-vide-icone {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.4;
    }

    .btn-actualiser {
      padding: 8px 20px;
      background: transparent;
      color: #3498db;
      border: 1.5px solid #3498db;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-actualiser:hover {
      background: rgba(52,152,219,0.1);
    }

    /* ============================== */
    /* FORMULAIRE CREATION PARTIE     */
    /* ============================== */
    #creer-partie {
      justify-content: center;
      gap: 0;
    }

    .cp-formulaire {
      width: clamp(340px, 50vw, 500px);
      background: rgba(26,26,46,0.92);
      border-radius: 16px;
      border: 2px solid #e74c3c;
      overflow: hidden;
      margin-top: 20px;
    }
    .cp-header {
      background: #2c3e50;
      padding: 12px 20px;
      text-align: center;
    }
    .cp-header h3 {
      color: #f39c12;
      font-size: 15px;
      letter-spacing: 3px;
    }
    .cp-body {
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .cp-champ {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .cp-champ label {
      color: #bdc3c7;
      font-size: 12px;
      letter-spacing: 2px;
    }
    .cp-champ input, .cp-champ select {
      background: #1a252f;
      border: 1.5px solid #34495e;
      border-radius: 8px;
      padding: 10px 14px;
      color: #ecf0f1;
      font-size: 14px;
      font-family: Arial, sans-serif;
      outline: none;
      transition: border-color 0.2s;
    }
    .cp-champ input:focus, .cp-champ select:focus {
      border-color: #e74c3c;
    }
    .cp-champ input::placeholder { color: #566573; }
    .cp-champ select option { background: #1a252f; }

    .cp-toggle-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .cp-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: #34495e;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
      flex-shrink: 0;
    }
    .cp-toggle.active { background: #27ae60; }
    .cp-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #ecf0f1;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .cp-toggle.active::after { transform: translateX(20px); }
    .cp-toggle-label { color: #95a5a6; font-size: 13px; font-family: Arial, sans-serif; }
    .cp-toggle-label.active { color: #2ecc71; }
    .cp-toggle.cp-fanatic.active { background: #8e44ad; }
    .cp-toggle-label.cp-fanatic-label.active { color: #8e44ad; }
    .cp-toggle.cp-spy.active { background: #9b59b6; }
    .cp-toggle-label.cp-spy-label.active { color: #9b59b6; }
    .cp-roles-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .cp-role-item {
      background: #1a252f;
      border: 1px solid #34495e;
      border-radius: 8px;
      padding: 10px 12px;
    }
    .cp-role-item label {
      margin-bottom: 6px;
      display: block;
    }
    .btn-valider-creer {
      width: 100%;
      height: 50px;
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      color: white;
      border: 2px solid #ff6b6b;
      border-radius: 10px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-valider-creer:hover {
      filter: brightness(1.15);
      transform: translateY(-2px);
    }

    /* ============================== */
    /* ECRAN CREATION COMPTE          */
    /* ============================== */
    #ecran-compte {
      justify-content: center;
      gap: 0;
      z-index: 999;
    }

    .compte-carte {
      width: clamp(320px, 45vw, 440px);
      background: rgba(26,26,46,0.95);
      border-radius: 20px;
      border: 2px solid #e74c3c;
      overflow: hidden;
      margin-top: 25px;
      box-shadow: 0 0 40px rgba(231,76,60,0.15);
    }
    .compte-header {
      background: linear-gradient(180deg, #2c3e50, #1a252f);
      padding: 20px;
      text-align: center;
    }
    .compte-header h3 {
      color: #f39c12;
      font-size: 16px;
      letter-spacing: 3px;
    }
    .compte-header p {
      color: #7f8c8d;
      font-size: 11px;
      margin-top: 6px;
    }
    .compte-body {
      padding: 30px 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .compte-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(#4fc3f7, #0288d1);
      border: 4px solid #e74c3c;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      box-shadow: 0 0 20px rgba(231,76,60,0.3);
    }

    .compte-champ {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .compte-champ label {
      color: #bdc3c7;
      font-size: 12px;
      letter-spacing: 2px;
      text-align: center;
    }
    .compte-champ input {
      background: #1a252f;
      border: 2px solid #34495e;
      border-radius: 10px;
      padding: 12px 16px;
      color: #ecf0f1;
      font-size: 18px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 2px;
      text-align: center;
      outline: none;
      transition: border-color 0.2s;
    }
    .compte-champ input:focus {
      border-color: #e74c3c;
    }
    .compte-champ input::placeholder {
      color: #566573;
      font-size: 14px;
      letter-spacing: 1px;
      font-family: Arial, sans-serif;
    }

    .btn-creer-compte {
      width: 100%;
      height: 50px;
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      color: white;
      border: 2px solid #ff6b6b;
      border-radius: 10px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-creer-compte:hover {
      filter: brightness(1.15);
      transform: translateY(-2px);
    }

    /* Affichage pseudo dans le menu */
    .btn-musique {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #34495e;
      background: rgba(26,26,46,0.85);
      color: #f1c40f;
      font-size: 20px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-musique:hover {
      background: rgba(52,73,94,0.9);
      transform: scale(1.1);
    }
    .btn-musique.muted {
      color: #566573;
      border-color: #566573;
    }

    .menu-pseudo-bar {
      position: absolute;
      top: 15px;
      right: 75px;
      background: rgba(26,26,46,0.85);
      border: 1.5px solid #34495e;
      border-radius: 10px;
      padding: 6px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .menu-gold {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(243,156,18,0.15);
      border: 1px solid #f39c12;
      border-radius: 8px;
      padding: 2px 8px;
      margin-right: 4px;
    }
    .menu-gold-icon {
      font-size: 14px;
    }
    .menu-gold-val {
      color: #f39c12;
      font-size: 13px;
      font-weight: bold;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 1px;
    }
    .fin-partie-gold {
      color: #f39c12;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 22px;
      letter-spacing: 2px;
      margin-top: 5px;
      text-shadow: 0 0 10px rgba(243,156,18,0.5);
    }
    .menu-pseudo-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2ecc71;
      border: 1px solid #27ae60;
    }
    .menu-pseudo-nom {
      color: #ecf0f1;
      font-size: 13px;
      font-weight: bold;
      font-family: Arial, sans-serif;
    }
    .menu-pseudo-edit {
      color: #7f8c8d;
      font-size: 16px;
      cursor: pointer;
      transition: color 0.2s;
      background: none;
      border: none;
      padding: 0;
    }
    .menu-pseudo-edit:hover { color: #f39c12; }

    /* Popup parametres */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }
    .popup-overlay.visible {
      display: flex;
    }
    .popup-box {
      width: clamp(300px, 40vw, 420px);
      background: #1a1a2e;
      border-radius: 16px;
      border: 2px solid #566573;
      overflow: hidden;
    }
    .popup-header {
      background: #2c3e50;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-header h3 {
      color: #f39c12;
      font-size: 15px;
      letter-spacing: 3px;
    }
    .popup-close {
      background: none;
      border: none;
      color: #7f8c8d;
      font-size: 20px;
      cursor: pointer;
    }
    .popup-close:hover { color: #e74c3c; }
    .popup-body {
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .popup-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .popup-section label {
      color: #bdc3c7;
      font-size: 11px;
      letter-spacing: 2px;
    }
    .popup-section .pseudo-edit-row {
      display: flex;
      gap: 8px;
    }
    .popup-section input {
      flex: 1;
      background: #1a252f;
      border: 1.5px solid #34495e;
      border-radius: 8px;
      padding: 8px 12px;
      color: #ecf0f1;
      font-size: 14px;
      font-family: Arial, sans-serif;
      outline: none;
    }
    .popup-section input:focus { border-color: #f39c12; }
    .lang-selector { display:flex; gap:10px; margin-top:8px; }
    .lang-btn { flex:1; display:flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; background:linear-gradient(180deg,#34495e,#2c3e50); border:2px solid #566573; border-radius:8px; color:#ecf0f1; font-size:14px; font-weight:bold; cursor:pointer; font-family:Arial,sans-serif; }
    .lang-btn:hover { background:linear-gradient(180deg,#3d566e,#34495e); border-color:#7f8c8d; }
    .lang-btn.active { background:linear-gradient(180deg,#27ae60,#1e8449); border-color:#2ecc71; }
    .btn-sauver-pseudo {
      padding: 8px 16px;
      background: linear-gradient(180deg, #27ae60, #1e8449);
      color: white;
      border: 1.5px solid #2ecc71;
      border-radius: 8px;
      font-size: 12px;
      font-family: Arial, sans-serif;
      cursor: pointer;
      letter-spacing: 1px;
    }
    .btn-sauver-pseudo:hover { filter: brightness(1.15); }

    .popup-info {
      color: #7f8c8d;
      font-size: 10px;
      font-family: Arial, sans-serif;
      text-align: center;
      line-height: 1.5;
    }

    /* ============================== */
    /* CENTRE COMMERCIAL (JEU)        */
    /* ============================== */
    #jeu {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #1a1a2e;
      overflow: hidden;
    }
    #jeu.active { display: block; }

    .jeu-viewport {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    .mall-map {
      width: 8000px;
      height: 6000px;
      position: absolute;
      background: #c9c1b3;
    }

    /* Sol du centre commercial - carrelage realiste */
    .mall-sol {
      width: 100%;
      height: 100%;
      position: absolute;
      background:
        linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px),
        repeating-conic-gradient(#e6ddd0 0% 25%, #ded5c7 0% 50%) 0 0 / 60px 60px;
      background-size: 60px 60px, 60px 60px, 60px 60px;
    }

    /* Corridors */
    .corridor {
      position: absolute;
      background:
        repeating-conic-gradient(#f0e8dc 0% 25%, #e6ded0 0% 50%) 0 0 / 40px 40px;
    }
    .corridor-h {
      height: 140px;
    }
    .corridor-v {
      width: 160px;
    }

    /* Murs exterieurs */
    .mall-mur-ext {
      position: absolute;
      background: linear-gradient(180deg, #3d3027, #4a3c2e, #554636);
      box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
    }
    .mall-mur-ext-h {
      width: 100%;
      height: 20px;
    }
    .mall-mur-ext-v {
      height: 100%;
      width: 20px;
      background: linear-gradient(90deg, #3d3027, #4a3c2e, #554636);
    }

    /* Boutiques */
    .boutique {
      position: absolute;
      border-radius: 6px;
      overflow: hidden;
      border: 3px solid #5c4a3a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .boutique-interieur {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, transparent 40%, rgba(0,0,0,0.1) 100%);
    }
    .boutique-icone {
      font-size: 32px;
      margin-bottom: 4px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    .boutique-nom {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 11px;
      font-weight: bold;
      color: white;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.7), 0 0 10px rgba(0,0,0,0.3);
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }
    .boutique-porte {
      position: absolute;
      width: 36px;
      height: 8px;
      background: linear-gradient(90deg, #7a6345, #a08968, #7a6345);
      border: 1px solid #6b5740;
      box-shadow: 0 0 6px rgba(160,137,104,0.4);
    }

    /* Objets interieurs des boutiques */
    .obj-comptoir {
      position: absolute; background: linear-gradient(180deg, #6d4c41, #5d4037, #4e342e); border: 2px solid #3e2723; border-radius: 3px;
      width: 120px; height: 20px; z-index: 2;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .obj-etagere {
      position: absolute; background: linear-gradient(180deg, #a1887f, #8d6e63); border: 1px solid #6d4c41; border-radius: 2px;
      width: 80px; height: 15px; z-index: 2;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .obj-table {
      position: absolute; background: radial-gradient(circle at 35% 35%, #bcaaa4, #a1887f, #8d6e63); border: 2px solid #795548; border-radius: 50%;
      width: 40px; height: 40px; z-index: 2;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }
    .obj-table-rect {
      position: absolute; background: linear-gradient(135deg, #bcaaa4, #a1887f); border: 2px solid #795548; border-radius: 4px;
      width: 60px; height: 35px; z-index: 2;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .obj-chaise {
      position: absolute; background: radial-gradient(circle at 40% 40%, #8d6e63, #6d4c41); border: 1px solid #4e342e; border-radius: 50%;
      width: 14px; height: 14px; z-index: 2;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .obj-caisse {
      position: absolute; background: linear-gradient(135deg, #455a64, #37474f); border: 2px solid #263238; border-radius: 3px;
      width: 30px; height: 25px; z-index: 3;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .obj-caisse::after {
      content: ''; position: absolute; top: 3px; left: 50%; transform: translateX(-50%);
      width: 14px; height: 4px; background: #4caf50; border-radius: 1px;
      box-shadow: 0 0 4px rgba(76,175,80,0.5);
    }
    .obj-vitrine {
      position: absolute; background: linear-gradient(135deg, rgba(179,229,252,0.4), rgba(129,212,250,0.25)); border: 2px solid #78909c; border-radius: 4px;
      width: 60px; height: 30px; z-index: 2;
      box-shadow: inset 0 0 8px rgba(255,255,255,0.2), 0 1px 4px rgba(0,0,0,0.15);
    }
    .obj-ecran {
      position: absolute; background: linear-gradient(135deg, #0d1b4a, #1a237e, #283593); border: 3px solid #1a1a2e; border-radius: 3px;
      width: 50px; height: 30px; z-index: 2;
      box-shadow: 0 0 12px rgba(33,150,243,0.4), 0 0 4px rgba(33,150,243,0.2);
      animation: ecranFlicker 4s ease-in-out infinite alternate;
    }
    @keyframes ecranFlicker {
      0%, 90% { box-shadow: 0 0 12px rgba(33,150,243,0.4), 0 0 4px rgba(33,150,243,0.2); }
      95% { box-shadow: 0 0 6px rgba(33,150,243,0.2); }
      100% { box-shadow: 0 0 15px rgba(33,150,243,0.5), 0 0 6px rgba(33,150,243,0.3); }
    }
    .obj-portant {
      position: absolute; background: linear-gradient(90deg, #b0b0b0, #d0d0d0, #b0b0b0); border: 1px solid #9e9e9e; border-radius: 2px;
      width: 60px; height: 10px; z-index: 2;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .obj-portant::before {
      content: ''; position: absolute; top: -10px; left: 3px; right: 3px; height: 8px;
      background: repeating-linear-gradient(90deg, #e91e63 0px, #e91e63 8px, #2196f3 8px, #2196f3 16px, #ffc107 16px, #ffc107 24px, #4caf50 24px, #4caf50 32px);
      border-radius: 2px; opacity: 0.75;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .obj-miroir {
      position: absolute; background: linear-gradient(180deg, #e8f5fe, #bbdefb, #90caf9, #bbdefb); border: 2px solid #78909c;
      width: 8px; height: 30px; z-index: 2;
      box-shadow: 0 0 10px rgba(144,202,249,0.5), inset 0 0 4px rgba(255,255,255,0.6);
    }
    .obj-rayon {
      position: absolute; background: linear-gradient(180deg, #f5f0eb, #efebe9); border: 2px solid #bcaaa4; border-radius: 2px;
      width: 150px; height: 25px; z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .obj-rayon::after {
      content: ''; position: absolute; top: 3px; left: 5px; right: 5px; bottom: 3px;
      background: repeating-linear-gradient(90deg, #8bc34a 0px, #8bc34a 12px, #ff9800 12px, #ff9800 24px, #2196f3 24px, #2196f3 36px, #e91e63 36px, #e91e63 48px);
      border-radius: 1px; opacity: 0.55;
    }
    .obj-machine {
      position: absolute; background: linear-gradient(180deg, #4a4a4a, #424242, #333); border: 2px solid #212121; border-radius: 4px;
      width: 35px; height: 45px; z-index: 2;
      box-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }
    .obj-machine::after {
      content: ''; position: absolute; top: 4px; left: 4px; right: 4px; height: 18px;
      background: linear-gradient(135deg, #0d47a1, #1565c0); border-radius: 2px;
      box-shadow: 0 0 8px rgba(33,150,243,0.6);
    }
    .obj-canape {
      position: absolute; background: linear-gradient(180deg, #7986cb, #5c6bc0, #5c6bc0); border: 2px solid #3949ab; border-radius: 6px;
      width: 70px; height: 25px; z-index: 2;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }
    .obj-lavabo {
      position: absolute; background: radial-gradient(circle at 40% 30%, #fff, #eceff1, #cfd8dc); border: 2px solid #90a4ae; border-radius: 50% 50% 4px 4px;
      width: 25px; height: 20px; z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .obj-cabine {
      position: absolute; background: rgba(96,125,139,0.45); border: 2px solid #546e7a; border-radius: 3px;
      width: 40px; height: 50px; z-index: 2;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.15);
    }
    .obj-plante-int {
      position: absolute; width: 20px; height: 20px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #81c784, #66bb6a, #388e3c); border: 1px solid #2e7d32; z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .obj-piste {
      position: absolute; background: linear-gradient(90deg, #efebe9, #f5f0eb, #efebe9); border: 2px solid #d7ccc8; border-radius: 3px;
      width: 30px; height: 200px; z-index: 2;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.08);
    }
    .obj-piste::after {
      content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
      width: 12px; height: 12px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #ef5350, #e53935); border: 2px solid #c62828;
      box-shadow: 0 0 4px rgba(229,57,53,0.4);
    }

    /* Couleurs des boutiques */
    .b-mode { background: linear-gradient(135deg, #f06292, #e91e63, #c2185b, #ad1457); }
    .b-pharma { background: linear-gradient(135deg, #66bb6a, #4caf50, #388e3c, #2e7d32); }
    .b-resto { background: linear-gradient(135deg, #ffb74d, #ff9800, #f57c00, #e65100); }
    .b-bijoux { background: linear-gradient(135deg, #ffd54f, #ffc107, #ffa000, #ff8f00); }
    .b-techno { background: linear-gradient(135deg, #42a5f5, #2196f3, #1976d2, #1565c0); }
    .b-livre { background: linear-gradient(135deg, #8d6e63, #795548, #5d4037, #4e342e); }
    .b-super { background: linear-gradient(135deg, #aed581, #8bc34a, #689f38, #558b2f); }
    .b-sport { background: linear-gradient(135deg, #ff8a65, #ff5722, #e64a19, #d84315); }
    .b-cinema { background: linear-gradient(135deg, #ba68c8, #9c27b0, #7b1fa2, #6a1b9a); }
    .b-wc { background: linear-gradient(135deg, #78909c, #607d8b, #455a64, #37474f); }
    .b-secu { background: linear-gradient(135deg, #ef5350, #f44336, #d32f2f, #c62828); }
    .b-food { background: linear-gradient(135deg, #ff6e40, #e65100, #bf360c, #a33000); }

    /* Fontaine centrale */
    .mall-fontaine {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(ellipse at 40% 40%, #b3e5fc, #81d4fa, #4fc3f7, #29b6f6, #0288d1);
      border: 8px solid #78909c;
      box-shadow: 0 0 30px rgba(79,195,247,0.4), 0 0 60px rgba(79,195,247,0.15), inset 0 0 20px rgba(255,255,255,0.2);
      animation: fontaineRipple 3s ease-in-out infinite;
    }
    @keyframes fontaineRipple {
      0%, 100% { box-shadow: 0 0 30px rgba(79,195,247,0.4), 0 0 60px rgba(79,195,247,0.15), inset 0 0 20px rgba(255,255,255,0.2); }
      50% { box-shadow: 0 0 40px rgba(79,195,247,0.5), 0 0 80px rgba(79,195,247,0.2), inset 0 0 25px rgba(255,255,255,0.3); }
    }
    .mall-fontaine::before {
      content: '';
      position: absolute;
      top: 15%; left: 15%;
      width: 70%; height: 70%;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.2);
      animation: fontaineWave 2s linear infinite;
    }
    @keyframes fontaineWave {
      0% { transform: scale(0.6); opacity: 0.8; }
      100% { transform: scale(1.1); opacity: 0; }
    }
    .mall-fontaine::after {
      content: '';
      position: absolute;
      top: 30%; left: 30%;
      width: 40%; height: 40%;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 40%, rgba(255,255,255,0.6), rgba(179,229,252,0.4), transparent);
    }
    .fontaine-label {
      position: absolute;
      bottom: -26px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: #546e7a;
      letter-spacing: 3px;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: bold;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Bancs */
    .banc {
      position: absolute;
      width: 50px;
      height: 16px;
      background: linear-gradient(180deg, #a1887f, #8d6e63, #795548);
      border-radius: 4px;
      border: 1px solid #5d4037;
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }
    .banc::before {
      content: '';
      position: absolute;
      top: 2px; left: 3px; right: 3px; height: 2px;
      background: rgba(255,255,255,0.15);
      border-radius: 1px;
    }

    /* Plantes decoratives */
    .mall-plante {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #81c784, #66bb6a, #43a047, #2e7d32);
      border: 3px solid #6d4c41;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3), inset 0 -3px 6px rgba(0,0,0,0.15);
    }
    .mall-plante::after {
      content: '';
      position: absolute;
      top: 4px; left: 5px;
      width: 8px; height: 6px;
      background: rgba(255,255,255,0.25);
      border-radius: 50%;
    }

    /* Escalators */
    .escalator {
      position: absolute;
      width: 70px;
      height: 30px;
      background: linear-gradient(180deg, #90a4ae, #78909c, #607d8b);
      border: 2px solid #455a64;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    .escalator::before {
      content: '';
      position: absolute;
      top: 3px; left: 6px; right: 6px; bottom: 3px;
      background: repeating-linear-gradient(90deg, rgba(0,0,0,0.08) 0px, rgba(0,0,0,0.08) 3px, transparent 3px, transparent 6px);
      border-radius: 2px;
    }
    .escalator span {
      font-size: 8px;
      color: white;
      letter-spacing: 1px;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      z-index: 1;
    }

    /* Bouches d'aeration (events) */
    .vent {
      position: absolute;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #455a64, #37474f, #263238);
      border: 2px solid #1a2327;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.4), 0 2px 4px rgba(0,0,0,0.3);
    }
    .vent::before {
      content: '';
      width: 20px;
      height: 3px;
      background: #1a2327;
      box-shadow: 0 6px 0 #1a2327, 0 12px 0 #1a2327;
      border-radius: 1px;
    }

    /* Allees principales */
    .mall-allee-h {
      position: absolute;
      height: 200px;
      background:
        linear-gradient(rgba(0,0,0,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.015) 1px, transparent 1px),
        rgba(255,248,225,0.06);
      background-size: 60px 60px, 60px 60px, 100% 100%;
      border-top: 2px solid rgba(139,119,101,0.15);
      border-bottom: 2px solid rgba(139,119,101,0.15);
    }
    .mall-allee-v {
      position: absolute;
      width: 200px;
      background:
        linear-gradient(rgba(0,0,0,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.015) 1px, transparent 1px),
        rgba(255,248,225,0.06);
      background-size: 60px 60px, 60px 60px, 100% 100%;
      border-left: 2px solid rgba(139,119,101,0.15);
      border-right: 2px solid rgba(139,119,101,0.15);
    }

    /* Distributeurs automatiques */
    .mall-distributeur {
      position: absolute;
      width: 28px;
      height: 42px;
      border-radius: 4px;
      border: 2px solid #263238;
      background: linear-gradient(180deg, #546e7a, #455a64, #37474f);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    .mall-distributeur::before {
      content: '';
      position: absolute;
      top: 4px; left: 4px; right: 4px; height: 14px;
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      border-radius: 2px;
      box-shadow: 0 0 6px rgba(21,101,192,0.4);
    }
    .mall-distributeur::after {
      content: '';
      width: 12px;
      height: 6px;
      background: #1a1a1a;
      border-radius: 0 0 3px 3px;
      margin-bottom: 4px;
    }

    /* Poubelles */
    .mall-poubelle {
      position: absolute;
      width: 18px;
      height: 22px;
      background: linear-gradient(180deg, #546e7a, #455a64, #37474f);
      border: 1px solid #263238;
      border-radius: 2px 2px 5px 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }
    .mall-poubelle::after {
      content: '';
      position: absolute;
      top: -5px;
      left: -2px;
      right: -2px;
      height: 6px;
      background: linear-gradient(180deg, #78909c, #607d8b);
      border-radius: 3px 3px 0 0;
      border: 1px solid #455a64;
    }

    /* Panneaux publicitaires lumineux */
    .mall-pub {
      position: absolute;
      width: 100px;
      height: 60px;
      border-radius: 5px;
      border: 3px solid #37474f;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 9px;
      color: #e0f7fa;
      font-weight: bold;
      letter-spacing: 1.5px;
      text-align: center;
      text-shadow: 0 0 8px rgba(0,229,255,0.6);
      animation: pubGlow 3s ease-in-out infinite alternate;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    @keyframes pubGlow {
      from { box-shadow: 0 0 8px rgba(0,229,255,0.15), 0 3px 10px rgba(0,0,0,0.3); }
      to { box-shadow: 0 0 25px rgba(0,229,255,0.3), 0 3px 10px rgba(0,0,0,0.3); }
    }

    /* Tapis d'entree */
    .mall-tapis {
      position: absolute;
      background:
        repeating-linear-gradient(90deg, #b71c1c 0px, #b71c1c 20px, #c62828 20px, #c62828 40px),
        linear-gradient(180deg, rgba(255,255,255,0.08), transparent, rgba(0,0,0,0.1));
      background-blend-mode: normal;
      border: 3px solid #7f0000;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Fleches directionnelles au sol */
    .mall-fleche {
      position: absolute;
      font-size: 28px;
      color: rgba(255,193,7,0.25);
      font-family: Arial, sans-serif;
      pointer-events: none;
      text-shadow: 0 0 6px rgba(255,193,7,0.1);
    }

    /* Bouton reunion */
    .btn-reunion {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #f39c12, #e67e22);
      color: white;
      border: 3px solid #d35400;
      border-radius: 14px;
      padding: 12px 28px;
      font-family: 'Arial Black', Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      letter-spacing: 2px;
      cursor: pointer;
      pointer-events: auto;
      display: none;
      box-shadow: 0 4px 15px rgba(243,156,18,0.4);
      transition: all 0.2s;
      z-index: 210;
    }
    .btn-reunion:hover {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 6px 25px rgba(243,156,18,0.6);
    }

    /* Joueur */
    .joueur-perso {
      position: absolute;
      z-index: 100;
      transition: left 0.08s linear, top 0.08s linear;
      overflow: visible;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .joueur-perso img {
      height: 46px;
      width: auto;
      pointer-events: none;
    }
    .bot-perso {
      pointer-events: none;
      transition: left 0.15s linear, top 0.15s linear;
    }

    /* ============================== */
    /* CONFIG HORS LIGNE              */
    /* ============================== */
    #config-horsline {
      justify-content: center;
      gap: 0;
    }
    .config-hl-formulaire {
      width: clamp(340px, 50vw, 460px);
      background: rgba(26,26,46,0.92);
      border-radius: 16px;
      border: 2px solid #7f8c8d;
      overflow: hidden;
      margin-top: 20px;
    }
    .config-hl-header {
      background: #2c3e50;
      padding: 12px 20px;
      text-align: center;
    }
    .config-hl-header h3 {
      color: #bdc3c7;
      font-size: 15px;
      letter-spacing: 3px;
    }
    .config-hl-body {
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .config-hl-champ {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .config-hl-champ label {
      color: #bdc3c7;
      font-size: 12px;
      letter-spacing: 2px;
    }
    .config-hl-slider-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .config-hl-slider-row input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: #34495e;
      border-radius: 4px;
      outline: none;
    }
    .config-hl-slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #576574;
      border: 2px solid #95a5a6;
      cursor: pointer;
      transition: background 0.2s;
    }
    .config-hl-slider-row input[type="range"]::-webkit-slider-thumb:hover {
      background: #7f8c8d;
    }
    .config-hl-valeur {
      min-width: 36px;
      height: 36px;
      background: #1a252f;
      border: 1.5px solid #34495e;
      border-radius: 8px;
      color: #ecf0f1;
      font-size: 18px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 1px;
    }
    .config-hl-toggle-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .config-hl-toggle {
      position: relative;
      width: 52px;
      height: 28px;
      background: #34495e;
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .config-hl-toggle.active {
      background: #27ae60;
    }
    .config-hl-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: #ecf0f1;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .config-hl-toggle.active::after {
      transform: translateX(24px);
    }
    .config-hl-toggle-label {
      color: #95a5a6;
      font-size: 14px;
      font-family: Arial, sans-serif;
    }
    .config-hl-toggle-label.active {
      color: #2ecc71;
    }
    #hl-toggle-fanatique.active {
      background: #8e44ad;
    }
    #hl-toggle-fanatique-label.active {
      color: #8e44ad;
    }
    .config-hl-resume {
      background: #1a252f;
      border: 1px solid #34495e;
      border-radius: 10px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .config-hl-resume-item {
      color: #95a5a6;
      font-size: 12px;
      letter-spacing: 1px;
    }
    .config-hl-resume-item span {
      color: #ecf0f1;
      font-size: 16px;
      font-family: 'Impact', 'Arial Black', sans-serif;
    }
    .btn-lancer-hl {
      width: 100%;
      height: 50px;
      background: linear-gradient(180deg, #576574, #4a5568, #2d3436);
      color: white;
      border: 2px solid #7f8c8d;
      border-radius: 10px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-lancer-hl:hover {
      filter: brightness(1.15);
      transform: translateY(-2px);
    }

    /* Pseudo au-dessus du joueur */
    .joueur-pseudo {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 10px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: white;
      text-shadow: 0 0 4px #000, 0 0 4px #000, 1px 1px 2px #000;
      pointer-events: none;
      z-index: 101;
    }

    /* Admin arc-en-ciel */
    @keyframes rainbow {
      0% { color: #ff0000; }
      14% { color: #ff7f00; }
      28% { color: #ffff00; }
      42% { color: #00ff00; }
      57% { color: #0000ff; }
      71% { color: #4b0082; }
      85% { color: #9400d3; }
      100% { color: #ff0000; }
    }
    .pseudo-admin {
      animation: rainbow 2s linear infinite;
      text-shadow: 0 0 6px rgba(255,255,255,0.5), 0 0 4px #000, 1px 1px 2px #000;
    }
    .pseudo-admin-text {
      animation: rainbow 2s linear infinite;
    }

    /* Joueur dans la salle d'attente */
    .sa-joueur-avatar {
      position: absolute;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: left 0.08s linear, top 0.08s linear;
    }
    .sa-joueur-avatar .sa-avatar-pseudo {
      font-size: 10px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: white;
      text-shadow: 0 0 4px #000, 0 0 4px #000;
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .sa-joueur-avatar .sa-avatar-skin {
      display: flex;
      justify-content: center;
    }
    .sa-joueur-avatar .sa-avatar-skin img {
      height: 60px;
      width: auto;
    }

    /* Selecteur de skin (cabines + parametres) */
    .skin-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      padding: 10px 0;
      max-height: 280px;
      overflow-y: auto;
    }
    .skin-option {
      width: 70px;
      height: 80px;
      border: 3px solid #566573;
      border-radius: 10px;
      cursor: pointer;
      background: rgba(26,26,46,0.6);
      padding: 5px;
      transition: transform 0.15s, border-color 0.15s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .skin-option:hover { transform: scale(1.1); border-color: #95a5a6; }
    .skin-option.skin-selected { border-color: #f1c40f; box-shadow: 0 0 12px rgba(241,196,15,0.5); }
    .skin-option img {
      height: 46px;
      width: 46px;
      object-fit: contain;
    }
    .skin-option .skin-label {
      font-size: 8px;
      color: #95a5a6;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .skin-option.skin-selected .skin-label { color: #f1c40f; }
    .skin-rarete {
      font-size: 7px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 1px;
      padding: 1px 4px;
      border-radius: 3px;
      background: rgba(0,0,0,0.3);
    }
    .skin-carte-rarete {
      font-size: 11px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 2px;
      margin-bottom: 4px;
    }

    /* Popup casier (locker) */
    .cabine-popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(180deg, #2c3e50, #1a252f);
      border: 2px solid #f1c40f;
      border-radius: 12px;
      padding: 20px;
      z-index: 2000;
      min-width: 320px;
      max-width: 90vw;
      text-align: center;
    }
    .cabine-popup.visible { display: block; }
    .cabine-popup h3 {
      color: #f1c40f;
      font-size: 14px;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    .cabine-popup p {
      color: #95a5a6;
      font-size: 10px;
      margin-bottom: 12px;
    }
    .cabine-popup-close {
      margin-top: 10px;
      padding: 6px 20px;
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 11px;
      cursor: pointer;
      letter-spacing: 1px;
    }
    .cabine-popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1999;
    }
    .cabine-popup-overlay.visible { display: block; }

    /* Onglets du casier */
    .casier-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      border-bottom: 2px solid #34495e;
      padding-bottom: 0;
    }
    .casier-tab {
      flex: 1;
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #7f8c8d;
      font-size: 13px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      letter-spacing: 1px;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }
    .casier-tab:hover { color: #bdc3c7; }
    .casier-tab.active {
      color: #f1c40f;
      border-bottom-color: #f1c40f;
    }
    .casier-tab-content {
      display: none;
    }
    .casier-tab-content.active {
      display: block;
    }

    /* Onglet musique */
    .musique-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 280px;
      overflow-y: auto;
      padding: 4px 0;
    }
    .musique-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(26,26,46,0.6);
      border: 2px solid #34495e;
      border-radius: 8px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .musique-item:hover { border-color: #7f8c8d; background: rgba(44,62,80,0.5); }
    .musique-item.musique-active { border-color: #f1c40f; box-shadow: 0 0 10px rgba(241,196,15,0.3); }
    .musique-item-icon {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      background: linear-gradient(180deg, #8e44ad, #6c3483);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .musique-item-info {
      flex: 1;
      text-align: left;
    }
    .musique-item-title {
      color: #ecf0f1;
      font-size: 12px;
      font-weight: bold;
      font-family: Arial, sans-serif;
    }
    .musique-item-artist {
      color: #7f8c8d;
      font-size: 10px;
      font-family: Arial, sans-serif;
      margin-top: 2px;
    }
    .musique-item-equip {
      padding: 4px 10px;
      background: linear-gradient(180deg, #27ae60, #1e8449);
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1px;
    }
    .musique-item.musique-active .musique-item-equip {
      background: linear-gradient(180deg, #f39c12, #d68910);
    }

    /* HUD en jeu */
    .jeu-hud {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 200;
    }

    .hud-top {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26,26,46,0.85);
      border: 1.5px solid #e74c3c;
      border-radius: 10px;
      padding: 6px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      pointer-events: auto;
    }
    .hud-top span {
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #ecf0f1;
    }
    .hud-role {
      padding: 3px 10px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 11px;
      letter-spacing: 1px;
    }
    .hud-role-innocent { background: #27ae60; color: white; }
    .hud-role-virus { background: #e74c3c; color: white; }
    .hud-role-journaliste { background: #3498db; color: white; }
    .hud-role-fanatique { background: #8e44ad; color: white; }
    .hud-role-espion { background: #9b59b6; color: white; }

    .hud-minimap {
      position: absolute;
      bottom: 15px;
      right: 15px;
      width: 160px;
      height: 120px;
      background: rgba(26,26,46,0.85);
      border: 1.5px solid #566573;
      border-radius: 8px;
      overflow: hidden;
      pointer-events: auto;
    }
    .minimap-inner {
      width: 100%;
      height: 100%;
      position: relative;
      background: #2c3e50;
    }
    .minimap-shop {
      position: absolute;
      background: #546e7a;
      border-radius: 1px;
    }
    .minimap-joueur {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4fc3f7;
      border: 1px solid white;
      z-index: 5;
    }
    .minimap-mission {
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #f1c40f;
      border: 1px solid #f39c12;
      z-index: 4;
      animation: minimapMissionPulse 1.5s ease-in-out infinite;
    }
    @keyframes minimapMissionPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .hud-missions {
      position: absolute;
      top: 60px;
      left: 15px;
      background: rgba(26,26,46,0.85);
      border: 1.5px solid #f39c12;
      border-radius: 8px;
      padding: 10px 14px;
      pointer-events: auto;
      min-width: 180px;
    }
    .hud-missions h4 {
      color: #f39c12;
      font-size: 11px;
      letter-spacing: 2px;
      margin-bottom: 8px;
      font-family: Arial, sans-serif;
    }
    .mission-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 3px 0;
      font-family: Arial, sans-serif;
      font-size: 11px;
      color: #bdc3c7;
    }
    .mission-check {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1.5px solid #566573;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
    }
    .mission-done .mission-check {
      background: #27ae60;
      border-color: #27ae60;
      color: white;
    }
    .mission-done { color: #7f8c8d; text-decoration: line-through; }

    .mission-jauge-container {
      margin-top: 10px;
      background: rgba(0,0,0,0.4);
      border: 1.5px solid #566573;
      border-radius: 6px;
      height: 18px;
      position: relative;
      overflow: hidden;
    }
    .mission-jauge-fill {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border-radius: 4px;
      width: 0%;
      transition: width 0.5s ease;
    }
    .mission-jauge-text {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      font-size: 9px;
      font-weight: bold;
      color: #ecf0f1;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
      letter-spacing: 1px;
    }

    .boutique-cible {
      outline: 4px solid #f1c40f !important;
      outline-offset: -2px;
      box-shadow: 0 0 20px rgba(241,196,15,0.5);
      z-index: 10;
    }

    .caisse-cible {
      outline: 3px solid #f1c40f !important;
      outline-offset: 2px;
      box-shadow: 0 0 18px rgba(241,196,15,0.7), 0 0 40px rgba(241,196,15,0.3);
      z-index: 20;
      animation: caissePulse 1.2s ease-in-out infinite alternate;
    }
    @keyframes caissePulse {
      0% { box-shadow: 0 0 18px rgba(241,196,15,0.7), 0 0 40px rgba(241,196,15,0.3); }
      100% { box-shadow: 0 0 25px rgba(241,196,15,1), 0 0 60px rgba(241,196,15,0.5); }
    }

    .btn-mission-progress {
      position: absolute;
      bottom: 0; left: 0;
      width: 0;
      height: 100%;
      background: rgba(0,0,0,0.25);
      border-radius: 12px;
      transition: width 2s linear;
      pointer-events: none;
    }

    .btn-mission {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #f1c40f, #f39c12);
      color: #000;
      border: 2px solid #e67e22;
      border-radius: 12px;
      padding: 12px 30px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 2px;
      cursor: pointer;
      pointer-events: auto;
      display: none;
      box-shadow: 0 4px 15px rgba(243,156,18,0.5);
      z-index: 210;
    }
    .btn-mission:hover { filter: brightness(1.1); transform: translateX(-50%) translateY(-2px); }

    .btn-kill {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      color: white;
      border: 3px solid #96281b;
      border-radius: 14px;
      padding: 12px 28px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 3px;
      cursor: pointer;
      pointer-events: auto;
      display: none;
      box-shadow: 0 4px 15px rgba(231,76,60,0.5);
      z-index: 210;
      animation: killPulse 1s ease-in-out infinite;
    }
    @keyframes killPulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(231,76,60,0.5); }
      50% { box-shadow: 0 4px 25px rgba(231,76,60,0.8); }
    }
    .btn-kill:hover { filter: brightness(1.15); transform: translateX(-50%) scale(1.05); }

    .btn-enqueter {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #3498db, #2980b9);
      color: white;
      border: 3px solid #1a5276;
      border-radius: 14px;
      padding: 12px 28px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 3px;
      cursor: pointer;
      pointer-events: auto;
      display: none;
      box-shadow: 0 4px 15px rgba(52,152,219,0.5);
      z-index: 210;
      animation: enqueterPulse 1s ease-in-out infinite;
    }
    @keyframes enqueterPulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(52,152,219,0.5); }
      50% { box-shadow: 0 4px 25px rgba(52,152,219,0.8); }
    }
    .btn-enqueter:hover { filter: brightness(1.15); transform: translateX(-50%) scale(1.05); }

    .kill-countdown {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #e74c3c;
      border: 2px solid #e74c3c;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: none;
      align-items: center;
      justify-content: center;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 28px;
      letter-spacing: 1px;
      z-index: 210;
      pointer-events: none;
      text-shadow: 0 0 10px rgba(231,76,60,0.8);
    }

    .bot-mort {
      opacity: 0.3;
      filter: grayscale(1);
      transition: opacity 1s, filter 1s;
    }
    .bot-mort .joueur-pseudo {
      text-decoration: line-through;
      color: #7f8c8d !important;
    }
    .bot-fantome {
      opacity: 0;
      pointer-events: none;
      filter: grayscale(1);
      transition: opacity 0.5s;
    }
    .bot-fantome.fantome-visible {
      opacity: 0.35;
    }
    .virus-allie-badge {
      position: absolute;
      top: -18px;
      right: -8px;
      width: 18px;
      height: 18px;
      background: radial-gradient(circle, #e74c3c 40%, #c0392b 100%);
      border-radius: 50%;
      border: 2px solid #96281b;
      display: none;
      z-index: 200;
      box-shadow: 0 0 8px rgba(231,76,60,0.7);
    }
    .virus-allie-badge::after {
      content: '\2620';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      color: white;
    }
    .cadavre {
      position: absolute;
      z-index: 90;
      pointer-events: none;
    }
    .cadavre img {
      height: 46px;
      width: auto;
      transform: rotate(90deg);
      filter: hue-rotate(-30deg) saturate(0.5) brightness(0.6);
      opacity: 0.7;
    }
    .cadavre .cadavre-x {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      color: #e74c3c;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 0 0 6px rgba(231,76,60,0.8);
    }
    .btn-signaler {
      position: absolute;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #e67e22, #d35400);
      color: white;
      border: 3px solid #e74c3c;
      border-radius: 14px;
      padding: 12px 28px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 3px;
      cursor: pointer;
      pointer-events: auto;
      display: none;
      box-shadow: 0 4px 15px rgba(231,76,60,0.5);
      z-index: 210;
      animation: signalerPulse 1.2s ease-in-out infinite;
    }
    @keyframes signalerPulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(231,76,60,0.5); }
      50% { box-shadow: 0 4px 25px rgba(231,76,60,0.9); }
    }
    .btn-signaler:hover { filter: brightness(1.15); transform: translateX(-50%) scale(1.05); }

    /* Joystick mobile */
    #joystick-container {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 150px;
      z-index: 300;
      display: none;
      touch-action: none;
      pointer-events: auto;
    }
    #joystick-base {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      border: 3px solid rgba(255,255,255,0.3);
      position: relative;
    }
    #joystick-stick {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    /* Bouton cameras securite */
    .btn-cameras {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #3498db, #2980b9);
      color: #fff;
      border: 2px solid #1a6fa0;
      border-radius: 12px;
      padding: 12px 24px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      cursor: pointer;
      display: none;
      z-index: 210;
      pointer-events: auto;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      box-shadow: 0 4px 15px rgba(52,152,219,0.5);
    }
    .btn-cameras:hover { filter: brightness(1.15); transform: translateX(-50%) scale(1.05); }

    /* Overlay cameras de securite */
    .cameras-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 700;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    .cameras-overlay.visible { display: flex; }
    .cameras-titre {
      color: #e74c3c;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 22px;
      letter-spacing: 4px;
      margin-bottom: 12px;
      text-shadow: 0 0 10px rgba(231,76,60,0.5);
    }
    .cameras-grille {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-width: 750px;
      width: 95%;
    }
    .camera-panel {
      background: #0a0a0a;
      border: 1.5px solid #333;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
      aspect-ratio: 4/3;
    }
    .camera-panel-header {
      position: absolute;
      top: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.7);
      padding: 3px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 2;
    }
    .camera-panel-nom {
      font-family: 'Courier New', monospace;
      font-size: 9px;
      color: #ecf0f1;
      letter-spacing: 1px;
    }
    .camera-panel-rec {
      font-family: 'Courier New', monospace;
      font-size: 8px;
      color: #e74c3c;
      animation: recBlink 1s infinite;
    }
    @keyframes recBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    .camera-panel-vue {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: #0a0f0a;
      overflow: hidden;
      filter: brightness(0.7) contrast(1.2) saturate(0.4) sepia(0.3) hue-rotate(70deg);
    }
    .camera-map-clone {
      position: absolute;
      transform-origin: 0 0;
      pointer-events: none;
      background: #d5cec0;
    }
    .camera-map-clone .joueur-perso,
    .camera-map-clone .bot-perso,
    .camera-map-clone .cadavre {
      display: none !important;
    }
    .camera-cadavre {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 1;
      text-align: center;
    }
    .camera-cadavre img {
      width: 28px;
      height: 28px;
      display: block;
      margin: 0 auto;
      transform: rotate(90deg);
      filter: brightness(1.5) saturate(0.4);
      opacity: 0.8;
    }
    .camera-cadavre-x {
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      color: #e74c3c;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
    }
    .camera-scanlines {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,50,0,0.1) 2px,
        rgba(0,50,0,0.1) 4px
      );
      z-index: 1;
      pointer-events: none;
    }
    .camera-dots-layer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }
    .camera-perso {
      position: absolute;
      transform: translate(-50%, -80%);
      z-index: 1;
      text-align: center;
    }
    .camera-perso img {
      width: 28px;
      height: 28px;
      display: block;
      margin: 0 auto;
      filter: brightness(1.8);
    }
    .camera-perso-pseudo {
      font-family: 'Courier New', monospace;
      font-size: 6px;
      color: #8f8;
      white-space: nowrap;
      text-shadow: 0 0 3px rgba(0,0,0,0.8);
      margin-top: 1px;
    }
    .cameras-fermer {
      margin-top: 12px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 30px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      cursor: pointer;
    }
    .cameras-fermer:hover { filter: brightness(1.15); }

    /* Popup pouvoir journaliste */
    .journaliste-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 600;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .journaliste-popup.visible { display: flex; }
    .journaliste-box {
      background: linear-gradient(180deg, #1a1a2e, #0f1923);
      border: 2px solid #3498db;
      border-radius: 16px;
      padding: 30px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 40px rgba(52,152,219,0.3);
    }
    .journaliste-titre {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 22px;
      color: #3498db;
      letter-spacing: 3px;
      margin-bottom: 8px;
    }
    .journaliste-desc {
      color: #bdc3c7;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.4;
    }
    .journaliste-choix {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .journaliste-choix-btn {
      width: 60px; height: 60px;
      border-radius: 12px;
      background: linear-gradient(180deg, #2c3e50, #1a252f);
      border: 2px solid #3498db;
      color: #ecf0f1;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .journaliste-choix-btn:hover {
      background: linear-gradient(180deg, #3498db, #2980b9);
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(52,152,219,0.4);
    }
    .journaliste-resultats {
      display: none;
      text-align: left;
      margin-top: 15px;
    }
    .journaliste-resultats.visible { display: block; }
    .journaliste-resultat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 8px;
      background: rgba(44,62,80,0.5);
    }
    .journaliste-resultat-nom { color: #ecf0f1; font-size: 14px; }
    .journaliste-resultat-role {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .role-tag-virus { background: #e74c3c; color: white; }
    .role-tag-innocent { background: #27ae60; color: white; }
    .journaliste-fermer {
      margin-top: 15px;
      padding: 10px 30px;
      background: linear-gradient(180deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      cursor: pointer;
      display: none;
    }
    .journaliste-fermer:hover { filter: brightness(1.1); }

    /* ============================== */
    /* SYSTEME DE REUNION (EN JEU)    */
    /* ============================== */

    /* Bandeau titre + timer en haut */
    .reunion-bandeau {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26,26,46,0.95);
      border: 2px solid #f39c12;
      border-radius: 12px;
      padding: 10px 30px;
      text-align: center;
      z-index: 220;
      pointer-events: auto;
      display: none;
    }
    .reunion-bandeau.visible { display: block; }
    .reunion-bandeau-titre {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 22px;
      color: #f39c12;
      letter-spacing: 3px;
    }
    .reunion-bandeau-timer {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      color: #e74c3c;
      letter-spacing: 2px;
    }

    /* Chat reunion (panneau a droite) */
    .reunion-chat {
      position: absolute;
      top: 60px;
      right: 15px;
      width: 330px;
      max-height: 55vh;
      background: rgba(26,26,46,0.95);
      border: 1.5px solid #566573;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 220;
      pointer-events: auto;
    }
    .reunion-chat.visible { display: flex; }
    .reunion-chat-header {
      background: #2c3e50;
      padding: 8px 15px;
      text-align: center;
    }
    .reunion-chat-header h4 {
      color: #ecf0f1;
      font-size: 12px;
      letter-spacing: 2px;
    }
    .reunion-chat-messages {
      flex: 1;
      padding: 8px 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 180px;
      max-height: 380px;
    }
    .reunion-chat-input {
      display: flex;
      padding: 8px;
      gap: 4px;
      border-top: 1px solid #34495e;
    }
    .reunion-chat-input input {
      flex: 1;
      background: #2c3e50;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      color: #ecf0f1;
      font-size: 11px;
      font-family: Arial, sans-serif;
      outline: none;
    }
    .reunion-chat-input button {
      width: 30px;
      height: 30px;
      background: #3498db;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }

    /* Bouton SKIP en bas */
    .reunion-btn-skip {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 40px;
      background: linear-gradient(180deg, #566573, #34495e);
      color: #ecf0f1;
      border: 2px solid #7f8c8d;
      border-radius: 12px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 2px;
      cursor: pointer;
      z-index: 220;
      pointer-events: auto;
      display: none;
    }
    .reunion-btn-skip.visible { display: block; }
    .reunion-btn-skip:hover { filter: brightness(1.2); }

    /* Bulle de vote au-dessus des joueurs */
    .vote-bulle {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      z-index: 102;
      box-shadow: 0 2px 8px rgba(231,76,60,0.5);
    }
    .vote-bulle.has-votes { display: flex; }

    /* Surbrillance joueur cliquable pendant reunion */
    .reunion-cliquable {
      pointer-events: auto !important;
      cursor: pointer;
    }
    .reunion-cliquable:hover img {
      filter: brightness(1.3) drop-shadow(0 0 8px #f39c12);
    }
    .reunion-vote-selection {
      outline: 3px solid #e74c3c;
      outline-offset: 4px;
      border-radius: 50%;
    }

    /* Resultat du vote (bandeau) */
    .reunion-resultat-bandeau {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26,26,46,0.95);
      border: 2px solid #f39c12;
      border-radius: 16px;
      padding: 30px 50px;
      text-align: center;
      z-index: 230;
      pointer-events: auto;
      display: none;
    }
    .reunion-resultat-bandeau.visible { display: block; }
    .reunion-resultat-texte {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 22px;
      color: #ecf0f1;
      letter-spacing: 2px;
      margin-bottom: 10px;
    }
    .reunion-resultat-role {
      font-size: 16px;
      letter-spacing: 1px;
      padding: 6px 18px;
      border-radius: 8px;
      display: inline-block;
      margin-bottom: 15px;
    }
    .reunion-btn-continuer {
      padding: 10px 30px;
      background: linear-gradient(180deg, #f39c12, #e67e22);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      cursor: pointer;
    }
    .reunion-btn-continuer:hover { filter: brightness(1.1); }

    /* Badge createur de reunion */
    .reunion-createur-badge {
      position: absolute;
      top: -38px;
      left: -15px;
      transform: none;
      font-size: 12px;
      filter: drop-shadow(0 0 4px rgba(231, 76, 60, 0.8));
      pointer-events: none;
      z-index: 100;
      animation: badge-createur-pulse 1.5s ease-in-out infinite;
    }
    @keyframes badge-createur-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    /* ============================== */
    /* ECRAN FIN DE PARTIE            */
    /* ============================== */
    .fin-partie-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 600;
      align-items: center;
      justify-content: flex-start;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
      padding: 40px 20px;
    }
    .fin-partie-overlay.visible {
      display: flex;
    }
    .fin-partie-titre {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: clamp(40px, 8vw, 80px);
      letter-spacing: 6px;
      text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
      animation: finPartiePulse 1.5s ease-in-out infinite;
    }
    @keyframes finPartiePulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.85; }
    }
    .fin-partie-titre.virus { color: #e74c3c; }
    .fin-partie-titre.innocents { color: #2ecc71; }
    .fin-partie-titre.fanatique { color: #8e44ad; }
    .fin-partie-titre.espion { color: #9b59b6; }
    .fin-partie-sous-titre {
      font-family: Arial, sans-serif;
      font-size: clamp(14px, 2.5vw, 22px);
      color: #bdc3c7;
      text-align: center;
      max-width: 500px;
      line-height: 1.5;
    }
    .fin-partie-roles {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 10px;
    }
    .fin-partie-joueur {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: rgba(26,26,46,0.8);
      border-radius: 10px;
      padding: 10px 14px;
      border: 1.5px solid #34495e;
    }
    .fin-partie-joueur img {
      height: 40px;
      width: auto;
    }
    .fin-partie-joueur .fp-pseudo {
      font-size: 11px;
      color: #ecf0f1;
      font-family: Arial, sans-serif;
    }
    .fin-partie-joueur .fp-role {
      font-size: 10px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      letter-spacing: 1px;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .fp-role-virus { background: #e74c3c; color: white; }
    .fp-role-innocent { background: #27ae60; color: white; }
    .fp-role-journaliste { background: #3498db; color: white; }
    .fp-role-fanatique { background: #8e44ad; color: white; }
    .fp-role-espion { background: #9b59b6; color: white; }
    .fin-partie-btn {
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 14px 40px;
      background: linear-gradient(180deg, #576574, #4a5568);
      color: white;
      border: 2px solid #7f8c8d;
      border-radius: 12px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 20px;
      letter-spacing: 3px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      pointer-events: auto;
      z-index: 610;
    }
    .fin-partie-btn:hover {
      filter: brightness(1.15);
      transform: translateY(-2px);
    }

    .hud-btn-quitter {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 6px 14px;
      background: rgba(231,76,60,0.8);
      border: 1px solid #e74c3c;
      border-radius: 6px;
      color: white;
      font-size: 11px;
      font-family: Arial, sans-serif;
      cursor: pointer;
      pointer-events: auto;
    }

    /* Notifications toast */
    .notif-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }
    .notif-toast {
      background: rgba(231,76,60,0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      animation: notifSlide 0.3s ease;
      pointer-events: auto;
      text-align: center;
      max-width: 400px;
    }
    .notif-toast.info {
      background: rgba(52,152,219,0.95);
    }
    .notif-toast.warn {
      background: rgba(243,156,18,0.95);
    }
    .notif-toast.fade-out {
      animation: notifFade 0.4s ease forwards;
    }
    @keyframes notifSlide {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes notifFade {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    .hud-controles {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(26,26,46,0.7);
      border-radius: 8px;
      padding: 6px 12px;
      color: #7f8c8d;
      font-size: 10px;
      font-family: Arial, sans-serif;
    }

    /* Panneau de boutique */
    .panneau-boutique {
      position: absolute;
      background: linear-gradient(180deg, #34495e, #2c3e50);
      border-radius: 5px;
      padding: 4px 10px;
      z-index: 50;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 8px rgba(241,196,15,0.15);
      border: 1px solid #3d566e;
    }
    .panneau-boutique span {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 8px;
      color: #f1c40f;
      letter-spacing: 1.5px;
      font-weight: bold;
      text-shadow: 0 0 6px rgba(241,196,15,0.4);
    }

    /* Entrees du mall */
    .mall-entree {
      position: absolute;
      background: linear-gradient(135deg, #c8e6c9, #a5d6a7, #81c784);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 12px rgba(76,175,80,0.3);
    }
    .mall-entree span {
      font-size: 8px;
      color: #1b5e20;
      font-weight: bold;
      font-family: 'Segoe UI', Arial, sans-serif;
      letter-spacing: 1.5px;
      text-shadow: 0 0 4px rgba(255,255,255,0.3);
    }

    /* ============================== */
    /* TRANSITIONS                    */
    /* ============================== */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ============================
       SYSTEME D'AMIS
    ============================ */
    #btn-amis {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 9999;
      width: 48px;
      height: 48px;
      background: rgba(26, 26, 46, 0.95);
      border: 2px solid #e74c3c;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #btn-amis:hover {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
    }
    #btn-amis svg { width: 24px; height: 24px; }
    #badge-amis {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #e74c3c;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 11px;
      font-weight: bold;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    #panel-amis {
      position: fixed;
      right: 0;
      top: 0;
      width: 25vw;
      min-width: 320px;
      max-width: 420px;
      height: 100vh;
      background: #1a1a2e;
      z-index: 9998;
      border-left: 3px solid #e74c3c;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      box-shadow: -5px 0 25px rgba(0,0,0,0.5);
    }
    .panel-amis-ferme { transform: translateX(100%); }
    .panel-amis-ouvert { transform: translateX(0); }

    .panel-amis-header {
      background: #2c3e50;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(231,76,60,0.3);
    }
    .panel-amis-header span {
      color: #ecf0f1;
      font-family: Arial, sans-serif;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 3px;
    }
    .panel-amis-header button {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 22px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .panel-amis-header button:hover { background: rgba(231,76,60,0.2); }

    .panel-amis-recherche {
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .panel-amis-recherche input {
      flex: 1;
      padding: 10px 14px;
      background: #2c3e50;
      border: 1px solid #566573;
      border-radius: 8px;
      color: #ecf0f1;
      font-family: Arial, sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }
    .panel-amis-recherche input:focus { border-color: #e74c3c; }
    .panel-amis-recherche input::placeholder { color: #7f8c8d; }
    .panel-amis-recherche button {
      padding: 10px 16px;
      background: #e74c3c;
      border: none;
      border-radius: 8px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1px;
      transition: background 0.2s;
    }
    .panel-amis-recherche button:hover { background: #c0392b; }

    .panel-amis-tabs {
      display: flex;
      padding: 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .tab-ami {
      flex: 1;
      padding: 12px 8px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: #7f8c8d;
      font-family: Arial, sans-serif;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: color 0.2s, border-color 0.2s;
    }
    .tab-ami:hover { color: #bdc3c7; }
    .tab-ami.active { color: #e74c3c; border-bottom-color: #e74c3c; }
    .tab-ami .count-demandes {
      background: #e74c3c;
      color: white;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 8px;
      margin-left: 4px;
    }

    .panel-amis-liste {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      scrollbar-width: thin;
      scrollbar-color: #e74c3c transparent;
    }

    .ami-item {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      gap: 12px;
      transition: background 0.15s;
      cursor: default;
    }
    .ami-item:hover { background: rgba(255,255,255,0.03); }
    .ami-statut-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .ami-statut-dot.online { background: #2ecc71; box-shadow: 0 0 6px rgba(46,204,113,0.5); }
    .ami-statut-dot.offline { background: #7f8c8d; }
    .ami-pseudo {
      flex: 1;
      color: #ecf0f1;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .ami-pseudo.offline-text { color: #7f8c8d; }
    .ami-btn-inviter {
      padding: 6px 12px;
      background: #3498db;
      border: none;
      border-radius: 6px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .ami-btn-inviter:hover { background: #2980b9; }

    .demande-item {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      gap: 10px;
    }
    .demande-pseudo {
      flex: 1;
      color: #f39c12;
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-weight: bold;
    }
    .demande-btn-accepter {
      padding: 6px 12px;
      background: #2ecc71;
      border: none;
      border-radius: 6px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .demande-btn-accepter:hover { background: #27ae60; }
    .demande-btn-refuser {
      padding: 6px 12px;
      background: #e74c3c;
      border: none;
      border-radius: 6px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .demande-btn-refuser:hover { background: #c0392b; }

    .panel-amis-vide {
      text-align: center;
      color: #566573;
      font-family: Arial, sans-serif;
      font-size: 13px;
      padding: 40px 20px;
    }

    /* Popup invitation recue */
    #popup-invitation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 2px solid #f39c12;
      border-radius: 12px;
      padding: 24px;
      z-index: 10000;
      display: none;
      text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      min-width: 300px;
    }
    #popup-invitation h3 {
      color: #f39c12;
      font-family: Arial, sans-serif;
      margin-bottom: 8px;
    }
    #popup-invitation p {
      color: #ecf0f1;
      font-family: Arial, sans-serif;
      font-size: 14px;
      margin-bottom: 16px;
    }
    #popup-invitation .popup-btns {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    /* Overlay choix de camp espion */
    #espion-choix-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 10000;
      display: none; justify-content: center; align-items: center; flex-direction: column;
    }
    #espion-choix-overlay h2 { color: #9b59b6; font-family: Arial, sans-serif; font-size: 28px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 3px; }
    #espion-choix-overlay p { color: #ecf0f1; font-family: Arial, sans-serif; font-size: 14px; margin-bottom: 30px; }
    .espion-btn-camp { padding: 15px 40px; font-size: 18px; border: none; border-radius: 10px; cursor: pointer; margin: 10px; font-weight: bold; letter-spacing: 1px; transition: transform 0.2s, box-shadow 0.2s; }
    .espion-btn-camp:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .espion-btn-virus { background: #e74c3c; color: white; }
    .espion-btn-innocent { background: #27ae60; color: white; }

    /* ============================== */
    /* RESPONSIVE MOBILE              */
    /* ============================== */
    @media (max-width: 768px) {
      /* Salle d'attente : empiler verticalement */
      #salle-attente {
        flex-direction: column;
      }
      .sa-content {
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }
      .sa-gauche {
        width: 100%;
        padding: 10px;
      }
      .sa-droite {
        width: 100%;
        padding: 10px;
      }
      .cabines-grid {
        justify-content: center;
      }
      .cabine {
        width: clamp(70px, 20vw, 100px);
      }
      .cabine-interieur {
        height: 70px;
      }
      .sa-enseigne {
        padding: 6px 15px;
      }
      .sa-enseigne h2 {
        font-size: 22px;
        letter-spacing: 5px;
      }
      .sa-panneau-joueurs {
        max-width: 100%;
      }
      .sa-chat {
        max-width: 100%;
        max-height: 200px;
      }
      .sa-droite > div {
        flex-direction: column;
      }
      .sa-droite > div > div {
        min-width: 0 !important;
      }

      /* Cacher les decorations qui genent sur mobile */
      .sa-centre,
      .sa-entree,
      .plante,
      .distributeur,
      .sa-joueur-avatar {
        display: none;
      }

      /* Murs plus fins */
      .sa-mur-haut, .sa-mur-bas {
        height: 30px;
      }
      .sa-content {
        height: calc(100% - 60px);
      }

      /* Bouton demarrer plus accessible */
      .btn-demarrer {
        width: 100%;
        height: 50px;
      }

      /* Panneau cabines centre */
      .panneau-cabines {
        align-self: center;
      }

      /* ============================== */
      /* ECRAN CREATION COMPTE          */
      /* ============================== */
      .compte-carte {
        width: 90vw;
        margin-top: 10px;
      }
      .compte-header {
        padding: 12px;
      }
      .compte-body {
        padding: 20px 15px;
      }
      .compte-avatar {
        width: 60px;
        height: 60px;
        font-size: 28px;
      }

      /* ============================== */
      /* MENU PRINCIPAL                 */
      /* ============================== */
      .menu-pseudo-bar {
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        gap: 6px;
        font-size: 11px;
      }
      .btn-musique {
        top: 10px;
        left: 10px;
        width: 34px;
        height: 34px;
        font-size: 16px;
      }
      .virus-icons {
        gap: clamp(40px, 12vw, 100px);
      }
      .menu-buttons {
        gap: 10px;
        margin-top: 15px;
      }
      .btn-online {
        width: clamp(260px, 75vw, 400px);
        height: 65px;
        font-size: clamp(20px, 5vw, 32px);
      }
      .btn-horsline,
      .btn-boutique,
      .btn-casier {
        width: clamp(220px, 65vw, 340px);
        height: 50px;
        font-size: clamp(14px, 3.5vw, 20px);
      }
      .btn-param {
        width: 140px;
        height: 36px;
        font-size: 12px;
      }
      .regles-panneau {
        width: 90vw;
        margin-top: 15px;
      }
      .regles-liste {
        max-height: 150px;
      }
      .version {
        font-size: 8px;
        bottom: 5px;
      }

      /* ============================== */
      /* CONFIG HORS LIGNE              */
      /* ============================== */
      .config-hl-formulaire {
        width: 90vw;
        margin-top: 10px;
      }
      .config-hl-body {
        padding: 15px;
        gap: 14px;
      }
      .config-hl-resume {
        flex-direction: column;
        align-items: flex-start;
      }

      /* ============================== */
      /* BOUTIQUE DE SKINS              */
      /* ============================== */
      #boutique-skins {
        padding-top: 30px;
        gap: 10px;
      }
      .boutique-grille {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 8px;
        max-height: 55vh;
      }
      .boutique-tabs {
        width: 90vw;
      }
      .skin-carte-img {
        width: 45px;
        height: 45px;
      }
      .skin-carte-nom {
        font-size: 11px;
        letter-spacing: 1px;
      }
      .skin-carte-prix {
        font-size: 11px;
      }
      .skin-carte-btn {
        font-size: 10px;
        padding: 6px 0;
      }

      /* ============================== */
      /* MENU ONLINE                    */
      /* ============================== */
      .btn-retour {
        top: 10px;
        left: 10px;
        width: 90px;
        height: 36px;
        font-size: 12px;
      }
      .online-sous-titre {
        font-size: 12px;
        letter-spacing: 3px;
        margin-bottom: 15px;
      }
      .panneau-central {
        padding: 20px 15px;
        gap: 15px;
        width: 90vw;
        box-sizing: border-box;
      }
      .btn-creer,
      .btn-trouver {
        width: 100%;
        height: 90px;
        padding: 0 15px;
        gap: 12px;
      }
      .btn-creer .btn-icon,
      .btn-trouver .btn-icon {
        width: 40px;
        height: 40px;
        font-size: 22px;
      }
      .separateur-ou {
        width: 100%;
      }
      .info-bas {
        max-width: 100%;
      }

      /* ============================== */
      /* CREER PARTIE                   */
      /* ============================== */
      .cp-formulaire {
        width: 90vw;
        margin-top: 10px;
      }
      .cp-body {
        padding: 15px;
        gap: 14px;
      }
      .cp-roles-grid {
        grid-template-columns: 1fr;
      }

      /* ============================== */
      /* LISTE DES PARTIES              */
      /* ============================== */
      .lp-conteneur {
        width: 95vw;
        margin-top: 10px;
      }
      .lp-tableau thead th {
        padding: 8px 6px;
        font-size: 9px;
        letter-spacing: 1px;
      }
      .lp-tableau tbody td {
        padding: 8px 6px;
        font-size: 11px;
      }
      .lp-nom-partie {
        gap: 6px;
      }
      .lp-icone-partie {
        width: 24px;
        height: 24px;
        font-size: 11px;
      }
      .lp-nom-texte .nom {
        font-size: 11px;
      }
      .lp-barre-joueurs {
        width: 40px;
      }

      /* ============================== */
      /* POPUP PARAMETRES               */
      /* ============================== */
      .popup-box {
        width: 90vw;
      }
      .lang-selector {
        flex-direction: column;
      }

      /* ============================== */
      /* HUD EN JEU                     */
      /* ============================== */
      .hud-top {
        top: 8px;
        padding: 4px 10px;
        gap: 8px;
      }
      .hud-top span {
        font-size: 10px;
      }
      .hud-role {
        font-size: 9px;
        padding: 2px 6px;
      }
      .hud-missions {
        top: 45px;
        left: 8px;
        padding: 6px 8px;
        min-width: 140px;
        max-width: 45vw;
        font-size: 10px;
      }
      .hud-missions h4 {
        font-size: 9px;
        margin-bottom: 4px;
      }
      .mission-item {
        font-size: 9px;
        gap: 5px;
      }
      .hud-minimap {
        bottom: 8px;
        right: 8px;
        width: 110px;
        height: 82px;
      }
      .btn-mission {
        bottom: 30px;
        padding: 8px 20px;
        font-size: 14px;
      }
      .btn-kill {
        bottom: 90px;
        padding: 8px 20px;
        font-size: 14px;
      }
      .btn-enqueter {
        bottom: 90px;
        padding: 8px 20px;
        font-size: 14px;
      }
      .btn-signaler {
        bottom: 150px;
        padding: 8px 20px;
        font-size: 14px;
      }
      .btn-cameras {
        bottom: 80px;
        padding: 8px 16px;
        font-size: 13px;
      }
      .kill-countdown {
        bottom: 90px;
        width: 48px;
        height: 48px;
        font-size: 22px;
      }

      /* ============================== */
      /* CAMERAS SECURITE               */
      /* ============================== */
      .cameras-grille {
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
      }
      .cameras-titre {
        font-size: 16px;
        letter-spacing: 2px;
      }

      /* ============================== */
      /* REUNION / VOTE                 */
      /* ============================== */
      .reunion-box {
        width: 95vw;
        max-width: 95vw;
        padding: 15px;
      }
      .reunion-titre {
        font-size: 18px;
      }
      .vote-carte {
        padding: 6px 8px;
      }
      .vote-carte-pseudo {
        font-size: 11px;
      }

      /* Reunion mobile */
      .reunion-bandeau {
        top: 50px;
        padding: 5px 12px;
      }
      .reunion-bandeau-titre {
        font-size: 14px;
        letter-spacing: 1px;
      }
      .reunion-bandeau-timer {
        font-size: 13px;
      }
      .reunion-chat {
        top: auto;
        bottom: 55px;
        right: 5px;
        left: 5px;
        width: auto;
        max-height: 30vh;
      }
      .reunion-chat-messages {
        min-height: 50px;
        max-height: 16vh;
        font-size: 11px;
      }
      .reunion-chat-header {
        padding: 3px 8px;
      }
      .reunion-chat-header h4 {
        font-size: 9px;
      }
      .reunion-chat-input {
        padding: 4px;
      }
      .reunion-chat-input input {
        font-size: 12px;
        padding: 6px 8px;
      }
      .reunion-chat-input button {
        width: 28px;
        height: 28px;
      }
      .reunion-btn-skip {
        bottom: 12px;
        padding: 8px 24px;
        font-size: 14px;
        z-index: 225;
      }
      .vote-bulle {
        top: -35px;
        width: 22px;
        height: 22px;
        font-size: 11px;
      }

      /* ============================== */
      /* FIN DE PARTIE                  */
      /* ============================== */
      .fin-partie-box {
        width: 90vw;
        padding: 20px;
      }

      /* ============================== */
      /* CASIER / CABINE POPUP          */
      /* ============================== */
      .cabine-popup {
        min-width: auto;
        width: 90vw;
        padding: 15px;
      }
      .skin-selector {
        gap: 8px;
        max-height: 200px;
      }
      .skin-option {
        width: 60px;
        height: 70px;
      }
      .skin-option img {
        height: 38px;
        width: 38px;
      }

      /* ============================== */
      /* MINI-JEUX RESPONSIVE           */
      /* ============================== */
      .minijeu-zone {
        padding: 16px;
        max-width: 95vw;
        min-height: 250px;
      }
      .minijeu-titre {
        font-size: 16px;
        margin-bottom: 10px;
      }
      .simon-btn {
        width: 70px;
        height: 70px;
      }
      .wire-endpoint {
        width: 40px;
        height: 34px;
      }
      .digicode-display {
        font-size: 28px;
        letter-spacing: 8px;
      }
      .digicode-btn {
        padding: 10px;
        font-size: 18px;
      }
      .rapidclick-btn {
        width: 100px;
        height: 100px;
        font-size: 14px;
      }
    }

    /* ============================== */
    /* MINI-JEUX OVERLAY              */
    /* ============================== */
    .minijeu-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.92);
      z-index: 700;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    .minijeu-overlay.visible { display: flex; }

    .minijeu-titre {
      color: #f39c12;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 22px;
      letter-spacing: 4px;
      margin-bottom: 16px;
      text-shadow: 0 0 10px rgba(243,156,18,0.5);
      text-align: center;
    }

    .minijeu-zone {
      background: rgba(26,26,46,0.95);
      border: 2px solid #2c3e50;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .minijeu-fermer {
      position: absolute;
      top: -18px;
      right: -18px;
      width: 40px;
      height: 40px;
      background: #e74c3c;
      color: white;
      border: 3px solid #c0392b;
      border-radius: 50%;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .minijeu-fermer:hover { filter: brightness(1.15); }

    /* --- WIRES --- */
    .wires-container {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      min-height: 220px;
      position: relative;
    }
    .wires-left, .wires-right {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      gap: 12px;
      z-index: 2;
    }
    .wire-endpoint {
      width: 50px;
      height: 40px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: rgba(0,0,0,0.4);
      border: 3px solid rgba(0,0,0,0.2);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .wire-endpoint:hover {
      transform: scale(1.1);
    }
    .wire-endpoint.connected {
      opacity: 0.5;
      pointer-events: none;
    }
    .wires-svg {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }
    .wires-svg line {
      stroke-width: 4;
      stroke-linecap: round;
    }

    /* --- DIGICODE --- */
    .digicode-display {
      background: #0a0a1a;
      border: 2px solid #2c3e50;
      border-radius: 8px;
      padding: 16px 24px;
      font-family: 'Courier New', monospace;
      font-size: 36px;
      letter-spacing: 12px;
      color: #2ecc71;
      text-align: center;
      min-width: 200px;
      margin-bottom: 16px;
      text-shadow: 0 0 10px rgba(46,204,113,0.5);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .digicode-display.error {
      color: #e74c3c;
      text-shadow: 0 0 10px rgba(231,76,60,0.5);
    }
    .digicode-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-width: 240px;
    }
    .digicode-btn {
      background: #2c3e50;
      color: #ecf0f1;
      border: 2px solid #34495e;
      border-radius: 8px;
      padding: 14px;
      font-size: 22px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      cursor: pointer;
      transition: background 0.1s;
    }
    .digicode-btn:hover { background: #34495e; }
    .digicode-btn:active { background: #1abc9c; color: #000; }
    .digicode-btn.zero-btn {
      grid-column: 2;
    }
    .digicode-message {
      color: #bdc3c7;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
      min-height: 20px;
    }

    /* --- RAPID CLICK --- */
    .rapidclick-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .rapidclick-gauge-bg {
      width: 80%;
      height: 30px;
      background: #1a1a2e;
      border: 2px solid #2c3e50;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }
    .rapidclick-gauge-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
      border-radius: 15px;
      transition: width 0.1s linear;
    }
    .rapidclick-gauge-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 14px;
      color: white;
      text-shadow: 1px 1px 2px #000;
    }
    .rapidclick-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(180deg, #e74c3c, #c0392b);
      border: 4px solid #96281b;
      color: white;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(231,76,60,0.5);
      transition: transform 0.05s;
      user-select: none;
      -webkit-user-select: none;
    }
    .rapidclick-btn:active {
      transform: scale(0.92);
      box-shadow: 0 2px 8px rgba(231,76,60,0.8);
    }

    /* --- SLIDER --- */
    .slider-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .slider-track {
      width: 85%;
      height: 40px;
      background: #1a1a2e;
      border: 2px solid #2c3e50;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
    }
    .slider-target {
      position: absolute;
      top: 0;
      height: 100%;
      width: 18%;
      background: rgba(46,204,113,0.25);
      border-left: 2px solid #2ecc71;
      border-right: 2px solid #2ecc71;
    }
    .slider-indicator {
      position: absolute;
      top: 2px; bottom: 2px;
      width: 6px;
      background: #e74c3c;
      border-radius: 3px;
      left: 0;
    }
    .slider-score {
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      color: #f39c12;
      letter-spacing: 2px;
    }
    .slider-hit {
      animation: sliderHitFlash 0.3s;
    }
    @keyframes sliderHitFlash {
      0% { background: rgba(46,204,113,0.6); }
      100% { background: rgba(46,204,113,0.25); }
    }
    .slider-miss {
      animation: sliderMissFlash 0.3s;
    }
    @keyframes sliderMissFlash {
      0% { background: rgba(231,76,60,0.6); }
      100% { background: rgba(46,204,113,0.25); }
    }
    .slider-tap-btn {
      background: linear-gradient(180deg, #f39c12, #e67e22);
      color: #000;
      border: 2px solid #d35400;
      border-radius: 12px;
      padding: 14px 40px;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 18px;
      letter-spacing: 2px;
      cursor: pointer;
    }
    .slider-tap-btn:active { transform: scale(0.95); }

    /* --- SIMON --- */
    .simon-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .simon-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .simon-btn {
      width: 90px;
      height: 90px;
      border-radius: 12px;
      border: 3px solid rgba(0,0,0,0.3);
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.15s, transform 0.1s;
    }
    .simon-btn.active {
      opacity: 1;
      transform: scale(1.08);
    }
    .simon-btn.clickable {
      opacity: 0.7;
      cursor: pointer;
    }
    .simon-btn.clickable:hover {
      opacity: 0.85;
    }
    .simon-btn-red    { background: #e74c3c; }
    .simon-btn-blue   { background: #3498db; }
    .simon-btn-green  { background: #2ecc71; }
    .simon-btn-yellow { background: #f1c40f; }
    .simon-message {
      color: #bdc3c7;
      font-family: Arial, sans-serif;
      font-size: 14px;
      text-align: center;
      min-height: 20px;
    }

    /* --- SUCCESS ANIMATION --- */
    .minijeu-success {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(39,174,96,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Impact', 'Arial Black', sans-serif;
      font-size: 28px;
      color: #2ecc71;
      letter-spacing: 4px;
      text-shadow: 0 0 15px rgba(46,204,113,0.7);
      border-radius: 12px;
      animation: successFade 1s forwards;
      z-index: 5;
    }
    @keyframes successFade {
      0% { opacity: 0; transform: scale(0.8); }
      30% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>

  <!-- ============================== -->
  <!-- ECRAN 0 : CREATION DE COMPTE  -->
  <!-- ============================== -->
  <div id="ecran-compte" class="screen bg-mall">
    <h1 class="titre-virus" style="margin-top:0;">VIRUS</h1>

    <div class="compte-carte">
      <div class="compte-header">
        <h3 data-i18n="createAccount">CREER TON COMPTE</h3>
        <p data-i18n="chooseNickname">Choisis un pseudo pour jouer</p>
      </div>
      <div class="compte-body">
        <div class="compte-avatar">&#128566;</div>
        <div class="compte-champ">
          <label data-i18n="pseudo">TON PSEUDO</label>
          <input type="text" id="input-pseudo-compte" placeholder="Entre ton pseudo..." maxlength="20" data-i18n="phPseudo" data-i18n-attr="placeholder">
        </div>
        <div class="compte-champ">
          <label>LANGUE / LANGUAGE</label>
          <div class="lang-selector" style="margin-top:4px;">
            <button class="lang-btn active" id="compte-lang-fr" onclick="setLangueCompte('fr')">Francais</button>
            <button class="lang-btn" id="compte-lang-en" onclick="setLangueCompte('en')">English</button>
          </div>
        </div>
        <button class="btn-creer-compte" onclick="creerCompte()" data-i18n="play">C'EST PARTI !</button>
      </div>
    </div>

    <span class="version">VIRUS v0.1 - ALPHA</span>
  </div>

  <!-- ============================== -->
  <!-- ECRAN CONFIG HORS LIGNE        -->
  <!-- ============================== -->
  <div id="config-horsline" class="screen bg-mall">
    <button class="btn-retour" onclick="showScreen('menu-principal')" data-i18n="back">&#9664; RETOUR</button>

    <h1 class="online-titre" style="color:#7f8c8d;" data-i18n="offline">HORS LIGNE</h1>
    <span class="online-sous-titre" style="color:#95a5a6;" data-i18n="config">CONFIGURATION</span>

    <div class="config-hl-formulaire">
      <div class="config-hl-header"><h3 data-i18n="gameSettings">PARAMETRES DE LA PARTIE</h3></div>
      <div class="config-hl-body">

        <div class="config-hl-champ">
          <label data-i18n="nbPlayers">NOMBRE DE JOUEURS</label>
          <div class="config-hl-slider-row">
            <input type="range" id="hl-nb-joueurs" min="4" max="15" value="4" oninput="majConfigHL()">
            <div class="config-hl-valeur" id="hl-nb-joueurs-val">4</div>
          </div>
        </div>

        <div class="config-hl-champ">
          <label data-i18n="nbVirus">NOMBRE DE VIRUS</label>
          <div class="config-hl-slider-row">
            <input type="range" id="hl-nb-virus" min="1" max="3" value="1" oninput="majConfigHL()">
            <div class="config-hl-valeur" id="hl-nb-virus-val">1</div>
          </div>
        </div>

        <div class="config-hl-champ">
          <label data-i18n="journalist">JOURNALISTE</label>
          <div class="config-hl-toggle-row">
            <div class="config-hl-toggle" id="hl-toggle-journaliste" onclick="toggleJournalisteHL()"></div>
            <span class="config-hl-toggle-label" id="hl-toggle-journaliste-label" data-i18n="zeroJournalist">0 JOURNALISTE</span>
          </div>
        </div>

        <div class="config-hl-champ">
          <label><span data-i18n="fanaticRole">FANATIQUE</span> <span style="color:#8e44ad; font-size:10px;" data-i18n="fanaticNeutral">(NEUTRE)</span></label>
          <div class="config-hl-toggle-row">
            <div class="config-hl-toggle" id="hl-toggle-fanatique" onclick="toggleFanatiqueHL()"></div>
            <span class="config-hl-toggle-label" id="hl-toggle-fanatique-label" data-i18n="zeroFanatic">0 FANATIQUE</span>
          </div>
        </div>

        <div class="config-hl-champ">
          <label><span data-i18n="spyRole">ESPION</span> <span style="color:#9b59b6; font-size:10px;" data-i18n="spyNeutral">(NEUTRE)</span></label>
          <div class="config-hl-toggle-row">
            <div class="config-hl-toggle" id="hl-toggle-espion" onclick="toggleEspionHL()"></div>
            <span class="config-hl-toggle-label" id="hl-toggle-espion-label" data-i18n="zeroSpy">0 ESPION</span>
          </div>
        </div>

        <div class="config-hl-resume" id="hl-resume">
          <div class="config-hl-resume-item"><span data-i18n="totalPlayers">Total :</span> <span id="hl-resume-total">4</span> <span data-i18n="players">joueurs</span></div>
          <div class="config-hl-resume-item"><span data-i18n="innocentsLabel">Innocents :</span> <span id="hl-resume-innocents">3</span></div>
          <div class="config-hl-resume-item"><span data-i18n="virusLabel">Virus :</span> <span id="hl-resume-virus">1</span></div>
          <div class="config-hl-resume-item"><span data-i18n="journalistLabel">Journaliste :</span> <span id="hl-resume-journaliste">0</span></div>
          <div class="config-hl-resume-item"><span data-i18n="fanaticLabel">Fanatique :</span> <span id="hl-resume-fanatique">0</span></div>
          <div class="config-hl-resume-item"><span data-i18n="spyLabel">Espion :</span> <span id="hl-resume-espion">0</span></div>
        </div>

        <button class="btn-lancer-hl" onclick="validerConfigHL()" data-i18n="launch">LANCER LA PARTIE</button>
      </div>
    </div>

    <span class="version">VIRUS v0.1 - ALPHA</span>
  </div>

  <!-- ============================== -->
  <!-- POPUP PARAMETRES               -->
  <!-- ============================== -->
  <div class="popup-overlay" id="popup-params">
    <div class="popup-box">
      <div class="popup-header">
        <h3 data-i18n="settings">PARAMETRES</h3>
        <button class="popup-close" onclick="fermerParams()">&times;</button>
      </div>
      <div class="popup-body">
        <div class="popup-section">
          <label data-i18n="pseudo">PSEUDO</label>
          <div class="pseudo-edit-row">
            <span style="color:#aaa;font-size:14px;" id="input-edit-pseudo-display"></span>
          </div>
        </div>
        <div class="popup-section">
          <label>LANGUE / LANGUAGE</label>
          <div class="lang-selector">
            <button class="lang-btn active" id="lang-fr" onclick="setLanguage('fr')">Francais</button>
            <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">English</button>
          </div>
        </div>
        <div class="popup-section">
          <label data-i18n="account">COMPTE</label>
          <button class="btn-sauver-pseudo" data-i18n="deleteAccount" style="background:linear-gradient(180deg,#e74c3c,#c0392b); border-color:#e74c3c; width:100%; padding:10px;" onclick="supprimerCompte()">SUPPRIMER MON COMPTE</button>
        </div>
        <p class="popup-info" data-i18n="savedAuto" data-i18n-html>Les changements sont sauvegardes automatiquement.<br>VIRUS v0.1 - ALPHA</p>
      </div>
    </div>
  </div>

  <!-- ============================== -->
  <!-- ECRAN 1 : MENU PRINCIPAL      -->
  <!-- ============================== -->
  <audio id="musique-menu" loop preload="auto" src="musique/Destroyed/Destroyed multiverse album.mp3"></audio>

  <div id="menu-principal" class="screen bg-mall">
    <button class="btn-musique" id="btn-musique" onclick="toggleMusique()" title="Musique">&#9835;</button>
    <div class="menu-pseudo-bar" id="pseudo-bar">
      <div class="menu-gold">
        <span class="menu-gold-icon">&#9733;</span>
        <span class="menu-gold-val" id="gold-display">0</span>
      </div>
      <div class="menu-pseudo-dot"></div>
      <span class="menu-pseudo-nom" id="pseudo-display">---</span>
      <button class="menu-pseudo-edit" onclick="ouvrirParams()" title="Parametres">&#9881;</button>
    </div>
    <div class="virus-icons">
      <svg class="virus-icon" viewBox="-35 -35 70 70">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="0" cy="0" r="10" fill="#e74c3c" opacity="0.3"/>
        <line x1="0" y1="-18" x2="0" y2="-26" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="0" cy="-28" r="3" fill="#e74c3c"/>
        <line x1="18" y1="0" x2="26" y2="0" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="28" cy="0" r="3" fill="#e74c3c"/>
        <line x1="-18" y1="0" x2="-26" y2="0" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="-28" cy="0" r="3" fill="#e74c3c"/>
        <line x1="13" y1="-13" x2="18" y2="-18" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="20" cy="-20" r="2.5" fill="#e74c3c"/>
        <line x1="-13" y1="13" x2="-18" y2="18" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="-20" cy="20" r="2.5" fill="#e74c3c"/>
      </svg>

      <h1 class="titre-virus">VIRUS</h1>

      <svg class="virus-icon" viewBox="-35 -35 70 70">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="0" cy="0" r="10" fill="#e74c3c" opacity="0.3"/>
        <line x1="0" y1="-18" x2="0" y2="-26" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="0" cy="-28" r="3" fill="#e74c3c"/>
        <line x1="18" y1="0" x2="26" y2="0" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="28" cy="0" r="3" fill="#e74c3c"/>
        <line x1="-18" y1="0" x2="-26" y2="0" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="-28" cy="0" r="3" fill="#e74c3c"/>
        <line x1="-13" y1="-13" x2="-18" y2="-18" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="-20" cy="-20" r="2.5" fill="#e74c3c"/>
        <line x1="13" y1="13" x2="18" y2="18" stroke="#e74c3c" stroke-width="2"/>
        <circle cx="20" cy="20" r="2.5" fill="#e74c3c"/>
      </svg>
    </div>

    <div class="menu-buttons">
      <button class="btn btn-online" onclick="showScreen('menu-online')">
        <span data-i18n="online">ONLINE</span>
        <span class="btn-sub" data-i18n="joinOrCreate">Rejoindre ou creer une partie</span>
      </button>
      <button class="btn btn-horsline" onclick="showScreen('config-horsline')">
        <span data-i18n="offline">HORS LIGNE</span>
        <span class="btn-sub" data-i18n="playWithBots">Jouer avec des bots</span>
      </button>
      <button class="btn btn-boutique" onclick="showScreen('boutique-skins')">
        <span data-i18n="shop">BOUTIQUE</span>
        <span class="btn-sub" data-i18n="skinsAccs">Skins et accessoires</span>
      </button>
      <button class="btn btn-casier" onclick="ouvrirCabine()">
        <span data-i18n="locker">CASIER</span>
        <span class="btn-sub" data-i18n="changeSkin">Changer de skin</span>
      </button>
      <button class="btn btn-param" onclick="ouvrirParams()" data-i18n="settings">PARAMETRES</button>
    </div>

    <div class="regles-panneau">
      <div class="regles-header"><h3 data-i18n="rules">REGLES DU JEU</h3></div>
      <div class="regles-liste">
        <div class="regle-item">
          <div class="regle-num" style="background:#e74c3c">1</div>
          <div class="regle-texte">
            <h4 data-i18n="rule1Title">Le Virus se propage</h4>
            <p data-i18n="rule1Desc">Un joueur est infecte et doit contaminer les autres dans le centre commercial.</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#3498db">2</div>
          <div class="regle-texte">
            <h4 data-i18n="rule2Title">Accomplir les missions</h4>
            <p data-i18n="rule2Desc">Les sains doivent completer leurs taches dans les boutiques pour gagner.</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#f39c12">3</div>
          <div class="regle-texte">
            <h4 data-i18n="rule3Title">Voter pour eliminer</h4>
            <p data-i18n="rule3Desc">Signalez les suspects ! Votez ensemble pour demasquer le virus.</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#2ecc71">4</div>
          <div class="regle-texte">
            <h4 data-i18n="rule4Title">Survivre ou infecter</h4>
            <p data-i18n="rule4Desc">Sains : terminez les missions ou trouvez le virus. Virus : infectez tout le monde !</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#9b59b6">5</div>
          <div class="regle-texte">
            <h4 data-i18n="rule5Title">Devenir un fantome</h4>
            <p data-i18n="rule5Desc">Si vous etes infecte, apres 5 secondes vous devenez un fantome invisible.</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#3498db">6</div>
          <div class="regle-texte">
            <h4 data-i18n="rule6Title">Le Journaliste enquete</h4>
            <p data-i18n="rule6Desc">Le journaliste peut enqueter sur les joueurs pour decouvrir s'ils sont virus ou non.</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#8e44ad">7</div>
          <div class="regle-texte">
            <h4 data-i18n="rule7Title">Le Fanatique (neutre)</h4>
            <p data-i18n="rule7Desc">Son but : se faire eliminer ! S'il meurt, la partie se termine et il gagne avec l'espion.</p>
          </div>
        </div>
        <div class="regle-item">
          <div class="regle-num" style="background:#9b59b6">8</div>
          <div class="regle-texte">
            <h4 data-i18n="rule8Title">L'Espion (neutre)</h4>
            <p data-i18n="rule8Desc">Il choisit un camp au debut. S'il choisit virus, il les voit mais ne peut pas etre tue par eux. Il gagne avec son camp. Si le fanatique gagne, l'espion gagne aussi !</p>
          </div>
        </div>
      </div>
    </div>

    <span class="version">VIRUS v0.1 - ALPHA</span>
  </div>

  <!-- ============================== -->
  <!-- ECRAN : BOUTIQUE DE SKINS     -->
  <!-- ============================== -->
  <div id="boutique-skins" class="screen bg-mall">
    <button class="btn-retour" onclick="showScreen('menu-principal')" data-i18n="back">&#9664; RETOUR</button>

    <h1 class="boutique-titre" data-i18n="shop">BOUTIQUE</h1>

    <div class="boutique-gold-bar">
      <span class="gold-icon">&#9733;</span>
      <span class="gold-val" id="boutique-gold-display">0</span>
    </div>

    <div class="boutique-tabs">
      <button class="boutique-tab active" id="boutique-tab-skins" onclick="switchBoutiqueTab('skins')" data-i18n="skinsTab">SKINS</button>
      <button class="boutique-tab" id="boutique-tab-musique" onclick="switchBoutiqueTab('musique')" data-i18n="musicTab">MUSIQUE</button>
    </div>

    <div class="boutique-tab-content active" id="boutique-content-skins">
      <div class="boutique-grille" id="boutique-grille">
      </div>
    </div>

    <div class="boutique-tab-content" id="boutique-content-musique">
      <div class="boutique-grille" id="boutique-grille-musique">
      </div>
    </div>
  </div>

  <!-- ============================== -->
  <!-- ECRAN 2 : MENU ONLINE         -->
  <!-- ============================== -->
  <div id="menu-online" class="screen bg-mall">
    <button class="btn-retour" onclick="showScreen('menu-principal')" data-i18n="back">&#9664; RETOUR</button>

    <h1 class="online-titre">VIRUS</h1>
    <span class="online-sous-titre" data-i18n="online">ONLINE</span>

    <div class="panneau-central">
      <button class="btn btn-creer" onclick="showScreen('creer-partie')">
        <div class="btn-icon">+</div>
        <div class="btn-content">
          <span class="btn-label" data-i18n="createGame">CREER UNE PARTIE</span>
          <span class="btn-sub" data-i18n="inviteFriends">Invitez vos amis a rejoindre</span>
        </div>
      </button>

      <div class="separateur-ou">
        <div class="ligne"></div>
        <div class="ou-cercle" data-i18n="or">OU</div>
        <div class="ligne"></div>
      </div>

      <button class="btn btn-trouver" onclick="showScreen('liste-parties')">
        <div class="btn-icon">&#128269;</div>
        <div class="btn-content">
          <span class="btn-label" data-i18n="findGame">TROUVER UNE PARTIE</span>
          <span class="btn-sub" data-i18n="joinExisting">Rejoindre une partie existante</span>
        </div>
      </button>
    </div>

    <div class="info-bas" data-i18n="createDesc">
      Creez votre propre partie et invitez vos amis, ou rejoignez une partie existante.
    </div>

    <span class="version">VIRUS v0.1 - ALPHA</span>
  </div>

  <!-- ============================== -->
  <!-- ECRAN 5 : CREER UNE PARTIE    -->
  <!-- ============================== -->
  <div id="creer-partie" class="screen bg-mall">
    <button class="btn-retour" onclick="showScreen('menu-online')" data-i18n="back">&#9664; RETOUR</button>

    <h1 class="online-titre">VIRUS</h1>
    <span class="online-sous-titre" data-i18n="createGame">CREER UNE PARTIE</span>

    <div class="cp-formulaire">
      <div class="cp-header"><h3 data-i18n="newGame">NOUVELLE PARTIE</h3></div>
      <div class="cp-body">
        <div class="cp-champ">
          <label data-i18n="gameName">NOM DE LA PARTIE</label>
          <input type="text" id="cp-nom" placeholder="Ex: Ma super partie" maxlength="30" data-i18n="phGameName" data-i18n-attr="placeholder">
        </div>
        <div class="cp-champ">
          <label data-i18n="maxPlayers">NOMBRE MAX DE JOUEURS</label>
          <select id="cp-max-joueurs" onchange="mettreAJourOptionsVirus()">
            <option value="4">4 joueurs</option>
            <option value="5">5 joueurs</option>
            <option value="6">6 joueurs</option>
            <option value="7">7 joueurs</option>
            <option value="8">8 joueurs</option>
            <option value="9">9 joueurs</option>
            <option value="10" selected>10 joueurs</option>
            <option value="11">11 joueurs</option>
            <option value="12">12 joueurs</option>
            <option value="13">13 joueurs</option>
            <option value="14">14 joueurs</option>
            <option value="15">15 joueurs</option>
          </select>
        </div>
        <div class="cp-champ">
          <label data-i18n="nbVillains">NOMBRE DE MECHANTS (VIRUS)</label>
          <select id="cp-mechants">
            <option value="1" selected>1 virus</option>
            <option value="2">2 virus</option>
            <option value="3">3 virus</option>
          </select>
        </div>
        <div class="cp-roles-grid">
          <div class="cp-role-item">
            <label data-i18n="journalist">JOURNALISTE</label>
            <div class="cp-toggle-row">
              <div class="cp-toggle" id="cp-toggle-journaliste" onclick="toggleCpJournaliste()"></div>
              <span class="cp-toggle-label" id="cp-toggle-journaliste-label" data-i18n="zeroJournalist">0 JOURNALISTE</span>
            </div>
          </div>
          <div class="cp-role-item">
            <label>FANATIQUE <span style="color:#8e44ad;font-size:10px" data-i18n="fanaticNeutral">(NEUTRE)</span></label>
            <div class="cp-toggle-row">
              <div class="cp-toggle cp-fanatic" id="cp-toggle-fanatique" onclick="toggleCpFanatique()"></div>
              <span class="cp-toggle-label cp-fanatic-label" id="cp-toggle-fanatique-label" data-i18n="zeroFanatic">0 FANATIQUE</span>
            </div>
          </div>
          <div class="cp-role-item">
            <label>ESPION <span style="color:#9b59b6;font-size:10px" data-i18n="spyNeutral">(NEUTRE)</span></label>
            <div class="cp-toggle-row">
              <div class="cp-toggle cp-spy" id="cp-toggle-espion" onclick="toggleCpEspion()"></div>
              <span class="cp-toggle-label cp-spy-label" id="cp-toggle-espion-label" data-i18n="zeroSpy">0 ESPION</span>
            </div>
          </div>
          <div class="cp-role-item">
            <label data-i18n="langLabel">LANGUE</label>
            <div class="lang-selector" style="margin-top:4px">
              <button class="lang-btn active" id="cp-lang-fr" onclick="setCpLang('fr')" style="padding:8px 10px;font-size:12px">FR</button>
              <button class="lang-btn" id="cp-lang-en" onclick="setCpLang('en')" style="padding:8px 10px;font-size:12px">EN</button>
            </div>
          </div>
        </div>
        <button class="btn-valider-creer" onclick="creerPartie()" data-i18n="create">CREER LA PARTIE</button>
      </div>
    </div>

    <span class="version">VIRUS v0.1 - ALPHA</span>
  </div>

  <!-- ============================== -->
  <!-- ECRAN 4 : LISTE DES PARTIES   -->
  <!-- ============================== -->
  <div id="liste-parties" class="screen bg-mall">
    <button class="btn-retour" onclick="showScreen('menu-online')" data-i18n="back">&#9664; RETOUR</button>

    <h1 class="online-titre">VIRUS</h1>
    <span class="online-sous-titre" data-i18n="findGame">TROUVER UNE PARTIE</span>

    <div class="lp-conteneur">
      <div class="lp-header">
        <h3 data-i18n="waitingGames">PARTIES EN ATTENTE</h3>
        <span class="lp-count" id="lp-total" data-i18n="noGame">0 partie disponible</span>
      </div>

      <table class="lp-tableau">
        <thead>
          <tr>
            <th data-i18n="game">PARTIE</th>
            <th data-i18n="players">JOUEURS</th>
            <th data-i18n="villains">MECHANTS</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="lp-tbody">
        </tbody>
      </table>

      <div class="lp-vide" id="lp-vide">
        <div class="lp-vide-icone">&#128269;</div>
        <p>Aucune partie en attente pour le moment.<br>Creez-en une depuis le menu online !</p>
      </div>
    </div>

    <button class="btn-actualiser" onclick="rafraichirListeParties()">
      &#8635; ACTUALISER
    </button>

    <span class="version">VIRUS v0.1 - ALPHA</span>
  </div>

  <!-- ============================== -->
  <!-- ECRAN 3 : SALLE D'ATTENTE     -->
  <!-- ============================== -->
  <div id="salle-attente" class="screen">
    <div class="sa-mur-haut"></div>

    <div class="sa-content" style="background: repeating-conic-gradient(#f0e6dc 0% 25%, #e8ddd3 0% 50%) 0 0 / 60px 60px;">

      <!-- Gauche : Cabines -->
      <div class="sa-gauche">
        <div class="panneau-cabines">
          <h3>CABINES</h3>
          <span>CHANGEZ DE SKIN</span>
        </div>

        <div class="cabines-grid">
          <div class="cabine" onclick="ouvrirCabine()">
            <div class="cabine-interieur">
              <div class="cabine-miroir"></div>
              <div class="cabine-rideau rideau-rouge"></div>
            </div>
            <div class="cabine-footer">
              <div class="cabine-statut statut-libre"></div>
              <div class="cabine-num" style="background:#e74c3c">1</div>
            </div>
          </div>
          <div class="cabine" onclick="ouvrirCabine()">
            <div class="cabine-interieur">
              <div class="cabine-miroir"></div>
              <div class="cabine-rideau rideau-bleu"></div>
            </div>
            <div class="cabine-footer">
              <div class="cabine-statut statut-libre"></div>
              <div class="cabine-num" style="background:#2e86c1">2</div>
            </div>
          </div>
          <div class="cabine" onclick="ouvrirCabine()">
            <div class="cabine-interieur">
              <div class="cabine-miroir"></div>
              <div class="cabine-rideau rideau-vert"></div>
            </div>
            <div class="cabine-footer">
              <div class="cabine-statut statut-occupe"></div>
              <div class="cabine-num" style="background:#27ae60">3</div>
            </div>
          </div>
          <div class="cabine" onclick="ouvrirCabine()">
            <div class="cabine-interieur">
              <div class="cabine-miroir"></div>
              <div class="cabine-rideau rideau-violet"></div>
            </div>
            <div class="cabine-footer">
              <div class="cabine-statut statut-libre"></div>
              <div class="cabine-num" style="background:#8e44ad">4</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Droite : UI -->
      <div class="sa-droite">
        <div class="sa-enseigne">
          <h2>VIRUS</h2>
          <span>SALLE D'ATTENTE</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1; min-width:200px; display:flex; flex-direction:column; gap:10px;">
            <div class="sa-panneau-joueurs">
              <div class="sa-panneau-joueurs-header">
                <h4>JOUEURS</h4>
                <span class="compteur">0/10</span>
              </div>
              <div class="sa-joueurs-liste">
                <div class="sa-joueur-item attente">&#9675; <span data-i18n="waiting">En attente...</span></div>
              </div>
            </div>

            <button class="btn btn-demarrer" id="btn-demarrer" onclick="lancerJeu()" style="display:none;">
              DEMARRER
              <span class="btn-sub">(Host uniquement)</span>
            </button>
            <div id="msg-attente-host" style="display:none; background:rgba(44,62,80,0.8); border-radius:8px; padding:10px 15px; text-align:center;">
              <span style="color:#f39c12; font-size:12px; letter-spacing:1px;" data-i18n="waitingForHost">En attente du host pour demarrer...</span>
            </div>

            <button class="btn-retour" style="position:relative; top:0; left:0;" onclick="quitterPartie()">&#9664; QUITTER</button>
          </div>

          <div style="flex:1; min-width:200px; display:flex;">
            <div class="sa-chat">
              <div class="sa-chat-header"><h4>CHAT</h4></div>
              <div class="sa-chat-messages" id="chat-messages">
              </div>
              <div class="sa-chat-input">
                <input type="text" id="chat-input" placeholder="Ecrire ici..." onkeydown="if(event.key==='Enter')sendChat()">
                <button onclick="sendChat()">&#9654;</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications joueurs (bas gauche) -->
      <div class="sa-notifs" id="sa-notifs"></div>

      <!-- Decorations -->
      <div class="sa-entree">
        <span>ENTREE</span>
        <div class="fleche">&#9660;</div>
        <div class="fleche">&#9660;</div>
      </div>

      <div class="plante plante-1">
        <div class="plante-feuilles"></div>
        <div class="plante-pot"></div>
      </div>
      <div class="plante plante-2">
        <div class="plante-feuilles"></div>
        <div class="plante-pot"></div>
      </div>

      <!-- Joueur avatar dans la salle d'attente -->
      <div class="sa-joueur-avatar" id="sa-mon-avatar" style="left:50%; bottom:100px;">
        <span class="sa-avatar-pseudo" id="sa-avatar-pseudo"></span>
        <div class="sa-avatar-skin"><img id="sa-avatar-skin-img" src="skin/skin gratuit/skin de base (garon).svg" alt="skin"></div>
      </div>

      <div class="distributeur">
        <div class="distributeur-vitre">
          <div class="canette" style="background:#e74c3c"></div>
          <div class="canette" style="background:#3498db"></div>
          <div class="canette" style="background:#f39c12"></div>
          <div class="canette" style="background:#2ecc71"></div>
          <div class="canette" style="background:#9b59b6"></div>
          <div class="canette" style="background:#e74c3c"></div>
          <div class="canette" style="background:#1abc9c"></div>
          <div class="canette" style="background:#f39c12"></div>
        </div>
        <div class="distributeur-fente"></div>
        <span>BOISSONS</span>
      </div>

    </div>

    <div class="sa-mur-bas"></div>
  </div>

  <!-- POPUP CASIER (LOCKER) -->
  <div class="cabine-popup-overlay" id="cabine-overlay" onclick="fermerCabine()"></div>
  <div class="cabine-popup" id="cabine-popup">
    <h3 data-i18n="locker">CASIER</h3>

    <div class="casier-tabs">
      <button class="casier-tab active" id="casier-tab-skin" onclick="switchCasierTab('skin')" data-i18n="skin">SKIN</button>
      <button class="casier-tab" id="casier-tab-musique" onclick="switchCasierTab('musique')" data-i18n="musicTab">MUSIQUE</button>
    </div>

    <div class="casier-tab-content active" id="casier-content-skin">
      <p data-i18n="chooseSkin">Choisis ton skin !</p>
      <div class="skin-selector" id="cabine-skin-selector"></div>
      <button class="cabine-popup-close" style="background:linear-gradient(180deg,#27ae60,#1e8449); margin-right:8px;" onclick="confirmerEtFermerCabine()" data-i18n="confirm">CONFIRMER</button>
      <button class="cabine-popup-close" onclick="fermerCabine()" data-i18n="cancel">ANNULER</button>
    </div>

    <div class="casier-tab-content" id="casier-content-musique">
      <p data-i18n="chooseMusic">Choisis ta musique !</p>
      <div class="musique-list" id="casier-musique-list"></div>
      <button class="cabine-popup-close" onclick="fermerCabine()" data-i18n="close">FERMER</button>
    </div>
  </div>

  <!-- ============================== -->
  <!-- ECRAN 6 : CENTRE COMMERCIAL    -->
  <!-- ============================== -->
  <div id="jeu" class="screen">
    <div class="jeu-viewport" id="jeu-viewport">
      <div class="mall-map" id="mall-map">

        <!-- Sol carrelage -->
        <div class="mall-sol"></div>

        <!-- Murs exterieurs -->
        <div class="mall-mur-ext mall-mur-ext-h" style="top:0; left:0;"></div>
        <div class="mall-mur-ext mall-mur-ext-h" style="bottom:0; left:0;"></div>
        <div class="mall-mur-ext mall-mur-ext-v" style="top:0; left:0;"></div>
        <div class="mall-mur-ext mall-mur-ext-v" style="top:0; right:0;"></div>

        <!-- Entrees du mall -->
        <div class="mall-entree" style="bottom:0; left:3700px; width:200px; height:20px;"><span>ENTREE PRINCIPALE SUD</span></div>
        <div class="mall-entree" style="top:0; left:3700px; width:200px; height:20px;"><span>ENTREE NORD</span></div>
        <div class="mall-entree" style="left:0; top:2800px; width:20px; height:120px;"><span style="writing-mode:vertical-lr;">SORTIE OUEST</span></div>
        <div class="mall-entree" style="right:0; top:2800px; width:20px; height:120px;"><span style="writing-mode:vertical-lr;">SORTIE EST</span></div>
        <div class="mall-entree" style="left:0; top:800px; width:20px; height:100px;"><span style="writing-mode:vertical-lr;">PARKING A</span></div>
        <div class="mall-entree" style="right:0; top:800px; width:20px; height:100px;"><span style="writing-mode:vertical-lr;">PARKING B</span></div>

        <!-- ================================================ -->
        <!-- AILE NORD-OUEST (haut gauche)                     -->
        <!-- ================================================ -->
        <div class="boutique b-mode" style="left:60px; top:60px; width:500px; height:400px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128087;</div><div class="boutique-nom" style="font-size:16px;">BOUTIQUE MODE</div></div>
          <div class="obj-portant" style="left:30px; top:40px; width:80px;"></div>
          <div class="obj-portant" style="left:30px; top:100px; width:80px;"></div>
          <div class="obj-portant" style="left:30px; top:160px; width:80px;"></div>
          <div class="obj-miroir" style="left:15px; top:70px; height:40px;"></div>
          <div class="obj-miroir" style="left:15px; top:130px; height:40px;"></div>
          <div class="obj-cabine" style="right:20px; top:30px;"></div>
          <div class="obj-cabine" style="right:20px; top:100px;"></div>
          <div class="obj-comptoir" style="left:150px; bottom:30px; width:160px;"></div>
          <div class="obj-caisse" style="left:260px; bottom:25px;"></div>
          <div class="obj-plante-int" style="right:30px; bottom:25px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:220px;"></div>
        </div>
        <div class="boutique b-pharma" style="left:60px; top:550px; width:500px; height:350px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128138;</div><div class="boutique-nom" style="font-size:16px;">PHARMACIE</div></div>
          <div class="obj-etagere" style="left:15px; top:20px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:55px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:90px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:125px; width:100px;"></div>
          <div class="obj-vitrine" style="right:30px; top:30px; width:80px; height:35px;"></div>
          <div class="obj-comptoir" style="left:180px; bottom:25px; width:180px;"></div>
          <div class="obj-caisse" style="left:310px; bottom:20px;"></div>
          <div class="obj-plante-int" style="right:20px; bottom:20px;"></div>
          <div class="boutique-porte" style="right:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique b-livre" style="left:60px; top:1000px; width:500px; height:350px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128218;</div><div class="boutique-nom" style="font-size:16px;">LIBRAIRIE</div></div>
          <div class="obj-etagere" style="left:10px; top:15px; width:120px;"></div>
          <div class="obj-etagere" style="left:10px; top:45px; width:120px;"></div>
          <div class="obj-etagere" style="left:10px; top:75px; width:120px;"></div>
          <div class="obj-etagere" style="right:15px; top:15px; width:100px;"></div>
          <div class="obj-etagere" style="right:15px; top:45px; width:100px;"></div>
          <div class="obj-table" style="left:200px; top:80px;"></div>
          <div class="obj-chaise" style="left:195px; top:65px;"></div>
          <div class="obj-chaise" style="left:230px; top:65px;"></div>
          <div class="obj-table" style="left:200px; top:180px;"></div>
          <div class="obj-chaise" style="left:195px; top:165px;"></div>
          <div class="obj-chaise" style="left:230px; top:165px;"></div>
          <div class="obj-comptoir" style="left:160px; bottom:20px; width:140px;"></div>
          <div class="obj-caisse" style="left:260px; bottom:15px;"></div>
          <div class="boutique-porte" style="right:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique b-sport" style="left:60px; top:1450px; width:500px; height:400px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127947;</div><div class="boutique-nom" style="font-size:16px;">SALLE DE SPORT</div></div>
          <div class="obj-machine" style="left:30px; top:40px;"></div>
          <div class="obj-machine" style="left:80px; top:40px;"></div>
          <div class="obj-machine" style="left:130px; top:40px;"></div>
          <div class="obj-miroir" style="right:12px; top:30px; height:60px; width:10px;"></div>
          <div class="obj-miroir" style="right:12px; top:110px; height:60px; width:10px;"></div>
          <div class="obj-comptoir" style="left:180px; bottom:25px; width:140px;"></div>
          <div class="obj-caisse" style="left:280px; bottom:20px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:20px;"></div>
          <div class="obj-plante-int" style="right:25px; bottom:20px;"></div>
          <div class="boutique-porte" style="right:-4px; top:180px; width:8px; height:50px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- AILE NORD-EST (haut droite)                       -->
        <!-- ================================================ -->
        <div class="boutique b-bijoux" style="right:60px; top:60px; width:500px; height:400px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128142;</div><div class="boutique-nom" style="font-size:16px;">BIJOUTERIE</div></div>
          <div class="obj-vitrine" style="left:30px; top:30px; width:90px; height:35px;"></div>
          <div class="obj-vitrine" style="left:30px; top:90px; width:90px; height:35px;"></div>
          <div class="obj-vitrine" style="right:30px; top:30px; width:90px; height:35px;"></div>
          <div class="obj-miroir" style="right:15px; top:90px; height:50px;"></div>
          <div class="obj-comptoir" style="left:160px; bottom:30px; width:180px;"></div>
          <div class="obj-caisse" style="left:290px; bottom:25px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:20px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:220px;"></div>
        </div>
        <div class="boutique b-techno" style="right:60px; top:550px; width:500px; height:350px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128241;</div><div class="boutique-nom" style="font-size:16px;">TECH & ELECTRONIQUE</div></div>
          <div class="obj-table-rect" style="left:30px; top:30px;"></div>
          <div class="obj-table-rect" style="left:120px; top:30px;"></div>
          <div class="obj-table-rect" style="left:30px; top:120px;"></div>
          <div class="obj-ecran" style="right:20px; top:20px; width:60px; height:35px;"></div>
          <div class="obj-ecran" style="right:20px; top:75px; width:60px; height:35px;"></div>
          <div class="obj-etagere" style="right:15px; top:130px; width:90px;"></div>
          <div class="obj-etagere" style="right:15px; top:160px; width:90px;"></div>
          <div class="obj-comptoir" style="left:160px; bottom:20px; width:160px;"></div>
          <div class="obj-caisse" style="left:270px; bottom:15px;"></div>
          <div class="boutique-porte" style="left:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique b-cinema" style="right:60px; top:1000px; width:500px; height:450px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127916;</div><div class="boutique-nom" style="font-size:16px;">CINEMA MULTIPLEX</div></div>
          <div class="obj-ecran" style="left:50px; top:15px; width:400px; height:50px;"></div>
          <div class="obj-comptoir" style="left:80px; top:100px; width:340px; height:14px; background:#4e342e;"></div>
          <div class="obj-comptoir" style="left:80px; top:140px; width:340px; height:14px; background:#4e342e;"></div>
          <div class="obj-comptoir" style="left:80px; top:180px; width:340px; height:14px; background:#4e342e;"></div>
          <div class="obj-comptoir" style="left:80px; top:220px; width:340px; height:14px; background:#4e342e;"></div>
          <div class="obj-comptoir" style="right:20px; bottom:25px; width:120px; background:#ff9800; border-color:#f57c00;"></div>
          <div class="obj-caisse" style="right:25px; bottom:20px;"></div>
          <div class="boutique-porte" style="left:-4px; top:200px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique b-resto" style="right:60px; top:1550px; width:500px; height:350px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127860;</div><div class="boutique-nom" style="font-size:16px;">RESTAURANT</div></div>
          <div class="obj-table" style="left:40px; top:35px;"></div>
          <div class="obj-chaise" style="left:35px; top:20px;"></div>
          <div class="obj-chaise" style="left:70px; top:20px;"></div>
          <div class="obj-table" style="left:140px; top:35px;"></div>
          <div class="obj-chaise" style="left:135px; top:20px;"></div>
          <div class="obj-chaise" style="left:170px; top:20px;"></div>
          <div class="obj-table" style="left:40px; top:140px;"></div>
          <div class="obj-chaise" style="left:35px; top:125px;"></div>
          <div class="obj-chaise" style="left:70px; top:125px;"></div>
          <div class="obj-table" style="left:140px; top:140px;"></div>
          <div class="obj-chaise" style="left:135px; top:125px;"></div>
          <div class="obj-chaise" style="left:170px; top:125px;"></div>
          <div class="obj-table" style="right:80px; top:80px;"></div>
          <div class="obj-chaise" style="right:75px; top:65px;"></div>
          <div class="obj-chaise" style="right:110px; top:65px;"></div>
          <div class="obj-comptoir" style="right:15px; bottom:20px; width:200px; background:#ff9800; border-color:#f57c00;"></div>
          <div class="obj-caisse" style="right:170px; bottom:15px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:15px;"></div>
          <div class="boutique-porte" style="left:-4px; top:150px; width:8px; height:50px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- AILE SUD-OUEST (bas gauche)                       -->
        <!-- ================================================ -->
        <div class="boutique b-super" style="left:60px; top:3200px; width:700px; height:500px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128722;</div><div class="boutique-nom" style="font-size:16px;">SUPERMARCHE GEANT</div></div>
          <div class="obj-rayon" style="left:30px; top:40px;"></div>
          <div class="obj-rayon" style="left:30px; top:90px;"></div>
          <div class="obj-rayon" style="left:30px; top:140px;"></div>
          <div class="obj-rayon" style="left:30px; top:190px;"></div>
          <div class="obj-rayon" style="left:250px; top:40px;"></div>
          <div class="obj-rayon" style="left:250px; top:90px;"></div>
          <div class="obj-vitrine" style="left:30px; top:260px; width:140px; height:40px; background:rgba(33,150,243,0.15); border-color:#64b5f6;"></div>
          <div class="obj-caisse" style="right:40px; bottom:30px;"></div>
          <div class="obj-caisse" style="right:90px; bottom:30px;"></div>
          <div class="obj-comptoir" style="right:30px; bottom:25px; width:100px;"></div>
          <div class="obj-comptoir" style="right:30px; bottom:70px; width:100px;"></div>
          <div class="boutique-porte" style="right:-4px; top:220px; width:8px; height:50px;"></div>
          <div class="boutique-porte" style="top:-4px; left:300px;"></div>
        </div>
        <div class="boutique" style="left:60px; top:3800px; width:500px; height:350px; background:linear-gradient(135deg,#5c6bc0,#3949ab);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127918;</div><div class="boutique-nom" style="font-size:16px;">MAGASIN DE JEUX VIDEO</div></div>
          <div class="obj-etagere" style="left:15px; top:20px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:50px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:80px; width:100px;"></div>
          <div class="obj-ecran" style="right:20px; top:25px; width:55px; height:35px;"></div>
          <div class="obj-ecran" style="right:20px; top:80px; width:55px; height:35px;"></div>
          <div class="obj-comptoir" style="left:170px; bottom:20px; width:150px;"></div>
          <div class="obj-caisse" style="left:270px; bottom:15px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:15px;"></div>
          <div class="boutique-porte" style="right:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique" style="left:60px; top:4250px; width:500px; height:350px; background:linear-gradient(135deg,#00897b,#00695c);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127808;</div><div class="boutique-nom" style="font-size:16px;">JARDINERIE</div></div>
          <div class="obj-table-rect" style="left:25px; top:25px; background:#4caf50; border-color:#388e3c;"></div>
          <div class="obj-table-rect" style="left:25px; top:85px; background:#4caf50; border-color:#388e3c;"></div>
          <div class="obj-table-rect" style="left:25px; top:145px; background:#4caf50; border-color:#388e3c;"></div>
          <div class="obj-table-rect" style="left:120px; top:25px; background:#4caf50; border-color:#388e3c;"></div>
          <div class="obj-etagere" style="right:20px; top:25px; width:90px;"></div>
          <div class="obj-etagere" style="right:20px; top:55px; width:90px;"></div>
          <div class="obj-comptoir" style="left:170px; bottom:20px; width:140px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:15px;"></div>
          <div class="obj-plante-int" style="right:20px; bottom:15px;"></div>
          <div class="obj-plante-int" style="left:100px; bottom:15px;"></div>
          <div class="boutique-porte" style="right:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique" style="left:60px; top:4700px; width:500px; height:400px; background:linear-gradient(135deg,#6d4c41,#4e342e);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128186;</div><div class="boutique-nom" style="font-size:16px;">MEUBLES & DECO</div></div>
          <div class="obj-canape" style="left:25px; top:35px;"></div>
          <div class="obj-canape" style="left:25px; top:120px; background:#e91e63; border-color:#c2185b;"></div>
          <div class="obj-table" style="left:120px; top:40px;"></div>
          <div class="obj-table-rect" style="right:30px; top:35px; width:80px;"></div>
          <div class="obj-comptoir" style="left:170px; bottom:25px; width:160px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:20px;"></div>
          <div class="obj-plante-int" style="right:20px; bottom:20px;"></div>
          <div class="boutique-porte" style="right:-4px; top:180px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique b-wc" style="left:60px; top:5200px; width:400px; height:280px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:50px;">&#128701;</div><div class="boutique-nom" style="font-size:16px;">TOILETTES SUD</div></div>
          <div class="obj-cabine" style="left:20px; top:20px;"></div>
          <div class="obj-cabine" style="left:75px; top:20px;"></div>
          <div class="obj-cabine" style="left:130px; top:20px;"></div>
          <div class="obj-lavabo" style="right:30px; top:25px;"></div>
          <div class="obj-lavabo" style="right:70px; top:25px;"></div>
          <div class="obj-miroir" style="right:15px; top:20px; height:35px;"></div>
          <div class="boutique-porte" style="right:-4px; top:120px; width:8px; height:50px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- AILE SUD-EST (bas droite)                         -->
        <!-- ================================================ -->
        <div class="boutique b-food" style="right:60px; top:3200px; width:700px; height:500px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127828;</div><div class="boutique-nom" style="font-size:16px;">FOOD COURT</div></div>
          <div class="obj-comptoir" style="left:20px; top:25px; width:140px; background:#ff9800; border-color:#f57c00;"></div>
          <div class="obj-comptoir" style="left:200px; top:25px; width:140px; background:#e53935; border-color:#c62828;"></div>
          <div class="obj-comptoir" style="left:380px; top:25px; width:140px; background:#43a047; border-color:#2e7d32;"></div>
          <div class="obj-table" style="left:40px; top:110px;"></div>
          <div class="obj-chaise" style="left:35px; top:95px;"></div>
          <div class="obj-chaise" style="left:70px; top:95px;"></div>
          <div class="obj-table" style="left:140px; top:110px;"></div>
          <div class="obj-chaise" style="left:135px; top:95px;"></div>
          <div class="obj-chaise" style="left:170px; top:95px;"></div>
          <div class="obj-table" style="left:240px; top:110px;"></div>
          <div class="obj-chaise" style="left:235px; top:95px;"></div>
          <div class="obj-chaise" style="left:270px; top:95px;"></div>
          <div class="obj-table" style="left:40px; top:220px;"></div>
          <div class="obj-chaise" style="left:35px; top:205px;"></div>
          <div class="obj-chaise" style="left:70px; top:205px;"></div>
          <div class="obj-table" style="left:140px; top:220px;"></div>
          <div class="obj-chaise" style="left:135px; top:205px;"></div>
          <div class="obj-chaise" style="left:170px; top:205px;"></div>
          <div class="obj-table" style="left:240px; top:220px;"></div>
          <div class="obj-chaise" style="left:235px; top:205px;"></div>
          <div class="obj-chaise" style="left:270px; top:205px;"></div>
          <div class="obj-plante-int" style="right:20px; bottom:20px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:20px;"></div>
          <div class="boutique-porte" style="left:-4px; top:220px; width:8px; height:50px;"></div>
          <div class="boutique-porte" style="top:-4px; left:300px;"></div>
        </div>
        <div class="boutique" style="right:60px; top:3800px; width:500px; height:350px; background:linear-gradient(135deg,#d84315,#bf360c);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127936;</div><div class="boutique-nom" style="font-size:16px;">ARTICLES DE SPORT</div></div>
          <div class="obj-etagere" style="left:15px; top:20px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:50px; width:100px;"></div>
          <div class="obj-etagere" style="left:15px; top:80px; width:100px;"></div>
          <div class="obj-portant" style="right:25px; top:30px; width:80px;"></div>
          <div class="obj-portant" style="right:25px; top:80px; width:80px;"></div>
          <div class="obj-comptoir" style="left:170px; bottom:20px; width:150px;"></div>
          <div class="obj-caisse" style="left:270px; bottom:15px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:15px;"></div>
          <div class="boutique-porte" style="left:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique" style="right:60px; top:4250px; width:500px; height:350px; background:linear-gradient(135deg,#ad1457,#880e4f);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128132;</div><div class="boutique-nom" style="font-size:16px;">PARFUMERIE</div></div>
          <div class="obj-vitrine" style="left:25px; top:25px; width:80px; height:35px;"></div>
          <div class="obj-vitrine" style="left:25px; top:85px; width:80px; height:35px;"></div>
          <div class="obj-vitrine" style="right:25px; top:25px; width:80px; height:35px;"></div>
          <div class="obj-miroir" style="right:15px; top:80px; height:50px;"></div>
          <div class="obj-miroir" style="left:15px; top:140px; height:50px;"></div>
          <div class="obj-comptoir" style="left:170px; bottom:20px; width:150px;"></div>
          <div class="obj-caisse" style="left:270px; bottom:15px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:15px;"></div>
          <div class="boutique-porte" style="left:-4px; top:150px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique" style="right:60px; top:4700px; width:500px; height:400px; background:linear-gradient(135deg,#0277bd,#01579b);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#9992;</div><div class="boutique-nom" style="font-size:16px;">AGENCE DE VOYAGE</div></div>
          <div class="obj-table-rect" style="left:25px; top:30px;"></div>
          <div class="obj-chaise" style="left:45px; top:72px;"></div>
          <div class="obj-table-rect" style="left:25px; top:110px;"></div>
          <div class="obj-chaise" style="left:45px; top:152px;"></div>
          <div class="obj-table-rect" style="left:25px; top:190px;"></div>
          <div class="obj-chaise" style="left:45px; top:232px;"></div>
          <div class="obj-ecran" style="right:20px; top:30px; width:60px; height:40px;"></div>
          <div class="obj-comptoir" style="right:15px; bottom:25px; width:140px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:20px;"></div>
          <div class="obj-plante-int" style="right:20px; bottom:65px;"></div>
          <div class="boutique-porte" style="left:-4px; top:180px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique b-wc" style="right:60px; top:5200px; width:400px; height:280px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:50px;">&#128701;</div><div class="boutique-nom" style="font-size:16px;">TOILETTES SUD-EST</div></div>
          <div class="obj-cabine" style="right:20px; top:20px;"></div>
          <div class="obj-cabine" style="right:75px; top:20px;"></div>
          <div class="obj-cabine" style="right:130px; top:20px;"></div>
          <div class="obj-lavabo" style="left:30px; top:25px;"></div>
          <div class="obj-lavabo" style="left:70px; top:25px;"></div>
          <div class="obj-miroir" style="left:15px; top:20px; height:35px;"></div>
          <div class="boutique-porte" style="left:-4px; top:120px; width:8px; height:50px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- ZONE CENTRALE - HAUT                              -->
        <!-- ================================================ -->
        <div class="boutique b-secu" style="left:2800px; top:60px; width:450px; height:300px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128225;</div><div class="boutique-nom" style="font-size:16px;">POSTE DE SECURITE</div></div>
          <div class="obj-table-rect" style="left:30px; top:40px;"></div>
          <div class="obj-chaise" style="left:55px; top:80px;"></div>
          <div class="obj-table-rect" style="left:30px; top:140px;"></div>
          <div class="obj-chaise" style="left:55px; top:180px;"></div>
          <div class="obj-ecran" style="right:30px; top:25px;"></div>
          <div class="obj-ecran" style="right:30px; top:80px;"></div>
          <div class="obj-ecran" style="right:30px; top:135px;"></div>
          <div class="obj-comptoir" style="left:160px; bottom:30px; width:140px;"></div>
          <div class="obj-caisse" style="left:260px; bottom:25px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:200px;"></div>
        </div>
        <div class="boutique b-wc" style="left:3350px; top:60px; width:350px; height:250px;">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:50px;">&#128701;</div><div class="boutique-nom" style="font-size:16px;">TOILETTES NORD</div></div>
          <div class="obj-cabine" style="right:25px; top:20px;"></div>
          <div class="obj-cabine" style="right:25px; top:80px;"></div>
          <div class="obj-cabine" style="right:25px; top:140px;"></div>
          <div class="obj-lavabo" style="left:25px; top:40px;"></div>
          <div class="obj-lavabo" style="left:25px; top:90px;"></div>
          <div class="obj-miroir" style="left:15px; top:35px; height:35px;"></div>
          <div class="obj-caisse" style="left:160px; bottom:20px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:150px;"></div>
        </div>
        <div class="boutique" style="left:3800px; top:60px; width:450px; height:300px; background:linear-gradient(135deg,#78909c,#546e7a);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127863;</div><div class="boutique-nom" style="font-size:16px;">CAFE DU CENTRE</div></div>
          <div class="obj-comptoir" style="left:20px; top:30px; width:140px; height:22px; background:#4e342e;"></div>
          <div class="obj-caisse" style="left:25px; top:60px;"></div>
          <div class="obj-table" style="left:200px; top:30px;"></div>
          <div class="obj-chaise" style="left:195px; top:18px;"></div>
          <div class="obj-chaise" style="left:225px; top:18px;"></div>
          <div class="obj-chaise" style="left:195px; top:72px;"></div>
          <div class="obj-chaise" style="left:225px; top:72px;"></div>
          <div class="obj-table" style="right:60px; top:30px;"></div>
          <div class="obj-chaise" style="right:55px; top:18px;"></div>
          <div class="obj-chaise" style="right:85px; top:18px;"></div>
          <div class="obj-chaise" style="right:55px; top:72px;"></div>
          <div class="obj-chaise" style="right:85px; top:72px;"></div>
          <div class="obj-table" style="left:200px; top:160px;"></div>
          <div class="obj-chaise" style="left:195px; top:148px;"></div>
          <div class="obj-chaise" style="left:225px; top:148px;"></div>
          <div class="obj-chaise" style="left:195px; top:202px;"></div>
          <div class="obj-chaise" style="left:225px; top:202px;"></div>
          <div class="obj-table" style="right:60px; top:160px;"></div>
          <div class="obj-chaise" style="right:55px; top:148px;"></div>
          <div class="obj-chaise" style="right:85px; top:148px;"></div>
          <div class="obj-chaise" style="right:55px; top:202px;"></div>
          <div class="obj-chaise" style="right:85px; top:202px;"></div>
          <div class="obj-plante-int" style="left:170px; top:240px;"></div>
          <div class="obj-plante-int" style="right:30px; top:240px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:200px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- ILOTS CENTRAUX                                    -->
        <!-- ================================================ -->

        <!-- Ilot 1 - Kiosque -->
        <div class="boutique" style="left:2500px; top:1200px; width:600px; height:350px; background:linear-gradient(135deg,#78909c,#546e7a);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128240;</div><div class="boutique-nom" style="font-size:16px;">KIOSQUE A JOURNAUX</div></div>
          <div class="obj-etagere" style="left:20px; top:20px; width:120px;"></div>
          <div class="obj-etagere" style="left:20px; top:50px; width:120px;"></div>
          <div class="obj-etagere" style="right:20px; top:20px; width:120px;"></div>
          <div class="obj-etagere" style="right:20px; top:50px; width:120px;"></div>
          <div class="obj-etagere" style="left:20px; top:200px; width:100px;"></div>
          <div class="obj-etagere" style="right:20px; top:200px; width:100px;"></div>
          <div class="obj-comptoir" style="left:240px; bottom:40px; width:130px;"></div>
          <div class="obj-caisse" style="left:275px; bottom:65px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:280px;"></div>
          <div class="boutique-porte" style="left:-4px; top:150px; width:8px; height:50px;"></div>
          <div class="boutique-porte" style="right:-4px; top:150px; width:8px; height:50px;"></div>
        </div>

        <!-- Ilot 2 - Opticien -->
        <div class="boutique" style="left:4500px; top:1200px; width:600px; height:350px; background:linear-gradient(135deg,#5c6bc0,#3f51b5);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128083;</div><div class="boutique-nom" style="font-size:16px;">OPTICIEN</div></div>
          <div class="obj-vitrine" style="left:20px; top:25px; width:100px; height:40px;"></div>
          <div class="obj-vitrine" style="left:20px; top:90px; width:100px; height:40px;"></div>
          <div class="obj-vitrine" style="right:20px; top:25px; width:100px; height:40px;"></div>
          <div class="obj-miroir" style="right:15px; top:90px; height:40px;"></div>
          <div class="obj-comptoir" style="left:240px; bottom:40px; width:130px;"></div>
          <div class="obj-caisse" style="left:275px; bottom:65px;"></div>
          <div class="obj-chaise" style="left:180px; top:80px;"></div>
          <div class="obj-plante-int" style="left:150px; top:20px;"></div>
          <div class="boutique-porte" style="bottom:-4px; left:280px;"></div>
          <div class="boutique-porte" style="left:-4px; top:150px; width:8px; height:50px;"></div>
          <div class="boutique-porte" style="right:-4px; top:150px; width:8px; height:50px;"></div>
        </div>

        <!-- Fontaine centrale GRANDE -->
        <div class="mall-fontaine" style="left:3700px; top:2700px; width:200px; height:200px;">
          <span class="fontaine-label">FONTAINE CENTRALE</span>
        </div>

        <!-- Ilot 3 - Salle d'arcade -->
        <div class="boutique" style="left:2500px; top:3800px; width:600px; height:400px; background:linear-gradient(135deg,#78909c,#546e7a);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127922;</div><div class="boutique-nom" style="font-size:16px;">SALLE D'ARCADE</div></div>
          <div class="obj-machine" style="left:30px; top:30px;"></div>
          <div class="obj-machine" style="left:80px; top:30px;"></div>
          <div class="obj-machine" style="left:130px; top:30px;"></div>
          <div class="obj-machine" style="right:80px; top:30px;"></div>
          <div class="obj-machine" style="right:30px; top:30px;"></div>
          <div class="obj-machine" style="left:30px; top:180px;"></div>
          <div class="obj-machine" style="left:80px; top:180px;"></div>
          <div class="obj-comptoir" style="right:30px; bottom:40px; width:150px;"></div>
          <div class="obj-caisse" style="right:60px; bottom:65px;"></div>
          <div class="boutique-porte" style="top:-4px; left:280px;"></div>
          <div class="boutique-porte" style="left:-4px; top:180px; width:8px; height:50px;"></div>
          <div class="boutique-porte" style="right:-4px; top:180px; width:8px; height:50px;"></div>
        </div>

        <!-- Ilot 4 - Bowling -->
        <div class="boutique" style="left:4500px; top:3800px; width:600px; height:400px; background:linear-gradient(135deg,#e65100,#bf360c);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127923;</div><div class="boutique-nom" style="font-size:16px;">BOWLING</div></div>
          <div class="obj-piste" style="left:30px; top:60px;"></div>
          <div class="obj-piste" style="left:30px; top:140px;"></div>
          <div class="obj-piste" style="left:30px; top:220px;"></div>
          <div class="obj-comptoir" style="right:30px; bottom:40px; width:140px; background:#5d4037;"></div>
          <div class="obj-caisse" style="right:60px; bottom:65px;"></div>
          <div class="obj-canape" style="right:30px; top:40px;"></div>
          <div class="obj-canape" style="right:30px; top:120px;"></div>
          <div class="boutique-porte" style="top:-4px; left:280px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- AILE GAUCHE CENTRE (milieu gauche)                -->
        <!-- ================================================ -->
        <div class="boutique" style="left:60px; top:2100px; width:500px; height:400px; background:linear-gradient(135deg,#f9a825,#f57f17);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#128058;</div><div class="boutique-nom" style="font-size:16px;">ANIMALERIE</div></div>
          <div class="obj-vitrine" style="left:20px; top:25px; width:100px; height:50px; background:rgba(33,150,243,0.2); border-color:#42a5f5;"></div>
          <div class="obj-vitrine" style="left:20px; top:100px; width:80px; height:50px;"></div>
          <div class="obj-vitrine" style="left:20px; top:175px; width:80px; height:50px;"></div>
          <div class="obj-etagere" style="right:20px; top:30px; width:100px;"></div>
          <div class="obj-etagere" style="right:20px; top:60px; width:100px;"></div>
          <div class="obj-comptoir" style="left:180px; bottom:25px; width:150px;"></div>
          <div class="obj-caisse" style="left:280px; bottom:20px;"></div>
          <div class="obj-plante-int" style="left:30px; bottom:20px;"></div>
          <div class="obj-plante-int" style="right:30px; bottom:20px;"></div>
          <div class="boutique-porte" style="right:-4px; top:180px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique" style="left:60px; top:2600px; width:500px; height:400px; background:linear-gradient(135deg,#ec407a,#c2185b);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127874;</div><div class="boutique-nom" style="font-size:16px;">PATISSERIE</div></div>
          <div class="obj-vitrine" style="left:20px; top:25px; width:100px; height:40px;"></div>
          <div class="obj-vitrine" style="left:20px; top:85px; width:100px; height:40px;"></div>
          <div class="obj-comptoir" style="right:15px; bottom:25px; width:180px; background:#ff9800; border-color:#f57c00;"></div>
          <div class="obj-caisse" style="right:150px; bottom:20px;"></div>
          <div class="obj-table" style="left:200px; top:40px;"></div>
          <div class="obj-chaise" style="left:195px; top:25px;"></div>
          <div class="obj-chaise" style="left:230px; top:25px;"></div>
          <div class="obj-table" style="left:200px; top:130px;"></div>
          <div class="obj-chaise" style="left:195px; top:115px;"></div>
          <div class="obj-chaise" style="left:230px; top:115px;"></div>
          <div class="obj-table" style="left:300px; top:40px;"></div>
          <div class="obj-chaise" style="left:295px; top:25px;"></div>
          <div class="obj-chaise" style="left:330px; top:25px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:15px;"></div>
          <div class="boutique-porte" style="right:-4px; top:180px; width:8px; height:50px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- AILE DROITE CENTRE (milieu droite)                -->
        <!-- ================================================ -->
        <div class="boutique" style="right:60px; top:2100px; width:500px; height:400px; background:linear-gradient(135deg,#7cb342,#558b2f);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#127811;</div><div class="boutique-nom" style="font-size:16px;">BIO & NATURE</div></div>
          <div class="obj-etagere" style="left:20px; top:25px; width:110px;"></div>
          <div class="obj-etagere" style="left:20px; top:55px; width:110px;"></div>
          <div class="obj-etagere" style="left:20px; top:85px; width:110px;"></div>
          <div class="obj-etagere" style="left:20px; top:115px; width:110px;"></div>
          <div class="obj-table-rect" style="right:30px; top:40px;"></div>
          <div class="obj-table-rect" style="right:30px; top:110px;"></div>
          <div class="obj-comptoir" style="left:180px; bottom:25px; width:160px;"></div>
          <div class="obj-caisse" style="left:290px; bottom:20px;"></div>
          <div class="obj-plante-int" style="left:25px; bottom:20px;"></div>
          <div class="obj-plante-int" style="right:25px; bottom:20px;"></div>
          <div class="boutique-porte" style="left:-4px; top:180px; width:8px; height:50px;"></div>
        </div>
        <div class="boutique" style="right:60px; top:2600px; width:500px; height:400px; background:linear-gradient(135deg,#8d6e63,#5d4037);">
          <div class="boutique-interieur"><div class="boutique-icone" style="font-size:60px;">&#9749;</div><div class="boutique-nom" style="font-size:16px;">SALON DE THE</div></div>
          <div class="obj-table" style="left:30px; top:35px;"></div>
          <div class="obj-chaise" style="left:25px; top:20px;"></div>
          <div class="obj-chaise" style="left:60px; top:20px;"></div>
          <div class="obj-table" style="left:130px; top:35px;"></div>
          <div class="obj-chaise" style="left:125px; top:20px;"></div>
          <div class="obj-chaise" style="left:160px; top:20px;"></div>
          <div class="obj-table" style="left:30px; top:140px;"></div>
          <div class="obj-chaise" style="left:25px; top:125px;"></div>
          <div class="obj-chaise" style="left:60px; top:125px;"></div>
          <div class="obj-table" style="left:130px; top:140px;"></div>
          <div class="obj-chaise" style="left:125px; top:125px;"></div>
          <div class="obj-chaise" style="left:160px; top:125px;"></div>
          <div class="obj-comptoir" style="right:15px; top:25px; width:140px; height:22px; background:#a1887f; border-color:#8d6e63;"></div>
          <div class="obj-caisse" style="right:115px; top:20px;"></div>
          <div class="obj-plante-int" style="right:20px; bottom:20px;"></div>
          <div class="obj-plante-int" style="left:20px; bottom:20px;"></div>
          <div class="boutique-porte" style="left:-4px; top:180px; width:8px; height:50px;"></div>
        </div>

        <!-- ================================================ -->
        <!-- DECORATIONS                                       -->
        <!-- ================================================ -->

        <!-- Bancs autour fontaine -->
        <div class="banc" style="left:3600px; top:2650px;"></div>
        <div class="banc" style="left:3950px; top:2650px;"></div>
        <div class="banc" style="left:3600px; top:2950px;"></div>
        <div class="banc" style="left:3950px; top:2950px;"></div>

        <!-- Bancs corridors -->
        <div class="banc" style="left:800px; top:500px;"></div>
        <div class="banc" style="left:800px; top:1400px;"></div>
        <div class="banc" style="left:800px; top:2500px;"></div>
        <div class="banc" style="left:800px; top:3600px;"></div>
        <div class="banc" style="left:800px; top:4600px;"></div>
        <div class="banc" style="left:6700px; top:500px;"></div>
        <div class="banc" style="left:6700px; top:1400px;"></div>
        <div class="banc" style="left:6700px; top:2500px;"></div>
        <div class="banc" style="left:6700px; top:3600px;"></div>
        <div class="banc" style="left:6700px; top:4600px;"></div>
        <div class="banc" style="left:2000px; top:700px;"></div>
        <div class="banc" style="left:5500px; top:700px;"></div>
        <div class="banc" style="left:2000px; top:5200px;"></div>
        <div class="banc" style="left:5500px; top:5200px;"></div>

        <!-- Plantes decoratives -->
        <div class="mall-plante" style="left:700px; top:70px;"></div>
        <div class="mall-plante" style="left:700px; top:950px;"></div>
        <div class="mall-plante" style="left:700px; top:1900px;"></div>
        <div class="mall-plante" style="left:700px; top:3100px;"></div>
        <div class="mall-plante" style="left:700px; top:4200px;"></div>
        <div class="mall-plante" style="left:700px; top:5100px;"></div>
        <div class="mall-plante" style="left:7200px; top:70px;"></div>
        <div class="mall-plante" style="left:7200px; top:950px;"></div>
        <div class="mall-plante" style="left:7200px; top:1900px;"></div>
        <div class="mall-plante" style="left:7200px; top:3100px;"></div>
        <div class="mall-plante" style="left:7200px; top:4200px;"></div>
        <div class="mall-plante" style="left:7200px; top:5100px;"></div>
        <div class="mall-plante" style="left:3500px; top:2650px;"></div>
        <div class="mall-plante" style="left:4100px; top:2650px;"></div>
        <div class="mall-plante" style="left:3500px; top:2950px;"></div>
        <div class="mall-plante" style="left:4100px; top:2950px;"></div>
        <div class="mall-plante" style="left:2000px; top:2000px;"></div>
        <div class="mall-plante" style="left:5600px; top:2000px;"></div>
        <div class="mall-plante" style="left:2000px; top:3500px;"></div>
        <div class="mall-plante" style="left:5600px; top:3500px;"></div>

        <!-- Escalators -->
        <div class="escalator" style="left:1800px; top:60px;"><span>ESCALATOR</span></div>
        <div class="escalator" style="left:5800px; top:60px;"><span>ESCALATOR</span></div>
        <div class="escalator" style="left:1800px; top:5920px;"><span>ESCALATOR</span></div>
        <div class="escalator" style="left:5800px; top:5920px;"><span>ESCALATOR</span></div>
        <div class="escalator" style="left:3700px; top:2000px;"><span>ESCALATOR</span></div>
        <div class="escalator" style="left:3700px; top:4500px;"><span>ESCALATOR</span></div>

        <!-- Bouches d'aeration (vents) -->
        <div class="vent" style="left:580px; top:1900px;" title="Ventilation"></div>
        <div class="vent" style="left:7350px; top:1900px;" title="Ventilation"></div>
        <div class="vent" style="left:580px; top:4100px;" title="Ventilation"></div>
        <div class="vent" style="left:7350px; top:4100px;" title="Ventilation"></div>
        <div class="vent" style="left:3800px; top:600px;" title="Ventilation"></div>
        <div class="vent" style="left:3800px; top:5300px;" title="Ventilation"></div>
        <div class="vent" style="left:2200px; top:2800px;" title="Ventilation"></div>
        <div class="vent" style="left:5400px; top:2800px;" title="Ventilation"></div>

        <!-- Panneaux directionnels -->
        <div class="panneau-boutique" style="left:900px; top:470px;"><span>&#8592; BOUTIQUES NORD</span></div>
        <div class="panneau-boutique" style="left:6500px; top:470px;"><span>BOUTIQUES NORD &#8594;</span></div>
        <div class="panneau-boutique" style="left:900px; top:3100px;"><span>&#8592; BOUTIQUES SUD</span></div>
        <div class="panneau-boutique" style="left:6500px; top:3100px;"><span>BOUTIQUES SUD &#8594;</span></div>
        <div class="panneau-boutique" style="left:3600px; top:2400px;"><span>&#9660; FONTAINE CENTRALE</span></div>
        <div class="panneau-boutique" style="left:3600px; top:1800px;"><span>&#9650; SECURITE / CAFE</span></div>
        <div class="panneau-boutique" style="left:2100px; top:2800px;"><span>&#8592; ANIMALERIE / PATISSERIE</span></div>
        <div class="panneau-boutique" style="left:5200px; top:2800px;"><span>BIO / SALON DE THE &#8594;</span></div>

        <!-- Allees principales visibles -->
        <div class="mall-allee-h" style="left:100px; top:2700px; width:7800px; height:200px;"></div>
        <div class="mall-allee-v" style="left:3700px; top:100px; width:200px; height:5800px;"></div>
        <div class="mall-allee-h" style="left:100px; top:1300px; width:3500px; height:100px;"></div>
        <div class="mall-allee-h" style="left:4000px; top:1300px; width:3900px; height:100px;"></div>
        <div class="mall-allee-h" style="left:100px; top:4300px; width:3500px; height:100px;"></div>
        <div class="mall-allee-h" style="left:4000px; top:4300px; width:3900px; height:100px;"></div>

        <!-- Distributeurs automatiques -->
        <div class="mall-distributeur" style="left:1200px; top:1320px;"></div>
        <div class="mall-distributeur" style="left:6200px; top:1320px;"></div>
        <div class="mall-distributeur" style="left:1200px; top:4310px;"></div>
        <div class="mall-distributeur" style="left:6200px; top:4310px;"></div>
        <div class="mall-distributeur" style="left:3300px; top:2710px;"></div>
        <div class="mall-distributeur" style="left:4300px; top:2710px;"></div>

        <!-- Poubelles -->
        <div class="mall-poubelle" style="left:750px; top:100px;"></div>
        <div class="mall-poubelle" style="left:750px; top:980px;"></div>
        <div class="mall-poubelle" style="left:750px; top:1930px;"></div>
        <div class="mall-poubelle" style="left:7250px; top:100px;"></div>
        <div class="mall-poubelle" style="left:7250px; top:980px;"></div>
        <div class="mall-poubelle" style="left:7250px; top:1930px;"></div>
        <div class="mall-poubelle" style="left:3550px; top:2650px;"></div>
        <div class="mall-poubelle" style="left:4150px; top:2650px;"></div>

        <!-- Panneaux publicitaires lumineux -->
        <div class="mall-pub" style="left:1500px; top:50px;">SOLDES -50%</div>
        <div class="mall-pub" style="left:5800px; top:50px;">NOUVEAU MAGASIN</div>
        <div class="mall-pub" style="left:1500px; top:5920px;">HAPPY HOUR 18H</div>
        <div class="mall-pub" style="left:5800px; top:5920px;">OUVERT 7J/7</div>

        <!-- Tapis rouge entree sud -->
        <div class="mall-tapis" style="left:3700px; top:5750px; width:200px; height:200px;"></div>

        <!-- Fleches directionnelles au sol -->
        <div class="mall-fleche" style="left:3780px; top:5500px;">&#9650;</div>
        <div class="mall-fleche" style="left:3780px; top:400px;">&#9660;</div>
        <div class="mall-fleche" style="left:1600px; top:2780px;">&#9654;</div>
        <div class="mall-fleche" style="left:5800px; top:2780px;">&#9664;</div>
        <div class="mall-fleche" style="left:3780px; top:2100px;">&#9660;</div>
        <div class="mall-fleche" style="left:3780px; top:3500px;">&#9650;</div>

        <!-- JOUEUR (spawn au sud) -->
        <div class="joueur-perso" id="joueur" style="left:3800px; top:3050px;">
          <span class="joueur-pseudo" id="joueur-pseudo-label"></span>
          <img id="joueur-skin-img" src="skin/skin gratuit/skin de base (garon).svg" alt="skin">
        </div>

      </div>
    </div>

    <!-- HUD (interface en jeu) -->
    <div class="jeu-hud">
      <div class="hud-top">
        <span style="font-weight:bold; color:#e74c3c; letter-spacing:2px;">VIRUS</span>
        <span>|</span>
        <span class="hud-role" id="hud-role">INNOCENT</span>
      </div>

      <div class="hud-missions">
        <h4>MISSIONS</h4>
        <div id="missions-liste"></div>
        <div class="mission-jauge-container" id="mission-jauge" style="display:none;">
          <div class="mission-jauge-fill" id="mission-jauge-fill"></div>
          <div class="mission-jauge-text" id="mission-jauge-text">0%</div>
        </div>
      </div>

      <button class="hud-btn-quitter" onclick="quitterJeu()" data-i18n="quit">QUITTER</button>

      <button class="btn-reunion" id="btn-reunion" onclick="demanderReunion()" data-i18n="callMeeting">APPELER UNE REUNION</button>
      <button class="btn-mission" id="btn-mission" onclick="faireMission()" data-i18n="doTask">FAIRE LA TACHE</button>
      <button class="btn-kill" id="btn-kill" onclick="tuerVictime()" data-i18n="kill">KILL</button>
      <div class="kill-countdown" id="kill-countdown">7</div>
      <button class="btn-signaler" id="btn-signaler" onclick="signalerCadavre()" data-i18n="report">SIGNALER</button>
      <button class="btn-enqueter" id="btn-enqueter" onclick="enqueterCible()" data-i18n="investigate">ENQUETER</button>
      <button class="btn-cameras" id="btn-cameras" onclick="ouvrirCameras()" data-i18n="cameras">CAMERAS</button>

      <!-- Joystick mobile -->
      <div id="joystick-container">
        <div id="joystick-base">
          <div id="joystick-stick"></div>
        </div>
      </div>

      <!-- Overlay cameras de securite -->
      <div class="cameras-overlay" id="cameras-overlay">
        <div class="cameras-titre" data-i18n="securityCams">CAMERAS DE SECURITE</div>
        <div class="cameras-grille" id="cameras-grille"></div>
        <button class="cameras-fermer" onclick="fermerCameras()" data-i18n="close">FERMER</button>
      </div>

      <!-- Overlay mini-jeux -->
      <div class="minijeu-overlay" id="minijeu-overlay">
        <div class="minijeu-titre" id="minijeu-titre"></div>
        <div class="minijeu-zone" id="minijeu-zone"></div>
      </div>

      <!-- Popup pouvoir journaliste -->
      <div class="journaliste-popup" id="popup-journaliste">
        <div class="journaliste-box">
          <div class="journaliste-titre">POUVOIR DU JOURNALISTE</div>
          <div class="journaliste-desc">
            Combien de virus penses-tu qu'il y a parmi les joueurs ?<br>
            <small>Choisis un nombre, et les roles te seront reveles.</small>
          </div>
          <div class="journaliste-choix" id="journaliste-choix"></div>
          <div class="journaliste-resultats" id="journaliste-resultats"></div>
          <button class="journaliste-fermer" id="journaliste-fermer" onclick="fermerPouvoirJournaliste()" data-i18n="gotIt">COMPRIS</button>
        </div>
      </div>

      <!-- Reunion HUD elements -->
      <div class="reunion-bandeau" id="reunion-bandeau">
        <div class="reunion-bandeau-titre" data-i18n="emergencyMeeting">REUNION D'URGENCE</div>
        <div class="reunion-bandeau-timer" id="reunion-timer">60</div>
      </div>

      <div class="reunion-chat" id="reunion-chat">
        <div class="reunion-chat-header"><h4>CHAT</h4></div>
        <div class="reunion-chat-messages" id="reunion-chat-messages"></div>
        <div class="reunion-chat-input">
          <input type="text" id="reunion-chat-input" placeholder="Discutez ici..." onkeydown="if(event.key==='Enter')envoyerMsgReunion()" data-i18n="phChatReunion" data-i18n-attr="placeholder">
          <button onclick="envoyerMsgReunion()">&#9654;</button>
        </div>
      </div>

      <button class="reunion-btn-skip" id="reunion-btn-skip" onclick="skipVote()" data-i18n="skip">SKIP</button>

      <div class="reunion-resultat-bandeau" id="reunion-resultat">
        <div class="reunion-resultat-texte" id="reunion-resultat-texte"></div>
        <div class="reunion-resultat-role" id="reunion-resultat-role"></div>
        <button class="reunion-btn-continuer" onclick="fermerReunion()" data-i18n="cont">CONTINUER</button>
      </div>

      <!-- FIN DE PARTIE -->
      <div class="fin-partie-overlay" id="fin-partie-overlay">
        <div class="fin-partie-titre" id="fin-partie-titre">VICTOIRE DES VIRUS</div>
        <div class="fin-partie-sous-titre" id="fin-partie-sous-titre"></div>
        <div class="fin-partie-roles" id="fin-partie-roles"></div>
        <button class="fin-partie-btn" onclick="retourMenuFinPartie()" data-i18n="mainMenu">MENU PRINCIPAL</button>
      </div>

      <div class="hud-minimap">
        <div class="minimap-inner">
          <!-- AILE NORD-OUEST -->
          <div class="minimap-shop" style="left:1px; top:1px; width:10px; height:8px;"></div>
          <div class="minimap-shop" style="left:1px; top:11px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="left:1px; top:20px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="left:1px; top:29px; width:10px; height:8px;"></div>
          <!-- AILE GAUCHE CENTRE -->
          <div class="minimap-shop" style="left:1px; top:42px; width:10px; height:8px;"></div>
          <div class="minimap-shop" style="left:1px; top:52px; width:10px; height:8px;"></div>
          <!-- AILE SUD-OUEST -->
          <div class="minimap-shop" style="left:1px; top:64px; width:14px; height:10px;"></div>
          <div class="minimap-shop" style="left:1px; top:76px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="left:1px; top:85px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="left:1px; top:94px; width:10px; height:8px;"></div>
          <div class="minimap-shop" style="left:1px; top:104px; width:8px; height:6px;"></div>
          <!-- AILE NORD-EST -->
          <div class="minimap-shop" style="right:1px; top:1px; width:10px; height:8px;"></div>
          <div class="minimap-shop" style="right:1px; top:11px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="right:1px; top:20px; width:10px; height:9px;"></div>
          <div class="minimap-shop" style="right:1px; top:31px; width:10px; height:7px;"></div>
          <!-- AILE DROITE CENTRE -->
          <div class="minimap-shop" style="right:1px; top:42px; width:10px; height:8px;"></div>
          <div class="minimap-shop" style="right:1px; top:52px; width:10px; height:8px;"></div>
          <!-- AILE SUD-EST -->
          <div class="minimap-shop" style="right:1px; top:64px; width:14px; height:10px;"></div>
          <div class="minimap-shop" style="right:1px; top:76px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="right:1px; top:85px; width:10px; height:7px;"></div>
          <div class="minimap-shop" style="right:1px; top:94px; width:10px; height:8px;"></div>
          <div class="minimap-shop" style="right:1px; top:104px; width:8px; height:6px;"></div>
          <!-- ZONE CENTRALE HAUT -->
          <div class="minimap-shop" style="left:56px; top:1px; width:9px; height:6px;"></div>
          <div class="minimap-shop" style="left:67px; top:1px; width:7px; height:5px;"></div>
          <div class="minimap-shop" style="left:76px; top:1px; width:9px; height:6px;"></div>
          <!-- ILOTS CENTRAUX -->
          <div class="minimap-shop" style="left:50px; top:24px; width:12px; height:7px;"></div>
          <div class="minimap-shop" style="left:90px; top:24px; width:12px; height:7px;"></div>
          <div class="minimap-shop" style="left:50px; top:76px; width:12px; height:8px;"></div>
          <div class="minimap-shop" style="left:90px; top:76px; width:12px; height:8px;"></div>
          <!-- Fontaine minimap -->
          <div style="position:absolute; left:74px; top:54px; width:4px; height:4px; border-radius:50%; background:#4fc3f7; opacity:0.6;"></div>
          <!-- Joueur minimap -->
          <div class="minimap-joueur" id="minimap-point" style="left:77px; top:112px;"></div>
        </div>
      </div>

      <div class="hud-controles" data-i18n="hudControls">ZQSD ou Fleches pour se deplacer</div>
    </div>
  </div>

  <script>
    // ============================
    // FIREBASE - Configuration
    // ============================
    var firebaseConfig = {
      apiKey: "VOTRE_API_KEY",           // Remplacer avec votre config Firebase
      authDomain: "VOTRE_PROJET.firebaseapp.com",
      projectId: "VOTRE_PROJET",
      storageBucket: "VOTRE_PROJET.appspot.com",
      messagingSenderId: "000000000000",
      appId: "VOTRE_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Identite persistante du joueur (UUID local)
    var monPlayerId = localStorage.getItem('virus_player_id');
    if (!monPlayerId) {
      monPlayerId = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('virus_player_id', monPlayerId);
    }

    var mesAmis = [];
    var demandesEnAttente = [];
    var panelAmisOuvert = false;
    var tabAmiActif = 'en-ligne';
    var amisStatuts = {};
    var ancienNbDemandes = 0;
    var invitationsAffichees = {};

    // Listeners Firestore actifs
    var firebaseUnsubscribers = [];
    var gameUnsubscribers = [];
    var remotePlayers = {};
    var lastPositionSend = 0;
    var lastSaPositionSend = 0;
    var myPartyPlayerDocId = null;

    // Heartbeat toutes les 30 secondes
    setInterval(function() {
      if (monPlayerId) {
        db.collection('players').doc(monPlayerId).set({
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          online: true
        }, { merge: true }).catch(function() {});
      }
    }, 30000);

    // Passer hors ligne quand on ferme la page
    window.addEventListener('beforeunload', function() {
      if (monPlayerId) {
        db.collection('players').doc(monPlayerId).update({ online: false }).catch(function() {});
      }
    });

    // ============================
    // GESTION DU COMPTE
    // ============================
    function isAdmin() {
      var pseudo = (getPseudo() || '').toLowerCase();
      return pseudo === 'obstinate' || pseudo === 'obstinate2.0';
    }

    // ============================
    // SYSTEME DE SKINS
    // ============================
    var RARETES = {
      typique:     { nom: 'TYPIQUE',     couleur: '#95a5a6' },
      commun:      { nom: 'COMMUN',      couleur: '#2ecc71' },
      rare:        { nom: 'RARE',        couleur: '#3498db' },
      epic:        { nom: 'EPIC',        couleur: '#9b59b6' },
      legendaire:  { nom: 'LEGENDAIRE',  couleur: '#f39c12' }
    };

    var SKINS = [
      { id: 'garcon', nom: 'Garcon', fichier: 'skin/skin gratuit/skin de base (garon).svg', rarete: 'typique' },
      { id: 'fille', nom: 'Fille', fichier: 'skin/skin gratuit/skin de base (fille).svg', rarete: 'typique' }
    ];

    function getSkin() {
      return localStorage.getItem('virus_skin') || 'garcon';
    }
    function setSkin(skinId) {
      localStorage.setItem('virus_skin', skinId);
      appliquerSkinPartout();
    }
    function getSkinFichier(skinId) {
      var s = SKINS.find(function(sk) { return sk.id === skinId; });
      return s ? s.fichier : SKINS[0].fichier;
    }
    function appliquerSkinPartout() {
      var fichier = getSkinFichier(getSkin());
      var joueurImg = document.getElementById('joueur-skin-img');
      if (joueurImg) joueurImg.src = fichier;
      var saImg = document.getElementById('sa-avatar-skin-img');
      if (saImg) saImg.src = fichier;
    }
    var skinTempSelection = null; // Skin selectionne mais pas encore confirme

    function genererSkinSelector(containerId) {
      var container = document.getElementById(containerId);
      if (!container) return;
      var currentSkin = getSkin();
      skinTempSelection = currentSkin;
      container.innerHTML = '';
      var ordreRarete = {legendaire:0, epic:1, rare:2, commun:3, typique:4};
      var skinsTries = SKINS.slice().sort(function(a, b) {
        return (ordreRarete[a.rarete] || 4) - (ordreRarete[b.rarete] || 4);
      });
      skinsTries.forEach(function(skin) {
        var div = document.createElement('div');
        div.className = 'skin-option' + (skin.id === currentSkin ? ' skin-selected' : '');
        div.onclick = function() {
          skinTempSelection = skin.id;
          container.querySelectorAll('.skin-option').forEach(function(el) { el.classList.remove('skin-selected'); });
          div.classList.add('skin-selected');
        };
        var rar = RARETES[skin.rarete] || RARETES.typique;
        div.innerHTML = '<img src="' + skin.fichier + '" alt="' + skin.nom + '"><span class="skin-rarete" style="color:' + rar.couleur + '">' + rar.nom + '</span><span class="skin-label">' + skin.nom + '</span>';
        container.appendChild(div);
      });
    }

    function confirmerSkin() {
      if (skinTempSelection) {
        setSkin(skinTempSelection);
      }
    }

    // Cabines d'essayage
    function ouvrirCabine() {
      document.getElementById('cabine-overlay').classList.add('visible');
      document.getElementById('cabine-popup').classList.add('visible');
      switchCasierTab('skin');
      genererSkinSelector('cabine-skin-selector');
    }
    function fermerCabine() {
      document.getElementById('cabine-overlay').classList.remove('visible');
      document.getElementById('cabine-popup').classList.remove('visible');
    }
    function confirmerEtFermerCabine() {
      confirmerSkin();
      fermerCabine();
    }

    // Onglets du casier
    function switchCasierTab(tab) {
      document.querySelectorAll('.casier-tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.casier-tab-content').forEach(function(c) { c.classList.remove('active'); });
      document.getElementById('casier-tab-' + tab).classList.add('active');
      document.getElementById('casier-content-' + tab).classList.add('active');
      if (tab === 'musique') genererMusiqueList();
    }

    // Systeme de musique
    var MUSIQUES = [
      { id: 'destroyed', nom: 'Destroyed', artiste: '', fichier: 'musique/Destroyed/Destroyed multiverse album.mp3', image: 'musique/Destroyed/Destroyed image.svg' }
    ];

    var MUSIQUES_BOUTIQUE = [
      { id: 'minecraft', nom: 'Minecraft', artiste: '', fichier: 'musique/mincraft/minecraft (game relax 2).wav', image: 'musique/mincraft/Capture d\'cran 2026-02-13 121434.png', prix: 300, couleur: '#2ecc71' },
      { id: 'tadc', nom: 'The Amazing Digital Circus', artiste: '', fichier: 'musique/The_Amazing_Digital_Circus/The_Amazing_Digital_Circus_.mp3', image: 'musique/The_Amazing_Digital_Circus/The_Amazing_Digital_Circus.png', prix: 250, couleur: '#9b59b6' }
    ];

    function getMusiqueId() {
      return localStorage.getItem('virus_musique') || 'destroyed';
    }

    function setMusique(musiqueId) {
      localStorage.setItem('virus_musique', musiqueId);
      var m = MUSIQUES.find(function(x) { return x.id === musiqueId; });
      if (m) {
        var audio = document.getElementById('musique-menu');
        if (audio) {
          var wasPlaying = !audio.paused;
          audio.src = m.fichier;
          if (wasPlaying) audio.play();
        }
      }
      genererMusiqueList();
    }

    function genererMusiqueList() {
      var container = document.getElementById('casier-musique-list');
      if (!container) return;
      container.innerHTML = '';
      var currentId = getMusiqueId();
      MUSIQUES.forEach(function(m) {
        var isActive = m.id === currentId;
        var div = document.createElement('div');
        div.className = 'musique-item' + (isActive ? ' musique-active' : '');
        var iconHtml = m.image ? '<div class="musique-item-icon" style="background:none;"><img src="' + m.image + '" style="width:100%;height:100%;object-fit:contain;"></div>' : '<div class="musique-item-icon">&#9835;</div>';
        div.innerHTML = iconHtml +
          '<div class="musique-item-info">' +
            '<div class="musique-item-title">' + m.nom + '</div>' +
            '<div class="musique-item-artist">' + m.artiste + '</div>' +
          '</div>' +
          '<button class="musique-item-equip">' + (isActive ? t('equip') : t('equip')) + '</button>';
        div.querySelector('.musique-item-equip').textContent = isActive ? '' : t('equip');
        div.querySelector('.musique-item-equip').onclick = function(e) {
          e.stopPropagation();
          setMusique(m.id);
        };
        container.appendChild(div);
      });
    }

    function getPseudo() {
      return localStorage.getItem('virus_pseudo') || '';
    }

    function setPseudo(pseudo) {
      localStorage.setItem('virus_pseudo', pseudo);
      // Mettre a jour l'affichage partout
      var display = document.getElementById('pseudo-display');
      if (display) {
        display.textContent = pseudo;
        if (isAdmin()) {
          display.classList.add('pseudo-admin-text');
        } else {
          display.classList.remove('pseudo-admin-text');
        }
      }
    }

    function pseudoDejaUtilise(pseudo) {
      var parties = getParties();
      for (var i = 0; i < parties.length; i++) {
        if (parties[i].host && parties[i].host.toLowerCase() === pseudo.toLowerCase()) {
          return true;
        }
        if (parties[i].listeJoueurs) {
          for (var j = 0; j < parties[i].listeJoueurs.length; j++) {
            if (parties[i].listeJoueurs[j].toLowerCase() === pseudo.toLowerCase()) {
              return true;
            }
          }
        }
      }
      return false;
    }

    function setLangueCompte(lang) {
      setLanguage(lang);
    }

    function creerCompte() {
      var pseudo = document.getElementById('input-pseudo-compte').value.trim();
      if (!pseudo) { alert(t('vChoosePseudo')); return; }
      if (pseudo.length < 2) { alert(t('vPseudoTooShort')); return; }
      // Verifier dans Firebase si le pseudo existe deja
      db.collection('players').where('pseudo', '==', pseudo).limit(1).get().then(function(snap) {
        if (!snap.empty) {
          showNotif(t('pseudoTaken'), 'warn');
          return;
        }
        setPseudo(pseudo);
        // Skin aleatoire entre garcon et fille
        var skinAleatoire = Math.random() < 0.5 ? 'garcon' : 'fille';
        setSkin(skinAleatoire);
        // Enregistrer sur Firebase
        db.collection('players').doc(monPlayerId).set({
          playerId: monPlayerId,
          pseudo: pseudo,
          skin: getSkinFichier(skinAleatoire),
          online: true,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(function() {
          initAmisListeners();
          var btnAmis = document.getElementById('btn-amis');
          if (btnAmis) btnAmis.style.display = 'flex';
        }).catch(function() {});
        showScreen('menu-principal');
      }).catch(function() {
        showNotif(t('connectionError'), 'error');
      });
    }

    function ouvrirParams() {
      document.getElementById('popup-params').classList.add('visible');
      var display = document.getElementById('input-edit-pseudo-display');
      if (display) display.textContent = getPseudo();
    }

    function fermerParams() {
      document.getElementById('popup-params').classList.remove('visible');
    }

    function supprimerCompte() {
      if (confirm(t('vDeleteAccount'))) {
        // Passer hors ligne sur Firebase
        db.collection('players').doc(monPlayerId).update({ online: false }).catch(function() {});
        localStorage.removeItem('virus_pseudo');
        localStorage.removeItem('virus_skin');
        localStorage.removeItem('virus_admin');
        localStorage.removeItem('virusGold');
        localStorage.removeItem('virusSkinsAchetes');
        localStorage.removeItem('virus_player_id');
        mesAmis = [];
        demandesEnAttente = [];
        amisStatuts = {};
        // Generer un nouveau player ID
        monPlayerId = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('virus_player_id', monPlayerId);
        showScreen('ecran-compte');
      }
    }

    // Au chargement : verifier si un compte existe
    (function() {
      var pseudo = getPseudo();
      if (pseudo) {
        // Compte existant -> menu principal
        var display = document.getElementById('pseudo-display');
        display.textContent = pseudo;
        if (isAdmin()) {
          display.classList.add('pseudo-admin-text');
        }
        appliquerSkinPartout();
        showScreen('menu-principal');
      } else {
        // Pas de compte -> ecran de creation
        document.getElementById('ecran-compte').classList.add('active');
      }
    })();

    // ============================
    // FIREBASE - Initialisation joueur
    // ============================
    function initFirebaseAuth() {
      var pseudo = getPseudo();
      if (pseudo) {
        db.collection('players').doc(monPlayerId).set({
          playerId: monPlayerId,
          pseudo: pseudo,
          skin: getSkinFichier(getSkin()),
          online: true,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(function() {
          initAmisListeners();
          var btnAmis = document.getElementById('btn-amis');
          if (btnAmis) btnAmis.style.display = 'flex';
        }).catch(function() {});
      }
    }

    // Initialiser au chargement
    setTimeout(initFirebaseAuth, 500);

    // ============================
    // GESTION DES PARTIES (Firebase)
    // ============================
    const COULEURS_PARTIES = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71', '#9b59b6', '#1abc9c', '#e67e22', '#2c3e50'];
    var estHost = false;
    var partieActuelleId = null;
    var firebaseParties = [];
    var firebasePartyPlayers = [];

    // Listener temps reel sur la liste des parties
    db.collection('parties').orderBy('createdAt', 'desc').onSnapshot(function(snapshot) {
      firebaseParties = [];
      snapshot.forEach(function(doc) {
        var data = doc.data();
        data._id = doc.id;
        data.enCours = (data.phase !== 'lobby');
        firebaseParties.push(data);
      });
      var ecranListe = document.getElementById('liste-parties');
      if (ecranListe && ecranListe.classList.contains('active')) {
        rafraichirListeParties();
      }
    });

    function getParties() {
      return firebaseParties;
    }

    function sauvegarderParties() {
      // Plus necessaire avec Firebase (les donnees sont sur le cloud)
    }

    // Notification salle d'attente (bas gauche)
    function ajouterNotifSalle(texte, type) {
      var container = document.getElementById('sa-notifs');
      if (!container) return;
      var div = document.createElement('div');
      div.className = 'sa-notif ' + (type || 'join');
      div.textContent = texte;
      container.appendChild(div);
      setTimeout(function() {
        div.classList.add('fade-out');
        setTimeout(function() { div.remove(); }, 400);
      }, 4000);
    }

    // Sons de la salle d'attente (join/quit)
    function jouerSonSalle(fichier) {
      try {
        var son = new Audio(fichier);
        son.volume = 0.5;
        son.play();
      } catch(e) {}
    }

    // Met a jour la salle d'attente selon si on est host ou pas
    function updateSalleAttente() {
      var btnDemarrer = document.getElementById('btn-demarrer');
      var msgAttente = document.getElementById('msg-attente-host');

      if (estHost) {
        btnDemarrer.style.display = 'flex';
        msgAttente.style.display = 'none';
      } else {
        btnDemarrer.style.display = 'none';
        msgAttente.style.display = 'block';
      }
    }

    function quitterPartie() {
      jouerSonSalle('quitter.mp3');
      if (partieActuelleId) {
        // Supprimer le joueur de la partie
        if (myPartyPlayerDocId) {
          db.collection('partyPlayers').doc(myPartyPlayerDocId).delete().catch(function() {});
          myPartyPlayerDocId = null;
        }
        // Mettre a jour le compteur et la liste de joueurs
        var pseudo = getPseudo();
        db.collection('parties').doc(partieActuelleId).update({
          joueurs: firebase.firestore.FieldValue.increment(-1),
          listeJoueurs: firebase.firestore.FieldValue.arrayRemove(pseudo)
        }).catch(function() {});
        // Transferer host si necessaire
        db.collection('partyPlayers').where('partyId', '==', partieActuelleId).limit(1).get().then(function(snap) {
          if (!snap.empty) {
            var newHost = snap.docs[0];
            newHost.ref.update({ isHost: true });
            db.collection('parties').doc(partieActuelleId).update({ hostPlayerId: newHost.data().playerId, hostPseudo: newHost.data().pseudo });
          } else {
            // Plus personne -> supprimer la partie
            db.collection('parties').doc(partieActuelleId).delete().catch(function() {});
          }
        }).catch(function() {});
        unsubscribeFromParty();
        partieActuelleId = null;
      }
      estHost = false;
      showScreen('menu-online');
    }

    // S'abonner aux mises a jour d'une partie (joueurs, chat)
    function subscribeToParty(partyId) {
      unsubscribeFromParty();
      // Joueurs de la partie (temps reel)
      firebaseUnsubscribers.push(
        db.collection('partyPlayers').where('partyId', '==', partyId).onSnapshot(function(snapshot) {
          var oldCount = firebasePartyPlayers.length;
          firebasePartyPlayers = [];
          snapshot.forEach(function(doc) {
            var data = doc.data();
            data._docId = doc.id;
            firebasePartyPlayers.push(data);
          });
          updateSalleAttenteUI(firebasePartyPlayers);

          if (oldCount > 0 && firebasePartyPlayers.length > oldCount) {
            jouerSonSalle('join.mp3');
            var newPlayer = firebasePartyPlayers[firebasePartyPlayers.length - 1];
            if (newPlayer && newPlayer.playerId !== monPlayerId) {
              ajouterNotifSalle(t('playerJoined', newPlayer.pseudo), 'join');
            }
          } else if (oldCount > 0 && firebasePartyPlayers.length < oldCount) {
            jouerSonSalle('quitter.mp3');
          }
        })
      );
      // Chat lobby
      firebaseUnsubscribers.push(
        db.collection('chatMessages').where('partyId', '==', partyId).where('context', '==', 'lobby').orderBy('timestamp').onSnapshot(function(snapshot) {
          var messages = [];
          snapshot.forEach(function(doc) { messages.push(doc.data()); });
          updateChatUI(messages, 'lobby');
        })
      );
    }

    function unsubscribeFromParty() {
      firebaseUnsubscribers.forEach(function(unsub) { if (unsub) unsub(); });
      firebaseUnsubscribers = [];
      gameUnsubscribers.forEach(function(unsub) { if (unsub) unsub(); });
      gameUnsubscribers = [];
      firebasePartyPlayers = [];
      remotePlayers = {};
    }

    // S'abonner a l'etat du jeu en temps reel (positions, kills, reunions)
    function subscribeToGameState(partyId) {
      // Etat de la partie (phase, etc.)
      gameUnsubscribers.push(
        db.collection('parties').doc(partyId).onSnapshot(function(doc) {
          if (!doc.exists) return;
          var state = doc.data();
          state._id = doc.id;
          handleGameStateUpdate(state);
        })
      );
      // Positions des joueurs (partyPlayers)
      gameUnsubscribers.push(
        db.collection('partyPlayers').where('partyId', '==', partyId).onSnapshot(function(snapshot) {
          var players = [];
          snapshot.forEach(function(d) {
            var data = d.data();
            data._docId = d.id;
            players.push(data);
          });
          handlePositionUpdate(players);
        })
      );
      // Cadavres
      gameUnsubscribers.push(
        db.collection('cadavres').where('partyId', '==', partyId).onSnapshot(function(snapshot) {
          var cadavres = [];
          snapshot.forEach(function(d) {
            var data = d.data();
            data._id = d.id;
            cadavres.push(data);
          });
          if (lastGamePhase === 'playing') updateCadavresMultiplayer(cadavres);
        })
      );
      // Chat reunion
      gameUnsubscribers.push(
        db.collection('chatMessages').where('partyId', '==', partyId).where('context', '==', 'meeting').orderBy('timestamp').onSnapshot(function(snapshot) {
          var messages = [];
          snapshot.forEach(function(doc) { messages.push(doc.data()); });
          if (reunionEnCours) updateChatUI(messages, 'meeting');
        })
      );
      // Reunions actives
      gameUnsubscribers.push(
        db.collection('meetings').where('partyId', '==', partyId).where('active', '==', true).onSnapshot(function(snapshot) {
          if (!snapshot.empty) {
            var meeting = snapshot.docs[0].data();
            meeting._id = snapshot.docs[0].id;
            if (!reunionEnCours) {
              ouvrirReunionMultiplayer(meeting);
            }
            // Mettre a jour le compteur de votes
            db.collection('votes').where('meetingId', '==', meeting._id).get().then(function(voteSnap) {
              var voteInfo = document.getElementById('reunion-vote-info');
              var aliveCount = firebasePartyPlayers.filter(function(p) { return p.alive; }).length;
              if (voteInfo) voteInfo.textContent = voteSnap.size + '/' + aliveCount;
            });
          }
        })
      );
    }

    // Gestion des mises a jour de l'etat du jeu
    var lastGamePhase = null;
    function handleGameStateUpdate(state) {
      // Phase a change
      if (state.phase !== lastGamePhase) {
        if (state.phase === 'playing' && lastGamePhase === 'lobby') {
          lancerJeuMultiplayer(state);
        } else if (state.phase === 'meeting' && !reunionEnCours) {
          // Reunion geree par le listener meetings
        } else if (state.phase === 'playing' && reunionEnCours) {
          fermerReunionMultiplayer(state);
        } else if (state.phase === 'finished') {
          afficherFinPartieMultiplayer(state);
        }
        lastGamePhase = state.phase;
      }
    }

    // Lancer le jeu en mode multiplayer
    function lancerJeuMultiplayer(state) {
      // Trouver mon role depuis les partyPlayers
      var myPlayer = firebasePartyPlayers.find(function(p) { return p.playerId === monPlayerId; });
      monRole = (myPlayer && myPlayer.role) || 'innocent';
      modeHorsLigne = false;
      showScreen('jeu');
      jeuActif = true;
      joueurX = 3800;
      joueurY = 3050;
      joueursElimines = [];
      killProtection = true;
      setTimeout(function() { killProtection = false; }, 10000);
      reunionCooldown = true;
      setTimeout(function() { reunionCooldown = false; }, 15000);
      voteTermine = false;
      voteChoisi = false;
      joueurAVote = false;

      // Afficher le role
      if (monRole === 'virus') {
        var allies = firebasePartyPlayers.filter(function(p) { return p.role === 'virus' && p.playerId !== monPlayerId; }).map(function(p) { return p.pseudo; });
        showNotif(t('youAreVirus', allies.join(', ') || 'aucun'), 'warn');
      } else if (monRole === 'journaliste') {
        showNotif(t('youAreJournalist'), 'info');
      } else if (monRole === 'fanatique') {
        showNotif(t('youAreFanatic'), 'warn');
      } else if (monRole === 'espion') {
        showNotif(t('youAreSpy'), 'info');
        var overlay = document.getElementById('espion-choix-overlay');
        if (overlay) overlay.style.display = 'flex';
      } else {
        showNotif(t('youAreInnocent'), 'info');
      }

      // Initialiser les missions
      initMissions();

      // Souscrire a l'etat du jeu
      subscribeToGameState(partieActuelleId);
      lastGamePhase = 'playing';
      gameLoop();
    }

    // Gestion des positions distantes
    function handlePositionUpdate(players) {
      var now = Date.now();
      players.forEach(function(p) {
        if (p.playerId === monPlayerId) return;
        if (!remotePlayers[p.playerId]) {
          remotePlayers[p.playerId] = {
            x: p.x, y: p.y, prevX: p.x, prevY: p.y,
            targetX: p.x, targetY: p.y,
            direction: p.direction, lastUpdate: now,
            alive: p.alive, pseudo: p.pseudo, skin: p.skin
          };
          createRemotePlayerElement(p);
        } else {
          var rp = remotePlayers[p.playerId];
          rp.prevX = rp.x;
          rp.prevY = rp.y;
          rp.targetX = p.x;
          rp.targetY = p.y;
          rp.direction = p.direction;
          rp.lastUpdate = now;
          rp.alive = p.alive;
        }
      });
    }

    // Creer un element DOM pour un joueur distant
    function createRemotePlayerElement(p) {
      var container = document.getElementById('map');
      if (!container) return;
      var div = document.createElement('div');
      div.id = 'remote-' + p.playerId;
      div.className = 'bot';
      div.style.position = 'absolute';
      div.style.left = p.x + 'px';
      div.style.top = p.y + 'px';
      div.innerHTML = '<div class="bot-pseudo">' + p.pseudo.replace(/</g, '&lt;') + '</div>' +
        '<img src="' + (p.skin || 'skin/skin gratuit/skin de base (garon).svg') +
        '" class="bot-skin" style="width:60px;height:60px;">';
      container.appendChild(div);
    }

    // Mettre a jour les joueurs distants (interpolation)
    function updateRemotePlayers() {
      var now = Date.now();
      for (var pid in remotePlayers) {
        var rp = remotePlayers[pid];
        var elapsed = now - rp.lastUpdate;
        var t = Math.min(elapsed / 200, 1);
        rp.x = rp.prevX + (rp.targetX - rp.prevX) * t;
        rp.y = rp.prevY + (rp.targetY - rp.prevY) * t;

        var el = document.getElementById('remote-' + pid);
        if (el) {
          el.style.left = rp.x + 'px';
          el.style.top = rp.y + 'px';
          var img = el.querySelector('img');
          if (img) img.style.transform = 'scaleX(' + rp.direction + ')';
          if (!rp.alive) el.style.opacity = '0.3';
        }
      }
    }

    // Mettre a jour les cadavres en multiplayer
    function updateCadavresMultiplayer(cadavres) {
      if (!cadavres) return;
      var container = document.getElementById('map');
      if (!container) return;
      container.querySelectorAll('.cadavre-mp').forEach(function(el) { el.remove(); });
      cadavres.forEach(function(c) {
        var div = document.createElement('div');
        div.className = 'cadavre-mp';
        div.style.position = 'absolute';
        div.style.left = c.x + 'px';
        div.style.top = c.y + 'px';
        div.style.opacity = '0.5';
        div.innerHTML = '<img src="' + (c.victimSkin || 'skin/skin gratuit/skin de base (garon).svg') +
          '" style="width:60px;height:60px;filter:grayscale(100%);transform:rotate(90deg);">';
        div.onclick = function() {
          if (!c.reported) {
            db.collection('cadavres').doc(c._id).update({ reported: true }).then(function() {
              // Signaler le cadavre -> declencher reunion
              db.collection('meetings').add({
                partyId: partieActuelleId,
                initiatorPlayerId: monPlayerId,
                reason: 'report',
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              db.collection('parties').doc(partieActuelleId).update({ phase: 'meeting' });
            }).catch(function() {});
          }
        };
        container.appendChild(div);
      });
    }

    // Reunion en multiplayer
    function ouvrirReunionMultiplayer(meeting) {
      if (miniJeuOuvert) pauserMiniJeu();
      reunionEnCours = true;
      jeuActif = false;
      try { var sReunion = new Audio("runion d'urgence !.mp3"); sReunion.volume = 0.6; sReunion.play(); } catch(e) {}
      var popup = document.getElementById('popup-reunion');
      if (popup) popup.style.display = 'flex';
      // Afficher les joueurs vivants dans la liste de vote
      var voteList = document.getElementById('reunion-vote-liste');
      if (voteList) {
        voteList.innerHTML = '';
        firebasePartyPlayers.forEach(function(j) {
          if (!j.alive || j.playerId === monPlayerId) return;
          var btn = document.createElement('button');
          btn.className = 'reunion-vote-btn';
          btn.textContent = j.pseudo;
          btn.onclick = function() {
            db.collection('votes').add({
              meetingId: meeting._id,
              partyId: partieActuelleId,
              voterPlayerId: monPlayerId,
              targetPlayerId: j.playerId,
              isSkip: false
            }).catch(function() {});
            try { var sVote = new Audio('I VOTED.mp3'); sVote.volume = 0.5; sVote.play(); } catch(e) {}
            voteList.querySelectorAll('.reunion-vote-btn').forEach(function(b) { b.disabled = true; });
            // Host verifie si tous ont vote
            if (estHost) checkVotesComplete(meeting._id);
          };
          voteList.appendChild(btn);
        });
      }
    }

    // Host verifie si tous les joueurs vivants ont vote
    function checkVotesComplete(meetingId) {
      setTimeout(function() {
        var aliveCount = firebasePartyPlayers.filter(function(p) { return p.alive; }).length;
        db.collection('votes').where('meetingId', '==', meetingId).get().then(function(snap) {
          if (snap.size >= aliveCount) {
            concludeVote(meetingId);
          }
        });
      }, 1000);
    }

    // Host conclut le vote
    function concludeVote(meetingId) {
      db.collection('votes').where('meetingId', '==', meetingId).get().then(function(snap) {
        var voteCounts = {};
        var skipCount = 0;
        snap.forEach(function(doc) {
          var v = doc.data();
          if (v.isSkip) { skipCount++; }
          else { voteCounts[v.targetPlayerId] = (voteCounts[v.targetPlayerId] || 0) + 1; }
        });
        // Trouver le plus vote
        var maxVotes = skipCount;
        var eliminated = null;
        for (var pid in voteCounts) {
          if (voteCounts[pid] > maxVotes) {
            maxVotes = voteCounts[pid];
            eliminated = pid;
          }
        }
        // Eliminer le joueur vote
        if (eliminated) {
          firebasePartyPlayers.forEach(function(p) {
            if (p.playerId === eliminated && p._docId) {
              db.collection('partyPlayers').doc(p._docId).update({ alive: false });
            }
          });
        }
        // Fermer la reunion
        db.collection('meetings').doc(meetingId).update({ active: false });
        db.collection('parties').doc(partieActuelleId).update({ phase: 'playing' });
        // Verifier fin de partie
        checkEndGame();
      });
    }

    // Verifier si la partie est terminee
    function checkEndGame() {
      if (!estHost) return;
      setTimeout(function() {
        var virusAlive = firebasePartyPlayers.filter(function(p) { return p.alive && p.role === 'virus'; }).length;
        var innocentsAlive = firebasePartyPlayers.filter(function(p) { return p.alive && p.role !== 'virus'; }).length;
        if (virusAlive === 0 || virusAlive >= innocentsAlive) {
          db.collection('parties').doc(partieActuelleId).update({
            phase: 'finished',
            winner: virusAlive === 0 ? 'innocents' : 'virus'
          });
        }
      }, 500);
    }

    function fermerReunionMultiplayer(state) {
      reunionEnCours = false;
      jeuActif = true;
      var popup = document.getElementById('popup-reunion');
      if (popup) popup.style.display = 'none';
      reunionCooldown = true;
      setTimeout(function() { reunionCooldown = false; }, 15000);
      killProtection = true;
      setTimeout(function() { killProtection = false; }, 10000);
      gameLoop();
      // Reprendre le mini-jeu si un etait en pause
      if (miniJeuPause) reprendreMiniJeu();
    }

    function afficherFinPartieMultiplayer(state) {
      jeuActif = false;
      if (miniJeuOuvert) fermerMiniJeu();
      reunionEnCours = false;
      var popup = document.getElementById('popup-reunion');
      if (popup) popup.style.display = 'none';
      if (state.winner === 'innocents') {
        showNotif(t('innocentsWin'), 'info');
      } else {
        showNotif(t('virusWin'), 'warn');
      }
      setTimeout(function() {
        unsubscribeFromParty();
        partieActuelleId = null;
        lastGamePhase = null;
        showScreen('menu-online');
      }, 5000);
    }

    // Mettre a jour l'UI de la salle d'attente
    function updateSalleAttenteUI(players) {
      if (!players) return;
      var currentParty = firebaseParties.find(function(p) { return p._id === partieActuelleId; });
      var maxJ = currentParty ? currentParty.maxJoueurs : 10;

      // Compteur
      var compteur = document.querySelector('.compteur');
      if (compteur) compteur.textContent = players.length + '/' + maxJ;

      // Liste joueurs
      var liste = document.querySelector('.sa-joueurs-liste');
      if (liste) {
        var html = '';
        players.forEach(function(p) {
          var hostLabel = p.isHost ? ' (Host)' : '';
          html += '<div class="sa-joueur-item connecte">&#9679; ' +
            p.pseudo.replace(/</g, '&lt;') + hostLabel + '</div>';
        });
        for (var i = players.length; i < maxJ; i++) {
          html += '<div class="sa-joueur-item attente">&#9675; ' + t('waiting') + '</div>';
        }
        liste.innerHTML = html;
      }

      // Verifier si on est host
      var me = players.find(function(p) { return p.playerId === monPlayerId; });
      estHost = me ? me.isHost : false;
      updateSalleAttente();

      // Afficher les avatars des autres joueurs dans la salle
      renderWaitingRoomPlayers(players);
    }

    // Afficher les avatars des autres joueurs dans la salle d'attente
    function renderWaitingRoomPlayers(players) {
      var container = document.querySelector('.sa-content');
      if (!container) return;
      // Supprimer les anciens avatars distants
      container.querySelectorAll('.sa-remote-avatar').forEach(function(el) { el.remove(); });
      players.forEach(function(p) {
        if (p.playerId === monPlayerId) return;
        var div = document.createElement('div');
        div.className = 'sa-joueur-avatar sa-remote-avatar';
        div.style.position = 'absolute';
        div.style.left = (p.saX || 50) + '%';
        div.style.top = (p.saY || 70) + '%';
        div.style.transform = 'translate(-50%, -50%)';
        div.style.textAlign = 'center';
        div.style.zIndex = '5';
        div.innerHTML = '<div style="font-size:10px;color:#fff;margin-bottom:2px;">' +
          p.pseudo.replace(/</g, '&lt;') + '</div>' +
          '<img src="' + (p.skin || 'skin/skin gratuit/skin de base (garon).svg') +
          '" style="width:48px;height:48px;" alt="skin">';
        container.appendChild(div);
      });
    }

    // Mettre a jour le chat depuis Firebase
    function updateChatUI(messages, context) {
      var chatId = context === 'lobby' ? 'chat-messages' : 'reunion-messages';
      var chatDiv = document.getElementById(chatId);
      if (!chatDiv) return;
      chatDiv.innerHTML = '';
      if (!messages) return;
      messages.forEach(function(msg) {
        var div = document.createElement('div');
        div.className = 'chat-message' + (msg.isSystem ? ' system' : '');
        div.innerHTML = '<strong>' + msg.pseudo.replace(/</g, '&lt;') + ':</strong> ' +
          msg.message.replace(/</g, '&lt;');
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
      // Son chat
      if (messages.length > 0) {
        try { var sChat = new Audio(Math.random() < 0.5 ? 'chat1.mp3' : 'chat2.mp3'); sChat.volume = 0.4; sChat.play(); } catch(e) {}
      }
    }

    function mettreAJourOptionsVirus() {
      var maxJ = parseInt(document.getElementById('cp-max-joueurs').value);
      var selectMechants = document.getElementById('cp-mechants');
      var options = selectMechants.querySelectorAll('option');
      options.forEach(function(opt) {
        var val = parseInt(opt.value);
        if (val >= 3 && maxJ < 10) {
          opt.disabled = true;
          opt.title = t('need10For3VirusTip');
        } else if (val >= 2 && maxJ < 7) {
          opt.disabled = true;
          opt.title = t('need7For2VirusTip');
        } else {
          opt.disabled = false;
          opt.title = '';
        }
      });
      // Si l'option selectionnee est desactivee, revenir a 1
      if (selectMechants.selectedOptions[0] && selectMechants.selectedOptions[0].disabled) {
        selectMechants.value = '1';
      }
    }

    // Toggles creer-partie online
    var cpJournaliste = false;
    var cpFanatique = false;
    var cpEspion = false;
    var cpLang = 'fr';

    function toggleCpJournaliste() {
      cpJournaliste = !cpJournaliste;
      var el = document.getElementById('cp-toggle-journaliste');
      var lbl = document.getElementById('cp-toggle-journaliste-label');
      if (cpJournaliste) {
        el.classList.add('active'); lbl.classList.add('active');
        lbl.textContent = t('oneJournalist');
      } else {
        el.classList.remove('active'); lbl.classList.remove('active');
        lbl.textContent = t('zeroJournalist');
      }
    }
    function toggleCpFanatique() {
      cpFanatique = !cpFanatique;
      var el = document.getElementById('cp-toggle-fanatique');
      var lbl = document.getElementById('cp-toggle-fanatique-label');
      if (cpFanatique) {
        el.classList.add('active'); lbl.classList.add('active');
        lbl.textContent = t('oneFanatic');
      } else {
        el.classList.remove('active'); lbl.classList.remove('active');
        lbl.textContent = t('zeroFanatic');
      }
    }
    function toggleCpEspion() {
      cpEspion = !cpEspion;
      var el = document.getElementById('cp-toggle-espion');
      var lbl = document.getElementById('cp-toggle-espion-label');
      if (cpEspion) {
        el.classList.add('active'); lbl.classList.add('active');
        lbl.textContent = t('oneSpy');
      } else {
        el.classList.remove('active'); lbl.classList.remove('active');
        lbl.textContent = t('zeroSpy');
      }
    }
    function setCpLang(lang) {
      cpLang = lang;
      document.querySelectorAll('#creer-partie .lang-btn').forEach(function(b) { b.classList.remove('active'); });
      var btn = document.getElementById('cp-lang-' + lang);
      if (btn) btn.classList.add('active');
    }

    function creerPartie() {
      const nom = document.getElementById('cp-nom').value.trim();
      const pseudo = getPseudo();
      const maxJoueurs = parseInt(document.getElementById('cp-max-joueurs').value);
      const mechants = parseInt(document.getElementById('cp-mechants').value);

      if (!nom) { alert(t('vGiveGameName')); return; }
      if (mechants >= 2 && maxJoueurs < 7) {
        showNotif(t('need7For2Virus'), 'warn');
        return;
      }
      if (mechants >= 3 && maxJoueurs < 10) {
        showNotif(t('need10For3Virus'), 'warn');
        return;
      }
      if (maxJoueurs < 7 && (cpJournaliste || cpFanatique || cpEspion)) {
        if (cpJournaliste) { showNotif(t('notEnoughJournalist'), 'warn'); return; }
        if (cpFanatique) { showNotif(t('notEnoughFanatic'), 'warn'); return; }
        if (cpEspion) { showNotif(t('notEnoughSpy'), 'warn'); return; }
      }

      // Enregistrer le joueur sur Firebase
      var skin = getSkinFichier(getSkin());
      db.collection('players').doc(monPlayerId).set({
        playerId: monPlayerId, pseudo: pseudo, skin: skin,
        online: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).then(function() {
        // Creer la partie
        return db.collection('parties').add({
          nom: nom, hostPlayerId: monPlayerId, hostPseudo: pseudo,
          maxJoueurs: maxJoueurs, mechants: mechants,
          journaliste: cpJournaliste, fanatique: cpFanatique, espion: cpEspion,
          langue: cpLang, couleur: COULEURS_PARTIES[Math.floor(Math.random() * COULEURS_PARTIES.length)],
          phase: 'lobby', joueurs: 1, listeJoueurs: [pseudo],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }).then(function(docRef) {
        var partyId = docRef.id;
        // Ajouter le joueur host
        return db.collection('partyPlayers').add({
          partyId: partyId, playerId: monPlayerId, pseudo: pseudo, skin: skin,
          isHost: true, role: '', alive: true, x: 0, y: 0, direction: 1, saX: 50, saY: 70
        }).then(function(ppDoc) {
          myPartyPlayerDocId = ppDoc.id;
          document.getElementById('cp-nom').value = '';
          estHost = true;
          partieActuelleId = partyId;
          showScreen('salle-attente');
          subscribeToParty(partyId);
          updateSalleAttente();
        });
      }).catch(function(err) {
        showNotif('Erreur de connexion', 'warn');
      });
    }

    function rejoindrePartie(partieId) {
      var pseudo = getPseudo() || 'Joueur';
      var skin = getSkinFichier(getSkin());
      // Verifier que la partie est disponible
      db.collection('parties').doc(partieId).get().then(function(doc) {
        if (!doc.exists) { showNotif('Partie introuvable', 'warn'); return; }
        var party = doc.data();
        if (party.phase !== 'lobby') { showNotif(t('gameAlreadyStarted'), 'warn'); return; }
        if (party.joueurs >= party.maxJoueurs) { showNotif(t('gameFull'), 'warn'); return; }
        // Enregistrer le joueur
        return db.collection('players').doc(monPlayerId).set({
          playerId: monPlayerId, pseudo: pseudo, skin: skin,
          online: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(function() {
          // Ajouter a la partie
          return db.collection('partyPlayers').add({
            partyId: partieId, playerId: monPlayerId, pseudo: pseudo, skin: skin,
            isHost: false, role: '', alive: true, x: 0, y: 0, direction: 1, saX: 50, saY: 70
          });
        }).then(function(ppDoc) {
          myPartyPlayerDocId = ppDoc.id;
          // Mettre a jour le compteur
          return db.collection('parties').doc(partieId).update({
            joueurs: firebase.firestore.FieldValue.increment(1),
            listeJoueurs: firebase.firestore.FieldValue.arrayUnion(pseudo)
          });
        }).then(function() {
          estHost = false;
          partieActuelleId = partieId;
          showScreen('salle-attente');
          subscribeToParty(partieId);
          updateSalleAttente();
        });
      }).catch(function(err) {
        showNotif('Erreur de connexion', 'warn');
      });
    }

    function rafraichirListeParties() {
      const parties = getParties();
      const tbody = document.getElementById('lp-tbody');
      const vide = document.getElementById('lp-vide');
      const total = document.getElementById('lp-total');

      tbody.innerHTML = '';

      if (parties.length === 0) {
        vide.style.display = 'block';
        total.textContent = t('noGamesAvailable');
        return;
      }

      vide.style.display = 'none';
      total.textContent = t('gamesAvailable', parties.length, parties.length > 1 ? 's' : '', parties.length > 1 ? 's' : '');

      parties.forEach(function(p) {
        var pourcent = Math.round((p.joueurs / p.maxJoueurs) * 100);
        var couleurBarre = pourcent < 50 ? '#2ecc71' : pourcent < 80 ? '#f39c12' : '#e74c3c';

        var estPlein = p.joueurs >= p.maxJoueurs;
        var partyIdStr = p._id; // Firebase doc ID
        var hostPseudo = p.listeJoueurs && p.listeJoueurs.length > 0 ? p.listeJoueurs[0] : '?';
        var tr = document.createElement('tr');
        if (!p.enCours && !estPlein) {
          (function(pid) {
            tr.onclick = function() { rejoindrePartie(pid); };
          })(partyIdStr);
          tr.style.cursor = 'pointer';
        } else {
          tr.style.opacity = '0.6';
          tr.style.cursor = 'not-allowed';
        }
        tr.innerHTML =
          '<td>' +
            '<div class="lp-nom-partie">' +
              '<div class="lp-icone-partie" style="border:2px solid ' + p.couleur + '">&#128367;</div>' +
              '<div class="lp-nom-texte">' +
                '<span class="nom">' + p.nom.replace(/</g, '&lt;') + '</span>' +
                '<span class="host">Host: ' + hostPseudo.replace(/</g, '&lt;') + '</span>' +
              '</div>' +
            '</div>' +
          '</td>' +
          '<td>' +
            '<div class="lp-joueurs">' +
              '<div class="lp-barre-joueurs">' +
                '<div class="lp-barre-remplissage" style="width:' + pourcent + '%; background:' + couleurBarre + ';"></div>' +
              '</div>' +
              '<span class="lp-joueurs-texte">' + p.joueurs + '/' + p.maxJoueurs + '</span>' +
            '</div>' +
          '</td>' +
          '<td>' +
            '<div class="lp-mechants">' +
              '<div class="lp-virus-icone">&#9763;</div>' +
              '<span class="lp-mechants-texte">' + p.mechants + ' virus</span>' +
            '</div>' +
          '</td>' +
          '<td style="text-align:center">' +
            (p.enCours
              ? '<button class="btn-rejoindre" style="opacity:0.4;cursor:not-allowed;" disabled>' + t('inProgress') + '</button>'
              : estPlein
                ? '<button class="btn-rejoindre" style="opacity:0.4;cursor:not-allowed;background:#e74c3c;" disabled>' + t('gameFull') + '</button>'
                : '<button class="btn-rejoindre" data-partyid="' + partyIdStr + '">' + t('joinBtn') + '</button>') +
          '</td>';

        // Attacher le click handler au bouton rejoindre
        var btnRejoindre = tr.querySelector('.btn-rejoindre[data-partyid]');
        if (btnRejoindre) {
          (function(pid) {
            btnRejoindre.onclick = function(e) { e.stopPropagation(); rejoindrePartie(pid); };
          })(partyIdStr);
        }

        tbody.appendChild(tr);
      });
    }

    // Navigation entre ecrans
    var musiqueMuted = false;
    function toggleMusique() {
      var audio = document.getElementById('musique-menu');
      var btn = document.getElementById('btn-musique');
      if (!audio) return;
      if (musiqueMuted) {
        audio.play();
        btn.classList.remove('muted');
        btn.innerHTML = '&#9835;';
        musiqueMuted = false;
      } else {
        audio.pause();
        btn.classList.add('muted');
        btn.innerHTML = '&#9835;';
        musiqueMuted = true;
      }
    }

    function gererMusiqueMenu(ecranId) {
      var audio = document.getElementById('musique-menu');
      if (!audio) return;
      if (ecranId === 'jeu' || ecranId === 'salle-attente') {
        audio.pause();
        audio.currentTime = 0;
      } else {
        if (!musiqueMuted && audio.paused) {
          audio.play().catch(function() {});
        }
      }
    }

    function showNotif(message, type) {
      type = type || 'error';
      var container = document.getElementById('notif-container');
      if (!container) return;
      var toast = document.createElement('div');
      toast.className = 'notif-toast' + (type === 'info' ? ' info' : type === 'warn' ? ' warn' : '');
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(function() {
        toast.classList.add('fade-out');
        setTimeout(function() { toast.remove(); }, 400);
      }, 3000);
    }

    function choisirCampEspion(camp) {
      espionCamp = camp;
      var overlay = document.getElementById('espion-choix-overlay');
      if (overlay) overlay.style.display = 'none';

      if (camp === 'virus') {
        showNotif(t('joinedVirus'), 'warn');
        // Colorer les pseudos des virus en rouge (comme si on etait virus)
        for (var bv = 0; bv < bots.length; bv++) {
          if (bots[bv].role === 'virus') {
            var pseudoEl = bots[bv].element.querySelector('.joueur-pseudo');
            if (pseudoEl) pseudoEl.style.color = '#e74c3c';
          }
        }
        // Les virus voient l'espion en violet - pour les bots virus, on colore le pseudo du joueur
        // (pas applicable en mode local car le joueur ne se voit pas comme les bots le voient)
      } else {
        showNotif(t('joinedInnocent'), 'info');
      }
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      screen.classList.add('active', 'fade-in');
      setTimeout(() => screen.classList.remove('fade-in'), 300);

      // Gerer la musique du menu
      gererMusiqueMenu(id);

      // Rafraichir la liste quand on arrive sur l'ecran
      if (id === 'liste-parties') {
        rafraichirListeParties();
      }

      // Generer la boutique quand on l'ouvre
      if (id === 'boutique-skins') {
        genererBoutique();
      }

      // Mettre a jour l'avatar dans la salle d'attente
      if (id === 'salle-attente') {
        updateSalleAvatar();
        salleActif = true;
        saJoueurX = 50;
        saJoueurY = 70;
        updateSallePosition();
        if (salleAnimFrame) { cancelAnimationFrame(salleAnimFrame); salleAnimFrame = null; }
        salleLoop();
      } else {
        salleActif = false;
      }

      // Afficher/cacher le bouton amis
      var btnAmis = document.getElementById('btn-amis');
      if (btnAmis) {
        btnAmis.style.display = (id === 'ecran-compte' || modeHorsLigne) ? 'none' : 'flex';
      }
      // Fermer le panel amis si on change d'ecran
      if (panelAmisOuvert) {
        panelAmisOuvert = false;
        var panel = document.getElementById('panel-amis');
        if (panel) {
          panel.classList.remove('panel-amis-ouvert');
          panel.classList.add('panel-amis-ferme');
        }
      }
    }

    function updateSalleAvatar() {
      var pseudo = getPseudo() || t('player');
      var pseudoEl = document.getElementById('sa-avatar-pseudo');
      if (pseudoEl) {
        pseudoEl.textContent = pseudo;
        if (isAdmin()) {
          pseudoEl.classList.add('pseudo-admin-text');
        } else {
          pseudoEl.classList.remove('pseudo-admin-text');
        }
      }
      appliquerSkinPartout();
    }

    // (Cabines gerees par ouvrirCabine/fermerCabine plus haut)

    // Chat - Filtre de mots grossiers/familiers
    var MOTS_INTERDITS = [
      'merde', 'putain', 'bordel', 'connard', 'connasse', 'salaud', 'salope',
      'enculer', 'encule', 'enculee', 'nique', 'niquer', 'ntm', 'ntkm',
      'batard', 'batarde', 'fdp', 'fils de pute', 'pute', 'pd', 'pede',
      'bite', 'couille', 'couilles', 'chier', 'foutre', 'baiser',
      'con', 'conne', 'debile', 'abruti', 'abrutie', 'cretin', 'cretine',
      'idiot', 'idiote', 'imbecile', 'taree', 'tare', 'mongol', 'mongole',
      'ta gueule', 'ferme la', 'tg', 'stfu', 'fuck', 'shit', 'bitch',
      'ass', 'asshole', 'damn', 'wtf', 'wesh', 'bouffon', 'bouffonne',
      'naze', 'petasse', 'pouffiasse', 'enfoirer', 'enfoire', 'enfoiree',
      'trouduc', 'trou du cul', 'cul', 'degage', 'ta mere', 'ta race',
      'negro', 'negre', 'sale', 'gros porc', 'grosse', 'pig'
    ];

    function filtrerMessage(msg) {
      var msgFiltre = msg;
      for (var i = 0; i < MOTS_INTERDITS.length; i++) {
        var mot = MOTS_INTERDITS[i];
        var regex = new RegExp('\\b' + mot.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
        msgFiltre = msgFiltre.replace(regex, function(match) {
          var stars = '';
          for (var s = 0; s < match.length; s++) stars += '*';
          return stars;
        });
      }
      return msgFiltre;
    }

    // Chat
    function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;
      var msgFiltre = filtrerMessage(msg);
      input.value = '';

      if (partieActuelleId && !modeHorsLigne) {
        // Mode en ligne : envoyer via Firebase
        db.collection('chatMessages').add({
          partyId: partieActuelleId,
          playerId: monPlayerId,
          pseudo: getPseudo() || 'Joueur',
          message: msgFiltre,
          context: reunionEnCours ? 'meeting' : 'lobby',
          isSystem: false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(function() {});
      } else {
        // Mode hors ligne : affichage local
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'chat-msg';
        var monPseudo = getPseudo() || 'Vous';
        var pseudoClass = isAdmin() ? 'pseudo pseudo-admin-text' : 'pseudo';
        var pseudoStyle = isAdmin() ? '' : ' style="color:#e74c3c"';
        div.innerHTML = '<span class="' + pseudoClass + '"' + pseudoStyle + '>[' + monPseudo.replace(/</g, '&lt;') + ']:</span> <span class="texte">' + msgFiltre.replace(/</g, '&lt;') + '</span>';
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        try { var sChat = new Audio(Math.random() < 0.5 ? 'chat1.mp3' : 'chat2.mp3'); sChat.volume = 0.4; sChat.play(); } catch(e) {}
      }
    }

    // ============================
    // SYSTEME DE TRADUCTION
    // ============================
    var currentLang = localStorage.getItem('virus_lang') || 'fr';

    var TR = {
      fr: {
        // UI Boutons
        back: '\u25C4 RETOUR',
        settings: 'PARAMETRES',
        confirm: 'CONFIRMER',
        cancel: 'ANNULER',
        save: 'SAUVER',
        quit: 'QUITTER',
        play: 'C\'EST PARTI !',
        launch: 'LANCER LA PARTIE',
        create: 'CREER LA PARTIE',
        join: 'REJOINDRE',
        refresh: 'ACTUALISER',
        equip: 'EQUIPER',
        equipped: 'EQUIPE',
        buy: 'ACHETER',
        skinsTab: 'SKINS',
        close: 'FERMER',
        gotIt: 'COMPRIS',
        skip: 'SKIP',
        cont: 'CONTINUER',
        mainMenu: 'MENU PRINCIPAL',
        add: 'AJOUTER',
        accept: 'ACCEPTER',
        refuse: 'REFUSER',
        start: 'DEMARRER',
        callMeeting: 'APPELER UNE REUNION',
        doTask: 'FAIRE LA TACHE',
        kill: 'KILL',
        report: 'SIGNALER',
        investigate: 'ENQUETER',
        cameras: 'CAMERAS',
        confirmSkin: 'CONFIRMER LE SKIN',
        deleteAccount: 'SUPPRIMER MON COMPTE',

        // Titres / Labels
        createAccount: 'CREER TON COMPTE',
        chooseNickname: 'Choisis un pseudo pour jouer',
        account: 'COMPTE',
        pseudo: 'PSEUDO',
        skin: 'SKIN',
        shop: 'BOUTIQUE',
        rules: 'REGLES DU JEU',
        online: 'ONLINE',
        offline: 'HORS LIGNE',
        offlineLabel: 'Hors ligne',
        onlineLabel: 'En ligne',
        requestsLabel: 'Demandes',
        config: 'CONFIGURATION',
        gameSettings: 'PARAMETRES DE LA PARTIE',
        missions: 'MISSIONS',
        emergencyMeeting: 'REUNION D\'URGENCE',
        fittingRoom: 'CABINE D\'ESSAYAGE',
        friends: 'AMIS',
        players: 'JOUEURS',
        chat: 'CHAT',
        waitingRoom: 'SALLE D\'ATTENTE',
        newGame: 'NOUVELLE PARTIE',
        waitingGames: 'PARTIES EN ATTENTE',
        skinsAndAccs: 'SKINS & ACCESSOIRES',
        changeSkin: 'CHANGEZ DE SKIN',
        chooseSkin: 'Choisis ton skin !',
        gameName: 'NOM DE LA PARTIE',
        maxPlayers: 'NOMBRE MAX DE JOUEURS',
        nbVillains: 'NOMBRE DE MECHANTS (VIRUS)',
        nbPlayers: 'NOMBRE DE JOUEURS',
        nbVirus: 'NOMBRE DE VIRUS',
        journalist: 'JOURNALISTE',
        fanaticNeutral: 'FANATIQUE (NEUTRE)',
        spyNeutral: 'ESPION (NEUTRE)',
        joinOrCreate: 'Rejoindre ou creer une partie',
        playWithBots: 'Jouer avec des bots',
        skinsAccs: 'Skins et accessoires',
        inviteFriends: 'Invitez vos amis a rejoindre',
        or: 'OU',
        joinExisting: 'Rejoindre une partie existante',
        createDesc: 'Creez votre propre partie et invitez vos amis, ou rejoignez une partie existante.',
        createGame: 'CREER UNE PARTIE',
        findGame: 'TROUVER UNE PARTIE',
        waiting: 'En attente...',
        hostOnly: '(Host uniquement)',
        waitingForHost: 'En attente du host pour demarrer...',
        savedAuto: 'Les changements sont sauvegardes automatiquement.<br>VIRUS v0.1 - ALPHA',
        noGamesWaiting: 'Aucune partie en attente pour le moment. Creez-en une depuis le menu online !',
        game: 'PARTIE',
        villains: 'MECHANTS',
        noPendingRequests: 'Aucune demande en attente.',
        securityCams: 'CAMERAS DE SECURITE',

        // Roles
        roleVirus: 'VIRUS',
        roleInnocent: 'INNOCENT',
        roleJournalist: 'JOURNALISTE',
        roleFanatic: 'FANATIQUE',
        roleSpy: 'ESPION',
        oneJournalist: '1 JOURNALISTE',
        zeroJournalist: '0 JOURNALISTE',
        oneFanatic: '1 FANATIQUE',
        zeroFanatic: '0 FANATIQUE',
        oneSpy: '1 ESPION',
        zeroSpy: '0 ESPION',

        // Notifications
        pseudoTaken: 'Ce pseudo est deja utilise ! Choisis-en un autre.',
        pseudoTakenKeep: 'Ce pseudo est deja utilise ! Ton pseudo reste : {0}',
        need7For2Virus: 'Il faut au moins 7 joueurs pour avoir 2 virus !',
        need10For3Virus: 'Il faut au moins 10 joueurs pour avoir 3 virus !',
        joinedVirus: 'Tu as rejoint le camp des VIRUS ! Tu peux voir les virus.',
        joinedInnocent: 'Tu as rejoint le camp des INNOCENTS ! Complete tes missions.',
        notEnoughJournalist: 'Il faut au moins 7 joueurs pour ajouter un journaliste !',
        notEnoughFanatic: 'Il faut au moins 7 joueurs pour ajouter un fanatique !',
        notEnoughSpy: 'Il faut au moins 7 joueurs pour ajouter un espion !',
        'notif.musicPurchased': 'Musique "{0}" achetee !',
        youAreVirusAllies: 'Tu es VIRUS ! Tes allies : {0}',
        youAreOnlyVirus: 'Tu es le seul VIRUS ! Infecte tout le monde sans te faire reperer.',
        youAreJournalist: 'Tu es le JOURNALISTE ! Tu as {0} enquete(s) disponible(s).',
        youAreFanatic: 'Tu es le FANATIQUE ! Si tu te fais eliminer, la partie se termine et tu gagnes !',
        youAreSpy: 'Tu es l\'ESPION ! Choisis ton camp...',
        youAreInnocent: 'Tu es INNOCENT. Complete tes missions et survis !',
        need4Players: 'Il faut au moins 4 joueurs pour demarrer une partie !',
        gameAlreadyStarted: 'Cette partie est deja en cours !',
        gameFull: 'MAX',
        playerJoined: '{0} a rejoint la partie',
        playerLeft: '{0} a quitte la partie',
        newHost: '{0} est le nouveau host',
        joinBtn: 'REJOINDRE',
        virusAdjusted: 'Nombre de virus ajuste a {0} (pas assez de joueurs pour {1})',
        youAreTheVirus: 'Tu es le VIRUS ! Infecte tout le monde sans te faire reperer.',
        ghostsCantMeet: 'Les fantomes ne peuvent pas appeler de reunion !',
        waitBeforeMeeting: 'Tu dois attendre avant de relancer une reunion !',
        emergencyMeetingNotif: 'Reunion d\'urgence !',
        useInfoWisely: 'Utilise cette information a bon escient !',
        ghostsCantVote: 'Les fantomes ne peuvent pas voter !',
        wasTheFanatic: '{0} etait le FANATIQUE ! La partie est terminee !',
        youEliminatedFanatic: 'Tu as ete elimine en tant que FANATIQUE ! Tu as gagne !',
        playerIs: '{0} est {1} !',
        allInvestigationsUsed: 'Tu as utilise toutes tes enquetes !',
        youInfected: 'Tu as infecte {0}...',
        playerDied: '{0} est mort !',
        bodyReported: 'Cadavre de {0} signale ! Reunion d\'urgence !',
        virusInfectedYou: 'Un virus t\'a infecte ! Tu mourras dans 5 secondes...',
        diedAsFanatic: 'Tu es mort en tant que FANATIQUE ! Tu as gagne !',
        youDiedGhost: 'Tu es mort ! Tu es maintenant un fantome.',
        foundBodyOf: '{0} a trouve le cadavre de {1} !',
        ghostsCantTalk: 'Les fantomes ne peuvent pas parler !',
        missionDone: 'Mission accomplie : {0}',
        allMissionsComplete: 'Toutes les missions sont completes !',
        youFinishedMissions: 'Tu as fini toutes tes missions !',
        enterPseudo: 'Entre un pseudo !',
        connecting: 'Connexion en cours...',
        cantAddSelf: 'Tu ne peux pas t\'ajouter toi-meme !',
        alreadyFriend: 'Deja dans ta liste d\'amis !',
        pseudoNotFound: 'Rien trouve ! Ce pseudo n\'existe pas.',
        requestAlreadySent: 'Demande deja envoyee !',
        requestSentTo: 'Demande envoyee a {0} !',
        connectionError: 'Erreur de connexion',
        nowYourFriend: '{0} est maintenant ton ami !',
        requestRefused: 'Demande refusee.',
        friendRequestFrom: 'Demande d\'ami de {0}',
        mustBeInGame: 'Tu dois etre dans une partie pour inviter !',
        inviteSentTo: 'Invitation envoyee a {0} !',

        // Reunion / Meeting
        meetDead: 'Morts : {0}',
        meetYouAreGhost: 'Tu es un fantome. Tu ne peux pas voter.',
        meetEmergency: 'Reunion d\'urgence ! Cliquez sur un joueur pour voter ou SKIP.',
        meetVoted: 'a vote !',
        meetSkipped: 'a passe son vote.',
        meetBotVoted: 'a vote.',
        meetNoElim: 'Aucune elimination. La partie continue.',
        meetWasVirus: '{0} etait un VIRUS !',
        meetWasJournalist: '{0} etait le JOURNALISTE...',
        meetWasFanatic: '{0} etait le FANATIQUE ! Il a gagne ! La partie est terminee !',
        meetWasSpy: '{0} etait l\'ESPION !',
        meetWasInnocent: '{0} etait un INNOCENT...',
        meetNobodyElim: 'Personne n\'a ete elimine.',
        meetWasVirusRole: 'C\'etait un VIRUS !',
        meetWasJournalistRole: 'C\'etait le JOURNALISTE...',
        meetWasFanaticRole: 'C\'etait le FANATIQUE !',
        meetWasSpyRole: 'C\'etait l\'ESPION !',
        meetWasInnocentRole: 'C\'etait un INNOCENT...',

        // Victoire
        virusVictory: 'VICTOIRE DES VIRUS',
        virusVictoryDesc: 'Les virus ont pris le controle du centre commercial ! Il y a autant de virus que de survivants...',
        fanaticVictory: 'VICTOIRE DU FANATIQUE',
        innocentsVictory: 'VICTOIRE DES INNOCENTS',
        missionsVictoryDesc: 'Toutes les missions ont ete completees ! Les innocents et journalistes ont sauve le centre commercial !',
        virusEliminatedDesc: 'Tous les virus ont ete elimines ! Le centre commercial est sauve !',
        missionsLabel: 'MISSIONS : {0}/{1} ({2}%)',
        youWin: 'VICTOIRE !',
        youLose: 'DEFAITE...',
        total: 'Total : {0} joueurs',
        innocentsCount: 'Innocents : {0}',
        virusCount: 'Virus : {0}',
        journalistCount: 'Journaliste : {0}',
        fanaticCount: 'Fanatique : {0}',
        spyCount: 'Espion : {0}',

        // Espion
        spyChooseTitle: 'TU ES L\'ESPION',
        spyChooseDesc: 'Choisis ton camp ! Tu gagneras avec le camp que tu choisis.',
        spyBtnInnocent: 'INNOCENT',
        spyBtnVirus: 'VIRUS',

        // Validation / Alert
        vChoosePseudo: 'Choisis un pseudo !',
        vPseudoTooShort: 'Pseudo trop court (2 caracteres minimum) !',
        vPseudoEmpty: 'Le pseudo ne peut pas etre vide !',
        vPseudoShort: 'Pseudo trop court !',
        vDeleteAccount: 'Supprimer ton compte ? Ton pseudo, tes parties, ton or et tes skins seront effaces!',
        vGiveGameName: 'Donne un nom a ta partie !',

        // Placeholders
        phPseudo: 'Entre ton pseudo...',
        phNewPseudo: 'Nouveau pseudo...',
        phGameName: 'Ex: Ma super partie',
        phChat: 'Ecrire ici...',
        phChatReunion: 'Discutez ici...',
        phFriendSearch: 'Pseudo du joueur...',

        // Boutiques du mall
        shopFashion: 'BOUTIQUE MODE',
        shopPharmacy: 'PHARMACIE',
        shopBookstore: 'LIBRAIRIE',
        shopGym: 'SALLE DE SPORT',
        shopJewelry: 'BIJOUTERIE',
        shopTech: 'TECH & ELECTRONIQUE',
        shopCinema: 'CINEMA MULTIPLEX',
        shopRestaurant: 'RESTAURANT',
        shopSupermarket: 'SUPERMARCHE GEANT',
        shopVideoGames: 'MAGASIN DE JEUX VIDEO',
        shopGarden: 'JARDINERIE',
        shopFurniture: 'MEUBLES & DECO',
        shopSportGoods: 'ARTICLES DE SPORT',
        shopPerfume: 'PARFUMERIE',
        shopTravel: 'AGENCE DE VOYAGE',
        shopSecurity: 'POSTE DE SECURITE',
        shopCafe: 'CAFE DU CENTRE',
        shopNewsstand: 'KIOSQUE A JOURNAUX',
        shopOptician: 'OPTICIEN',
        shopArcade: 'SALLE D\'ARCADE',
        shopBowling: 'BOWLING',
        shopPetStore: 'ANIMALERIE',
        shopPastry: 'PATISSERIE',
        shopOrganic: 'BIO & NATURE',
        shopTea: 'SALON DE THE',
        shopFoodCourt: 'FOOD COURT',
        shopToiletSouth: 'TOILETTES SUD',
        shopToiletSE: 'TOILETTES SUD-EST',
        shopToiletNorth: 'TOILETTES NORD',

        // Mall
        mainEntranceSouth: 'ENTREE PRINCIPALE SUD',
        entranceNorth: 'ENTREE NORD',
        exitWest: 'SORTIE OUEST',
        exitEast: 'SORTIE EST',
        parkingA: 'PARKING A',
        parkingB: 'PARKING B',
        centralFountain: 'FONTAINE CENTRALE',
        entrance: 'ENTREE',
        drinks: 'BOISSONS',

        // Regles
        rule1Title: 'Le Virus se propage',
        rule1Desc: 'Un joueur est infecte et doit contaminer les autres dans le centre commercial.',
        rule2Title: 'Accomplir les missions',
        rule2Desc: 'Les sains doivent completer leurs taches dans les boutiques pour gagner.',
        rule3Title: 'Voter pour eliminer',
        rule3Desc: 'Signalez les suspects ! Votez ensemble pour demasquer le virus.',
        rule4Title: 'Survivre ou infecter',
        rule4Desc: 'Sains : terminez les missions ou trouvez le virus. Virus : infectez tout le monde !',
        rule5Title: 'Devenir un fantome',
        rule5Desc: 'Si vous etes infecte, apres 5 secondes vous devenez un fantome invisible.',
        rule6Title: 'Le Journaliste enquete',
        rule6Desc: 'Le journaliste peut enqueter sur les joueurs pour decouvrir s\'ils sont virus ou non.',
        rule7Title: 'Le Fanatique (neutre)',
        rule7Desc: 'Son but : se faire eliminer ! S\'il meurt, la partie se termine et il gagne avec l\'espion.',
        rule8Title: 'L\'Espion (neutre)',
        rule8Desc: 'Il choisit un camp au debut. S\'il choisit virus, il les voit mais ne peut pas etre tue par eux. Il gagne avec son camp. Si le fanatique gagne, l\'espion gagne aussi !',

        // Divers
        inProgress: 'EN COURS...',
        system: 'SYSTEME',
        player: 'Joueur',
        noGame: '0 partie disponible',
        nPlayers: '{0} joueurs',
        nVirus: '{0} virus',
        fanaticWonWith: '{0} etait le FANATIQUE ! Il a reussi a se faire eliminer et remporte la partie avec l\'ESPION !',
        wasEliminated: '{0} a ete elimine !',
        inviteToJoin: '{0} t\'invite a rejoindre sa partie !',
        noFriendsYet: 'Aucun ami pour le moment.<br>Ajoute des joueurs avec leur pseudo !',
        noFriendsOnline: 'Aucun ami en ligne.',
        noFriendsOffline: 'Aucun ami hors ligne.',
        langLabel: 'LANGUE',
        locker: 'CASIER',
        changeSkin: 'Changer de skin',
        totalPlayers: 'Total :',
        players: 'joueurs',
        innocentsLabel: 'Innocents :',
        virusLabel: 'Virus :',
        journalistLabel: 'Journaliste :',
        fanaticLabel: 'Fanatique :',
        spyLabel: 'Espion :',
        fanaticRole: 'FANATIQUE',
        spyRole: 'ESPION',
        musicTab: 'MUSIQUE',
        chooseMusic: 'Choisis ta musique !',
        hudControls: 'ZQSD ou Fleches pour se deplacer',
        inProgress: 'EN COURS...',
        noGamesAvailable: '0 partie disponible',
        gamesAvailable: '{0} partie{1} disponible{2}',
        need10For3VirusTip: 'Il faut au moins 10 joueurs pour 3 virus',
        need7For2VirusTip: 'Il faut au moins 7 joueurs pour 2 virus',
        youChoseVirus: 'Tu as choisi <b>{0}</b> virus',
        playerRoles: 'ROLES DES JOUEURS :',
        youLabel: '(toi)',
        botAccusation: [
          'Je suis sur que c\'est {c} le virus !',
          '{c} etait bizarre tout a l\'heure...',
          'J\'ai vu {c} trainer pres du cadavre',
          'Moi je vote {c}, il est trop suspect',
          '{c} m\'a suivi pendant un moment, c\'est louche',
          'Quelqu\'un d\'autre a vu {c} agir bizarrement ?',
          '{c} etait tout seul dans le couloir...',
          'Je parie que c\'est {c} le virus',
          'peut-etre que c\'est {c}',
          'Peut-etre que c\'est {c} le fanatique...',
          'Peut-etre que c\'est {c} l\'espion ...'
        ],
        botDefense: [
          'C\'est pas moi je le jure !',
          'J\'etais en train de faire mes missions',
          'Je suis innocent, j\'ai rien fait',
          'Arretez de m\'accuser svp',
          'J\'etais a l\'autre bout de la map',
          'Vous pouvez me faire confiance',
          'Pourquoi moi ? J\'ai rien fait de suspect',
          'je suis inocent je vous le jure !'
        ],
        botReaction: [
          'Hmm c\'est suspect ca...',
          'Je ne sais pas trop...',
          'On devrait skip si on est pas sur',
          'Quelqu\'un a des preuves ?',
          'Moi j\'ai rien vu de special',
          'C\'est tendu la...',
          'Faut pas se tromper de vote',
          'Qui a decouvert le corps ?',
          'On vote ou on skip ?',
          'J\'ai fait toutes mes missions moi',
          'Je pense pas.',
          'Je suis d\'accord.',
          'Moi je dis qu\'on devrait skip',
          'Pas assez de preuves pour voter quelqu\'un',
          'C\'est peut-etre un self-report non ?',
          'Faut pas voter au hasard les gars',
          'Je pense que c\'est quelqu\'un d\'autre...',
          'wsh',
          'Peut-etre',
          'vous n\'avez pas assez preuve pour me convaincre',
          'euh...'
        ],
        botVirus: [
          'Moi je dis qu\'on devrait skip',
          'Pas assez de preuves pour voter quelqu\'un',
          'C\'est peut-etre un self-report non ?',
          'Faut pas voter au hasard les gars',
          'Je pense que c\'est quelqu\'un d\'autre...',
          'et c\'etait le fanatique ?'
        ],
        botJournalist: [
          'J\'ai enquete sur {c}, je vous dis pas le resultat...',
          'Mon enquete montre que {c} est clean',
          'Faites-moi confiance, j\'ai des infos',
          'J\'ai verifie quelqu\'un, c\'est pas lui le virus',
          'D\'apres mon enquete, il faut voter {c}',
          'Je suis journaliste, je sais de quoi je parle',
          'J\'ai des preuves contre {c} !',
          'Mon enquete innocente {c}, cherchez ailleurs'
        ],
        botFanatic: [
          'Votez moi si vous voulez, je m\'en fiche',
          'Allez-y, eliminez-moi, ca me derange pas',
          'Moi je suis suspect ? Tant mieux !',
          'Je suis clairement louche, votez moi',
          'Honnetement, je suis le plus suspect ici',
          'C\'est moi le coupable, votez !',
          'J\'avoue j\'ai un comportement bizarre',
          'J\'ai traine pres du cadavre !'
        ],
        botSpy: [
          'Je reste discret, j\'observe tout le monde...',
          'J\'ai des infos mais je prefere les garder pour moi',
          'Faites attention, rien n\'est ce qu\'il parait ici',
          'Je suis dans mon propre camp, ne vous fiez pas a moi',
          'J\'ai choisi mon camp et je m\'y tiens',
          'Je sais des choses que vous ignorez...',
          'Mon role est plus complexe que vous ne le pensez',
          'Je ne suis ni avec vous, ni contre vous',
          '{c} cache quelque chose, j\'en suis certain',
          'Je joue mon propre jeu, ne m\'incluez pas dans vos plans'
        ],
        botComment: [
          'wsh wsh canne a peche.',
          'aller votez !',
          'je vais faire mes taches apres',
          'voter avec moi !',
          'courage les amis',
          'Ne vous trompez pas',
          'Lets go !'
        ]
      },

      en: {
        // UI Buttons
        back: '\u25C4 BACK',
        settings: 'SETTINGS',
        confirm: 'CONFIRM',
        cancel: 'CANCEL',
        save: 'SAVE',
        quit: 'QUIT',
        play: 'LET\'S GO!',
        launch: 'START GAME',
        create: 'CREATE GAME',
        join: 'JOIN',
        refresh: 'REFRESH',
        equip: 'EQUIP',
        equipped: 'EQUIPPED',
        buy: 'BUY',
        skinsTab: 'SKINS',
        close: 'CLOSE',
        gotIt: 'GOT IT',
        skip: 'SKIP',
        cont: 'CONTINUE',
        mainMenu: 'MAIN MENU',
        add: 'ADD',
        accept: 'ACCEPT',
        refuse: 'REFUSE',
        start: 'START',
        callMeeting: 'CALL A MEETING',
        doTask: 'DO THE TASK',
        kill: 'KILL',
        report: 'REPORT',
        investigate: 'INVESTIGATE',
        cameras: 'CAMERAS',
        confirmSkin: 'CONFIRM SKIN',
        deleteAccount: 'DELETE MY ACCOUNT',

        // Titles / Labels
        createAccount: 'CREATE YOUR ACCOUNT',
        chooseNickname: 'Choose a nickname to play',
        account: 'ACCOUNT',
        pseudo: 'NICKNAME',
        skin: 'SKIN',
        shop: 'SHOP',
        rules: 'GAME RULES',
        online: 'ONLINE',
        offline: 'OFFLINE',
        offlineLabel: 'Offline',
        onlineLabel: 'Online',
        requestsLabel: 'Requests',
        config: 'CONFIGURATION',
        gameSettings: 'GAME SETTINGS',
        missions: 'MISSIONS',
        emergencyMeeting: 'EMERGENCY MEETING',
        fittingRoom: 'FITTING ROOM',
        friends: 'FRIENDS',
        players: 'PLAYERS',
        chat: 'CHAT',
        waitingRoom: 'WAITING ROOM',
        newGame: 'NEW GAME',
        waitingGames: 'WAITING GAMES',
        skinsAndAccs: 'SKINS & ACCESSORIES',
        changeSkin: 'CHANGE YOUR SKIN',
        chooseSkin: 'Choose your skin!',
        gameName: 'GAME NAME',
        maxPlayers: 'MAX PLAYERS',
        nbVillains: 'NUMBER OF VILLAINS (VIRUSES)',
        nbPlayers: 'NUMBER OF PLAYERS',
        nbVirus: 'NUMBER OF VIRUSES',
        journalist: 'JOURNALIST',
        fanaticNeutral: 'FANATIC (NEUTRAL)',
        spyNeutral: 'SPY (NEUTRAL)',
        joinOrCreate: 'Join or create a game',
        playWithBots: 'Play with bots',
        skinsAccs: 'Skins and accessories',
        inviteFriends: 'Invite your friends to join',
        or: 'OR',
        joinExisting: 'Join an existing game',
        createDesc: 'Create your own game and invite your friends, or join an existing game.',
        createGame: 'CREATE A GAME',
        findGame: 'FIND A GAME',
        waiting: 'Waiting...',
        hostOnly: '(Host only)',
        waitingForHost: 'Waiting for host to start...',
        savedAuto: 'Changes are saved automatically.<br>VIRUS v0.1 - ALPHA',
        noGamesWaiting: 'No games waiting right now. Create one from the online menu!',
        game: 'GAME',
        villains: 'VILLAINS',
        noPendingRequests: 'No pending requests.',
        securityCams: 'SECURITY CAMERAS',

        // Roles
        roleVirus: 'VIRUS',
        roleInnocent: 'INNOCENT',
        roleJournalist: 'JOURNALIST',
        roleFanatic: 'FANATIC',
        roleSpy: 'SPY',
        oneJournalist: '1 JOURNALIST',
        zeroJournalist: '0 JOURNALIST',
        oneFanatic: '1 FANATIC',
        zeroFanatic: '0 FANATIC',
        oneSpy: '1 SPY',
        zeroSpy: '0 SPY',

        // Notifications
        pseudoTaken: 'This nickname is already taken! Choose another one.',
        pseudoTakenKeep: 'This nickname is already taken! Your nickname remains: {0}',
        need7For2Virus: 'You need at least 7 players to have 2 viruses!',
        need10For3Virus: 'You need at least 10 players to have 3 viruses!',
        joinedVirus: 'You joined the VIRUS team! You can see the viruses.',
        joinedInnocent: 'You joined the INNOCENTS team! Complete your missions.',
        notEnoughJournalist: 'You need at least 7 players to add a journalist!',
        notEnoughFanatic: 'You need at least 7 players to add a fanatic!',
        notEnoughSpy: 'You need at least 7 players to add a spy!',
        'notif.musicPurchased': 'Music "{0}" purchased!',
        youAreVirusAllies: 'You are VIRUS! Your allies: {0}',
        youAreOnlyVirus: 'You are the only VIRUS! Infect everyone without getting caught.',
        youAreJournalist: 'You are the JOURNALIST! You have {0} investigation(s) available.',
        youAreFanatic: 'You are the FANATIC! If you get eliminated, the game ends and you win!',
        youAreSpy: 'You are the SPY! Choose your side...',
        youAreInnocent: 'You are INNOCENT. Complete your missions and survive!',
        need4Players: 'You need at least 4 players to start a game!',
        gameAlreadyStarted: 'This game has already started!',
        gameFull: 'FULL',
        playerJoined: '{0} joined the game',
        playerLeft: '{0} left the game',
        newHost: '{0} is the new host',
        joinBtn: 'JOIN',
        virusAdjusted: 'Number of viruses adjusted to {0} (not enough players for {1})',
        youAreTheVirus: 'You are the VIRUS! Infect everyone without getting caught.',
        ghostsCantMeet: 'Ghosts cannot call a meeting!',
        waitBeforeMeeting: 'You must wait before calling another meeting!',
        emergencyMeetingNotif: 'Emergency meeting!',
        useInfoWisely: 'Use this information wisely!',
        ghostsCantVote: 'Ghosts cannot vote!',
        wasTheFanatic: '{0} was the FANATIC! The game is over!',
        youEliminatedFanatic: 'You were eliminated as FANATIC! You won!',
        playerIs: '{0} is {1}!',
        allInvestigationsUsed: 'You used all your investigations!',
        youInfected: 'You infected {0}...',
        playerDied: '{0} is dead!',
        bodyReported: 'Body of {0} reported! Emergency meeting!',
        virusInfectedYou: 'A virus infected you! You will die in 5 seconds...',
        diedAsFanatic: 'You died as FANATIC! You won!',
        youDiedGhost: 'You died! You are now a ghost.',
        foundBodyOf: '{0} found the body of {1}!',
        ghostsCantTalk: 'Ghosts cannot speak!',
        missionDone: 'Mission accomplished: {0}',
        allMissionsComplete: 'All missions are complete!',
        youFinishedMissions: 'You finished all your missions!',
        enterPseudo: 'Enter a nickname!',
        connecting: 'Connecting...',
        cantAddSelf: 'You cannot add yourself!',
        alreadyFriend: 'Already in your friends list!',
        pseudoNotFound: 'Nothing found! This nickname does not exist.',
        requestAlreadySent: 'Request already sent!',
        requestSentTo: 'Request sent to {0}!',
        connectionError: 'Connection error',
        nowYourFriend: '{0} is now your friend!',
        requestRefused: 'Request refused.',
        friendRequestFrom: 'Friend request from {0}',
        mustBeInGame: 'You must be in a game to invite!',
        inviteSentTo: 'Invitation sent to {0}!',

        // Meeting
        meetDead: 'Dead: {0}',
        meetYouAreGhost: 'You are a ghost. You cannot vote.',
        meetEmergency: 'Emergency meeting! Click on a player to vote or SKIP.',
        meetVoted: 'voted!',
        meetSkipped: 'skipped their vote.',
        meetBotVoted: 'voted.',
        meetNoElim: 'No elimination. The game continues.',
        meetWasVirus: '{0} was a VIRUS!',
        meetWasJournalist: '{0} was the JOURNALIST...',
        meetWasFanatic: '{0} was the FANATIC! He won! The game is over!',
        meetWasSpy: '{0} was the SPY!',
        meetWasInnocent: '{0} was an INNOCENT...',
        meetNobodyElim: 'Nobody was eliminated.',
        meetWasVirusRole: 'It was a VIRUS!',
        meetWasJournalistRole: 'It was the JOURNALIST...',
        meetWasFanaticRole: 'It was the FANATIC!',
        meetWasSpyRole: 'It was the SPY!',
        meetWasInnocentRole: 'It was an INNOCENT...',

        // Victory
        virusVictory: 'VIRUS VICTORY',
        virusVictoryDesc: 'The viruses took control of the mall! There are as many viruses as survivors...',
        fanaticVictory: 'FANATIC VICTORY',
        innocentsVictory: 'INNOCENTS VICTORY',
        missionsVictoryDesc: 'All missions have been completed! The innocents and journalists saved the mall!',
        virusEliminatedDesc: 'All viruses have been eliminated! The mall is saved!',
        missionsLabel: 'MISSIONS: {0}/{1} ({2}%)',
        youWin: 'VICTORY!',
        youLose: 'DEFEAT...',
        total: 'Total: {0} players',
        innocentsCount: 'Innocents: {0}',
        virusCount: 'Viruses: {0}',
        journalistCount: 'Journalist: {0}',
        fanaticCount: 'Fanatic: {0}',
        spyCount: 'Spy: {0}',

        // Spy
        spyChooseTitle: 'YOU ARE THE SPY',
        spyChooseDesc: 'Choose your side! You will win with the side you choose.',
        spyBtnInnocent: 'INNOCENT',
        spyBtnVirus: 'VIRUS',

        // Validation / Alert
        vChoosePseudo: 'Choose a nickname!',
        vPseudoTooShort: 'Nickname too short (2 characters minimum)!',
        vPseudoEmpty: 'Nickname cannot be empty!',
        vPseudoShort: 'Nickname too short!',
        vDeleteAccount: 'Delete your account? Your nickname, games, gold and skins will be erased.',
        vGiveGameName: 'Give your game a name!',

        // Placeholders
        phPseudo: 'Enter your nickname...',
        phNewPseudo: 'New nickname...',
        phGameName: 'Ex: My awesome game',
        phChat: 'Type here...',
        phChatReunion: 'Chat here...',
        phFriendSearch: 'Player nickname...',

        // Mall shops
        shopFashion: 'FASHION STORE',
        shopPharmacy: 'PHARMACY',
        shopBookstore: 'BOOKSTORE',
        shopGym: 'GYM',
        shopJewelry: 'JEWELRY STORE',
        shopTech: 'TECH & ELECTRONICS',
        shopCinema: 'MULTIPLEX CINEMA',
        shopRestaurant: 'RESTAURANT',
        shopSupermarket: 'GIANT SUPERMARKET',
        shopVideoGames: 'VIDEO GAME STORE',
        shopGarden: 'GARDEN CENTER',
        shopFurniture: 'FURNITURE & DECOR',
        shopSportGoods: 'SPORTING GOODS',
        shopPerfume: 'PERFUME SHOP',
        shopTravel: 'TRAVEL AGENCY',
        shopSecurity: 'SECURITY POST',
        shopCafe: 'CENTER CAFE',
        shopNewsstand: 'NEWSSTAND',
        shopOptician: 'OPTICIAN',
        shopArcade: 'ARCADE ROOM',
        shopBowling: 'BOWLING',
        shopPetStore: 'PET STORE',
        shopPastry: 'PASTRY SHOP',
        shopOrganic: 'ORGANIC & NATURE',
        shopTea: 'TEA ROOM',
        shopFoodCourt: 'FOOD COURT',
        shopToiletSouth: 'SOUTH RESTROOMS',
        shopToiletSE: 'SOUTHEAST RESTROOMS',
        shopToiletNorth: 'NORTH RESTROOMS',

        // Mall
        mainEntranceSouth: 'MAIN SOUTH ENTRANCE',
        entranceNorth: 'NORTH ENTRANCE',
        exitWest: 'WEST EXIT',
        exitEast: 'EAST EXIT',
        parkingA: 'PARKING A',
        parkingB: 'PARKING B',
        centralFountain: 'CENTRAL FOUNTAIN',
        entrance: 'ENTRANCE',
        drinks: 'DRINKS',

        // Rules
        rule1Title: 'The Virus Spreads',
        rule1Desc: 'A player is infected and must contaminate others in the mall.',
        rule2Title: 'Complete the Missions',
        rule2Desc: 'The healthy must complete their tasks in the shops to win.',
        rule3Title: 'Vote to Eliminate',
        rule3Desc: 'Report suspects! Vote together to unmask the virus.',
        rule4Title: 'Survive or Infect',
        rule4Desc: 'Healthy: finish the missions or find the virus. Virus: infect everyone!',
        rule5Title: 'Become a Ghost',
        rule5Desc: 'If you are infected, after 5 seconds you become an invisible ghost.',
        rule6Title: 'The Journalist Investigates',
        rule6Desc: 'The journalist can investigate players to find out if they are viruses or not.',
        rule7Title: 'The Fanatic (neutral)',
        rule7Desc: 'His goal: get eliminated! If he dies, the game ends and he wins with the spy.',
        rule8Title: 'The Spy (neutral)',
        rule8Desc: 'He chooses a side at the start. If he chooses virus, he sees them but cannot be killed by them. He wins with his side. If the fanatic wins, the spy also wins!',

        // Misc
        inProgress: 'IN PROGRESS...',
        system: 'SYSTEM',
        player: 'Player',
        noGame: '0 game available',
        nPlayers: '{0} players',
        nVirus: '{0} viruses',
        fanaticWonWith: '{0} was the FANATIC! He got eliminated and wins the game with the SPY!',
        wasEliminated: '{0} was eliminated!',
        inviteToJoin: '{0} invites you to join their game!',
        noFriendsYet: 'No friends yet.<br>Add players with their nickname!',
        noFriendsOnline: 'No friends online.',
        noFriendsOffline: 'No friends offline.',
        langLabel: 'LANGUAGE',
        locker: 'LOCKERS',
        changeSkin: 'Change your skin',
        totalPlayers: 'Total:',
        players: 'players',
        innocentsLabel: 'Innocents:',
        virusLabel: 'Virus:',
        journalistLabel: 'Journalist:',
        fanaticLabel: 'Fanatic:',
        spyLabel: 'Spy:',
        fanaticRole: 'FANATIC',
        spyRole: 'SPY',
        musicTab: 'MUSIC',
        chooseMusic: 'Choose your music!',
        hudControls: 'WASD or Arrows to move',
        inProgress: 'IN PROGRESS...',
        noGamesAvailable: '0 games available',
        gamesAvailable: '{0} game{1} available',
        need10For3VirusTip: 'You need at least 10 players for 3 viruses',
        need7For2VirusTip: 'You need at least 7 players for 2 viruses',
        youChoseVirus: 'You chose <b>{0}</b> virus(es)',
        playerRoles: 'PLAYER ROLES:',
        youLabel: '(you)',
        botAccusation: [
          'I\'m sure {c} is the virus!',
          '{c} was acting weird earlier...',
          'I saw {c} hanging around the body',
          'I\'m voting {c}, way too suspicious',
          '{c} followed me for a while, that\'s shady',
          'Did anyone else see {c} acting strange?',
          '{c} was all alone in the hallway...',
          'I bet {c} is the virus',
          'maybe it\'s {c}',
          'Maybe {c} is the fanatic...',
          'Maybe {c} is the spy...'
        ],
        botDefense: [
          'It wasn\'t me I swear!',
          'I was doing my missions',
          'I\'m innocent, I did nothing',
          'Stop accusing me please',
          'I was on the other side of the map',
          'You can trust me',
          'Why me? I did nothing suspicious',
          'I\'m innocent I swear!'
        ],
        botReaction: [
          'Hmm that\'s suspicious...',
          'I\'m not really sure...',
          'We should skip if we\'re not sure',
          'Anyone got proof?',
          'I didn\'t see anything special',
          'This is tense...',
          'We can\'t afford to vote wrong',
          'Who found the body?',
          'Do we vote or skip?',
          'I\'ve done all my missions',
          'I don\'t think so.',
          'I agree.',
          'I say we should skip',
          'Not enough proof to vote anyone',
          'Maybe it\'s a self-report?',
          'Don\'t vote randomly guys',
          'I think it\'s someone else...',
          'bruh',
          'Maybe',
          'you don\'t have enough proof to convince me',
          'uhh...'
        ],
        botVirus: [
          'I say we should skip',
          'Not enough proof to vote anyone',
          'Maybe it\'s a self-report?',
          'Don\'t vote randomly guys',
          'I think it\'s someone else...',
          'was it the fanatic?'
        ],
        botJournalist: [
          'I investigated {c}, not gonna tell you the result...',
          'My investigation shows {c} is clean',
          'Trust me, I have intel',
          'I checked someone, they\'re not the virus',
          'Based on my investigation, we should vote {c}',
          'I\'m the journalist, I know what I\'m talking about',
          'I have proof against {c}!',
          'My investigation clears {c}, look elsewhere'
        ],
        botFanatic: [
          'Vote me if you want, I don\'t care',
          'Go ahead, eliminate me, doesn\'t bother me',
          'I\'m suspicious? Great!',
          'I\'m clearly sketchy, vote me',
          'Honestly, I\'m the most suspicious here',
          'I\'m the guilty one, vote!',
          'I admit I\'ve been acting weird',
          'I was hanging near the body!'
        ],
        botSpy: [
          'I\'m staying low, watching everyone...',
          'I have info but I\'d rather keep it to myself',
          'Be careful, nothing is what it seems here',
          'I\'m on my own side, don\'t trust me',
          'I chose my side and I\'m sticking to it',
          'I know things you don\'t...',
          'My role is more complex than you think',
          'I\'m neither with you nor against you',
          '{c} is hiding something, I\'m certain',
          'I\'m playing my own game, don\'t include me in your plans'
        ],
        botComment: [
          'let\'s goo!',
          'come on vote!',
          'I\'ll do my tasks after',
          'vote with me!',
          'come on guys',
          'Don\'t mess up',
          'Lets go!'
        ]
      }
    };

    function t(key) {
      var val = TR[currentLang] && TR[currentLang][key];
      if (val === undefined || val === null) val = TR['fr'][key] || key;
      // Si c'est un tableau, le retourner directement
      if (Array.isArray(val)) return val;
      // Remplacer {0}, {1}, etc.
      for (var i = 1; i < arguments.length; i++) {
        val = val.replace('{' + (i - 1) + '}', arguments[i]);
      }
      return val;
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('virus_lang', lang);
      document.querySelectorAll('.lang-btn').forEach(function(b) { b.classList.remove('active'); });
      ['lang-', 'compte-lang-', 'cp-lang-'].forEach(function(prefix) {
        var btn = document.getElementById(prefix + lang);
        if (btn) btn.classList.add('active');
      });
      translatePage();
    }

    function translatePage() {
      // Traduire les elements avec data-i18n
      var els = document.querySelectorAll('[data-i18n]');
      for (var i = 0; i < els.length; i++) {
        var key = els[i].getAttribute('data-i18n');
        var attr = els[i].getAttribute('data-i18n-attr');
        if (attr === 'placeholder') {
          els[i].placeholder = t(key);
        } else if (els[i].hasAttribute('data-i18n-html')) {
          els[i].innerHTML = t(key);
        } else {
          els[i].textContent = t(key);
        }
      }
    }

    // Initialiser la langue au chargement
    (function() {
      document.querySelectorAll('.lang-btn').forEach(function(b) { b.classList.remove('active'); });
      ['lang-', 'compte-lang-', 'cp-lang-'].forEach(function(prefix) {
        var btn = document.getElementById(prefix + currentLang);
        if (btn) btn.classList.add('active');
      });
      translatePage();
    })();

    // ============================
    // JEU - DEPLACEMENT JOUEUR
    // ============================
    var joueurX = 3800;
    var joueurY = 3050;
    var vitesse = 6;
    var keys = {};
    var jeuActif = false;
    var isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    var modeHorsLigne = false;
    var monRole = 'innocent';
    var espionCamp = null; // 'virus' ou 'innocent' - le camp choisi par l'espion

    // Systeme de monnaie : Golds
    var playerGold = parseInt(localStorage.getItem('virusGold')) || 0;
    function sauvegarderGold() {
      localStorage.setItem('virusGold', playerGold);
      var el = document.getElementById('gold-display');
      if (el) el.textContent = playerGold;
      var bel = document.getElementById('boutique-gold-display');
      if (bel) bel.textContent = playerGold;
    }
    function gagnerGold(montant) {
      playerGold += montant;
      sauvegarderGold();
    }
    // Initialiser l'affichage des golds au chargement
    sauvegarderGold();

    // ============================
    // BOUTIQUE DE SKINS
    // ============================
    var SKINS_BOUTIQUE = [
      { id: 'mario', nom: 'Mario', fichier: 'skin/skin de boutique/mario.svg', prix: 250, rarete: 'rare' },
      { id: 'princessepeach', nom: 'Princesse Peach', fichier: 'skin/skin de boutique/princesse peach.svg', prix: 100, rarete: 'commun' },
      { id: 'luigi', nom: 'Luigi', fichier: 'skin/skin de boutique/Luigi.svg', prix: 100, rarete: 'commun' },
      { id: 'steve', nom: 'Steve', fichier: 'skin/skin de boutique/Steve.svg', prix: 300, rarete: 'rare' },
      { id: 'alex', nom: 'Alex', fichier: 'skin/skin de boutique/Alex.svg', prix: 100, rarete: 'commun' },
      { id: 'ninjaxx', nom: 'Ninjaxx', fichier: 'skin/skin de boutique/Ninjaxx.svg', prix: 150, rarete: 'rare' },
      { id: 'valentina', nom: 'Valentina', fichier: 'skin/skin de boutique/Valentina.svg', prix: 500, rarete: 'epic' },
      { id: 'galaxy', nom: 'Galaxy', fichier: 'skin/skin de boutique/Galaxy.svg', prix: 1000, rarete: 'legendaire' },
      { id: 'obstinate', nom: 'Obstinate', fichier: 'skin/skin de boutique/obstinate.svg', prix: 500, rarete: 'epic' },
      { id: 'fermier', nom: 'Fermier', fichier: 'skin/skin de boutique/fermier.svg', prix: 50, rarete: 'typique' },
      { id: 'pandareulou', nom: 'Panda Reulou', fichier: 'skin/skin de boutique/panda reulou.svg', prix: 1000, rarete: 'legendaire' }
    ];

    function getSkinsAchetes() {
      try { return JSON.parse(localStorage.getItem('virusSkinsAchetes')) || []; }
      catch(e) { return []; }
    }
    function sauvegarderSkinsAchetes(liste) {
      localStorage.setItem('virusSkinsAchetes', JSON.stringify(liste));
    }

    function acheterSkin(skinId) {
      var skinBoutique = SKINS_BOUTIQUE.find(function(s) { return s.id === skinId; });
      if (!skinBoutique) return;
      var achetes = getSkinsAchetes();
      if (achetes.indexOf(skinId) >= 0) return;
      if (playerGold < skinBoutique.prix) return;
      playerGold -= skinBoutique.prix;
      sauvegarderGold();
      achetes.push(skinId);
      sauvegarderSkinsAchetes(achetes);
      // Ajouter au tableau SKINS pour pouvoir l'equiper
      if (!SKINS.find(function(s) { return s.id === skinId; })) {
        SKINS.push({ id: skinBoutique.id, nom: skinBoutique.nom, fichier: skinBoutique.fichier, rarete: skinBoutique.rarete });
      }
      genererBoutique();
    }

    function equiperSkinBoutique(skinId) {
      setSkin(skinId);
      genererBoutique();
    }

    function genererBoutique() {
      var grille = document.getElementById('boutique-grille');
      if (!grille) return;
      grille.innerHTML = '';
      // Recharger le gold depuis localStorage au cas ou
      playerGold = parseInt(localStorage.getItem('virusGold')) || 0;
      var achetes = getSkinsAchetes();
      var currentSkin = getSkin();
      var goldEl = document.getElementById('boutique-gold-display');
      if (goldEl) goldEl.textContent = playerGold;

      SKINS_BOUTIQUE.forEach(function(skin) {
        var possede = achetes.indexOf(skin.id) >= 0;
        var equipe = possede && currentSkin === skin.id;
        var peutAcheter = !possede && playerGold >= skin.prix;

        var carte = document.createElement('div');
        carte.className = 'skin-carte';
        var btnHtml = '';
        if (equipe) {
          btnHtml = '<button class="skin-carte-btn equipe">EQUIPE</button>';
        } else if (possede) {
          btnHtml = '<button class="skin-carte-btn possede" onclick="equiperSkinBoutique(\'' + skin.id + '\')">EQUIPER</button>';
        } else if (peutAcheter) {
          btnHtml = '<button class="skin-carte-btn acheter" onclick="acheterSkin(\'' + skin.id + '\')">ACHETER</button>';
        } else {
          btnHtml = '<button class="skin-carte-btn acheter desactive">ACHETER</button>';
        }
        var rar = RARETES[skin.rarete] || RARETES.typique;
        carte.style.borderColor = rar.couleur;
        carte.innerHTML = '<img class="skin-carte-img" src="' + skin.fichier + '" alt="' + skin.nom + '">' +
          '<div class="skin-carte-rarete" style="color:' + rar.couleur + '">' + rar.nom + '</div>' +
          '<div class="skin-carte-nom">' + skin.nom + '</div>' +
          (possede ? '' : '<div class="skin-carte-prix"><span class="prix-icon">&#9733;</span>' + skin.prix + '</div>') +
          btnHtml;
        grille.appendChild(carte);
      });
    }

    // Charger les skins achetes dans SKINS au demarrage
    (function() {
      var achetes = getSkinsAchetes();
      SKINS_BOUTIQUE.forEach(function(sb) {
        if (achetes.indexOf(sb.id) >= 0 && !SKINS.find(function(s) { return s.id === sb.id; })) {
          SKINS.push({ id: sb.id, nom: sb.nom, fichier: sb.fichier, rarete: sb.rarete });
        }
      });
    })();

    // ============================
    // ONGLETS BOUTIQUE
    // ============================
    function switchBoutiqueTab(tab) {
      document.querySelectorAll('.boutique-tab').forEach(function(el) { el.classList.remove('active'); });
      document.querySelectorAll('.boutique-tab-content').forEach(function(el) { el.classList.remove('active'); });
      document.getElementById('boutique-tab-' + tab).classList.add('active');
      document.getElementById('boutique-content-' + tab).classList.add('active');
      if (tab === 'musique') genererBoutiqueMusique();
    }

    // ============================
    // BOUTIQUE DE MUSIQUES
    // ============================
    function getMusiquesAchetees() {
      try { return JSON.parse(localStorage.getItem('virusMusiquesAchetees')) || []; }
      catch(e) { return []; }
    }
    function sauvegarderMusiquesAchetees(liste) {
      localStorage.setItem('virusMusiquesAchetees', JSON.stringify(liste));
    }

    function acheterMusique(musiqueId) {
      var mBoutique = MUSIQUES_BOUTIQUE.find(function(m) { return m.id === musiqueId; });
      if (!mBoutique) return;
      var achetees = getMusiquesAchetees();
      if (achetees.indexOf(musiqueId) >= 0) return;
      if (playerGold < mBoutique.prix) return;
      playerGold -= mBoutique.prix;
      sauvegarderGold();
      achetees.push(musiqueId);
      sauvegarderMusiquesAchetees(achetees);
      if (!MUSIQUES.find(function(m) { return m.id === musiqueId; })) {
        MUSIQUES.push({ id: mBoutique.id, nom: mBoutique.nom, artiste: mBoutique.artiste, fichier: mBoutique.fichier, image: mBoutique.image });
      }
      showNotif(t('notif.musicPurchased', mBoutique.nom), 'success');
      genererBoutiqueMusique();
    }

    function equiperMusiqueBoutique(musiqueId) {
      setMusique(musiqueId);
      genererBoutiqueMusique();
    }

    function genererBoutiqueMusique() {
      var grille = document.getElementById('boutique-grille-musique');
      if (!grille) return;
      grille.innerHTML = '';
      // Recharger le gold depuis localStorage au cas ou
      playerGold = parseInt(localStorage.getItem('virusGold')) || 0;
      var achetees = getMusiquesAchetees();
      var currentMusique = getMusiqueId();
      var goldEl = document.getElementById('boutique-gold-display');
      if (goldEl) goldEl.textContent = playerGold;

      MUSIQUES_BOUTIQUE.forEach(function(m) {
        var possede = achetees.indexOf(m.id) >= 0;
        var equipe = possede && currentMusique === m.id;
        var peutAcheter = !possede && playerGold >= m.prix;

        var carte = document.createElement('div');
        carte.className = 'skin-carte';
        var col = m.couleur || '#566573';
        carte.style.borderColor = col;
        carte.style.background = 'linear-gradient(180deg, rgba(26,26,46,0.9), ' + col + '22)';
        var btnHtml = '';
        if (equipe) {
          btnHtml = '<button class="skin-carte-btn equipe">' + t('equipped') + '</button>';
        } else if (possede) {
          btnHtml = '<button class="skin-carte-btn possede" onclick="equiperMusiqueBoutique(\'' + m.id + '\')">' + t('equip') + '</button>';
        } else if (peutAcheter) {
          btnHtml = '<button class="skin-carte-btn acheter" onclick="acheterMusique(\'' + m.id + '\')">' + t('buy') + '</button>';
        } else {
          btnHtml = '<button class="skin-carte-btn acheter desactive">' + t('buy') + '</button>';
        }

        var imgHtml = m.image ? '<img class="musique-carte-img" src="' + m.image + '" alt="' + m.nom + '">' : '';
        carte.innerHTML = imgHtml +
          '<div class="skin-carte-nom">' + m.nom + '</div>' +
          (possede ? '' : '<div class="skin-carte-prix"><span class="prix-icon">&#9733;</span>' + m.prix + '</div>') +
          btnHtml;
        grille.appendChild(carte);
      });
    }

    // Charger les musiques achetees dans MUSIQUES au demarrage
    (function() {
      var achetees = getMusiquesAchetees();
      MUSIQUES_BOUTIQUE.forEach(function(mb) {
        if (achetees.indexOf(mb.id) >= 0 && !MUSIQUES.find(function(m) { return m.id === mb.id; })) {
          MUSIQUES.push({ id: mb.id, nom: mb.nom, artiste: mb.artiste, fichier: mb.fichier, image: mb.image });
        }
      });
      // Restaurer la musique sauvegardee
      var savedMusique = getMusiqueId();
      if (savedMusique !== 'destroyed') {
        var m = MUSIQUES.find(function(x) { return x.id === savedMusique; });
        if (m) {
          var audio = document.getElementById('musique-menu');
          if (audio) audio.src = m.fichier;
        }
      }
    })();
    var reunionEnCours = false;
    var reunionTimer = null;
    var voteChoisi = -1; // index du joueur vote

    // Map dimensions
    var MAP_W = 8000;
    var MAP_H = 6000;

    // Collision system
    var collisionRects = [];
    var PJ_W = 22;
    var PJ_H = 38;
    var PJ_OX = 4;
    var PJ_OY = 8;
    var WALL_THICK = 6;

    function buildCollisionData() {
      collisionRects = [];
      var map = document.getElementById('mall-map');
      if (!map) return;
      var boutiques = map.querySelectorAll('.boutique');
      boutiques.forEach(function(b) {
        var bx = b.offsetLeft;
        var by = b.offsetTop;
        var bw = b.offsetWidth;
        var bh = b.offsetHeight;
        if (bw === 0 || bh === 0) return;

        // Parse doors
        var topDoors = [], bottomDoors = [], leftDoors = [], rightDoors = [];
        b.querySelectorAll('.boutique-porte').forEach(function(p) {
          var ps = p.style;
          if (ps.bottom && parseInt(ps.bottom) < 0) {
            bottomDoors.push({ start: parseInt(ps.left) || 0, size: parseInt(ps.width) || 36 });
          } else if (ps.top && parseInt(ps.top) < 0) {
            topDoors.push({ start: parseInt(ps.left) || 0, size: parseInt(ps.width) || 36 });
          } else if (ps.left && parseInt(ps.left) < 0) {
            leftDoors.push({ start: parseInt(ps.top) || 0, size: parseInt(ps.height) || 50 });
          } else if (ps.right && parseInt(ps.right) < 0) {
            rightDoors.push({ start: parseInt(ps.top) || 0, size: parseInt(ps.height) || 50 });
          }
        });

        // Build walls with door gaps
        buildWall(bx, by, bw, WALL_THICK, topDoors, true);
        buildWall(bx, by + bh - WALL_THICK, bw, WALL_THICK, bottomDoors, true);
        buildWall(bx, by, WALL_THICK, bh, leftDoors, false);
        buildWall(bx + bw - WALL_THICK, by, WALL_THICK, bh, rightDoors, false);

        // Interior objects collision - clip against door clearance zones
        var DOOR_CLEARANCE = 60;
        b.querySelectorAll('[class*="obj-"]').forEach(function(o) {
          var ow = o.offsetWidth;
          var oh = o.offsetHeight;
          if (ow > 2 && oh > 2) {
            var ox = o.offsetLeft;
            var oy = o.offsetTop;
            var rects = [{ x: ox, y: oy, w: ow, h: oh }];

            // Clip against bottom door clearance
            bottomDoors.forEach(function(d) {
              var nr = [];
              rects.forEach(function(r) {
                if (r.y + r.h > bh - DOOR_CLEARANCE && r.x < d.start + d.size && r.x + r.w > d.start) {
                  if (r.x < d.start) nr.push({ x: r.x, y: r.y, w: d.start - r.x, h: r.h });
                  if (r.x + r.w > d.start + d.size) nr.push({ x: d.start + d.size, y: r.y, w: (r.x + r.w) - (d.start + d.size), h: r.h });
                } else { nr.push(r); }
              });
              rects = nr;
            });

            // Clip against top door clearance
            topDoors.forEach(function(d) {
              var nr = [];
              rects.forEach(function(r) {
                if (r.y < DOOR_CLEARANCE && r.x < d.start + d.size && r.x + r.w > d.start) {
                  if (r.x < d.start) nr.push({ x: r.x, y: r.y, w: d.start - r.x, h: r.h });
                  if (r.x + r.w > d.start + d.size) nr.push({ x: d.start + d.size, y: r.y, w: (r.x + r.w) - (d.start + d.size), h: r.h });
                } else { nr.push(r); }
              });
              rects = nr;
            });

            // Clip against left door clearance
            leftDoors.forEach(function(d) {
              var nr = [];
              rects.forEach(function(r) {
                if (r.x < DOOR_CLEARANCE && r.y < d.start + d.size && r.y + r.h > d.start) {
                  if (r.y < d.start) nr.push({ x: r.x, y: r.y, w: r.w, h: d.start - r.y });
                  if (r.y + r.h > d.start + d.size) nr.push({ x: r.x, y: d.start + d.size, w: r.w, h: (r.y + r.h) - (d.start + d.size) });
                } else { nr.push(r); }
              });
              rects = nr;
            });

            // Clip against right door clearance
            rightDoors.forEach(function(d) {
              var nr = [];
              rects.forEach(function(r) {
                if (r.x + r.w > bw - DOOR_CLEARANCE && r.y < d.start + d.size && r.y + r.h > d.start) {
                  if (r.y < d.start) nr.push({ x: r.x, y: r.y, w: r.w, h: d.start - r.y });
                  if (r.y + r.h > d.start + d.size) nr.push({ x: r.x, y: d.start + d.size, w: r.w, h: (r.y + r.h) - (d.start + d.size) });
                } else { nr.push(r); }
              });
              rects = nr;
            });

            // Add surviving collision rects (converted to absolute coords)
            rects.forEach(function(r) {
              if (r.w > 2 && r.h > 2) {
                collisionRects.push({ x: bx + r.x, y: by + r.y, w: r.w, h: r.h });
              }
            });
          }
        });
      });

      // Fontaine centrale
      var fontaines = map.querySelectorAll('.mall-fontaine');
      fontaines.forEach(function(f) {
        collisionRects.push({ x: f.offsetLeft, y: f.offsetTop, w: f.offsetWidth, h: f.offsetHeight });
      });
    }

    function buildWall(wx, wy, ww, wh, doors, horizontal) {
      if (doors.length === 0) {
        collisionRects.push({ x: wx, y: wy, w: ww, h: wh });
        return;
      }
      doors.sort(function(a, b) { return a.start - b.start; });
      var cur = 0;
      for (var i = 0; i < doors.length; i++) {
        var ds = doors[i].start;
        var de = ds + doors[i].size;
        if (horizontal) {
          if (ds > cur) collisionRects.push({ x: wx + cur, y: wy, w: ds - cur, h: wh });
          cur = de;
        } else {
          if (ds > cur) collisionRects.push({ x: wx, y: wy + cur, w: ww, h: ds - cur });
          cur = de;
        }
      }
      if (horizontal && cur < ww) {
        collisionRects.push({ x: wx + cur, y: wy, w: ww - cur, h: wh });
      } else if (!horizontal && cur < wh) {
        collisionRects.push({ x: wx, y: wy + cur, w: ww, h: wh - cur });
      }
    }

    function checkCollision(px, py) {
      var x1 = px + PJ_OX;
      var y1 = py + PJ_OY;
      var x2 = x1 + PJ_W;
      var y2 = y1 + PJ_H;
      for (var i = 0; i < collisionRects.length; i++) {
        var r = collisionRects[i];
        if (x2 > r.x && x1 < r.x + r.w && y2 > r.y && y1 < r.y + r.h) {
          return true;
        }
      }
      return false;
    }

    document.addEventListener('keydown', function(e) {
      // Ne pas capturer les touches si on est dans un champ de saisie
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      keys[e.key] = true;
      // Empecher le scroll de la page avec les fleches
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].indexOf(e.key) > -1) {
        e.preventDefault();
      }
    });
    document.addEventListener('keyup', function(e) {
      keys[e.key] = false;
    });

    // Deplacement mobile : toucher pour se deplacer vers le doigt
    var touchActif = false;
    var touchTargetX = 0, touchTargetY = 0;

    if (isMobile) {
      var touchViewport = document.getElementById('jeu-viewport');
      if (touchViewport) {
        touchViewport.addEventListener('touchstart', function(e) {
          if (camerasOuvertes || reunionEnCours) return;
          e.preventDefault();
          touchActif = true;
          updateTouchTarget(e);
        }, { passive: false });
        touchViewport.addEventListener('touchmove', function(e) {
          if (!touchActif) return;
          e.preventDefault();
          updateTouchTarget(e);
        }, { passive: false });
        touchViewport.addEventListener('touchend', function(e) {
          touchActif = false;
        }, { passive: false });
        touchViewport.addEventListener('touchcancel', function(e) {
          touchActif = false;
        }, { passive: false });
      }
    }

    function updateTouchTarget(e) {
      var touch = e.touches[0];
      if (!touch) return;
      var vp = document.getElementById('jeu-viewport');
      if (!vp) return;
      var rect = vp.getBoundingClientRect();
      var vw = vp.clientWidth;
      var vh = vp.clientHeight;
      // Calculer l'offset camera (meme formule que updateJoueur)
      var camX = joueurX - vw / 2 + 14;
      var camY = joueurY - vh / 2 + 14;
      if (camX < 0) camX = 0;
      if (camY < 0) camY = 0;
      if (camX > MAP_W - vw) camX = MAP_W - vw;
      if (camY > MAP_H - vh) camY = MAP_H - vh;
      // Convertir coordonnees ecran en coordonnees map
      touchTargetX = (touch.clientX - rect.left) + camX;
      touchTargetY = (touch.clientY - rect.top) + camY;
    }

    // Demarrer la musique au premier clic (autoplay bloque par les navigateurs)
    var musiqueInitialisee = false;
    document.addEventListener('click', function() {
      if (musiqueInitialisee) return;
      musiqueInitialisee = true;
      var audio = document.getElementById('musique-menu');
      var jeuActifScreen = document.getElementById('jeu');
      if (audio && !musiqueMuted && !(jeuActifScreen && jeuActifScreen.classList.contains('active'))) {
        audio.play().catch(function() {});
      }
    }, { once: false });

    // ============================
    // MODE HORS LIGNE (BOTS)
    // ============================
    var bots = [];
    var botsMorts = []; // bots elimines (fantomes sur la map)
    var BOT_VITESSE = 4;
    var BOT_WAYPOINTS = [
      {x:800, y:1200}, {x:2000, y:1200}, {x:3800, y:1200}, {x:5500, y:1200}, {x:7200, y:1200},
      {x:800, y:2800}, {x:2000, y:2800}, {x:3800, y:2800}, {x:5500, y:2800}, {x:7200, y:2800},
      {x:800, y:4200}, {x:2000, y:4200}, {x:3800, y:4200}, {x:5500, y:4200}, {x:7200, y:4200},
      {x:1000, y:2000}, {x:7000, y:2000},
      {x:1000, y:4000}, {x:7000, y:4000},
      {x:3800, y:5500}, {x:2000, y:5500}, {x:5500, y:5500}
    ];
    // Positions devant les boutiques (pour les bots innocents qui "font des missions")
    var BOT_BOUTIQUES = [
      {x:335, y:1322, nom:'LIBRAIRIE'}, {x:2790, y:1472, nom:'KIOSQUE'},
      {x:3075, y:322, nom:'SECURITE'}, {x:705, y:3657, nom:'SUPERMARCHE'},
      {x:3025, y:4122, nom:'ARCADE'}, {x:3525, y:277, nom:'TOILETTES'},
      {x:355, y:1817, nom:'SPORT'}, {x:7745, y:422, nom:'BIJOUTERIE'},
      {x:7725, y:4572, nom:'PARFUMERIE'}, {x:3840, y:132, nom:'CAFE'}
    ];

    function nettoyerBots() {
      for (var i = 0; i < bots.length; i++) {
        if (bots[i].element && bots[i].element.parentNode) {
          bots[i].element.parentNode.removeChild(bots[i].element);
        }
      }
      bots = [];
      // Nettoyer aussi les fantomes
      for (var f = 0; f < botsMorts.length; f++) {
        if (botsMorts[f].element && botsMorts[f].element.parentNode) {
          botsMorts[f].element.parentNode.removeChild(botsMorts[f].element);
        }
      }
      botsMorts = [];
    }

    function initBots(nbBots) {
      nettoyerBots();
      var nomsPool = FAUX_PSEUDOS.slice();
      var mallMap = document.getElementById('mall-map');
      if (!mallMap) return;

      for (var i = 0; i < nbBots && nomsPool.length > 0; i++) {
        // Pseudo aleatoire
        var ni = Math.floor(Math.random() * nomsPool.length);
        var pseudo = nomsPool[ni];
        nomsPool.splice(ni, 1);

        // Skin aleatoire pondere par rarete : typique 80, commun 60, rare 40, epic 30, legendaire 10
        var skinObj;
        var tousLesSkins = SKINS.concat(SKINS_BOUTIQUE);
        var poidsRarete = {typique:80, commun:60, rare:40, epic:30, legendaire:10};
        var poidsTotal = 0;
        for (var ps = 0; ps < tousLesSkins.length; ps++) {
          poidsTotal += (poidsRarete[tousLesSkins[ps].rarete] || 50);
        }
        var tirage = Math.random() * poidsTotal;
        var cumul = 0;
        skinObj = tousLesSkins[0];
        for (var ps = 0; ps < tousLesSkins.length; ps++) {
          cumul += (poidsRarete[tousLesSkins[ps].rarete] || 50);
          if (tirage <= cumul) { skinObj = tousLesSkins[ps]; break; }
        }
        var skinFichier = skinObj.fichier;

        // Position de spawn - autour de la fontaine centrale (3800, 2800)
        var angle = (i / nbBots) * Math.PI * 2 + (Math.random() * 0.3 - 0.15);
        var rayon = 250 + Math.floor(Math.random() * 150);
        var spawnX = 3800 + Math.floor(Math.cos(angle) * rayon);
        var spawnY = 2800 + Math.floor(Math.sin(angle) * rayon);

        // Premiere cible
        var wp = BOT_WAYPOINTS[Math.floor(Math.random() * BOT_WAYPOINTS.length)];

        // Creer element DOM
        var div = document.createElement('div');
        div.className = 'joueur-perso bot-perso';
        div.id = 'bot-' + i;
        div.style.left = spawnX + 'px';
        div.style.top = spawnY + 'px';

        var span = document.createElement('span');
        span.className = 'joueur-pseudo';
        span.textContent = pseudo;
        div.appendChild(span);

        var img = document.createElement('img');
        img.src = skinFichier;
        img.alt = 'bot';
        div.appendChild(img);

        var badge = document.createElement('div');
        badge.className = 'virus-allie-badge';
        div.appendChild(badge);

        mallMap.appendChild(div);

        bots.push({
          id: 'bot-' + i,
          pseudo: pseudo,
          x: spawnX,
          y: spawnY,
          skin: skinFichier,
          role: 'innocent',
          cibleX: wp.x,
          cibleY: wp.y,
          timer: 100 + Math.floor(Math.random() * 200),
          blockedTimer: 0,
          etat: 'deplacement', // 'deplacement', 'pause', 'traque', 'fuite'
          pauseTimer: 0,
          suiviCible: null, // pseudo du joueur/bot suivi
          missionsVisitees: 0, // compteur de boutiques visitees
          element: div
        });
      }
    }

    // Trouver le joueur ou bot vivant le plus proche
    function botTrouverCibleProche(bot, cibleRole) {
      var meilleur = null;
      var meilleurDist = Infinity;
      // Verifier le joueur
      if (joueursElimines.indexOf(getPseudo()) < 0) {
        var d = Math.sqrt((joueurX - bot.x) * (joueurX - bot.x) + (joueurY - bot.y) * (joueurY - bot.y));
        if (d < meilleurDist) { meilleurDist = d; meilleur = {x: joueurX, y: joueurY, pseudo: getPseudo()}; }
      }
      // Verifier les autres bots
      for (var j = 0; j < bots.length; j++) {
        if (bots[j].id === bot.id || joueursElimines.indexOf(bots[j].pseudo) >= 0) continue;
        if (cibleRole && bots[j].role !== cibleRole) continue;
        var d = Math.sqrt((bots[j].x - bot.x) * (bots[j].x - bot.x) + (bots[j].y - bot.y) * (bots[j].y - bot.y));
        if (d < meilleurDist) { meilleurDist = d; meilleur = {x: bots[j].x, y: bots[j].y, pseudo: bots[j].pseudo}; }
      }
      return meilleur;
    }

    // Choisir une cible en fonction du role du bot
    function botChoisirCible(bot) {
      var rand = Math.random();

      if (bot.role === 'virus') {
        // Le virus traque les joueurs proches (70%) ou erre (30%)
        if (rand < 0.7) {
          var cible = botTrouverCibleProche(bot, null);
          if (cible) {
            bot.etat = 'traque';
            bot.suiviCible = cible.pseudo;
            // Viser un point proche de la cible (pas exactement dessus pour etre discret)
            bot.cibleX = cible.x + Math.floor(Math.random() * 200 - 100);
            bot.cibleY = cible.y + Math.floor(Math.random() * 200 - 100);
            bot.timer = 150 + Math.floor(Math.random() * 100);
            return;
          }
        }
        // Sinon errer normalement
        bot.etat = 'deplacement';
        var wp = BOT_WAYPOINTS[Math.floor(Math.random() * BOT_WAYPOINTS.length)];
        bot.cibleX = wp.x + Math.floor(Math.random() * 200 - 100);
        bot.cibleY = wp.y + Math.floor(Math.random() * 200 - 100);
        bot.timer = 200 + Math.floor(Math.random() * 200);

      } else if (bot.role === 'innocent') {
        // L'innocent va vers une boutique (60%), erre (25%) ou rejoint un groupe (15%)
        if (rand < 0.6 && BOT_BOUTIQUES.length > 0) {
          bot.etat = 'deplacement';
          var boutique = BOT_BOUTIQUES[Math.floor(Math.random() * BOT_BOUTIQUES.length)];
          bot.cibleX = boutique.x + Math.floor(Math.random() * 60 - 30);
          bot.cibleY = boutique.y + Math.floor(Math.random() * 60 - 30);
          bot.timer = 250 + Math.floor(Math.random() * 200);
        } else if (rand < 0.85) {
          bot.etat = 'deplacement';
          var wp = BOT_WAYPOINTS[Math.floor(Math.random() * BOT_WAYPOINTS.length)];
          bot.cibleX = wp.x + Math.floor(Math.random() * 200 - 100);
          bot.cibleY = wp.y + Math.floor(Math.random() * 200 - 100);
          bot.timer = 200 + Math.floor(Math.random() * 300);
        } else {
          // Rejoindre un autre bot
          var ami = botTrouverCibleProche(bot, null);
          if (ami) {
            bot.etat = 'deplacement';
            bot.cibleX = ami.x + Math.floor(Math.random() * 100 - 50);
            bot.cibleY = ami.y + Math.floor(Math.random() * 100 - 50);
            bot.timer = 150 + Math.floor(Math.random() * 150);
          }
        }

      } else if (bot.role === 'journaliste') {
        // Le journaliste suit un joueur pour "enqueter" (60%) ou erre (40%)
        if (rand < 0.6) {
          var cible = botTrouverCibleProche(bot, null);
          if (cible) {
            bot.etat = 'traque';
            bot.suiviCible = cible.pseudo;
            // Garder une distance d'observation (pas trop pres)
            var angle = Math.random() * Math.PI * 2;
            bot.cibleX = cible.x + Math.cos(angle) * 120;
            bot.cibleY = cible.y + Math.sin(angle) * 120;
            bot.timer = 200 + Math.floor(Math.random() * 150);
            return;
          }
        }
        bot.etat = 'deplacement';
        var wp = BOT_WAYPOINTS[Math.floor(Math.random() * BOT_WAYPOINTS.length)];
        bot.cibleX = wp.x + Math.floor(Math.random() * 200 - 100);
        bot.cibleY = wp.y + Math.floor(Math.random() * 200 - 100);
        bot.timer = 200 + Math.floor(Math.random() * 250);

      } else if (bot.role === 'fanatique') {
        // Le fanatique se met dans des situations dangereuses : va vers les groupes (50%), suit quelqu'un de pres (30%), erre (20%)
        if (rand < 0.5) {
          // Aller ou il y a le plus de monde
          var meilleurPoint = null;
          var meilleurCompte = 0;
          for (var w = 0; w < BOT_WAYPOINTS.length; w++) {
            var compte = 0;
            for (var b2 = 0; b2 < bots.length; b2++) {
              if (bots[b2].id === bot.id || joueursElimines.indexOf(bots[b2].pseudo) >= 0) continue;
              var d = Math.sqrt((bots[b2].x - BOT_WAYPOINTS[w].x) * (bots[b2].x - BOT_WAYPOINTS[w].x) + (bots[b2].y - BOT_WAYPOINTS[w].y) * (bots[b2].y - BOT_WAYPOINTS[w].y));
              if (d < 500) compte++;
            }
            if (compte > meilleurCompte) { meilleurCompte = compte; meilleurPoint = BOT_WAYPOINTS[w]; }
          }
          if (meilleurPoint && meilleurCompte > 0) {
            bot.etat = 'deplacement';
            bot.cibleX = meilleurPoint.x + Math.floor(Math.random() * 100 - 50);
            bot.cibleY = meilleurPoint.y + Math.floor(Math.random() * 100 - 50);
            bot.timer = 200 + Math.floor(Math.random() * 200);
            return;
          }
        } else if (rand < 0.8) {
          // Suivre quelqu'un de tres pres (comportement suspect)
          var cible = botTrouverCibleProche(bot, null);
          if (cible) {
            bot.etat = 'traque';
            bot.suiviCible = cible.pseudo;
            bot.cibleX = cible.x + Math.floor(Math.random() * 40 - 20);
            bot.cibleY = cible.y + Math.floor(Math.random() * 40 - 20);
            bot.timer = 120 + Math.floor(Math.random() * 100);
            return;
          }
        }
        bot.etat = 'deplacement';
        var wp = BOT_WAYPOINTS[Math.floor(Math.random() * BOT_WAYPOINTS.length)];
        bot.cibleX = wp.x + Math.floor(Math.random() * 200 - 100);
        bot.cibleY = wp.y + Math.floor(Math.random() * 200 - 100);
        bot.timer = 150 + Math.floor(Math.random() * 200);

      } else {
        // Defaut : errance
        bot.etat = 'deplacement';
        var wp = BOT_WAYPOINTS[Math.floor(Math.random() * BOT_WAYPOINTS.length)];
        bot.cibleX = wp.x + Math.floor(Math.random() * 200 - 100);
        bot.cibleY = wp.y + Math.floor(Math.random() * 200 - 100);
        bot.timer = 200 + Math.floor(Math.random() * 300);
      }
    }

    function updateBots() {
      for (var i = 0; i < bots.length; i++) {
        var bot = bots[i];

        // Si en pause (simulation de mission/arret), attendre
        if (bot.etat === 'pause') {
          bot.pauseTimer--;
          if (bot.pauseTimer <= 0) {
            bot.etat = 'deplacement';
            bot.missionsVisitees++;
            botChoisirCible(bot);
          }
          continue;
        }

        bot.timer--;

        // Si le virus traque, mettre a jour la position de la cible en temps reel
        if (bot.etat === 'traque' && bot.suiviCible) {
          var pseudo = getPseudo() || t('player');
          if (bot.suiviCible === pseudo && joueursElimines.indexOf(pseudo) < 0) {
            // Suivre le joueur
            if (bot.role === 'virus') {
              bot.cibleX = joueurX;
              bot.cibleY = joueurY;
            } else {
              // Journaliste/fanatique : garder une legere distance
              var angle = Math.atan2(bot.y - joueurY, bot.x - joueurX);
              var distSuivi = bot.role === 'fanatique' ? 40 : 120;
              bot.cibleX = joueurX + Math.cos(angle) * distSuivi;
              bot.cibleY = joueurY + Math.sin(angle) * distSuivi;
            }
          } else {
            // Suivre un autre bot
            for (var sb = 0; sb < bots.length; sb++) {
              if (bots[sb].pseudo === bot.suiviCible && joueursElimines.indexOf(bots[sb].pseudo) < 0) {
                if (bot.role === 'virus') {
                  bot.cibleX = bots[sb].x;
                  bot.cibleY = bots[sb].y;
                } else {
                  var angle = Math.atan2(bot.y - bots[sb].y, bot.x - bots[sb].x);
                  var distSuivi = bot.role === 'fanatique' ? 40 : 120;
                  bot.cibleX = bots[sb].x + Math.cos(angle) * distSuivi;
                  bot.cibleY = bots[sb].y + Math.sin(angle) * distSuivi;
                }
                break;
              }
            }
          }
        }

        // Changer de cible si timer expire ou arrive a destination
        var distCible = Math.abs(bot.x - bot.cibleX) + Math.abs(bot.y - bot.cibleY);
        if (bot.timer <= 0 || distCible < 30) {
          // A l'arrivee, chance de faire une pause (simuler une mission)
          if (distCible < 30 && bot.role === 'innocent' && Math.random() < 0.4) {
            bot.etat = 'pause';
            bot.pauseTimer = 120 + Math.floor(Math.random() * 180); // 2-5 secondes de pause
            continue;
          }
          botChoisirCible(bot);
          bot.blockedTimer = 0;
        }

        // Calculer direction vers la cible
        var dx = bot.cibleX - bot.x;
        var dy = bot.cibleY - bot.y;
        var dist = Math.sqrt(dx * dx + dy * dy);

        if (dist > 2) {
          // Vitesse : virus un peu plus rapide en traque
          var vitesse = BOT_VITESSE;
          if (bot.role === 'virus' && bot.etat === 'traque') vitesse = BOT_VITESSE + 0.5;

          var mx = (dx / dist) * vitesse;
          var my = (dy / dist) * vitesse;

          // Collision X
          var newX = bot.x + mx;
          if (!checkCollision(newX, bot.y)) {
            bot.x = newX;
            bot.blockedTimer = 0;
          } else {
            bot.blockedTimer++;
          }

          // Collision Y
          var newY = bot.y + my;
          if (!checkCollision(bot.x, newY)) {
            bot.y = newY;
            bot.blockedTimer = 0;
          } else {
            bot.blockedTimer++;
          }

          // Si bloque trop longtemps, changer de cible
          if (bot.blockedTimer > 60) {
            botChoisirCible(bot);
            bot.blockedTimer = 0;
          }

          // Limites de la map
          if (bot.x < 25) bot.x = 25;
          if (bot.x > MAP_W - 40) bot.x = MAP_W - 40;
          if (bot.y < 25) bot.y = 25;
          if (bot.y > MAP_H - 40) bot.y = MAP_H - 40;

          // Flip sprite
          var botImg = bot.element ? bot.element.querySelector('img') : null;
          if (botImg) {
            botImg.style.transform = mx < 0 ? 'scaleX(-1)' : 'scaleX(1)';
          }
        }

        // Mettre a jour position DOM
        if (bot.element) {
          bot.element.style.left = bot.x + 'px';
          bot.element.style.top = bot.y + 'px';
        }
      }
    }

    // ============================
    // CONFIG HORS LIGNE
    // ============================
    var hlConfigJournaliste = 0;
    var hlConfigFanatique = 0;
    var hlConfigEspion = 0;

    function majConfigHL() {
      var nbTotal = parseInt(document.getElementById('hl-nb-joueurs').value);
      var nbVirus = parseInt(document.getElementById('hl-nb-virus').value);
      var nbBots = nbTotal - 1; // total - joueur

      // Regles : 1 virus par defaut, 2 virus a partir de 7 joueurs, 3 virus a partir de 10
      var maxVirus = 1;
      if (nbTotal >= 10) maxVirus = 3;
      else if (nbTotal >= 7) maxVirus = 2;

      var sliderVirus = document.getElementById('hl-nb-virus');
      sliderVirus.max = maxVirus;
      if (nbVirus > maxVirus) {
        nbVirus = maxVirus;
        sliderVirus.value = nbVirus;
      }

      // Contrainte : minimum 7 joueurs pour journaliste/fanatique/espion
      if (nbTotal < 7) {
        if (hlConfigEspion === 1) {
          hlConfigEspion = 0;
          var tE = document.getElementById('hl-toggle-espion');
          var tEL = document.getElementById('hl-toggle-espion-label');
          tE.classList.remove('active'); tEL.classList.remove('active');
          tEL.textContent = t('zeroSpy');
        }
        if (hlConfigFanatique === 1) {
          hlConfigFanatique = 0;
          var tF = document.getElementById('hl-toggle-fanatique');
          var tFL = document.getElementById('hl-toggle-fanatique-label');
          tF.classList.remove('active'); tFL.classList.remove('active');
          tFL.textContent = t('zeroFanatic');
        }
        if (hlConfigJournaliste === 1) {
          hlConfigJournaliste = 0;
          var tJ = document.getElementById('hl-toggle-journaliste');
          var tJL = document.getElementById('hl-toggle-journaliste-label');
          tJ.classList.remove('active'); tJL.classList.remove('active');
          tJL.textContent = t('zeroJournalist');
        }
      }

      // Contrainte : virus + journaliste + fanatique + espion ne doit pas depasser nbTotal
      var rolesSpeciaux = nbVirus + hlConfigJournaliste + hlConfigFanatique + hlConfigEspion;
      if (rolesSpeciaux >= nbTotal) {
        // Desactiver espion d'abord, puis fanatique, puis journaliste si necessaire
        if (hlConfigEspion === 1 && nbVirus + hlConfigJournaliste + hlConfigFanatique >= nbTotal) {
          hlConfigEspion = 0;
          var toggleE = document.getElementById('hl-toggle-espion');
          var toggleELabel = document.getElementById('hl-toggle-espion-label');
          toggleE.classList.remove('active');
          toggleELabel.classList.remove('active');
          toggleELabel.textContent = t('zeroSpy');
        }
        if (hlConfigFanatique === 1 && nbVirus + hlConfigJournaliste + hlConfigEspion >= nbTotal) {
          hlConfigFanatique = 0;
          var toggleF = document.getElementById('hl-toggle-fanatique');
          var toggleFLabel = document.getElementById('hl-toggle-fanatique-label');
          toggleF.classList.remove('active');
          toggleFLabel.classList.remove('active');
          toggleFLabel.textContent = t('zeroFanatic');
        }
        if (nbVirus + hlConfigJournaliste + hlConfigEspion >= nbTotal && hlConfigJournaliste === 1) {
          hlConfigJournaliste = 0;
          var toggle = document.getElementById('hl-toggle-journaliste');
          var toggleLabel = document.getElementById('hl-toggle-journaliste-label');
          toggle.classList.remove('active');
          toggleLabel.classList.remove('active');
          toggleLabel.textContent = t('zeroJournalist');
        }
      }

      // Mettre a jour les affichages
      document.getElementById('hl-nb-joueurs-val').textContent = nbTotal;
      document.getElementById('hl-nb-virus-val').textContent = nbVirus;

      var nbInnocents = nbTotal - nbVirus - hlConfigJournaliste - hlConfigFanatique - hlConfigEspion;
      document.getElementById('hl-resume-total').textContent = nbTotal;
      document.getElementById('hl-resume-innocents').textContent = nbInnocents;
      document.getElementById('hl-resume-virus').textContent = nbVirus;
      document.getElementById('hl-resume-journaliste').textContent = hlConfigJournaliste;
      document.getElementById('hl-resume-fanatique').textContent = hlConfigFanatique;
      document.getElementById('hl-resume-espion').textContent = hlConfigEspion;
    }

    function toggleJournalisteHL() {
      var toggle = document.getElementById('hl-toggle-journaliste');
      var toggleLabel = document.getElementById('hl-toggle-journaliste-label');
      var nbTotal = parseInt(document.getElementById('hl-nb-joueurs').value);
      var nbVirus = parseInt(document.getElementById('hl-nb-virus').value);

      if (hlConfigJournaliste === 1) {
        hlConfigJournaliste = 0;
        toggle.classList.remove('active');
        toggleLabel.classList.remove('active');
        toggleLabel.textContent = t('zeroJournalist');
      } else {
        if (nbTotal < 7) {
          showNotif(t('notEnoughJournalist'), 'warn');
          return;
        }
        if (nbVirus + 1 >= nbTotal) {
          showNotif(t('notEnoughJournalist'), 'warn');
          return;
        }
        hlConfigJournaliste = 1;
        toggle.classList.add('active');
        toggleLabel.classList.add('active');
        toggleLabel.textContent = t('oneJournalist');
      }
      majConfigHL();
    }

    function toggleFanatiqueHL() {
      var toggle = document.getElementById('hl-toggle-fanatique');
      var toggleLabel = document.getElementById('hl-toggle-fanatique-label');
      var nbTotal = parseInt(document.getElementById('hl-nb-joueurs').value);
      var nbVirus = parseInt(document.getElementById('hl-nb-virus').value);

      if (hlConfigFanatique === 1) {
        hlConfigFanatique = 0;
        toggle.classList.remove('active');
        toggleLabel.classList.remove('active');
        toggleLabel.textContent = t('zeroFanatic');
      } else {
        if (nbTotal < 7) {
          showNotif(t('notEnoughFanatic'), 'warn');
          return;
        }
        if (nbVirus + hlConfigJournaliste + 1 >= nbTotal) {
          showNotif(t('notEnoughFanatic'), 'warn');
          return;
        }
        hlConfigFanatique = 1;
        toggle.classList.add('active');
        toggleLabel.classList.add('active');
        toggleLabel.textContent = t('oneFanatic');
      }
      majConfigHL();
    }

    function toggleEspionHL() {
      var toggle = document.getElementById('hl-toggle-espion');
      var toggleLabel = document.getElementById('hl-toggle-espion-label');
      var nbTotal = parseInt(document.getElementById('hl-nb-joueurs').value);
      var nbVirus = parseInt(document.getElementById('hl-nb-virus').value);

      if (hlConfigEspion === 1) {
        hlConfigEspion = 0;
        toggle.classList.remove('active');
        toggleLabel.classList.remove('active');
        toggleLabel.textContent = t('zeroSpy');
      } else {
        if (nbTotal < 7) {
          showNotif(t('notEnoughSpy'), 'warn');
          return;
        }
        if (nbVirus + hlConfigJournaliste + hlConfigFanatique + 1 >= nbTotal) {
          showNotif(t('notEnoughSpy'), 'warn');
          return;
        }
        hlConfigEspion = 1;
        toggle.classList.add('active');
        toggleLabel.classList.add('active');
        toggleLabel.textContent = t('oneSpy');
      }
      majConfigHL();
    }

    function validerConfigHL() {
      var nbTotal = parseInt(document.getElementById('hl-nb-joueurs').value);
      var nbBots = nbTotal - 1;
      var nbVirus = parseInt(document.getElementById('hl-nb-virus').value);
      var nbJournaliste = hlConfigJournaliste;
      var nbFanatique = hlConfigFanatique;
      var nbEspion = hlConfigEspion;
      lancerHorsLigne(nbBots, nbVirus, nbJournaliste, nbFanatique, nbEspion);
    }

    function lancerHorsLigne(nbBots, nbVirus, nbJournaliste, nbFanatique, nbEspion) {
      nbBots = nbBots || 3;
      nbVirus = nbVirus || 1;
      nbJournaliste = (nbJournaliste !== undefined) ? nbJournaliste : 1;
      nbFanatique = (nbFanatique !== undefined) ? nbFanatique : 1;
      nbEspion = (nbEspion !== undefined) ? nbEspion : 1;

      modeHorsLigne = true;
      partieActuelleId = null;

      showScreen('jeu');
      jeuActif = true;

      // Reset position
      joueurX = 3800;
      joueurY = 3050;

      // Pseudo
      var pseudo = getPseudo() || t('player');
      var pseudoLabel = document.getElementById('joueur-pseudo-label');
      if (pseudoLabel) {
        pseudoLabel.textContent = pseudo;
        if (isAdmin()) {
          pseudoLabel.classList.add('pseudo-admin');
        } else {
          pseudoLabel.classList.remove('pseudo-admin');
        }
      }

      // Appliquer skin
      appliquerSkinPartout();
      updateJoueur();

      // Build collision
      requestAnimationFrame(function() {
        buildCollisionData();
      });

      // Creer les bots
      initBots(nbBots);

      // Attribution des roles
      var nbTotal = nbBots + 1; // bots + joueur
      var roles = [];
      for (var i = 0; i < nbTotal; i++) roles.push('innocent');

      // Placer les virus aleatoirement
      var indicesDisponibles = [];
      for (var i = 0; i < nbTotal; i++) indicesDisponibles.push(i);
      for (var v = 0; v < nbVirus; v++) {
        var pick = Math.floor(Math.random() * indicesDisponibles.length);
        roles[indicesDisponibles[pick]] = 'virus';
        indicesDisponibles.splice(pick, 1);
      }

      // Placer le(s) journaliste(s)
      for (var j = 0; j < nbJournaliste; j++) {
        if (indicesDisponibles.length === 0) break;
        var pick = Math.floor(Math.random() * indicesDisponibles.length);
        roles[indicesDisponibles[pick]] = 'journaliste';
        indicesDisponibles.splice(pick, 1);
      }

      // Placer le(s) fanatique(s) (role neutre)
      for (var f = 0; f < nbFanatique; f++) {
        if (indicesDisponibles.length === 0) break;
        var pickF = Math.floor(Math.random() * indicesDisponibles.length);
        roles[indicesDisponibles[pickF]] = 'fanatique';
        indicesDisponibles.splice(pickF, 1);
      }

      // Placer le(s) espion(s) (role neutre)
      for (var es = 0; es < nbEspion; es++) {
        if (indicesDisponibles.length === 0) break;
        var pickE = Math.floor(Math.random() * indicesDisponibles.length);
        roles[indicesDisponibles[pickE]] = 'espion';
        indicesDisponibles.splice(pickE, 1);
      }

      // Le joueur est l'index 0
      monRole = roles[0];
      // Attribuer les roles aux bots
      for (var b = 0; b < bots.length; b++) {
        bots[b].role = roles[b + 1];
      }

      // Les bots espion choisissent aleatoirement un camp (avant coloration)
      for (var be0 = 0; be0 < bots.length; be0++) {
        if (bots[be0].role === 'espion') {
          bots[be0].espionCamp = Math.random() < 0.5 ? 'virus' : 'innocent';
        }
      }

      // Si le joueur est virus, colorer les pseudos des allies virus en rouge
      if (monRole === 'virus') {
        for (var bv = 0; bv < bots.length; bv++) {
          if (bots[bv].role === 'virus') {
            var pseudoEl = bots[bv].element.querySelector('.joueur-pseudo');
            if (pseudoEl) pseudoEl.style.color = '#e74c3c';
          }
        }
        // Si le joueur est virus, colorer les espions (camp virus) en violet
        for (var be2 = 0; be2 < bots.length; be2++) {
          if (bots[be2].role === 'espion' && bots[be2].espionCamp === 'virus') {
            var pseudoElE = bots[be2].element.querySelector('.joueur-pseudo');
            if (pseudoElE) pseudoElE.style.color = '#8e44ad';
          }
        }
      }

      // Afficher le role dans le HUD
      var roleEl = document.getElementById('hud-role');
      if (roleEl) {
        roleEl.className = 'hud-role hud-role-' + monRole;
        if (monRole === 'virus') { roleEl.textContent = t('roleVirus'); }
        else if (monRole === 'journaliste') { roleEl.textContent = t('roleJournalist'); }
        else if (monRole === 'fanatique') { roleEl.textContent = t('roleFanatic'); }
        else if (monRole === 'espion') { roleEl.textContent = t('roleSpy'); }
        else { roleEl.textContent = t('roleInnocent'); }
      }

      // Sauvegarder tous les joueurs pour l'ecran de fin
      tousLesJoueursPartie = [];
      tousLesJoueursPartie.push({ pseudo: pseudo, skin: getSkinFichier(getSkin()), role: monRole, estBot: false });
      for (var tj = 0; tj < bots.length; tj++) {
        tousLesJoueursPartie.push({ pseudo: bots[tj].pseudo, skin: bots[tj].skin, role: bots[tj].role, estBot: true });
      }

      // Notification role
      if (monRole === 'virus') {
        var aliesVirus = [];
        for (var av = 0; av < bots.length; av++) {
          if (bots[av].role === 'virus') aliesVirus.push(bots[av].pseudo);
        }
        if (aliesVirus.length > 0) {
          showNotif(t('youAreVirusAllies', aliesVirus.join(', ')), 'warn');
        } else {
          showNotif(t('youAreOnlyVirus'), 'warn');
        }
      } else if (monRole === 'journaliste') {
        showNotif(t('youAreJournalist', nbVirus), 'info');
        botsEnquetes = [];
        enquetesRestantes = nbVirus;
      } else if (monRole === 'fanatique') {
        showNotif(t('youAreFanatic'), 'info');
      } else if (monRole === 'espion') {
        showNotif(t('youAreSpy'), 'info');
        var overlay = document.getElementById('espion-choix-overlay');
        if (overlay) overlay.style.display = 'flex';
      } else {
        showNotif(t('youAreInnocent'), 'info');
      }

      // Reset eliminations
      joueursElimines = [];
      botsMorts = [];
      for (var ci = 0; ci < cadavres.length; ci++) {
        if (cadavres[ci].element && cadavres[ci].element.parentNode) cadavres[ci].element.parentNode.removeChild(cadavres[ci].element);
      }
      cadavres = [];
      killCooldown = false;
      if (killCountdownInterval) { clearInterval(killCountdownInterval); killCountdownInterval = null; }
      var cdElReset = document.getElementById('kill-countdown');
      if (cdElReset) cdElReset.style.display = 'none';
      botKillCooldowns = {};
      botSignaleCooldown = false;
      botsEnquetes = [];
      reunionEnCours = false;
      reunionCooldown = false;
      voteTermine = false;
      voteChoisi = -1;
      joueurAVote = false;
      if (reunionTimer) { clearInterval(reunionTimer); reunionTimer = null; }
      // Retirer le visuel fantome du joueur (si mort dans la partie precedente)
      var joueurEl = document.getElementById('joueur');
      if (joueurEl) joueurEl.classList.remove('bot-mort');

      // Protection de 7 secondes au debut
      activerKillProtection();

      // Missions
      initMissions();

      // Game loop
      gameLoop();
    }

    function lancerJeu() {
      // Mode en ligne : demarrer la partie (host assigne les roles)
      if (partieActuelleId && !modeHorsLigne) {
        if (!estHost) { showNotif('Seul le host peut demarrer', 'warn'); return; }
        if (firebasePartyPlayers.length < 4) { showNotif(t('need4Players'), 'warn'); return; }

        // Assigner les roles cote client (host)
        var partyData = firebaseParties.find(function(p) { return p._id === partieActuelleId; });
        var nbVirus = partyData ? partyData.mechants : 1;
        var hasJournaliste = partyData ? partyData.journaliste : false;
        var hasFanatique = partyData ? partyData.fanatique : false;
        var hasEspion = partyData ? partyData.espion : false;

        var roles = [];
        for (var v = 0; v < nbVirus; v++) roles.push('virus');
        if (hasJournaliste) roles.push('journaliste');
        if (hasFanatique) roles.push('fanatique');
        if (hasEspion) roles.push('espion');
        while (roles.length < firebasePartyPlayers.length) roles.push('innocent');

        // Melanger les roles
        for (var i = roles.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var tmp = roles[i]; roles[i] = roles[j]; roles[j] = tmp;
        }

        // Assigner a chaque joueur
        var batch = db.batch();
        firebasePartyPlayers.forEach(function(p, idx) {
          if (p._docId) {
            batch.update(db.collection('partyPlayers').doc(p._docId), {
              role: roles[idx], alive: true, x: 3800, y: 3050
            });
          }
        });
        batch.update(db.collection('parties').doc(partieActuelleId), { phase: 'playing' });
        batch.commit().catch(function() { showNotif('Erreur de connexion', 'warn'); });
        return;
      }

      // Mode hors ligne : demarrage local (inchange)

      showScreen('jeu');
      jeuActif = true;
      // Reset UI reunion au demarrage
      var skipBtn = document.getElementById('reunion-btn-skip');
      if (skipBtn) skipBtn.classList.remove('visible');
      var bandeauR = document.getElementById('reunion-bandeau');
      if (bandeauR) bandeauR.classList.remove('visible');
      var chatR = document.getElementById('reunion-chat');
      if (chatR) chatR.classList.remove('visible');
      var resultatR = document.getElementById('reunion-resultat');
      if (resultatR) { resultatR.classList.remove('visible'); resultatR.style.display = 'none'; }

      // Attribution des roles
      var nbMechants = 1;
      if (partieActuelleId) {
        var pp = getParties();
        for (var ri = 0; ri < pp.length; ri++) {
          if (pp[ri].id === partieActuelleId) { nbMechants = pp[ri].mechants || 1; break; }
        }
      }
      // Creer la liste des roles : X virus, 1 journaliste, reste innocents
      var nbTotal = 4; // simule un minimum de 4 joueurs
      if (partieActuelleId) {
        var pt = getParties();
        for (var ti = 0; ti < pt.length; ti++) {
          if (pt[ti].id === partieActuelleId) { nbTotal = pt[ti].joueurs || 4; break; }
        }
      }
      if (nbTotal < 4) nbTotal = 4;
      var roleEl = document.getElementById('hud-role');

      // Reset position
      joueurX = 3800;
      joueurY = 3050;
      // Afficher le pseudo au-dessus du joueur
      var pseudo = getPseudo() || t('player');
      var pseudoLabel = document.getElementById('joueur-pseudo-label');
      if (pseudoLabel) {
        pseudoLabel.textContent = pseudo;
        if (isAdmin()) {
          pseudoLabel.classList.add('pseudo-admin');
        } else {
          pseudoLabel.classList.remove('pseudo-admin');
        }
      }
      // Appliquer le skin
      appliquerSkinPartout();
      updateJoueur();
      // Build collision data after render
      requestAnimationFrame(function() {
        buildCollisionData();
      });
      // Reset eliminations
      joueursElimines = [];
      botsMorts = [];
      for (var ci = 0; ci < cadavres.length; ci++) {
        if (cadavres[ci].element && cadavres[ci].element.parentNode) cadavres[ci].element.parentNode.removeChild(cadavres[ci].element);
      }
      cadavres = [];
      killCooldown = false;
      if (killCountdownInterval) { clearInterval(killCountdownInterval); killCountdownInterval = null; }
      botKillCooldowns = {};
      botSignaleCooldown = false;
      reunionEnCours = false;
      reunionCooldown = false;
      voteTermine = false;
      voteChoisi = -1;
      joueurAVote = false;
      if (reunionTimer) { clearInterval(reunionTimer); reunionTimer = null; }

      // Creer des bots pour simuler les autres joueurs en ligne
      initBots(nbTotal - 1);
      // Attribuer les roles aux bots
      var rolesOnline = [];
      for (var ro = 0; ro < nbTotal; ro++) rolesOnline.push('innocent');
      var indicesOnline = [];
      for (var io = 0; io < nbTotal; io++) indicesOnline.push(io);
      // Placer les virus
      for (var vo = 0; vo < nbMechants; vo++) {
        if (indicesOnline.length === 0) break;
        var pickV = Math.floor(Math.random() * indicesOnline.length);
        rolesOnline[indicesOnline[pickV]] = 'virus';
        indicesOnline.splice(pickV, 1);
      }
      // Placer 1 journaliste
      if (indicesOnline.length > 0) {
        var pickJ = Math.floor(Math.random() * indicesOnline.length);
        rolesOnline[indicesOnline[pickJ]] = 'journaliste';
        indicesOnline.splice(pickJ, 1);
      }
      // Placer 1 fanatique (role neutre)
      if (indicesOnline.length > 0) {
        var pickF = Math.floor(Math.random() * indicesOnline.length);
        rolesOnline[indicesOnline[pickF]] = 'fanatique';
        indicesOnline.splice(pickF, 1);
      }
      // Placer 1 espion (role neutre)
      if (indicesOnline.length > 0) {
        var pickE = Math.floor(Math.random() * indicesOnline.length);
        rolesOnline[indicesOnline[pickE]] = 'espion';
        indicesOnline.splice(pickE, 1);
      }
      // Index 0 = joueur, reste = bots
      monRole = rolesOnline[0];
      for (var bo = 0; bo < bots.length; bo++) {
        bots[bo].role = rolesOnline[bo + 1];
      }

      // Les bots espion choisissent aleatoirement un camp (avant coloration)
      for (var be0 = 0; be0 < bots.length; be0++) {
        if (bots[be0].role === 'espion') {
          bots[be0].espionCamp = Math.random() < 0.5 ? 'virus' : 'innocent';
        }
      }

      // Mettre a jour le HUD du role
      if (roleEl) {
        roleEl.className = 'hud-role hud-role-' + monRole;
        if (monRole === 'virus') { roleEl.textContent = t('roleVirus'); }
        else if (monRole === 'journaliste') { roleEl.textContent = t('roleJournalist'); }
        else if (monRole === 'fanatique') { roleEl.textContent = t('roleFanatic'); }
        else if (monRole === 'espion') { roleEl.textContent = t('roleSpy'); }
        else { roleEl.textContent = t('roleInnocent'); }
      }
      // Si virus, colorer les allies
      if (monRole === 'virus') {
        for (var bvo = 0; bvo < bots.length; bvo++) {
          if (bots[bvo].role === 'virus') {
            var pseudoElV = bots[bvo].element.querySelector('.joueur-pseudo');
            if (pseudoElV) pseudoElV.style.color = '#e74c3c';
          }
        }
        // Si le joueur est virus, colorer les espions (camp virus) en violet
        for (var be2 = 0; be2 < bots.length; be2++) {
          if (bots[be2].role === 'espion' && bots[be2].espionCamp === 'virus') {
            var pseudoElE = bots[be2].element.querySelector('.joueur-pseudo');
            if (pseudoElE) pseudoElE.style.color = '#8e44ad';
          }
        }
      }
      // Notification role
      if (monRole === 'virus') {
        showNotif(t('youAreTheVirus'), 'warn');
      } else if (monRole === 'journaliste') {
        showNotif(t('youAreJournalist', nbMechants), 'info');
        botsEnquetes = [];
        enquetesRestantes = nbMechants;
        setTimeout(function() { ouvrirPouvoirJournaliste(nbTotal); }, 1500);
      } else if (monRole === 'fanatique') {
        showNotif(t('youAreFanatic'), 'info');
      } else if (monRole === 'espion') {
        showNotif(t('youAreSpy'), 'info');
        var overlayE = document.getElementById('espion-choix-overlay');
        if (overlayE) overlayE.style.display = 'flex';
      } else {
        showNotif(t('youAreInnocent'), 'info');
      }

      // Sauvegarder tous les joueurs
      tousLesJoueursPartie = [];
      var pseudoJoueur = getPseudo() || t('player');
      tousLesJoueursPartie.push({ pseudo: pseudoJoueur, skin: getSkinFichier(getSkin()), role: monRole, estBot: false });
      for (var tjo = 0; tjo < bots.length; tjo++) {
        tousLesJoueursPartie.push({ pseudo: bots[tjo].pseudo, skin: bots[tjo].skin, role: bots[tjo].role, estBot: true });
      }

      // Initialiser les missions (4 aleatoires)
      initMissions();
      // Jauge collective de missions (mode en ligne)
      totalMissionsCollectives = nbTotal * 4;
      missionsCollectivesCompletees = 0;
      updateJaugeMissions();
      demarrerSimulationMissions(nbTotal - 1);
      gameLoop();
    }

    var reunionCooldown = false;
    var REUNION_COOLDOWN_MS = 10000; // 10 secondes entre reunions
    var reunionCreateur = ''; // pseudo de celui qui a declenche la reunion

    function demanderReunion() {
      if (reunionEnCours) return;
      var pseudo = getPseudo() || t('player');
      if (joueursElimines.indexOf(pseudo) >= 0) {
        showNotif(t('ghostsCantMeet'), 'warn');
        return;
      }
      if (reunionCooldown) {
        showNotif(t('waitBeforeMeeting'), 'warn');
        return;
      }

      // Mode multiplayer : creer une reunion sur Firebase
      if (partieActuelleId && !modeHorsLigne) {
        db.collection('meetings').add({
          partyId: partieActuelleId,
          initiatorPlayerId: monPlayerId,
          reason: 'emergency',
          active: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function() {
          db.collection('parties').doc(partieActuelleId).update({ phase: 'meeting' });
        }).catch(function() {});
        return;
      }

      // Mode hors ligne : logique locale
      showNotif(t('emergencyMeetingNotif'), 'warn');
      reunionCreateur = pseudo;
      if (camerasOuvertes) fermerCameras();
      jeuActif = false;
      setTimeout(function() {
        try { ouvrirReunion(); } catch(e) { jeuActif = true; reunionEnCours = false; gameLoop(); }
      }, 500);
    }

    // ============================
    // POUVOIR DU JOURNALISTE
    // ============================
    var FAUX_PSEUDOS = [
      'DarkShadow', 'xXKillerXx', 'ProGamer99', 'NinjaFurtif', 'LoupSolitaire',
      'FlashMcQueen', 'CaptainMal', 'ViperNoir', 'FoxRuse', 'TigreBlanc',
      'PhantomX', 'AceSniper', 'StormRider', 'BlazeFire', 'IceWolf',
      'ThunderBolt', 'SilverArrow', 'GhostRecon', 'RedFalcon', 'BlueDragon'
    ];
    var joueursSimules = [];

    function ouvrirPouvoirJournaliste(nbJoueurs) {
      var popup = document.getElementById('popup-journaliste');
      var choixDiv = document.getElementById('journaliste-choix');
      var resultatsDiv = document.getElementById('journaliste-resultats');
      var fermerBtn = document.getElementById('journaliste-fermer');

      // Reset
      resultatsDiv.className = 'journaliste-resultats';
      resultatsDiv.innerHTML = '';
      fermerBtn.style.display = 'none';

      // Generer les joueurs simules (sauf le journaliste)
      var pool = FAUX_PSEUDOS.slice();
      joueursSimules = [];
      for (var i = 0; i < nbJoueurs - 1 && pool.length > 0; i++) {
        var idx = Math.floor(Math.random() * pool.length);
        joueursSimules.push({ pseudo: pool[idx], role: 'innocent' });
        pool.splice(idx, 1);
      }

      // Max virus possible
      var maxVirus = Math.min(3, Math.floor((nbJoueurs - 1) / 2));
      if (maxVirus < 1) maxVirus = 1;

      // Generer les boutons de choix
      var html = '';
      for (var v = 1; v <= maxVirus; v++) {
        html += '<button class="journaliste-choix-btn" onclick="choisirNbVirus(' + v + ')">' + v + '</button>';
      }
      choixDiv.innerHTML = html;

      popup.classList.add('visible');
    }

    function choisirNbVirus(nb) {
      var choixDiv = document.getElementById('journaliste-choix');
      var resultatsDiv = document.getElementById('journaliste-resultats');
      var fermerBtn = document.getElementById('journaliste-fermer');

      // Masquer les boutons de choix
      choixDiv.innerHTML = '<span style="color:#3498db; font-size:14px;">' + t('youChoseVirus', nb) + '</span>';

      // En mode hors ligne, garder les vrais roles des bots
      // En mode online, assigner les virus aleatoirement
      if (!modeHorsLigne) {
        var indices = [];
        for (var i = 0; i < joueursSimules.length; i++) {
          joueursSimules[i].role = 'innocent';
          indices.push(i);
        }
        for (var v = 0; v < nb && indices.length > 0; v++) {
          var ri = Math.floor(Math.random() * indices.length);
          joueursSimules[indices[ri]].role = 'virus';
          indices.splice(ri, 1);
        }
      }

      // Afficher les resultats
      var html = '<div style="color:#3498db; font-size:13px; margin-bottom:10px; letter-spacing:1px;">' + t('playerRoles') + '</div>';
      // Ajouter le journaliste (le joueur)
      html += '<div class="journaliste-resultat-item">';
      html += '<span class="journaliste-resultat-nom">' + (getPseudo() || t('player')) + ' ' + t('youLabel') + '</span>';
      html += '<span class="journaliste-resultat-role" style="background:#3498db;color:white;">JOURNALISTE</span>';
      html += '</div>';
      // Ajouter les autres joueurs
      for (var j = 0; j < joueursSimules.length; j++) {
        var p = joueursSimules[j];
        var tagClass = p.role === 'virus' ? 'role-tag-virus' : 'role-tag-innocent';
        var tagText = p.role === 'virus' ? 'VIRUS' : 'INNOCENT';
        html += '<div class="journaliste-resultat-item">';
        html += '<span class="journaliste-resultat-nom">' + p.pseudo + '</span>';
        html += '<span class="journaliste-resultat-role ' + tagClass + '">' + tagText + '</span>';
        html += '</div>';
      }

      resultatsDiv.innerHTML = html;
      resultatsDiv.classList.add('visible');
      fermerBtn.style.display = 'inline-block';
    }

    function fermerPouvoirJournaliste() {
      var popup = document.getElementById('popup-journaliste');
      popup.classList.remove('visible');
      showNotif(t('useInfoWisely'), 'info');
    }

    // ============================
    // SYSTEME DE REUNION
    // ============================
    var joueursReunion = [];
    var joueursElimines = [];
    var tousLesJoueursPartie = []; // sauvegarde de tous les joueurs au debut de la partie
    var positionsAvantReunion = {}; // sauvegarder les positions avant teleportation
    var joueurAVote = false;
    var nbVotesTotal = 0;
    var votesParJoueur = []; // votes[i] = nombre de votes recus par joueur i

    function ouvrirReunion() {
      if (reunionEnCours) return;
      if (miniJeuOuvert) pauserMiniJeu();
      reunionEnCours = true;
      voteChoisi = -1;
      joueurAVote = false;
      nbVotesTotal = 0;
      voteTermine = false;

      // Son reunion d'urgence
      try { var sReunion = new Audio("runion d'urgence !.mp3"); sReunion.volume = 0.6; sReunion.play(); } catch(e) {}

      // Stopper le deplacement tactile pendant la reunion
      touchActif = false;
      // Fermer les cameras si elles sont ouvertes
      if (camerasOuvertes) fermerCameras();

      // Supprimer tous les cadavres de la map AVANT teleportation
      for (var ci = 0; ci < cadavres.length; ci++) {
        if (cadavres[ci].element && cadavres[ci].element.parentNode) {
          cadavres[ci].element.parentNode.removeChild(cadavres[ci].element);
        }
      }
      cadavres = [];

      // Construire la liste des joueurs
      joueursReunion = [];
      var pseudo = getPseudo() || t('player');
      joueursReunion.push({
        pseudo: pseudo,
        skin: getSkinFichier(getSkin()),
        role: monRole,
        estBot: false,
        elimine: joueursElimines.indexOf(pseudo) >= 0,
        elementId: 'joueur'
      });
      if (bots.length > 0) {
        for (var i = 0; i < bots.length; i++) {
          joueursReunion.push({
            pseudo: bots[i].pseudo,
            skin: bots[i].skin,
            role: bots[i].role,
            estBot: true,
            elimine: joueursElimines.indexOf(bots[i].pseudo) >= 0,
            elementId: bots[i].id
          });
        }
      }

      // Init votes
      votesParJoueur = [];
      for (var vi = 0; vi < joueursReunion.length; vi++) {
        votesParJoueur.push(0);
      }

      // Sauvegarder positions et teleporter autour de la fontaine
      var fontCX = 3800, fontCY = 2800;
      var rayon = isMobile ? 110 : 220;
      var nbJoueurs = joueursReunion.length;

      // Sauvegarder position joueur
      positionsAvantReunion.joueurX = joueurX;
      positionsAvantReunion.joueurY = joueurY;

      for (var j = 0; j < nbJoueurs; j++) {
        var angle = (j / nbJoueurs) * 2 * Math.PI - Math.PI / 2;
        var px = fontCX + Math.cos(angle) * rayon;
        var py = fontCY + Math.sin(angle) * rayon;

        if (j === 0) {
          // Teleporter le joueur
          joueurX = px;
          joueurY = py;
          updateJoueur();
        } else {
          // Teleporter les bots
          var botData = bots[j - 1];
          if (botData) {
            positionsAvantReunion[botData.id] = { x: botData.x, y: botData.y };
            botData.x = px;
            botData.y = py;
            botData.element.style.left = px + 'px';
            botData.element.style.top = py + 'px';
          }
        }
      }

      // Centrer la camera sur la fontaine
      var viewport = document.getElementById('jeu-viewport');
      var vw = viewport.clientWidth;
      var vh = viewport.clientHeight;
      var camOffsetY = isMobile ? 0 : -40;
      var camX = fontCX - vw / 2;
      var camY = fontCY - vh / 2 + camOffsetY;
      if (camX < 0) camX = 0;
      if (camY < 0) camY = 0;
      if (camX > MAP_W - vw) camX = MAP_W - vw;
      if (camY > MAP_H - vh) camY = MAP_H - vh;
      var map = document.getElementById('mall-map');
      map.style.left = -camX + 'px';
      map.style.top = -camY + 'px';

      // Le joueur est-il un fantome ?
      var joueurEstFantome = joueursElimines.indexOf(pseudo) >= 0;

      // Ajouter bulles de vote et rendre les bots cliquables
      for (var k = 0; k < joueursReunion.length; k++) {
        var el = document.getElementById(joueursReunion[k].elementId);
        if (!el) continue;

        // Ajouter bulle de vote
        var bulle = document.createElement('div');
        bulle.className = 'vote-bulle';
        bulle.id = 'vote-bulle-' + k;
        bulle.textContent = '0';
        el.appendChild(bulle);

        // Rendre cliquable (sauf si le joueur est fantome) - tout joueur peut s'auto-voter
        if (!joueurEstFantome) {
          el.classList.add('reunion-cliquable');
          el.setAttribute('data-reunion-idx', k);
          el.onclick = (function(idx) {
            return function() { voterPour(idx); };
          })(k);
        }
      }

      // Ajouter badge createur de reunion
      for (var cr = 0; cr < joueursReunion.length; cr++) {
        if (joueursReunion[cr].pseudo === reunionCreateur) {
          var elCr = document.getElementById(joueursReunion[cr].elementId);
          if (elCr) {
            var badgeCr = document.createElement('div');
            badgeCr.className = 'reunion-createur-badge';
            badgeCr.id = 'reunion-createur-badge';
            badgeCr.innerHTML = '&#128227;';
            elCr.appendChild(badgeCr);
          }
          break;
        }
      }

      // Afficher HUD reunion
      document.getElementById('reunion-bandeau').classList.add('visible');
      document.getElementById('reunion-chat').classList.add('visible');
      // Masquer le skip si le joueur est fantome
      if (!joueurEstFantome) {
        document.getElementById('reunion-btn-skip').classList.add('visible');
      }
      document.getElementById('reunion-resultat').classList.remove('visible');
      document.getElementById('reunion-resultat').style.display = 'none';
      document.getElementById('reunion-chat-messages').innerHTML = '';

      // Masquer boutons de jeu et HUD inutile pendant la reunion
      var btnReunion = document.getElementById('btn-reunion');
      if (btnReunion) btnReunion.style.display = 'none';
      var btnMission = document.getElementById('btn-mission');
      if (btnMission) btnMission.style.display = 'none';
      var btnKillR = document.getElementById('btn-kill');
      if (btnKillR) btnKillR.style.display = 'none';
      var btnSignalerR = document.getElementById('btn-signaler');
      if (btnSignalerR) btnSignalerR.style.display = 'none';
      var cdElR = document.getElementById('kill-countdown');
      if (cdElR) cdElR.style.display = 'none';
      // Masquer missions et minimap pendant la reunion sur mobile
      var hudMissions = document.querySelector('.hud-missions');
      if (hudMissions) hudMissions.style.display = 'none';
      var minimap = document.querySelector('.minimap');
      if (minimap) minimap.style.display = 'none';
      if (killCountdownInterval) { clearInterval(killCountdownInterval); killCountdownInterval = null; }

      // Cadavres deja supprimes au debut de ouvrirReunion()

      // Afficher la liste des morts
      if (joueursElimines.length > 0) {
        ajouterMsgReunion(t('system'), t('meetDead', joueursElimines.join(', ')), '#e74c3c');
      }

      // Timer 60 secondes
      var tempsRestant = 60;
      document.getElementById('reunion-timer').textContent = tempsRestant;
      reunionTimer = setInterval(function() {
        tempsRestant--;
        document.getElementById('reunion-timer').textContent = tempsRestant;
        if (tempsRestant <= 10) {
          document.getElementById('reunion-timer').style.color = '#e74c3c';
        }
        if (tempsRestant <= 0) {
          clearInterval(reunionTimer);
          reunionTimer = null;
          if (!voteTermine) terminerVote();
        }
      }, 1000);

      // Bots votent apres un delai
      if (modeHorsLigne) {
        for (var bi = 0; bi < bots.length; bi++) {
          (function(botIndex) {
            var delai = 5000 + Math.floor(Math.random() * 30000);
            setTimeout(function() {
              if (!reunionEnCours) return;
              botVoter(botIndex);
              verifierTousOntVote();
            }, delai);
          })(bi);
        }
      }

      if (joueurEstFantome) {
        joueurAVote = true;
        nbVotesTotal++;
        ajouterMsgReunion(t('system'), t('meetYouAreGhost'), '#7f8c8d');
      }

      ajouterMsgReunion(t('system'), t('meetEmergency'), '#f39c12');

      // Lancer le chat IA des bots
      if (bots.length > 0) lancerChatBotsIA();
    }

    var botsChatTimers = [];

    function lancerChatBotsIA() {
      // Nettoyer les anciens timers
      for (var ti = 0; ti < botsChatTimers.length; ti++) clearTimeout(botsChatTimers[ti]);
      botsChatTimers = [];

      var phrasesAccusation = t('botAccusation');
      var phrasesDefense = t('botDefense');
      var phrasesReaction = t('botReaction');
      var phrasesVirus = t('botVirus');
      var phrasesJournaliste = t('botJournalist');
      var phrasesFanatique = t('botFanatic');
      var phrasesEspion = t('botSpy');
      var phrasesCommentaire = t('botComment');

      var pseudoJoueur = getPseudo() || t('player');

      // Creer une file de messages : chaque bot parle a tour de role, 3-10s entre chaque
      var botsActifs = [];
      for (var b = 0; b < bots.length; b++) {
        if (joueursElimines.indexOf(bots[b].pseudo) >= 0) continue;
        botsActifs.push(bots[b]);
      }
      if (botsActifs.length === 0) return;

      var delaiCumule = 2000; // Premier message apres 2s
      // 3-5 messages par bot, melanges aleatoirement
      var fileMessages = [];
      for (var fb = 0; fb < botsActifs.length; fb++) {
        var nbMsg = 3 + Math.floor(Math.random() * 3); // 3-5 messages par bot
        for (var fm = 0; fm < nbMsg; fm++) fileMessages.push(botsActifs[fb]);
      }
      // Melanger l'ordre des messages
      for (var sh = fileMessages.length - 1; sh > 0; sh--) {
        var rIdx = Math.floor(Math.random() * (sh + 1));
        var tmp = fileMessages[sh]; fileMessages[sh] = fileMessages[rIdx]; fileMessages[rIdx] = tmp;
      }
      for (var m = 0; m < fileMessages.length; m++) {
        (function(msgIdx) {
          var bot = fileMessages[msgIdx];
          var timer = setTimeout(function() {
            if (!reunionEnCours) return;
            var msg;
            var rand = Math.random();

            // Cibles pour accusations/enquetes
            var cibles = [];
            for (var j = 0; j < bots.length; j++) {
              if (bots[j].pseudo !== bot.pseudo && joueursElimines.indexOf(bots[j].pseudo) < 0) cibles.push(bots[j].pseudo);
            }
            if (pseudoJoueur && joueursElimines.indexOf(pseudoJoueur) < 0) cibles.push(pseudoJoueur);
            var cible = cibles.length > 0 ? cibles[Math.floor(Math.random() * cibles.length)] : '';

            // Les virus essaient de devier l'attention
            if (bot.role === 'virus' && rand < 0.5) {
              msg = phrasesVirus[Math.floor(Math.random() * phrasesVirus.length)];
            } else if (bot.role === 'journaliste' && rand < 0.5) {
              msg = phrasesJournaliste[Math.floor(Math.random() * phrasesJournaliste.length)].replace('{c}', cible);
            } else if (bot.role === 'fanatique' && rand < 0.5) {
              msg = phrasesFanatique[Math.floor(Math.random() * phrasesFanatique.length)];
            } else if (bot.role === 'espion' && rand < 0.5) {
              msg = phrasesEspion[Math.floor(Math.random() * phrasesEspion.length)].replace('{c}', cible);
            } else if (rand < 0.4) {
              if (cibles.length > 0) {
                msg = phrasesAccusation[Math.floor(Math.random() * phrasesAccusation.length)].replace('{c}', cible);
              } else {
                msg = phrasesReaction[Math.floor(Math.random() * phrasesReaction.length)];
              }
            } else if (rand < 0.65) {
              msg = phrasesDefense[Math.floor(Math.random() * phrasesDefense.length)];
            } else if (phrasesCommentaire.length > 0 && Math.random() < 0.3) {
              msg = phrasesCommentaire[Math.floor(Math.random() * phrasesCommentaire.length)].replace('{c}', cible);
            } else {
              msg = phrasesReaction[Math.floor(Math.random() * phrasesReaction.length)];
            }

            ajouterMsgReunion(bot.pseudo, msg, '#95a5a6');
          }, delaiCumule);
          botsChatTimers.push(timer);
          delaiCumule += 3000 + Math.floor(Math.random() * 7000); // 3-10s entre chaque message
        })(m);
      }
    }

    function voterPour(index) {
      if (!reunionEnCours || joueurAVote) return;
      if (joueursReunion[index].elimine) return;
      // Les fantomes ne peuvent pas voter
      var pseudo = getPseudo() || t('player');
      if (joueursElimines.indexOf(pseudo) >= 0) {
        showNotif(t('ghostsCantVote'), 'warn');
        return;
      }

      // Deselectionner l'ancien
      if (voteChoisi >= 0) {
        var oldEl = document.getElementById(joueursReunion[voteChoisi].elementId);
        if (oldEl) oldEl.classList.remove('reunion-vote-selection');
      }

      // Selectionner le nouveau
      voteChoisi = index;
      var el = document.getElementById(joueursReunion[index].elementId);
      if (el) el.classList.add('reunion-vote-selection');

      // Son de vote
      try { new Audio('I VOTED.mp3').play(); } catch(e) {}

      // Confirmer le vote immediatement
      joueurAVote = true;
      nbVotesTotal++;
      votesParJoueur[index]++;

      // Mettre a jour la bulle
      var bulle = document.getElementById('vote-bulle-' + index);
      if (bulle) {
        bulle.textContent = votesParJoueur[index];
        bulle.classList.add('has-votes');
      }

      // Masquer le skip
      document.getElementById('reunion-btn-skip').classList.remove('visible');

      ajouterMsgReunion(getPseudo() || t('player'), t('meetVoted'), '#e74c3c');

      // Retirer cliquable
      for (var i = 0; i < joueursReunion.length; i++) {
        var elem = document.getElementById(joueursReunion[i].elementId);
        if (elem) {
          elem.classList.remove('reunion-cliquable');
          elem.onclick = null;
        }
      }

      verifierTousOntVote();
    }

    function skipVote() {
      if (!reunionEnCours || joueurAVote) return;
      var pseudo = getPseudo() || t('player');
      if (joueursElimines.indexOf(pseudo) >= 0) {
        showNotif(t('ghostsCantVote'), 'warn');
        return;
      }
      // Son de vote
      try { new Audio('I VOTED.mp3').play(); } catch(e) {}
      joueurAVote = true;
      nbVotesTotal++;

      document.getElementById('reunion-btn-skip').classList.remove('visible');
      ajouterMsgReunion(getPseudo() || t('player'), t('meetSkipped'), '#95a5a6');

      // Retirer cliquable
      for (var i = 0; i < joueursReunion.length; i++) {
        var elem = document.getElementById(joueursReunion[i].elementId);
        if (elem) {
          elem.classList.remove('reunion-cliquable');
          elem.onclick = null;
        }
      }

      verifierTousOntVote();
    }

    function botVoter(botIdx) {
      if (!reunionEnCours) return;
      var bot = bots[botIdx];
      if (!bot) return;

      var cibles = [];
      for (var i = 0; i < joueursReunion.length; i++) {
        if (!joueursReunion[i].elimine && joueursReunion[i].pseudo !== bot.pseudo) {
          cibles.push(i);
        }
      }
      if (cibles.length === 0) return;

      var cibleIdx;
      if (bot.role === 'fanatique') {
        // Le fanatique vote pour lui-meme (il veut etre elimine)
        for (var fi = 0; fi < joueursReunion.length; fi++) {
          if (joueursReunion[fi].pseudo === bot.pseudo && !joueursReunion[fi].elimine) { cibleIdx = fi; break; }
        }
        if (cibleIdx === undefined || cibleIdx === null) cibleIdx = cibles[Math.floor(Math.random() * cibles.length)];
      } else if (bot.role === 'virus') {
        var innocentCibles = cibles.filter(function(ci) { return joueursReunion[ci].role !== 'virus'; });
        cibleIdx = innocentCibles.length > 0 ? innocentCibles[Math.floor(Math.random() * innocentCibles.length)] : cibles[Math.floor(Math.random() * cibles.length)];
      } else {
        cibleIdx = cibles[Math.floor(Math.random() * cibles.length)];
      }

      if (cibleIdx === undefined || cibleIdx === null || cibleIdx < 0 || cibleIdx >= joueursReunion.length) return;
      nbVotesTotal++;
      votesParJoueur[cibleIdx]++;

      var bulle = document.getElementById('vote-bulle-' + cibleIdx);
      if (bulle) {
        bulle.textContent = votesParJoueur[cibleIdx];
        bulle.classList.add('has-votes');
      }
      ajouterMsgReunion(bot.pseudo, t('meetBotVoted'), '#95a5a6');
    }

    function verifierTousOntVote() {
      var nbJoueursActifs = 0;
      for (var i = 0; i < joueursReunion.length; i++) {
        if (!joueursReunion[i].elimine) nbJoueursActifs++;
      }
      if (nbVotesTotal >= nbJoueursActifs && !voteTermine) {
        clearInterval(reunionTimer);
        reunionTimer = null;
        setTimeout(function() { if (!voteTermine) terminerVote(); }, 1000);
      }
    }

    var voteTermine = false;
    function terminerVote() {
      if (voteTermine) return;
      voteTermine = true;
      clearInterval(reunionTimer);
      reunionTimer = null;

      // Masquer skip
      document.getElementById('reunion-btn-skip').classList.remove('visible');

      // Compter les votes
      var maxVotes = 0;
      var maxIdx = -1;
      var egalite = false;
      for (var i = 0; i < votesParJoueur.length; i++) {
        if (votesParJoueur[i] > maxVotes) {
          maxVotes = votesParJoueur[i];
          maxIdx = i;
          egalite = false;
        } else if (votesParJoueur[i] === maxVotes && votesParJoueur[i] > 0) {
          egalite = true;
        }
      }

      var resultatDiv = document.getElementById('reunion-resultat');
      var texteEl = document.getElementById('reunion-resultat-texte');
      var roleEl = document.getElementById('reunion-resultat-role');

      if (maxVotes === 0 || egalite) {
        texteEl.textContent = t('meetNobodyElim');
        roleEl.textContent = '';
        roleEl.style.display = 'none';
        ajouterMsgReunion(t('system'), t('meetNoElim'), '#f39c12');
      } else {
        var elimine = joueursReunion[maxIdx];
        joueursElimines.push(elimine.pseudo);
        texteEl.textContent = t('wasEliminated', elimine.pseudo);
        roleEl.style.display = 'inline-block';

        if (elimine.role === 'virus') {
          roleEl.textContent = t('meetWasVirusRole');
          roleEl.style.background = '#e74c3c';
          roleEl.style.color = 'white';
          ajouterMsgReunion(t('system'), t('meetWasVirus', elimine.pseudo), '#e74c3c');
        } else if (elimine.role === 'journaliste') {
          roleEl.textContent = t('meetWasJournalistRole');
          roleEl.style.background = '#3498db';
          roleEl.style.color = 'white';
          ajouterMsgReunion(t('system'), t('meetWasJournalist', elimine.pseudo), '#3498db');
        } else if (elimine.role === 'fanatique') {
          roleEl.textContent = t('meetWasFanaticRole');
          roleEl.style.background = '#8e44ad';
          roleEl.style.color = 'white';
          ajouterMsgReunion(t('system'), t('meetWasFanatic', elimine.pseudo), '#8e44ad');
          showNotif(t('wasTheFanatic', elimine.pseudo), 'info');
        } else if (elimine.role === 'espion') {
          roleEl.textContent = t('meetWasSpyRole');
          roleEl.style.background = '#9b59b6';
          roleEl.style.color = 'white';
          ajouterMsgReunion(t('system'), t('meetWasSpy', elimine.pseudo), '#9b59b6');
        } else {
          roleEl.textContent = t('meetWasInnocentRole');
          roleEl.style.background = '#27ae60';
          roleEl.style.color = 'white';
          ajouterMsgReunion(t('system'), t('meetWasInnocent', elimine.pseudo), '#27ae60');
        }

        // Si c'est le joueur qui est elimine, appliquer le visuel fantome
        if (!elimine.estBot) {
          if (monRole === 'fanatique') {
            showNotif(t('youEliminatedFanatic'), 'info');
          }
          var joueurEl = document.getElementById('joueur');
          if (joueurEl) joueurEl.classList.add('bot-mort');
        }

        // Eliminer le bot (garder comme fantome)
        if (elimine.estBot) {
          for (var b = 0; b < bots.length; b++) {
            if (bots[b].pseudo === elimine.pseudo) {
              if (bots[b].element) {
                bots[b].element.classList.add('bot-fantome');
              }
              botsMorts.push(bots[b]);
              bots.splice(b, 1);
              break;
            }
          }
        }
      }

      resultatDiv.style.display = 'block';
      resultatDiv.classList.add('visible');
    }

    // ============================
    // SYSTEME DE KILL (VIRUS)
    // ============================
    var killCooldown = false; // cooldown de 15 secondes apres un kill
    var killCibleIndex = -1; // index du bot le plus proche pour kill
    var KILL_DISTANCE = 80; // distance pour pouvoir tuer
    var KILL_COOLDOWN_MS = 15000; // 15 secondes de cooldown

    var VIRUS_VISION_DISTANCE = 150; // distance pour voir les allies virus

    function detecterVirusProches() {
      if (bots.length === 0 || monRole !== 'virus' || reunionEnCours) return;
      for (var i = 0; i < bots.length; i++) {
        var badge = bots[i].element ? bots[i].element.querySelector('.virus-allie-badge') : null;
        if (!badge) continue;
        if (bots[i].role !== 'virus' || joueursElimines.indexOf(bots[i].pseudo) >= 0) {
          badge.style.display = 'none';
          continue;
        }
        var dx = joueurX - bots[i].x;
        var dy = joueurY - bots[i].y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        badge.style.display = (dist < VIRUS_VISION_DISTANCE) ? 'block' : 'none';
      }
    }

    function detecterCibleKill() {
      var pseudo = getPseudo() || t('player');
      if (bots.length === 0 || monRole !== 'virus' || killCooldown || reunionEnCours || joueursElimines.indexOf(pseudo) >= 0) {
        killCibleIndex = -1;
        return;
      }
      var minDist = Infinity;
      killCibleIndex = -1;
      for (var i = 0; i < bots.length; i++) {
        if (joueursElimines.indexOf(bots[i].pseudo) >= 0) continue;
        if (bots[i].role === 'virus') continue; // ne pas tuer un autre virus
        if (bots[i].role === 'espion' && bots[i].espionCamp === 'virus') continue; // ne pas tuer l'espion allie
        var dx = joueurX - bots[i].x;
        var dy = joueurY - bots[i].y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < KILL_DISTANCE && dist < minDist) {
          minDist = dist;
          killCibleIndex = i;
        }
      }
    }

    // POUVOIR JOURNALISTE - enquete par proximite
    var ENQUETE_DISTANCE = 100;
    var enqueteCibleIndex = -1;
    var botsEnquetes = []; // pseudos deja enquetes
    var enquetesRestantes = 1; // nombre d'enquetes restantes (= nombre de virus)

    function detecterCibleEnquete() {
      var pseudo = getPseudo() || t('player');
      if (bots.length === 0 || monRole !== 'journaliste' || reunionEnCours || joueursElimines.indexOf(pseudo) >= 0 || enquetesRestantes <= 0) {
        enqueteCibleIndex = -1;
        return;
      }
      var minDist = Infinity;
      enqueteCibleIndex = -1;
      for (var i = 0; i < bots.length; i++) {
        if (joueursElimines.indexOf(bots[i].pseudo) >= 0) continue;
        if (botsEnquetes.indexOf(bots[i].pseudo) >= 0) continue;
        var dx = joueurX - bots[i].x;
        var dy = joueurY - bots[i].y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < ENQUETE_DISTANCE && dist < minDist) {
          minDist = dist;
          enqueteCibleIndex = i;
        }
      }
    }

    function enqueterCible() {
      if (enqueteCibleIndex < 0 || enquetesRestantes <= 0) return;
      var bot = bots[enqueteCibleIndex];
      botsEnquetes.push(bot.pseudo);
      enquetesRestantes--;
      var roleText = bot.role.toUpperCase();
      var couleur = bot.role === 'virus' ? '#e74c3c' : (bot.role === 'journaliste' ? '#3498db' : '#2ecc71');
      showNotif(t('playerIs', bot.pseudo, roleText), bot.role === 'virus' ? 'warn' : 'info');
      // Changer la couleur du pseudo du bot pour indiquer qu'il a ete enquete
      var pseudoEl = bot.element ? bot.element.querySelector('.joueur-pseudo') : null;
      if (pseudoEl) pseudoEl.style.color = couleur;
      enqueteCibleIndex = -1;
      // Notifier si plus d'enquetes
      if (enquetesRestantes <= 0) {
        showNotif(t('allInvestigationsUsed'), 'warn');
        var btnEnq = document.getElementById('btn-enqueter');
        if (btnEnq) btnEnq.style.display = 'none';
      }
    }

    var cadavres = []; // {x, y, pseudo, skin, element}
    var SIGNALER_DISTANCE = 120;
    var cadavreProche = -1; // index du cadavre le plus proche
    var killProtection = false; // protection de 7s au debut et apres reunion

    function creerCadavre(x, y, pseudo, skin) {
      var mallMap = document.getElementById('mall-map');
      var div = document.createElement('div');
      div.className = 'cadavre';
      div.style.left = x + 'px';
      div.style.top = y + 'px';
      div.innerHTML = '<span class="cadavre-x">X</span><img src="' + skin + '" alt="cadavre">';
      mallMap.appendChild(div);
      cadavres.push({ x: x, y: y, pseudo: pseudo, skin: skin, element: div });
      // Si reunion en cours, supprimer immediatement le cadavre
      if (reunionEnCours) {
        if (div.parentNode) div.parentNode.removeChild(div);
        cadavres.pop();
      }
    }

    function eliminerBot(pseudoVictime) {
      if (joueursElimines.indexOf(pseudoVictime) >= 0) return;
      // Verifier si c'est un fanatique (victoire personnelle, la partie continue)
      var estFanatique = false;
      for (var bf = 0; bf < bots.length; bf++) {
        if (bots[bf].pseudo === pseudoVictime && bots[bf].role === 'fanatique') {
          estFanatique = true;
          break;
        }
      }
      joueursElimines.push(pseudoVictime);
      for (var b = 0; b < bots.length; b++) {
        if (bots[b].pseudo === pseudoVictime) {
          var bx = bots[b].x;
          var by = bots[b].y;
          var bskin = bots[b].skin;
          // Garder l'element comme fantome au lieu de le supprimer
          if (bots[b].element) {
            bots[b].element.classList.add('bot-fantome');
          }
          botsMorts.push(bots[b]);
          bots.splice(b, 1);
          creerCadavre(bx, by, pseudoVictime, bskin);
          break;
        }
      }
      if (estFanatique) {
        showNotif(t('wasTheFanatic', pseudoVictime), 'info');
      }
      var gagnant = verifierVictoire();
      if (gagnant) afficherFinPartie(gagnant);
    }

    function tuerVictime() {
      if (killCibleIndex < 0 || killCooldown || killProtection) return;
      var victime = bots[killCibleIndex];
      if (!victime) return;

      killCooldown = true;
      var pseudoVictime = victime.pseudo;

      showNotif(t('youInfected', pseudoVictime), 'warn');

      setTimeout(function() {
        eliminerBot(pseudoVictime);
        showNotif(t('playerDied', pseudoVictime), 'warn');
      }, 5000);

      var btnKill = document.getElementById('btn-kill');
      if (btnKill) btnKill.style.display = 'none';

      // Compte a rebours cooldown 15s visible pour le virus
      var cdEl = document.getElementById('kill-countdown');
      if (cdEl) {
        var secCd = Math.ceil(KILL_COOLDOWN_MS / 1000);
        cdEl.textContent = secCd;
        cdEl.style.display = 'flex';
        if (killCountdownInterval) clearInterval(killCountdownInterval);
        killCountdownInterval = setInterval(function() {
          secCd--;
          if (secCd <= 0) {
            clearInterval(killCountdownInterval);
            killCountdownInterval = null;
            cdEl.style.display = 'none';
            killCooldown = false;
          } else {
            cdEl.textContent = secCd;
          }
        }, 1000);
      } else {
        setTimeout(function() { killCooldown = false; }, KILL_COOLDOWN_MS);
      }
    }

    function detecterCadavreProche() {
      if (bots.length === 0 || reunionEnCours) { cadavreProche = -1; return; }
      // Les fantomes ne peuvent pas signaler
      var pseudo = getPseudo() || t('player');
      if (joueursElimines.indexOf(pseudo) >= 0) { cadavreProche = -1; return; }

      var minDist = Infinity;
      cadavreProche = -1;
      for (var i = 0; i < cadavres.length; i++) {
        var dx = joueurX - cadavres[i].x;
        var dy = joueurY - cadavres[i].y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < SIGNALER_DISTANCE && dist < minDist) {
          minDist = dist;
          cadavreProche = i;
        }
      }
    }

    function signalerCadavre() {
      if (cadavreProche < 0 || reunionEnCours) return;
      var c = cadavres[cadavreProche];
      showNotif(t('bodyReported', c.pseudo), 'warn');
      reunionCreateur = getPseudo() || t('player');
      // Supprimer le cadavre signale
      if (c.element && c.element.parentNode) c.element.parentNode.removeChild(c.element);
      cadavres.splice(cadavreProche, 1);
      cadavreProche = -1;
      document.getElementById('btn-signaler').style.display = 'none';
      // Declencher reunion
      jeuActif = false;
      setTimeout(function() { try { ouvrirReunion(); } catch(e) { jeuActif = true; reunionEnCours = false; gameLoop(); } }, 500);
    }

    var killCountdownInterval = null;

    function activerKillProtection() {
      killProtection = true;
      killCooldown = false; // Reset le cooldown (la protection le remplace)
      // Afficher le compte a rebours seulement pour le virus
      var cdEl = document.getElementById('kill-countdown');
      if (cdEl && monRole === 'virus') {
        var secondes = 15;
        cdEl.textContent = secondes;
        cdEl.style.display = 'flex';
        if (killCountdownInterval) clearInterval(killCountdownInterval);
        killCountdownInterval = setInterval(function() {
          secondes--;
          if (secondes <= 0) {
            clearInterval(killCountdownInterval);
            killCountdownInterval = null;
            cdEl.style.display = 'none';
            killProtection = false;
          } else {
            cdEl.textContent = secondes;
          }
        }, 1000);
      } else {
        setTimeout(function() { killProtection = false; }, 15000);
      }
    }

    // Bots virus tuent des innocents proches automatiquement
    var botKillCooldowns = {};

    function botsVirusTuent() {
      if (bots.length === 0 || reunionEnCours || killProtection) return;
      for (var v = 0; v < bots.length; v++) {
        if (bots[v].role !== 'virus') continue;
        if (botKillCooldowns[bots[v].id]) continue;

        var virusBot = bots[v];

        // Verifier si le joueur est proche et innocent (pas virus, pas espion camp virus)
        if (monRole !== 'virus' && !(monRole === 'espion' && espionCamp === 'virus') && joueursElimines.indexOf(getPseudo() || t('player')) < 0) {
          var dx = virusBot.x - joueurX;
          var dy = virusBot.y - joueurY;
          var dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < KILL_DISTANCE) {
            botKillCooldowns[virusBot.id] = true;
            showNotif(t('virusInfectedYou'), 'warn');
            try { var sInfect = new Audio('infectation.mp3'); sInfect.volume = 0.6; sInfect.play(); } catch(e) {}
            (function(botId) {
              setTimeout(function() {
                var pseudo = getPseudo() || t('player');
                if (joueursElimines.indexOf(pseudo) >= 0) return;
                joueursElimines.push(pseudo);
                if (monRole === 'fanatique') {
                  showNotif(t('diedAsFanatic'), 'info');
                } else {
                  showNotif(t('youDiedGhost'), 'warn');
                }
                var joueurEl = document.getElementById('joueur');
                if (joueurEl) joueurEl.classList.add('bot-mort');
                // Creer cadavre joueur
                creerCadavre(joueurX, joueurY, pseudo, getSkinFichier(getSkin()));
                var gagnant = verifierVictoire();
                if (gagnant) afficherFinPartie(gagnant);
              }, 5000);
              setTimeout(function() { botKillCooldowns[botId] = false; }, KILL_COOLDOWN_MS);
            })(virusBot.id);
            continue;
          }
        }

        // Chercher un bot innocent proche
        for (var bt = 0; bt < bots.length; bt++) {
          if (bt === v) continue;
          if (bots[bt].role === 'virus') continue;
          if (bots[bt].role === 'espion' && bots[bt].espionCamp === 'virus') continue; // ne pas tuer l'espion allie
          if (joueursElimines.indexOf(bots[bt].pseudo) >= 0) continue;
          var dx2 = virusBot.x - bots[bt].x;
          var dy2 = virusBot.y - bots[bt].y;
          var dist2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
          if (dist2 < KILL_DISTANCE) {
            botKillCooldowns[virusBot.id] = true;
            var victimePseudo = bots[bt].pseudo;
            var selfReport = Math.random() < 0.10;
            var virusPseudoSR = virusBot.pseudo;
            (function(bp, botId, doSelfReport, virusNom) {
              setTimeout(function() {
                eliminerBot(bp);
                // 10% de chance que le bot virus signale lui-meme le cadavre
                if (doSelfReport && !reunionEnCours && cadavres.length > 0) {
                  setTimeout(function() {
                    if (reunionEnCours) return;
                    showNotif(t('foundBodyOf', virusNom, bp), 'warn');
                    reunionCreateur = virusNom;
                    jeuActif = false;
                    setTimeout(function() { try { ouvrirReunion(); } catch(e) { jeuActif = true; reunionEnCours = false; gameLoop(); } }, 500);
                  }, 1000 + Math.floor(Math.random() * 2000));
                }
              }, 5000);
              setTimeout(function() { botKillCooldowns[botId] = false; }, KILL_COOLDOWN_MS);
            })(victimePseudo, virusBot.id, selfReport, virusPseudoSR);
            break;
          }
        }
      }
    }

    var botSignaleCooldown = false;
    var BOT_SIGNALE_DISTANCE = 150;

    function botsDetectentCadavres() {
      if (bots.length === 0 || reunionEnCours || cadavres.length === 0 || botSignaleCooldown) return;
      for (var b = 0; b < bots.length; b++) {
        if (joueursElimines.indexOf(bots[b].pseudo) >= 0) continue;
        for (var c = 0; c < cadavres.length; c++) {
          var dx = bots[b].x - cadavres[c].x;
          var dy = bots[b].y - cadavres[c].y;
          var dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < BOT_SIGNALE_DISTANCE) {
            botSignaleCooldown = true;
            var nomBot = bots[b].pseudo;
            var nomCadavre = cadavres[c].pseudo;
            showNotif(t('foundBodyOf', nomBot, nomCadavre), 'warn');
            reunionCreateur = nomBot;
            // Supprimer le cadavre signale
            if (cadavres[c].element && cadavres[c].element.parentNode) {
              cadavres[c].element.parentNode.removeChild(cadavres[c].element);
            }
            cadavres.splice(c, 1);
            // Declencher reunion
            jeuActif = false;
            setTimeout(function() { try { ouvrirReunion(); } catch(e) { jeuActif = true; reunionEnCours = false; gameLoop(); } }, 500);
            setTimeout(function() { botSignaleCooldown = false; }, 5000);
            return;
          }
        }
      }
    }

    // ============================
    // VERIFICATION VICTOIRE
    // ============================
    function compterRolesRestants() {
      var nbVirus = 0;
      var nbGentils = 0;
      var pseudo = getPseudo() || t('player');
      if (joueursElimines.indexOf(pseudo) < 0) {
        if (monRole === 'virus') nbVirus++;
        else if (monRole !== 'fanatique' && monRole !== 'espion') nbGentils++;
      }
      for (var i = 0; i < bots.length; i++) {
        if (joueursElimines.indexOf(bots[i].pseudo) < 0) {
          if (bots[i].role === 'virus') nbVirus++;
          else if (bots[i].role !== 'fanatique' && bots[i].role !== 'espion') nbGentils++;
        }
      }
      return { virus: nbVirus, gentils: nbGentils };
    }

    function verifierVictoire() {
      // Verifier si un fanatique a ete elimine  victoire du fanatique (la partie se termine)
      for (var vf = 0; vf < tousLesJoueursPartie.length; vf++) {
        if (tousLesJoueursPartie[vf].role === 'fanatique' && joueursElimines.indexOf(tousLesJoueursPartie[vf].pseudo) >= 0) {
          return 'fanatique';
        }
      }
      if (!modeHorsLigne) {
        // Mode en ligne : victoire quand TOUTES les missions collectives sont faites
        if (totalMissionsCollectives > 0 && missionsCollectivesCompletees >= totalMissionsCollectives) return 'missions';
        return null;
      }
      // Mode hors ligne : victoire quand le joueur a fini ses missions
      var toutesMissionsFaites = true;
      for (var vm = 0; vm < mesMissions.length; vm++) {
        if (!mesMissions[vm].faite) { toutesMissionsFaites = false; break; }
      }
      if (toutesMissionsFaites && mesMissions.length > 0) return 'missions';
      // Conditions avec bots (hors ligne uniquement)
      var compte = compterRolesRestants();
      if (compte.gentils <= compte.virus && compte.virus > 0) return 'virus';
      if (compte.virus === 0) return 'innocents';
      return null;
    }

    function afficherFinPartie(gagnant) {
      jeuActif = false;
      touchActif = false;
      if (miniJeuOuvert) fermerMiniJeu();
      if (camerasOuvertes) fermerCameras();
      if (simulationMissionsTimer) { clearInterval(simulationMissionsTimer); simulationMissionsTimer = null; }
      var overlay = document.getElementById('fin-partie-overlay');
      var titreEl = document.getElementById('fin-partie-titre');
      var sousTitreEl = document.getElementById('fin-partie-sous-titre');
      var rolesDiv = document.getElementById('fin-partie-roles');
      if (gagnant === 'virus') {
        titreEl.textContent = t('virusVictory');
        titreEl.className = 'fin-partie-titre virus';
        sousTitreEl.textContent = t('virusVictoryDesc');
      } else if (gagnant === 'fanatique') {
        // Trouver le pseudo du fanatique
        var pseudoFanatique = '';
        for (var pf = 0; pf < tousLesJoueursPartie.length; pf++) {
          if (tousLesJoueursPartie[pf].role === 'fanatique') { pseudoFanatique = tousLesJoueursPartie[pf].pseudo; break; }
        }
        titreEl.textContent = t('fanaticVictory');
        titreEl.className = 'fin-partie-titre fanatique';
        sousTitreEl.textContent = t('fanaticWonWith', pseudoFanatique);
      } else if (gagnant === 'missions') {
        titreEl.textContent = t('innocentsVictory');
        titreEl.className = 'fin-partie-titre innocents';
        sousTitreEl.textContent = t('missionsVictoryDesc');
      } else {
        titreEl.textContent = t('innocentsVictory');
        titreEl.className = 'fin-partie-titre innocents';
        sousTitreEl.textContent = t('virusEliminatedDesc');
      }
      var html = '';
      var pseudo = getPseudo() || t('player');
      var skinFichier = getSkinFichier(getSkin());
      var elimJoueur = joueursElimines.indexOf(pseudo) >= 0;
      html += '<div class="fin-partie-joueur" style="opacity:' + (elimJoueur ? '0.4' : '1') + '">';
      html += '<img src="' + skinFichier + '" alt="skin">';
      html += '<span class="fp-pseudo">' + pseudo.replace(/</g, '&lt;') + '</span>';
      html += '<span class="fp-role fp-role-' + monRole + '">' + monRole.toUpperCase() + '</span>';
      html += '</div>';
      // Utiliser tousLesJoueursPartie (sauvegarde complete) au lieu de joueursReunion (potentiellement incomplet)
      for (var i = 0; i < tousLesJoueursPartie.length; i++) {
        if (tousLesJoueursPartie[i].estBot) {
          var jr = tousLesJoueursPartie[i];
          var estElim = joueursElimines.indexOf(jr.pseudo) >= 0;
          html += '<div class="fin-partie-joueur" style="opacity:' + (estElim ? '0.4' : '1') + '">';
          html += '<img src="' + jr.skin + '" alt="skin">';
          html += '<span class="fp-pseudo">' + jr.pseudo.replace(/</g, '&lt;') + '</span>';
          html += '<span class="fp-role fp-role-' + jr.role + '">' + jr.role.toUpperCase() + '</span>';
          html += '</div>';
        }
      }
      // Verifier si le joueur a gagne et donner 50 golds
      var joueurAGagne = false;
      if (gagnant === 'fanatique') {
        if (monRole === 'fanatique') joueurAGagne = true;
        if (monRole === 'espion') joueurAGagne = true; // L'espion gagne toujours avec le fanatique
      } else {
        if (gagnant === 'virus' && (monRole === 'virus' || (monRole === 'espion' && espionCamp === 'virus'))) joueurAGagne = true;
        if ((gagnant === 'innocents' || gagnant === 'missions') && (monRole === 'innocent' || monRole === 'journaliste' || (monRole === 'espion' && espionCamp === 'innocent'))) joueurAGagne = true;
      }
      if (joueurAGagne) {
        var recompense = 50;
        gagnerGold(recompense);
        html += '<div class="fin-partie-gold">+' + recompense + ' GOLDS !</div>';
      }

      rolesDiv.innerHTML = html;
      overlay.classList.add('visible');
    }

    function retourMenuFinPartie() {
      document.getElementById('fin-partie-overlay').classList.remove('visible');
      // Retirer le visuel fantome du joueur
      var joueurEl = document.getElementById('joueur');
      if (joueurEl) joueurEl.classList.remove('bot-mort');
      // Nettoyer cadavres du DOM
      for (var ci = 0; ci < cadavres.length; ci++) {
        if (cadavres[ci].element && cadavres[ci].element.parentNode) {
          cadavres[ci].element.parentNode.removeChild(cadavres[ci].element);
        }
      }
      cadavres = [];
      // Reset kill state
      killCooldown = false;
      botKillCooldowns = {};
      if (killCountdownInterval) { clearInterval(killCountdownInterval); killCountdownInterval = null; }
      var cdElMenu = document.getElementById('kill-countdown');
      if (cdElMenu) cdElMenu.style.display = 'none';
      // Reset mission en cours
      if (missionTimer) { clearTimeout(missionTimer); missionTimer = null; }
      missionEnCours = false;
      var btnM = document.getElementById('btn-mission');
      if (btnM) { resetBtnMission(btnM); btnM.style.display = 'none'; }
      // Retirer highlights caisse
      document.querySelectorAll('.caisse-cible').forEach(function(c) { c.classList.remove('caisse-cible'); });
      arreterSimulationMissions();
      // Nettoyer la reunion si elle etait en cours
      if (reunionEnCours) fermerReunion();
      reunionEnCours = false;
      document.getElementById('reunion-btn-skip').classList.remove('visible');
      document.getElementById('reunion-bandeau').classList.remove('visible');
      document.getElementById('reunion-chat').classList.remove('visible');
      document.getElementById('reunion-resultat').classList.remove('visible');
      document.getElementById('reunion-resultat').style.display = 'none';
      nettoyerBots();
      modeHorsLigne = false;
      joueursElimines = [];
      botsMorts = [];
      showScreen('menu-principal');
    }

    function fermerReunion() {
      clearInterval(reunionTimer);
      reunionTimer = null;
      // Nettoyer les timers de chat IA des bots
      for (var ct = 0; ct < botsChatTimers.length; ct++) clearTimeout(botsChatTimers[ct]);
      botsChatTimers = [];

      try {
        // Masquer HUD reunion
        var elBandeau = document.getElementById('reunion-bandeau');
        if (elBandeau) elBandeau.classList.remove('visible');
        var elChat = document.getElementById('reunion-chat');
        if (elChat) elChat.classList.remove('visible');
        var elSkip = document.getElementById('reunion-btn-skip');
        if (elSkip) elSkip.classList.remove('visible');
        var elResultat = document.getElementById('reunion-resultat');
        if (elResultat) { elResultat.classList.remove('visible'); elResultat.style.display = 'none'; }
        var elTimer = document.getElementById('reunion-timer');
        if (elTimer) elTimer.style.color = '#e74c3c';

        // Nettoyer les bulles de vote, badge createur et les classes
        var badgeCr = document.getElementById('reunion-createur-badge');
        if (badgeCr && badgeCr.parentNode) badgeCr.parentNode.removeChild(badgeCr);
        for (var i = 0; i < joueursReunion.length; i++) {
          try {
            var el = document.getElementById(joueursReunion[i].elementId);
            if (el) {
              el.classList.remove('reunion-cliquable', 'reunion-vote-selection');
              el.onclick = null;
              var bulle = document.getElementById('vote-bulle-' + i);
              if (bulle && bulle.parentNode) bulle.parentNode.removeChild(bulle);
            }
          } catch(e) {}
        }

        // Les joueurs restent devant la fontaine apres la reunion
        updateJoueur();
      } catch(e) {}

      // Re-afficher missions et minimap
      var hudMissions = document.querySelector('.hud-missions');
      if (hudMissions) hudMissions.style.display = '';
      var minimap = document.querySelector('.minimap');
      if (minimap) minimap.style.display = '';

      // Verifier victoire apres elimination
      reunionEnCours = false;

      // Cooldown de 10 secondes apres la fin de la reunion
      reunionCooldown = true;
      setTimeout(function() { reunionCooldown = false; }, REUNION_COOLDOWN_MS);
      var gagnant = verifierVictoire();
      if (gagnant) {
        afficherFinPartie(gagnant);
        return;
      }

      // Protection de 7 secondes apres reunion
      activerKillProtection();

      // Reprendre le jeu
      jeuActif = true;
      gameLoop();

      // Reprendre le mini-jeu si un etait en pause
      if (miniJeuPause) reprendreMiniJeu();
    }

    function ajouterMsgReunion(auteur, message, couleur) {
      var container = document.getElementById('reunion-chat-messages');
      if (!container) return;
      var div = document.createElement('div');
      div.className = 'chat-msg';
      div.innerHTML = '<span class="pseudo" style="color:' + (couleur || '#e74c3c') + '">[' + auteur.replace(/</g, '&lt;') + ']:</span> <span class="texte">' + message.replace(/</g, '&lt;') + '</span>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      // Son de chat aleatoire
      try { var sChat = new Audio(Math.random() < 0.5 ? 'chat1.mp3' : 'chat2.mp3'); sChat.volume = 0.4; sChat.play(); } catch(e) {}
    }

    function envoyerMsgReunion() {
      var input = document.getElementById('reunion-chat-input');
      var msg = input.value.trim();
      if (!msg) return;
      var pseudo = getPseudo() || t('player');
      if (joueursElimines.indexOf(pseudo) >= 0) {
        showNotif(t('ghostsCantTalk'), 'warn');
        input.value = '';
        return;
      }
      var msgFiltre = filtrerMessage(msg);
      ajouterMsgReunion(pseudo, msgFiltre, isAdmin() ? '#f39c12' : '#e74c3c');
      input.value = '';

      // Bots reagissent au message du joueur
      if (modeHorsLigne && Math.random() < 0.5) {
        var phrasesReponse = [
          'Ouais t\'as raison...', 'Je suis pas d\'accord', 'Hmm possible...',
          'Carrement !', 'Tu dis ca mais t\'as fait quoi toi ?', 'Ok ok...',
          'C\'est vrai ca !', 'N\'importe quoi...', 'Mouais bof',
          'Exactement ce que je pensais', 'Ah bon ? T\'es sur ?'
        ];
        var botsVivants = [];
        for (var br = 0; br < bots.length; br++) {
          if (joueursElimines.indexOf(bots[br].pseudo) < 0) botsVivants.push(bots[br]);
        }
        if (botsVivants.length > 0) {
          var botRepondeur = botsVivants[Math.floor(Math.random() * botsVivants.length)];
          setTimeout(function() {
            if (reunionEnCours) {
              ajouterMsgReunion(botRepondeur.pseudo, phrasesReponse[Math.floor(Math.random() * phrasesReponse.length)], '#95a5a6');
            }
          }, 1000 + Math.floor(Math.random() * 3000));
        }
      }
    }

    // ============================
    // SYSTEME DE MISSIONS
    // ============================
    var POOL_MISSIONS = [
      { nom: 'Ranger les livres', boutiqueNom: 'LIBRAIRIE', rect: {x:60, y:1000, w:500, h:350}, caisseX: 335, caisseY: 1322, miniJeu: 'livres' },
      { nom: 'Recuperer un colis', boutiqueNom: 'KIOSQUE A JOURNAUX', rect: {x:2500, y:1200, w:600, h:350}, caisseX: 2790, caisseY: 1472, miniJeu: 'colis' },
      { nom: 'Verifier les cameras', boutiqueNom: 'POSTE DE SECURITE', rect: {x:2800, y:60, w:450, h:300}, caisseX: 3075, caisseY: 322, miniJeu: 'cameras' },
      { nom: 'Reapprovisionner les rayons', boutiqueNom: 'SUPERMARCHE GEANT', rect: {x:60, y:3200, w:700, h:500}, caisseX: 705, caisseY: 3657, miniJeu: 'rayons' },
      { nom: 'Reparer l\'escalator', boutiqueNom: 'SALLE D\'ARCADE', rect: {x:2500, y:3800, w:600, h:400}, caisseX: 3025, caisseY: 4122, miniJeu: 'escalator' },
      { nom: 'Reparer les toilettes', boutiqueNom: 'TOILETTES NORD', rect: {x:3350, y:60, w:350, h:250}, caisseX: 3525, caisseY: 277, miniJeu: 'toilettes' },
      { nom: 'Faire des pompes', boutiqueNom: 'SALLE DE SPORT', rect: {x:60, y:1450, w:500, h:400}, caisseX: 355, caisseY: 1817, miniJeu: 'pompes' },
      { nom: 'Nettoyer les vitrines', boutiqueNom: 'BIJOUTERIE', rect: {x:7440, y:60, w:500, h:400}, caisseX: 7745, caisseY: 422, miniJeu: 'vitrines' },
      { nom: 'Tester les echantillons', boutiqueNom: 'PARFUMERIE', rect: {x:7440, y:4250, w:500, h:350}, caisseX: 7725, caisseY: 4572, miniJeu: 'echantillons' },
      { nom: 'Prendre un cafe', boutiqueNom: 'CAFE DU CENTRE', rect: {x:3800, y:60, w:450, h:300}, caisseX: 3840, caisseY: 132, miniJeu: 'cafe' },
      { nom: 'Reallumer la box internet', boutiqueNom: 'TECH & ELECTRONIQUE', rect: {x:7440, y:550, w:500, h:350}, caisseX: 7725, caisseY: 872, miniJeu: 'box' },
      { nom: 'Verifier la projection', boutiqueNom: 'CINEMA MULTIPLEX', rect: {x:7440, y:1000, w:500, h:450}, caisseX: 7900, caisseY: 1417, miniJeu: 'projection' },
      { nom: 'Nettoyer les tables', boutiqueNom: 'RESTAURANT', rect: {x:7440, y:1550, w:500, h:350}, caisseX: 7755, caisseY: 1872, miniJeu: 'tables' },
      { nom: 'Trier les medicaments', boutiqueNom: 'PHARMACIE', rect: {x:60, y:550, w:500, h:350}, caisseX: 385, caisseY: 867, miniJeu: 'medicaments' },
      { nom: 'Ranger les vetements', boutiqueNom: 'BOUTIQUE MODE', rect: {x:60, y:60, w:500, h:400}, caisseX: 335, caisseY: 422, miniJeu: 'vetements' },
      { nom: 'Mettre a jour les consoles', boutiqueNom: 'MAGASIN DE JEUX VIDEO', rect: {x:60, y:3800, w:500, h:350}, caisseX: 345, caisseY: 4122, miniJeu: 'consoles' },
      { nom: 'Nourrir les animaux', boutiqueNom: 'ANIMALERIE', rect: {x:60, y:2100, w:500, h:400}, caisseX: 355, caisseY: 2467, miniJeu: 'animaux' },
      { nom: 'Verifier les fours', boutiqueNom: 'PATISSERIE', rect: {x:60, y:2600, w:500, h:400}, caisseX: 395, caisseY: 2967, miniJeu: 'fours' },
      { nom: 'Arroser les plantes', boutiqueNom: 'BIO & NATURE', rect: {x:7440, y:2100, w:500, h:400}, caisseX: 7745, caisseY: 2467, miniJeu: 'plantes' },
      { nom: 'Preparer les infusions', boutiqueNom: 'SALON DE THE', rect: {x:7440, y:2600, w:500, h:400}, caisseX: 7810, caisseY: 2633, miniJeu: 'infusions' },
      { nom: 'Calibrer les machines', boutiqueNom: 'OPTICIEN', rect: {x:4500, y:1200, w:600, h:350}, caisseX: 4790, caisseY: 1472, miniJeu: 'calibrer' },
      { nom: 'Realigner les quilles', boutiqueNom: 'BOWLING', rect: {x:4500, y:3800, w:600, h:400}, caisseX: 5025, caisseY: 4122, miniJeu: 'quilles' },
      { nom: 'Gonfler les ballons', boutiqueNom: 'ARTICLES DE SPORT', rect: {x:7440, y:3800, w:500, h:350}, caisseX: 7725, caisseY: 4122, miniJeu: 'ballons' }
    ];
    var mesMissions = [];

    // Jauge collective de missions (mode en ligne)
    var totalMissionsCollectives = 0; // nombre total de missions de tous les joueurs
    var missionsCollectivesCompletees = 0; // missions completees par tous les joueurs
    var simulationMissionsTimer = null; // timer pour simuler les missions des autres joueurs

    function updateJaugeMissions() {
      var jaugeContainer = document.getElementById('mission-jauge');
      var jauge = document.getElementById('mission-jauge-fill');
      var texte = document.getElementById('mission-jauge-text');
      if (!jaugeContainer || !jauge || !texte) return;
      if (totalMissionsCollectives <= 0) { jaugeContainer.style.display = 'none'; return; }
      jaugeContainer.style.display = 'block';
      var pct = Math.min(100, Math.round((missionsCollectivesCompletees / totalMissionsCollectives) * 100));
      jauge.style.width = pct + '%';
      texte.textContent = t('missionsLabel', missionsCollectivesCompletees, totalMissionsCollectives, pct);
    }

    function demarrerSimulationMissions(nbAutresJoueurs) {
      if (simulationMissionsTimer) clearInterval(simulationMissionsTimer);
      var missionsRestantesAutres = nbAutresJoueurs * 4;
      simulationMissionsTimer = setInterval(function() {
        if (!jeuActif || missionsRestantesAutres <= 0) {
          clearInterval(simulationMissionsTimer);
          simulationMissionsTimer = null;
          return;
        }
        missionsRestantesAutres--;
        missionsCollectivesCompletees++;
        updateJaugeMissions();
        // Verifier victoire
        if (missionsCollectivesCompletees >= totalMissionsCollectives) {
          clearInterval(simulationMissionsTimer);
          simulationMissionsTimer = null;
          var gagnant = verifierVictoire();
          if (gagnant) afficherFinPartie(gagnant);
        }
      }, (20000 + Math.random() * 20000)); // entre 20s et 40s par mission
    }

    function arreterSimulationMissions() {
      if (simulationMissionsTimer) { clearInterval(simulationMissionsTimer); simulationMissionsTimer = null; }
      totalMissionsCollectives = 0;
      missionsCollectivesCompletees = 0;
      var jaugeContainer = document.getElementById('mission-jauge');
      if (jaugeContainer) jaugeContainer.style.display = 'none';
    }

    function trouverBoutique(nom) {
      var boutiques = document.querySelectorAll('.boutique');
      for (var i = 0; i < boutiques.length; i++) {
        var nomEl = boutiques[i].querySelector('.boutique-nom');
        if (nomEl && nomEl.textContent.trim() === nom) return boutiques[i];
      }
      return null;
    }

    function initMissions() {
      // Tirer 4 missions aleatoires
      var pool = POOL_MISSIONS.slice();
      mesMissions = [];
      for (var i = 0; i < 4 && pool.length > 0; i++) {
        var idx = Math.floor(Math.random() * pool.length);
        mesMissions.push({ nom: pool[idx].nom, boutiqueNom: pool[idx].boutiqueNom, rect: pool[idx].rect, caisseX: pool[idx].caisseX, caisseY: pool[idx].caisseY, miniJeu: pool[idx].miniJeu, faite: false });
        pool.splice(idx, 1);
      }
      // Generer le HTML des missions dans le HUD
      var liste = document.getElementById('missions-liste');
      if (liste) {
        var html = '';
        for (var j = 0; j < mesMissions.length; j++) {
          html += '<div class="mission-item" id="mission-' + j + '">' +
            '<div class="mission-check"></div>' +
            '<span>' + mesMissions[j].nom + '</span>' +
            '</div>';
        }
        liste.innerHTML = html;
      }

      updateMissionHighlight();
    }

    var missionProche = -1; // index de la mission proche du joueur
    var missionEnCours = false; // true pendant le mini-jeu
    var missionTimer = null; // reference au setTimeout de la mission
    var miniJeuOuvert = false; // true quand un mini-jeu est ouvert
    var miniJeuMissionIdx = -1; // index de la mission en cours de mini-jeu
    var miniJeuInterval = null; // interval pour animations (slider, rapidclick)
    var miniJeuTimeouts = []; // timeouts actifs pour cleanup
    var miniJeuPause = false; // true quand le mini-jeu est en pause (reunion)
    var miniJeuResumeFn = null; // fonction pour relancer les intervals apres pause
    var miniJeuPauseMissionIdx = -1; // sauvegarde de l'index mission pendant pause
    var miniJeuPauseType = ''; // sauvegarde du type de mini-jeu pendant pause

    function updateMissionHighlight() {
      // Retirer le highlight de toutes les caisses et boutiques
      document.querySelectorAll('.caisse-cible').forEach(function(c) {
        c.classList.remove('caisse-cible');
      });
      document.querySelectorAll('.boutique-cible').forEach(function(b) {
        b.classList.remove('boutique-cible');
      });

      // Highlight la caisse de chaque mission non faite
      for (var i = 0; i < mesMissions.length; i++) {
        if (!mesMissions[i].faite) {
          var boutique = trouverBoutique(mesMissions[i].boutiqueNom);
          if (boutique) {
            var caisse = boutique.querySelector('.obj-caisse');
            if (caisse) caisse.classList.add('caisse-cible');
          }
        }
      }

      // Mettre a jour les points de mission sur la minimap
      majMinimapMissions();
    }

    function majMinimapMissions() {
      // Supprimer les anciens points
      var anciens = document.querySelectorAll('.minimap-mission');
      for (var a = 0; a < anciens.length; a++) {
        anciens[a].parentNode.removeChild(anciens[a]);
      }
      var minimapInner = document.querySelector('.minimap-inner');
      if (!minimapInner) return;
      // Ratio map (8000x6000) -> minimap (160x120)
      var rx = 160 / 8000;
      var ry = 120 / 6000;
      for (var i = 0; i < mesMissions.length; i++) {
        if (mesMissions[i].faite) continue;
        var cx = mesMissions[i].caisseX * rx;
        var cy = mesMissions[i].caisseY * ry;
        var pt = document.createElement('div');
        pt.className = 'minimap-mission';
        pt.style.left = (cx - 2.5) + 'px';
        pt.style.top = (cy - 2.5) + 'px';
        minimapInner.appendChild(pt);
      }
    }

    function faireMission() {
      if (missionProche < 0 || missionProche >= mesMissions.length) return;
      if (missionEnCours) return;
      if (miniJeuOuvert) return;

      // Reprendre le mini-jeu sauvegarde si c'est la meme mission
      if (miniJeuPause && miniJeuPauseMissionIdx === missionProche) {
        missionEnCours = true;
        reprendreMiniJeu();
        var btn = document.getElementById('btn-mission');
        if (btn) btn.style.display = 'none';
        return;
      }

      // Si un autre mini-jeu etait en pause, le fermer definitivement
      if (miniJeuPause) {
        miniJeuPause = false;
        miniJeuResumeFn = null;
        document.getElementById('minijeu-zone').innerHTML = '';
      }

      missionEnCours = true;
      miniJeuMissionIdx = missionProche;

      var btn = document.getElementById('btn-mission');
      if (btn) btn.style.display = 'none';

      var mission = mesMissions[miniJeuMissionIdx];
      var miniJeuType = mission.miniJeu || 'rapidclick';
      ouvrirMiniJeu(mission.nom, miniJeuType);
    }

    function ouvrirMiniJeu(nomMission, type) {
      miniJeuOuvert = true;
      miniJeuResumeFn = null;
      var overlay = document.getElementById('minijeu-overlay');
      var titre = document.getElementById('minijeu-titre');
      var zone = document.getElementById('minijeu-zone');
      titre.textContent = nomMission;
      zone.innerHTML = '';
      // Bouton croix pour fermer (sauvegarde la progression)
      var closeBtn = document.createElement('button');
      closeBtn.className = 'minijeu-fermer';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = function(){ pauserMiniJeu(); };
      zone.appendChild(closeBtn);
      overlay.classList.add('visible');

      var mjFunc = window['initMJ_' + type];
      if (mjFunc) mjFunc(zone);
      else initMJ_pompes(zone);
    }

    function fermerMiniJeu() {
      miniJeuOuvert = false;
      miniJeuPause = false;
      miniJeuResumeFn = null;
      if (miniJeuInterval) { clearInterval(miniJeuInterval); miniJeuInterval = null; }
      for (var i = 0; i < miniJeuTimeouts.length; i++) {
        clearTimeout(miniJeuTimeouts[i]);
      }
      miniJeuTimeouts = [];
      var overlay = document.getElementById('minijeu-overlay');
      overlay.classList.remove('visible');
      document.getElementById('minijeu-zone').innerHTML = '';

      if (missionEnCours && miniJeuMissionIdx >= 0 && mesMissions[miniJeuMissionIdx] && !mesMissions[miniJeuMissionIdx].faite) {
        missionEnCours = false;
        miniJeuMissionIdx = -1;
      }
    }

    function pauserMiniJeu() {
      // Pauser le mini-jeu (garde le DOM intact pour reprendre)
      if (!miniJeuOuvert) return;
      miniJeuPause = true;
      miniJeuPauseMissionIdx = miniJeuMissionIdx;
      miniJeuOuvert = false;
      missionEnCours = false;
      // Stopper les intervals et timeouts (les animations s'arretent)
      if (miniJeuInterval) { clearInterval(miniJeuInterval); miniJeuInterval = null; }
      for (var i = 0; i < miniJeuTimeouts.length; i++) clearTimeout(miniJeuTimeouts[i]);
      miniJeuTimeouts = [];
      // Cacher l'overlay sans detruire le contenu
      var overlay = document.getElementById('minijeu-overlay');
      overlay.classList.remove('visible');
    }

    function reprendreMiniJeu() {
      // Reprendre le mini-jeu apres la reunion
      if (!miniJeuPause) return;
      miniJeuPause = false;
      miniJeuOuvert = true;
      miniJeuMissionIdx = miniJeuPauseMissionIdx;
      // Re-afficher l'overlay (le DOM est intact)
      var overlay = document.getElementById('minijeu-overlay');
      overlay.classList.add('visible');
      // Relancer les intervals si le mini-jeu en avait
      if (miniJeuResumeFn) { miniJeuResumeFn(); }
    }

    function completerMiniJeu() {
      var zone = document.getElementById('minijeu-zone');
      var successDiv = document.createElement('div');
      successDiv.className = 'minijeu-success';
      successDiv.textContent = 'TERMINE !';
      zone.appendChild(successDiv);

      if (miniJeuInterval) { clearInterval(miniJeuInterval); miniJeuInterval = null; }

      var t1 = setTimeout(function() {
        var idx = miniJeuMissionIdx;
        fermerMiniJeu();
        terminerMission(idx);
      }, 1000);
      miniJeuTimeouts.push(t1);
    }

    function terminerMission(missionIdx) {
      missionEnCours = false;
      miniJeuMissionIdx = -1;

      var m = mesMissions[missionIdx];
      if (!m || m.faite) return;
      m.faite = true;

      var missionEl = document.getElementById('mission-' + missionIdx);
      if (missionEl) {
        missionEl.classList.add('mission-done');
        var check = missionEl.querySelector('.mission-check');
        if (check) check.innerHTML = '&#10003;';
      }

      showNotif(t('missionDone', m.nom), 'info');

      var btn = document.getElementById('btn-mission');
      if (btn) {
        resetBtnMission(btn);
        btn.style.display = 'none';
      }

      if (!modeHorsLigne && totalMissionsCollectives > 0) {
        missionsCollectivesCompletees++;
        updateJaugeMissions();
      }

      updateMissionHighlight();

      var toutesFaites = true;
      for (var i = 0; i < mesMissions.length; i++) {
        if (!mesMissions[i].faite) { toutesFaites = false; break; }
      }
      if (toutesFaites) {
        if (modeHorsLigne) {
          showNotif(t('allMissionsComplete'), 'info');
        } else {
          showNotif(t('youFinishedMissions'), 'info');
        }
      }
      var gagnant = verifierVictoire();
      if (gagnant) {
        afficherFinPartie(gagnant);
      }
    }

    function resetBtnMission(btn) {
      btn.innerHTML = t('doTask');
      btn.style.pointerEvents = '';
      btn.style.overflow = '';
    }

    // ============================
    // MINI-JEUX IMPLEMENTATIONS (23 uniques)
    // ============================

    // Helpers communs
    function mjShuffle(arr) { for (var i=arr.length-1;i>0;i--) { var j=Math.floor(Math.random()*(i+1)); var t=arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
    function mjBtn(text, bg, color) { var b=document.createElement('button'); b.textContent=text; b.style.cssText='padding:12px 24px;border:none;border-radius:10px;font-family:Impact,Arial Black,sans-serif;font-size:16px;letter-spacing:2px;cursor:pointer;background:'+bg+';color:'+color+';margin:4px;'; return b; }
    function mjGrid(cols) { var g=document.createElement('div'); g.style.cssText='display:grid;grid-template-columns:repeat('+cols+',1fr);gap:8px;width:100%;'; return g; }
    function mjCell(emoji, size) { var c=document.createElement('div'); c.textContent=emoji; c.style.cssText='display:flex;align-items:center;justify-content:center;font-size:'+(size||'28')+'px;background:#1a252f;border:2px solid #34495e;border-radius:8px;padding:10px;cursor:pointer;transition:all 0.15s;user-select:none;-webkit-user-select:none;'; return c; }
    function mjMsg(text) { var m=document.createElement('div'); m.textContent=text; m.style.cssText='color:#bdc3c7;font-size:13px;text-align:center;margin:8px 0;min-height:20px;'; return m; }
    function mjTitle(text) { var t=document.createElement('div'); t.textContent=text; t.style.cssText='color:#f39c12;font-family:Impact,Arial Black,sans-serif;font-size:16px;letter-spacing:2px;margin-bottom:10px;text-align:center;'; return t; }
    function mjGauge(w) { var bg=document.createElement('div'); bg.style.cssText='width:'+w+'%;height:24px;background:#1a1a2e;border:2px solid #2c3e50;border-radius:12px;overflow:hidden;position:relative;'; var fill=document.createElement('div'); fill.style.cssText='width:0%;height:100%;background:linear-gradient(90deg,#e74c3c,#f39c12,#2ecc71);border-radius:12px;transition:width 0.1s;'; var txt=document.createElement('div'); txt.style.cssText='position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:white;text-shadow:1px 1px 2px #000;'; bg.appendChild(fill); bg.appendChild(txt); return {el:bg,fill:fill,txt:txt}; }

    // 1. LIVRES : Remettre les livres dans l'ordre (clic pour swap)
    function initMJ_livres(zone) {
      var nums = mjShuffle([1,2,3,4,5]);
      var selected = -1;
      var grid = mjGrid(5);
      var msg = mjMsg('Cliquez 2 livres pour les echanger');
      var cells = [];
      for (var i=0;i<5;i++) {
        var c = mjCell(nums[i], 24);
        c.textContent = '\uD83D\uDCD5 ' + nums[i];
        c.setAttribute('data-i', i);
        c.addEventListener('click', (function(idx) { return function() { selectBook(idx); }; })(i));
        cells.push(c);
        grid.appendChild(c);
      }
      zone.appendChild(msg); zone.appendChild(grid);
      function selectBook(idx) {
        if (selected < 0) { selected = idx; cells[idx].style.borderColor = '#f39c12'; cells[idx].style.transform = 'scale(1.1)'; }
        else if (selected === idx) { cells[idx].style.borderColor = '#34495e'; cells[idx].style.transform = ''; selected = -1; }
        else {
          var tmp = nums[selected]; nums[selected] = nums[idx]; nums[idx] = tmp;
          cells[selected].textContent = '\uD83D\uDCD5 ' + nums[selected];
          cells[idx].textContent = '\uD83D\uDCD5 ' + nums[idx];
          cells[selected].style.borderColor = '#34495e'; cells[selected].style.transform = '';
          selected = -1;
          var ok = true; for (var j=0;j<5;j++) if (nums[j]!==j+1) ok=false;
          if (ok) completerMiniJeu();
        }
      }
    }

    // 2. COLIS : Scanner le code-barre (recopier un numero de suivi)
    function initMJ_colis(zone) {
      var code = ''; for (var i=0;i<6;i++) code += Math.floor(Math.random()*10);
      var input = ''; var showing = true;
      var display = document.createElement('div'); display.style.cssText='background:#0a0a1a;border:2px solid #2c3e50;border-radius:8px;padding:14px 20px;font-family:Courier New,monospace;font-size:28px;letter-spacing:8px;color:#2ecc71;text-align:center;margin-bottom:12px;text-shadow:0 0 10px rgba(46,204,113,0.5);';
      display.textContent = '\uD83D\uDCE6 ' + code;
      var msg = mjMsg('Memorisez le numero de suivi...');
      var pad = document.createElement('div'); pad.style.cssText='display:grid;grid-template-columns:repeat(5,1fr);gap:6px;max-width:280px;display:none;';
      for (var n=0;n<=9;n++) { var b=document.createElement('button'); b.className='digicode-btn'; b.textContent=n; b.addEventListener('click',(function(d){return function(){doInput(d);};})(n)); pad.appendChild(b); }
      zone.appendChild(display); zone.appendChild(msg); zone.appendChild(pad);
      var t1=setTimeout(function(){ showing=false; display.textContent='\uD83D\uDCE6 _ _ _ _ _ _'; msg.textContent='Entrez le numero de suivi'; pad.style.display='grid'; },3000); miniJeuTimeouts.push(t1);
      function doInput(d) { if(showing)return; input+=d; var s='\uD83D\uDCE6 '; for(var i=0;i<6;i++) s+=(i<input.length)?input[i]:'_'; display.textContent=s;
        if(input.length>=6){if(input===code){display.style.color='#2ecc71';completerMiniJeu();}else{display.style.color='#e74c3c';msg.textContent='Incorrect ! On vous le remontre...';input='';pad.style.display='none';var t2=setTimeout(function(){display.style.color='#2ecc71';display.textContent='\uD83D\uDCE6 '+code;showing=true;var t3=setTimeout(function(){showing=false;display.textContent='\uD83D\uDCE6 _ _ _ _ _ _';msg.textContent='Entrez le numero';pad.style.display='grid';},3000);miniJeuTimeouts.push(t3);},800);miniJeuTimeouts.push(t2);}}
      }
    }

    // 3. CAMERAS : Trouver l'ecran qui clignote
    function initMJ_cameras(zone) {
      var found = 0; var target = 3;
      var msg = mjMsg('Trouvez la camera avec alerte ! ('+found+'/'+target+')');
      var grid = mjGrid(3);
      var cams = [];
      for (var i=0;i<6;i++) { var c = mjCell('\uD83D\uDCF9', 22); c.style.minHeight='60px'; cams.push(c); grid.appendChild(c); }
      zone.appendChild(msg); zone.appendChild(grid);
      setAlert();
      function setAlert() {
        var idx = Math.floor(Math.random()*6);
        for (var i=0;i<6;i++) { cams[i].style.borderColor='#34495e'; cams[i].style.background='#1a252f'; cams[i].onclick=null; }
        cams[idx].style.borderColor='#e74c3c'; cams[idx].style.background='rgba(231,76,60,0.15)';
        cams[idx].textContent='\uD83D\uDCF9 \u26A0\uFE0F';
        cams[idx].onclick = function() {
          found++; msg.textContent='Trouvez la camera avec alerte ! ('+found+'/'+target+')';
          cams[idx].style.background='rgba(46,204,113,0.2)'; cams[idx].style.borderColor='#2ecc71'; cams[idx].textContent='\u2705';
          if (found>=target) { completerMiniJeu(); } else { var tt=setTimeout(function(){ for(var j=0;j<6;j++){cams[j].textContent='\uD83D\uDCF9';} setAlert(); },600); miniJeuTimeouts.push(tt); }
        };
      }
    }

    // 4. RAYONS : Glisser les produits sur les bons rayons
    function initMJ_rayons(zone) {
      var items = mjShuffle([{e:'\uD83C\uDF4E',n:'Fruits'},{e:'\uD83E\uDD5B',n:'Lait'},{e:'\uD83C\uDF5E',n:'Pain'},{e:'\uD83E\uDDC0',n:'Fromage'}]);
      var targets = [{e:'\uD83C\uDF4E',n:'Fruits'},{e:'\uD83E\uDD5B',n:'Lait'},{e:'\uD83C\uDF5E',n:'Pain'},{e:'\uD83E\uDDC0',n:'Fromage'}];
      var selectedItem = -1; var placed = 0;
      var msg = mjMsg('Placez chaque produit sur le bon rayon');
      var topRow = mjGrid(4); var botRow = mjGrid(4);
      var itemCells = []; var targetCells = [];
      for (var i=0;i<4;i++) {
        var ic = mjCell(items[i].e, 30); ic.addEventListener('click', (function(idx){return function(){selectItem(idx);};})(i)); itemCells.push(ic); topRow.appendChild(ic);
        var tc = mjCell('?', 20); tc.style.background='#2c3e50'; tc.innerHTML='<div style="font-size:10px;color:#95a5a6;">'+targets[i].n+'</div>'; tc.addEventListener('click', (function(idx){return function(){placeItem(idx);};})(i)); targetCells.push(tc); botRow.appendChild(tc);
      }
      zone.appendChild(msg); zone.appendChild(topRow); zone.appendChild(document.createElement('br')); zone.appendChild(botRow);
      function selectItem(idx) { if(itemCells[idx].style.opacity==='0.3')return; if(selectedItem>=0)itemCells[selectedItem].style.borderColor='#34495e'; selectedItem=idx; itemCells[idx].style.borderColor='#f39c12'; }
      function placeItem(idx) { if(selectedItem<0)return; if(items[selectedItem].n===targets[idx].n){ targetCells[idx].textContent=items[selectedItem].e; targetCells[idx].style.borderColor='#2ecc71'; itemCells[selectedItem].style.opacity='0.3'; itemCells[selectedItem].style.borderColor='#34495e'; placed++; selectedItem=-1; if(placed>=4)completerMiniJeu(); } else { targetCells[idx].style.borderColor='#e74c3c'; setTimeout(function(){targetCells[idx].style.borderColor='#34495e';},300); } }
    }

    // 5. ESCALATOR : Connecter les engrenages (cliquer pour tourner)
    function initMJ_escalator(zone) {
      var gears = [0,0,0,0]; // 0=pas bon, 1=bon sens
      var target = [1,0,1,0]; // alternance
      var msg = mjMsg('Tournez les engrenages pour qu\'ils s\'enchainent');
      var grid = mjGrid(4);
      var cells = [];
      for (var i=0;i<4;i++) {
        var c = mjCell('\u2699\uFE0F', 36); c.style.color=(gears[i]?'#2ecc71':'#e74c3c');
        c.innerHTML = '<span style="display:inline-block;transform:rotate(0deg);font-size:36px;">\u2699\uFE0F</span><div style="font-size:10px;color:#95a5a6;">'+(gears[i]?'\u21BB':'\u21BA')+'</div>';
        c.addEventListener('click', (function(idx){return function(){toggleGear(idx);};})(i));
        cells.push(c); grid.appendChild(c);
      }
      zone.appendChild(msg); zone.appendChild(grid);
      function toggleGear(idx) {
        gears[idx] = gears[idx]?0:1;
        cells[idx].innerHTML = '<span style="display:inline-block;transform:rotate('+(gears[idx]?'180':'0')+'deg);font-size:36px;">\u2699\uFE0F</span><div style="font-size:10px;color:#95a5a6;">'+(gears[idx]?'\u21BB':'\u21BA')+'</div>';
        var ok=true; for(var j=0;j<4;j++)if(gears[j]!==target[j])ok=false;
        if(ok) completerMiniJeu();
      }
    }

    // 6. TOILETTES : Fermer les fuites (cliquer quand elles apparaissent)
    function initMJ_toilettes(zone) {
      var fixed = 0; var total = 5;
      var msg = mjMsg('Cliquez sur les fuites pour les reparer ! ('+fixed+'/'+total+')');
      var grid = mjGrid(3);
      var pipes = [];
      for (var i=0;i<6;i++) { var c = mjCell('\uD83D\uDEB0', 28); c.style.minHeight='60px'; pipes.push(c); grid.appendChild(c); }
      zone.appendChild(msg); zone.appendChild(grid);
      spawnLeak();
      function spawnLeak() {
        if(fixed>=total)return;
        var idx=Math.floor(Math.random()*6);
        pipes[idx].textContent='\uD83D\uDCA7'; pipes[idx].style.borderColor='#3498db'; pipes[idx].style.background='rgba(52,152,219,0.15)';
        pipes[idx].onclick=function(){ fixed++; msg.textContent='Cliquez sur les fuites pour les reparer ! ('+fixed+'/'+total+')'; pipes[idx].textContent='\u2705'; pipes[idx].style.borderColor='#2ecc71'; pipes[idx].style.background='#1a252f'; pipes[idx].onclick=null;
          if(fixed>=total){completerMiniJeu();}else{var tt=setTimeout(spawnLeak,400);miniJeuTimeouts.push(tt);}
        };
      }
    }

    // 7. POMPES : Alterner haut/bas
    function initMJ_pompes(zone) {
      var count = 0; var total = 16; var expectUp = true;
      var msg = mjMsg('Alternez \u2B06 et \u2B07 ! ('+count+'/'+total+')');
      var btnUp = mjBtn('\u2B06 HAUT', '#2ecc71', 'white'); var btnDown = mjBtn('\u2B07 BAS', '#e74c3c', 'white');
      btnUp.style.width='120px'; btnUp.style.height='80px'; btnUp.style.fontSize='20px';
      btnDown.style.width='120px'; btnDown.style.height='80px'; btnDown.style.fontSize='20px';
      var gauge = mjGauge(80);
      btnUp.addEventListener('click', function(){ if(!expectUp)return; count++; expectUp=false; update(); });
      btnDown.addEventListener('click', function(){ if(expectUp)return; count++; expectUp=true; update(); });
      btnUp.addEventListener('touchstart', function(e){ e.preventDefault(); btnUp.click(); }, {passive:false});
      btnDown.addEventListener('touchstart', function(e){ e.preventDefault(); btnDown.click(); }, {passive:false});
      var row = document.createElement('div'); row.style.cssText='display:flex;gap:16px;justify-content:center;margin-top:10px;';
      row.appendChild(btnUp); row.appendChild(btnDown);
      zone.appendChild(msg); zone.appendChild(gauge.el); zone.appendChild(row);
      function update(){ var pct=Math.round(count/total*100); gauge.fill.style.width=pct+'%'; gauge.txt.textContent=pct+'%'; msg.textContent='Alternez \u2B06 et \u2B07 ! ('+count+'/'+total+')'; btnUp.style.opacity=expectUp?'1':'0.4'; btnDown.style.opacity=expectUp?'0.4':'1'; if(count>=total)completerMiniJeu(); }
      update();
    }

    // 8. VITRINES : Nettoyer les taches sur les vitrines
    function initMJ_vitrines(zone) {
      var cleaned = 0; var total = 8;
      var msg = mjMsg('Cliquez sur les taches pour nettoyer ! ('+cleaned+'/'+total+')');
      var grid = mjGrid(4);
      for (var i=0;i<total;i++) {
        var c = mjCell('\uD83D\uDCA9', 24); c.style.background='rgba(139,115,85,0.2)';
        c.addEventListener('click', (function(el){return function(){
          if(el.dataset.done)return; el.dataset.done='1'; el.textContent='\u2728'; el.style.background='rgba(46,204,113,0.1)'; el.style.borderColor='#2ecc71';
          cleaned++; msg.textContent='Cliquez sur les taches pour nettoyer ! ('+cleaned+'/'+total+')'; if(cleaned>=total)completerMiniJeu();
        };})(c));
        grid.appendChild(c);
      }
      zone.appendChild(msg); zone.appendChild(grid);
    }

    // 9. ECHANTILLONS : Trouver le bon parfum (memoire d'odeurs)
    function initMJ_echantillons(zone) {
      var parfums = ['\uD83C\uDF39','\uD83C\uDF3B','\uD83C\uDF3A','\uD83C\uDF37','\uD83C\uDF38','\uD83C\uDF3C'];
      var pairs = mjShuffle([0,0,1,1,2,2]); var revealed = []; var first = -1; var found = 0;
      var msg = mjMsg('Trouvez les 3 paires de parfums !');
      var grid = mjGrid(3);
      var cells = [];
      for (var i=0;i<6;i++) {
        var c = mjCell('?', 28); c.style.minHeight='55px';
        c.addEventListener('click', (function(idx){return function(){reveal(idx);};})(i));
        cells.push(c); grid.appendChild(c);
      }
      zone.appendChild(msg); zone.appendChild(grid);
      function reveal(idx) {
        if(revealed[idx]||cells[idx].dataset.locked)return;
        revealed[idx]=true; cells[idx].textContent=parfums[pairs[idx]];
        if(first<0){first=idx;}
        else{
          var f=first; first=-1;
          if(pairs[f]===pairs[idx]){cells[f].dataset.locked='1';cells[idx].dataset.locked='1';cells[f].style.borderColor='#2ecc71';cells[idx].style.borderColor='#2ecc71';found++;if(found>=3)completerMiniJeu();}
          else{var tt=setTimeout(function(){revealed[f]=false;revealed[idx]=false;cells[f].textContent='?';cells[idx].textContent='?';},800);miniJeuTimeouts.push(tt);}
        }
      }
    }

    // 10. CAFE : Remplir la tasse au bon niveau (maintenir et relacher)
    function initMJ_cafe(zone) {
      var level = 0; var targetMin = 65; var targetMax = 80; var filling = false; var done = false;
      var msg = mjMsg('Maintenez pour verser, relachez dans la zone verte !');
      var cup = document.createElement('div'); cup.style.cssText='width:80px;height:140px;border:3px solid #8b6914;border-top:none;border-radius:0 0 12px 12px;position:relative;overflow:hidden;background:#1a1a2e;margin:10px auto;';
      var fill = document.createElement('div'); fill.style.cssText='position:absolute;bottom:0;width:100%;height:0%;background:linear-gradient(180deg,#6b4226,#8b5e34);transition:height 0.05s;';
      var greenZone = document.createElement('div'); greenZone.style.cssText='position:absolute;bottom:'+targetMin+'%;width:100%;height:'+(targetMax-targetMin)+'%;background:rgba(46,204,113,0.25);border-top:2px solid #2ecc71;border-bottom:2px solid #2ecc71;';
      cup.appendChild(greenZone); cup.appendChild(fill);
      var pourBtn = mjBtn('\u2615 VERSER', '#8b5e34', 'white'); pourBtn.style.width='100%';
      pourBtn.addEventListener('mousedown', function(e){e.preventDefault();filling=true;});
      pourBtn.addEventListener('mouseup', function(){filling=false;checkLevel();});
      pourBtn.addEventListener('touchstart', function(e){e.preventDefault();filling=true;},{passive:false});
      pourBtn.addEventListener('touchend', function(){filling=false;checkLevel();});
      zone.appendChild(msg); zone.appendChild(cup); zone.appendChild(pourBtn);
      var tickCafe = function(){ if(done)return; if(filling){level=Math.min(100,level+1.5);} fill.style.height=level+'%'; };
      miniJeuInterval = setInterval(tickCafe,50);
      miniJeuResumeFn = function(){ miniJeuInterval = setInterval(tickCafe,50); };
      function checkLevel(){ if(done)return; if(level>=targetMin&&level<=targetMax){done=true;msg.textContent='Parfait !';completerMiniJeu();}else if(level>targetMax){msg.textContent='Trop plein ! Recommencez...';level=0;} }
    }

    // 11. BOX INTERNET : Connecter les fils colores
    function initMJ_box(zone) {
      var colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f'];
      var names = ['R', 'B', 'V', 'J'];
      var rightOrder = [0,1,2,3];
      for (var i = rightOrder.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = rightOrder[i]; rightOrder[i] = rightOrder[j]; rightOrder[j] = tmp;
      }

      var connected = 0;
      var selectedLeft = -1;

      var container = document.createElement('div');
      container.className = 'wires-container';

      var svgNS = 'http://www.w3.org/2000/svg';
      var svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('class', 'wires-svg');

      var leftCol = document.createElement('div');
      leftCol.className = 'wires-left';
      var rightCol = document.createElement('div');
      rightCol.className = 'wires-right';

      for (var li = 0; li < 4; li++) {
        var ep = document.createElement('div');
        ep.className = 'wire-endpoint';
        ep.style.background = colors[li];
        ep.textContent = names[li];
        ep.setAttribute('data-color-idx', li);
        ep.addEventListener('click', (function(idx, el) {
          return function() { wiresSelectLeft(idx, el); };
        })(li, ep));
        leftCol.appendChild(ep);
      }

      for (var ri = 0; ri < 4; ri++) {
        var ci = rightOrder[ri];
        var ep2 = document.createElement('div');
        ep2.className = 'wire-endpoint';
        ep2.style.background = colors[ci];
        ep2.textContent = names[ci];
        ep2.setAttribute('data-color-idx', ci);
        ep2.addEventListener('click', (function(idx, el) {
          return function() { wiresSelectRight(idx, el); };
        })(ci, ep2));
        rightCol.appendChild(ep2);
      }

      container.appendChild(leftCol);
      container.appendChild(svg);
      container.appendChild(rightCol);
      zone.appendChild(container);

      function wiresSelectLeft(colorIdx, el) {
        var prev = leftCol.querySelector('.wire-selected');
        if (prev) { prev.classList.remove('wire-selected'); prev.style.boxShadow = ''; }
        selectedLeft = colorIdx;
        el.classList.add('wire-selected');
        el.style.boxShadow = '0 0 15px ' + colors[colorIdx];
      }

      function wiresSelectRight(colorIdx, el) {
        if (selectedLeft < 0) return;
        if (colorIdx === selectedLeft) {
          var leftEl = leftCol.children[selectedLeft];
          leftEl.classList.add('connected');
          el.classList.add('connected');
          leftEl.style.boxShadow = '';
          leftEl.classList.remove('wire-selected');

          var lr = leftEl.getBoundingClientRect();
          var rr = el.getBoundingClientRect();
          var cr = container.getBoundingClientRect();
          var line = document.createElementNS(svgNS, 'line');
          line.setAttribute('x1', lr.right - cr.left);
          line.setAttribute('y1', lr.top + lr.height/2 - cr.top);
          line.setAttribute('x2', rr.left - cr.left);
          line.setAttribute('y2', rr.top + rr.height/2 - cr.top);
          line.setAttribute('stroke', colors[colorIdx]);
          svg.appendChild(line);

          connected++;
          selectedLeft = -1;
          if (connected >= 4) {
            completerMiniJeu();
          }
        } else {
          selectedLeft = -1;
          var prev = leftCol.querySelector('.wire-selected');
          if (prev) { prev.classList.remove('wire-selected'); prev.style.boxShadow = ''; }
        }
      }
    }

    // 12. PROJECTION : Ajuster le focus du projecteur
    function initMJ_projection(zone) {
      var pos = 0; var dir = 1; var speed = 1.0; var hits = 0; var total = 2; var done = false;
      var targetMin = 40; var targetMax = 58;
      var msg = mjMsg('Appuyez sur FOCUS quand l\'image est nette ! ('+hits+'/'+total+')');
      var screen = document.createElement('div'); screen.style.cssText='width:90%;height:60px;background:#0a0a1a;border:2px solid #2c3e50;border-radius:6px;position:relative;overflow:hidden;margin:8px auto;';
      var tgt = document.createElement('div'); tgt.style.cssText='position:absolute;top:0;height:100%;width:18%;background:rgba(46,204,113,0.2);border-left:2px solid #2ecc71;border-right:2px solid #2ecc71;left:'+targetMin+'%;';
      var ind = document.createElement('div'); ind.style.cssText='position:absolute;top:2px;bottom:2px;width:6px;background:#f39c12;border-radius:3px;left:0;';
      screen.appendChild(tgt); screen.appendChild(ind);
      var btn = mjBtn('\uD83C\uDFA5 FOCUS', '#3498db', 'white'); btn.style.width='100%';
      btn.addEventListener('click', function(){
        if(done)return;
        if(pos>=targetMin&&pos<=targetMax){hits++;msg.textContent='Appuyez sur FOCUS quand l\'image est nette ! ('+hits+'/'+total+')';speed+=0.4;targetMin=20+Math.floor(Math.random()*55);targetMax=targetMin+18;tgt.style.left=targetMin+'%';if(hits>=total){done=true;completerMiniJeu();}}
        else{tgt.style.background='rgba(231,76,60,0.3)';setTimeout(function(){tgt.style.background='rgba(46,204,113,0.2)';},200);}
      });
      zone.appendChild(msg); zone.appendChild(screen); zone.appendChild(btn);
      var tickProj = function(){if(done)return;pos+=dir*speed;if(pos>=100){pos=100;dir=-1;}if(pos<=0){pos=0;dir=1;}ind.style.left=pos+'%';};
      miniJeuInterval = setInterval(tickProj,16);
      miniJeuResumeFn = function(){ miniJeuInterval = setInterval(tickProj,16); };
    }

    // 13. TABLES : Debarrasser les assiettes sales
    function initMJ_tables(zone) {
      var cleaned = 0; var total = 6;
      var emojis = ['\uD83C\uDF7D\uFE0F','\uD83E\uDD62','\uD83C\uDF54','\uD83C\uDF5D','\uD83E\uDD57','\uD83C\uDF5B'];
      var msg = mjMsg('Debarrassez les assiettes ! ('+cleaned+'/'+total+')');
      var grid = mjGrid(3);
      for (var i=0;i<total;i++) {
        var c = mjCell(emojis[i], 28); c.style.background='rgba(139,69,19,0.15)';
        c.addEventListener('click', (function(el){return function(){
          if(el.dataset.done)return; el.dataset.done='1'; el.textContent='\u2728'; el.style.background='rgba(46,204,113,0.1)'; el.style.borderColor='#2ecc71';
          cleaned++; msg.textContent='Debarrassez les assiettes ! ('+cleaned+'/'+total+')'; if(cleaned>=total)completerMiniJeu();
        };})(c));
        grid.appendChild(c);
      }
      zone.appendChild(msg); zone.appendChild(grid);
    }

    // 14. MEDICAMENTS : Trier les pilules par couleur
    function initMJ_medicaments(zone) {
      var colors = ['#e74c3c','#3498db','#2ecc71']; var names = ['Rouge','Bleu','Vert'];
      var pills = mjShuffle([0,0,1,1,2,2]); var sorted = 0; var selectedPill = -1;
      var msg = mjMsg('Triez chaque pilule dans le bon bac');
      var pillRow = mjGrid(6); var pillCells = [];
      for (var i=0;i<6;i++) {
        var c = mjCell('\uD83D\uDC8A', 22); c.style.color=colors[pills[i]]; c.style.textShadow='0 0 8px '+colors[pills[i]];
        c.addEventListener('click',(function(idx){return function(){if(pillCells[idx].dataset.done)return;if(selectedPill>=0)pillCells[selectedPill].style.borderColor='#34495e';selectedPill=idx;pillCells[idx].style.borderColor='#f39c12';};})(i));
        pillCells.push(c); pillRow.appendChild(c);
      }
      var binRow = mjGrid(3); var bins = [];
      for (var j=0;j<3;j++) {
        var b = mjCell('\uD83D\uDDD1\uFE0F', 22); b.style.borderColor=colors[j]; b.innerHTML='\uD83D\uDDD1\uFE0F<div style="font-size:9px;color:'+colors[j]+';">'+names[j]+'</div>';
        b.addEventListener('click',(function(ci){return function(){
          if(selectedPill<0)return;
          if(pills[selectedPill]===ci){pillCells[selectedPill].dataset.done='1';pillCells[selectedPill].style.opacity='0.3';pillCells[selectedPill].style.borderColor='#34495e';sorted++;selectedPill=-1;if(sorted>=6)completerMiniJeu();}
          else{bins[ci].style.background='rgba(231,76,60,0.2)';setTimeout(function(){bins[ci].style.background='#1a252f';},300);}
        };})(j));
        bins.push(b); binRow.appendChild(b);
      }
      zone.appendChild(msg); zone.appendChild(pillRow); zone.appendChild(document.createElement('br')); zone.appendChild(binRow);
    }

    // 15. VETEMENTS : Accrocher les vetements par couleur
    function initMJ_vetements(zone) {
      var items = mjShuffle([{e:'\uD83D\uDC55',c:'#e74c3c'},{e:'\uD83D\uDC57',c:'#3498db'},{e:'\uD83E\uDDE5',c:'#2ecc71'},{e:'\uD83E\uDD7E',c:'#f39c12'}]);
      var hangers = [{e:'\uD83E\uDDE3',c:'#e74c3c',n:'Rouge'},{e:'\uD83E\uDDE3',c:'#3498db',n:'Bleu'},{e:'\uD83E\uDDE3',c:'#2ecc71',n:'Vert'},{e:'\uD83E\uDDE3',c:'#f39c12',n:'Orange'}];
      var sel = -1; var placed = 0;
      var msg = mjMsg('Rangez chaque vetement sur le bon cintre');
      var topRow = mjGrid(4); var botRow = mjGrid(4);
      var itemCells = []; var hangerCells = [];
      for (var i=0;i<4;i++) {
        var ic = mjCell(items[i].e, 30); ic.style.textShadow='0 0 8px '+items[i].c;
        ic.addEventListener('click',(function(idx){return function(){if(itemCells[idx].dataset.done)return;if(sel>=0)itemCells[sel].style.borderColor='#34495e';sel=idx;itemCells[idx].style.borderColor='#f39c12';};})(i));
        itemCells.push(ic); topRow.appendChild(ic);
        var hc = mjCell('', 18); hc.style.borderColor=hangers[i].c; hc.innerHTML='<div style="font-size:10px;color:'+hangers[i].c+';">'+hangers[i].n+'</div>';
        hc.addEventListener('click',(function(idx){return function(){
          if(sel<0)return;
          if(items[sel].c===hangers[idx].c){hangerCells[idx].textContent=items[sel].e;hangerCells[idx].style.borderColor='#2ecc71';itemCells[sel].dataset.done='1';itemCells[sel].style.opacity='0.3';itemCells[sel].style.borderColor='#34495e';placed++;sel=-1;if(placed>=4)completerMiniJeu();}
          else{hangerCells[idx].style.background='rgba(231,76,60,0.2)';setTimeout(function(){hangerCells[idx].style.background='#1a252f';},300);}
        };})(i));
        hangerCells.push(hc); botRow.appendChild(hc);
      }
      zone.appendChild(msg); zone.appendChild(topRow); zone.appendChild(document.createElement('br')); zone.appendChild(botRow);
    }

    // 16. CONSOLES : Telecharger la mise a jour (cliquer quand ca pause)
    function initMJ_consoles(zone) {
      var progress = 0; var paused = false; var pauses = 0; var totalPauses = 3; var done = false;
      var msg = mjMsg('Telechargement en cours...');
      var gauge = mjGauge(90);
      var resumeBtn = mjBtn('\u25B6 REPRENDRE', '#2ecc71', 'white'); resumeBtn.style.display='none'; resumeBtn.style.width='100%';
      resumeBtn.addEventListener('click', function(){if(!paused||done)return;paused=false;resumeBtn.style.display='none';msg.textContent='Telechargement en cours...';});
      zone.appendChild(msg); zone.appendChild(gauge.el); zone.appendChild(resumeBtn);
      var nextPause = 15+Math.floor(Math.random()*20);
      var tickConsoles = function(){
        if(done||paused)return;
        progress+=0.5;
        gauge.fill.style.width=Math.min(progress,100)+'%'; gauge.txt.textContent=Math.round(progress)+'%';
        if(progress>=nextPause&&pauses<totalPauses){paused=true;pauses++;msg.textContent='\u26A0 Erreur ! Cliquez REPRENDRE ('+pauses+'/'+totalPauses+')';resumeBtn.style.display='block';nextPause=progress+15+Math.floor(Math.random()*20);}
        if(progress>=100){done=true;completerMiniJeu();}
      };
      miniJeuInterval = setInterval(tickConsoles,50);
      miniJeuResumeFn = function(){ miniJeuInterval = setInterval(tickConsoles,50); };
    }

    // 17. ANIMAUX : Donner la bonne nourriture
    function initMJ_animaux(zone) {
      var animals = [{e:'\uD83D\uDC31',n:'Chat',food:'\uD83D\uDC1F'},{e:'\uD83D\uDC36',n:'Chien',food:'\uD83E\uDD69'},{e:'\uD83D\uDC30',n:'Lapin',food:'\uD83E\uDD55'}];
      var foods = mjShuffle(['\uD83D\uDC1F','\uD83E\uDD69','\uD83E\uDD55']);
      var selFood = -1; var fed = 0;
      var msg = mjMsg('Donnez la bonne nourriture a chaque animal');
      var animalRow = mjGrid(3); var foodRow = mjGrid(3);
      var aCells = []; var fCells = [];
      for (var i=0;i<3;i++) {
        var ac = mjCell(animals[i].e, 36); ac.innerHTML=animals[i].e+'<div style="font-size:10px;color:#bdc3c7;">'+animals[i].n+'</div>';
        ac.addEventListener('click',(function(idx){return function(){
          if(selFood<0||aCells[idx].dataset.done)return;
          if(foods[selFood]===animals[idx].food){aCells[idx].dataset.done='1';aCells[idx].style.borderColor='#2ecc71';aCells[idx].innerHTML=animals[idx].e+' '+animals[idx].food;fCells[selFood].style.opacity='0.3';fCells[selFood].dataset.done='1';selFood=-1;fed++;if(fed>=3)completerMiniJeu();}
          else{aCells[idx].style.background='rgba(231,76,60,0.2)';setTimeout(function(){aCells[idx].style.background='#1a252f';},300);}
        };})(i));
        aCells.push(ac); animalRow.appendChild(ac);
        var fc = mjCell(foods[i], 30);
        fc.addEventListener('click',(function(idx){return function(){if(fCells[idx].dataset.done)return;if(selFood>=0)fCells[selFood].style.borderColor='#34495e';selFood=idx;fCells[idx].style.borderColor='#f39c12';};})(i));
        fCells.push(fc); foodRow.appendChild(fc);
      }
      zone.appendChild(msg); zone.appendChild(animalRow); zone.appendChild(document.createElement('br')); zone.appendChild(foodRow);
    }

    // 18. FOURS : Regler la temperature (aiguille + zone cible)
    function initMJ_fours(zone) {
      var temp = 0; var dir = 1; var speed = 0.8; var done = false;
      var targetMin = 170; var targetMax = 190;
      var msg = mjMsg('Arretez le thermometre entre 170\u00B0C et 190\u00B0C');
      var display = document.createElement('div'); display.style.cssText='font-family:Courier New,monospace;font-size:42px;color:#f39c12;text-align:center;margin:10px;text-shadow:0 0 10px rgba(243,156,18,0.5);';
      display.textContent='0\u00B0C';
      var btn = mjBtn('\uD83C\uDF21\uFE0F ARRETER', '#e74c3c', 'white'); btn.style.width='100%';
      btn.addEventListener('click', function(){
        if(done)return;
        if(temp>=targetMin&&temp<=targetMax){done=true;display.style.color='#2ecc71';msg.textContent='Temperature parfaite !';completerMiniJeu();}
        else{msg.textContent=(temp<targetMin?'Trop froid !':'Trop chaud !')+' Reessayez...';display.style.color='#e74c3c';setTimeout(function(){display.style.color='#f39c12';msg.textContent='Arretez le thermometre entre 170\u00B0C et 190\u00B0C';},500);}
      });
      zone.appendChild(msg); zone.appendChild(display); zone.appendChild(btn);
      var tickFours = function(){if(done)return;temp+=dir*speed;if(temp>=250){temp=250;dir=-1;}if(temp<=0){temp=0;dir=1;}display.textContent=Math.round(temp)+'\u00B0C';if(temp>=targetMin&&temp<=targetMax)display.style.color='#2ecc71';else display.style.color='#f39c12';};
      miniJeuInterval = setInterval(tickFours,30);
      miniJeuResumeFn = function(){ miniJeuInterval = setInterval(tickFours,30); };
    }

    // 19. PLANTES : Arroser 3 plantes au bon niveau
    function initMJ_plantes(zone) {
      var plants = [{e:'\uD83C\uDF31',target:60},{e:'\uD83C\uDF3F',target:70},{e:'\uD83C\uDF35',target:40}];
      var levels = [0,0,0]; var done = [false,false,false]; var filling = -1; var completed = 0;
      var msg = mjMsg('Maintenez pour arroser chaque plante dans la zone verte');
      var grid = mjGrid(3);
      var bars = []; var cells = [];
      for (var i=0;i<3;i++) {
        var wrap = document.createElement('div'); wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:4px;';
        var bar = document.createElement('div'); bar.style.cssText='width:30px;height:100px;background:#1a252f;border:2px solid #34495e;border-radius:4px;position:relative;overflow:hidden;';
        var fl = document.createElement('div'); fl.style.cssText='position:absolute;bottom:0;width:100%;height:0%;background:#3498db;transition:height 0.05s;';
        var gz = document.createElement('div'); gz.style.cssText='position:absolute;bottom:'+(plants[i].target-8)+'%;width:100%;height:16%;background:rgba(46,204,113,0.3);border-top:1px solid #2ecc71;border-bottom:1px solid #2ecc71;';
        bar.appendChild(gz); bar.appendChild(fl);
        var lbl = document.createElement('div'); lbl.style.cssText='font-size:24px;'; lbl.textContent=plants[i].e;
        var btn = mjBtn('\uD83D\uDCA7', '#3498db', 'white'); btn.style.padding='6px 16px'; btn.style.fontSize='18px';
        btn.addEventListener('mousedown',(function(idx){return function(e){e.preventDefault();if(!done[idx])filling=idx;};})(i));
        btn.addEventListener('mouseup',(function(idx){return function(){if(filling===idx){filling=-1;checkPlant(idx);}};})(i));
        btn.addEventListener('touchstart',(function(idx){return function(e){e.preventDefault();if(!done[idx])filling=idx;};})(i),{passive:false});
        btn.addEventListener('touchend',(function(idx){return function(){if(filling===idx){filling=-1;checkPlant(idx);}};})(i));
        wrap.appendChild(lbl); wrap.appendChild(bar); wrap.appendChild(btn);
        bars.push(fl); cells.push(wrap); grid.appendChild(wrap);
      }
      zone.appendChild(msg); zone.appendChild(grid);
      var tickPlantes = function(){
        if(filling>=0&&!done[filling]){levels[filling]=Math.min(100,levels[filling]+1.2);bars[filling].style.height=levels[filling]+'%';}
      };
      miniJeuInterval = setInterval(tickPlantes,50);
      miniJeuResumeFn = function(){ miniJeuInterval = setInterval(tickPlantes,50); };
      function checkPlant(idx){
        var t=plants[idx].target;
        if(levels[idx]>=t-8&&levels[idx]<=t+8){done[idx]=true;bars[idx].style.background='#2ecc71';completed++;if(completed>=3)completerMiniJeu();}
        else{msg.textContent=(levels[idx]<t-8?'Pas assez !':'Trop d\'eau !')+' Recommencez cette plante';levels[idx]=0;bars[idx].style.height='0%';}
      }
    }

    // 20. INFUSIONS : Etapes dans le bon ordre
    function initMJ_infusions(zone) {
      var steps = ['\uD83D\uDD25 Faire bouillir','\uD83C\uDF75 Mettre le the','\u23F3 Laisser infuser','\uD83E\uDD64 Servir'];
      var shuffled = mjShuffle(steps.slice()); var current = 0;
      var msg = mjMsg('Cliquez les etapes dans le bon ordre');
      var orderDisplay = document.createElement('div'); orderDisplay.style.cssText='color:#f39c12;font-size:12px;text-align:center;margin-bottom:8px;letter-spacing:1px;';
      orderDisplay.textContent='Ordre : 1\u2192 Bouillir  2\u2192 The  3\u2192 Infuser  4\u2192 Servir';
      var grid = mjGrid(2);
      var cells = [];
      for (var i=0;i<4;i++) {
        var c = mjCell(shuffled[i], 14); c.style.fontSize='14px'; c.style.minHeight='50px';
        c.addEventListener('click',(function(idx){return function(){
          if(cells[idx].dataset.done)return;
          if(shuffled[idx]===steps[current]){cells[idx].dataset.done='1';cells[idx].style.borderColor='#2ecc71';cells[idx].style.opacity='0.5';current++;if(current>=4)completerMiniJeu();}
          else{cells[idx].style.borderColor='#e74c3c';setTimeout(function(){cells[idx].style.borderColor='#34495e';},400);msg.textContent='Mauvais ordre ! Recommencez l\'etape '+(current+1);}
        };})(i));
        cells.push(c); grid.appendChild(c);
      }
      zone.appendChild(msg); zone.appendChild(orderDisplay); zone.appendChild(grid);
    }

    // 21. CALIBRER : Deux aiguilles a aligner dans la zone verte
    function initMJ_calibrer(zone) {
      var pos1=0,pos2=100,dir1=1,dir2=-1,sp1=0.9,sp2=1.3,done=false;
      var tgt=42,tgtW=16;
      var msg = mjMsg('Appuyez quand les DEUX aiguilles sont dans le vert');
      var mkTrack=function(){
        var t=document.createElement('div');t.style.cssText='width:90%;height:30px;background:#1a1a2e;border:2px solid #2c3e50;border-radius:4px;position:relative;overflow:hidden;margin:6px auto;';
        var g=document.createElement('div');g.style.cssText='position:absolute;top:0;height:100%;width:'+tgtW+'%;background:rgba(46,204,113,0.2);border-left:2px solid #2ecc71;border-right:2px solid #2ecc71;left:'+tgt+'%;';
        var n=document.createElement('div');n.style.cssText='position:absolute;top:2px;bottom:2px;width:6px;background:#e74c3c;border-radius:3px;left:0;';
        t.appendChild(g);t.appendChild(n);return{el:t,needle:n};
      };
      var t1=mkTrack(),t2=mkTrack();
      var btn=mjBtn('\uD83D\uDC41\uFE0F VALIDER','#f39c12','#000');btn.style.width='100%';
      btn.addEventListener('click',function(){
        if(done)return;
        var ok1=pos1>=tgt&&pos1<=tgt+tgtW,ok2=pos2>=tgt&&pos2<=tgt+tgtW;
        if(ok1&&ok2){done=true;completerMiniJeu();}
        else{msg.textContent='Les deux doivent etre dans le vert !';setTimeout(function(){msg.textContent='Appuyez quand les DEUX aiguilles sont dans le vert';},800);}
      });
      zone.appendChild(msg);zone.appendChild(t1.el);zone.appendChild(t2.el);zone.appendChild(btn);
      var tickCalibrer=function(){if(done)return;
        pos1+=dir1*sp1;if(pos1>=100){pos1=100;dir1=-1;}if(pos1<=0){pos1=0;dir1=1;}t1.needle.style.left=pos1+'%';
        pos2+=dir2*sp2;if(pos2>=100){pos2=100;dir2=-1;}if(pos2<=0){pos2=0;dir2=1;}t2.needle.style.left=pos2+'%';
      };
      miniJeuInterval=setInterval(tickCalibrer,16);
      miniJeuResumeFn=function(){ miniJeuInterval=setInterval(tickCalibrer,16); };
    }

    // 22. QUILLES : Relever les quilles tombees
    function initMJ_quilles(zone) {
      var rows = [1,2,3,4]; var total = 10; var fallen = []; var fixed = 0;
      for(var i=0;i<total;i++) fallen.push(Math.random()<0.6);
      var toFix=0; for(var i=0;i<total;i++) if(fallen[i]) toFix++;
      if(toFix===0){fallen[0]=true;fallen[3]=true;toFix=2;}
      var msg = mjMsg('Relevez les quilles tombees ! ('+fixed+'/'+toFix+')');
      var container = document.createElement('div'); container.style.cssText='display:flex;flex-direction:column;align-items:center;gap:6px;';
      var idx = 0; var cells = [];
      for(var r=0;r<4;r++){
        var row = document.createElement('div'); row.style.cssText='display:flex;gap:6px;justify-content:center;';
        for(var c=0;c<=r;c++){
          var pin = mjCell(fallen[idx]?'\u274C':'\uD83C\uDFB3', 22); pin.style.width='44px'; pin.style.height='44px'; pin.style.padding='4px';
          if(fallen[idx]){pin.style.background='rgba(231,76,60,0.15)';pin.style.borderColor='#e74c3c';
            pin.addEventListener('click',(function(pidx,el){return function(){if(el.dataset.done)return;el.dataset.done='1';fallen[pidx]=false;el.textContent='\uD83C\uDFB3';el.style.background='#1a252f';el.style.borderColor='#2ecc71';fixed++;msg.textContent='Relevez les quilles tombees ! ('+fixed+'/'+toFix+')';if(fixed>=toFix)completerMiniJeu();};})(idx,pin));
          }
          cells.push(pin); row.appendChild(pin); idx++;
        }
        container.appendChild(row);
      }
      zone.appendChild(msg); zone.appendChild(container);
    }

    // 23. BALLONS : Gonfler sans eclater
    function initMJ_ballons(zone) {
      var current = 0; var total = 3; var size = 0; var targets = [60,70,80]; var inflating = false; var done = false;
      var msg = mjMsg('Maintenez pour gonfler, relachez avant que ca eclate ! ('+current+'/'+total+')');
      var balloon = document.createElement('div'); balloon.style.cssText='width:40px;height:40px;background:radial-gradient(circle,#e74c3c,#c0392b);border-radius:50%;margin:10px auto;transition:width 0.05s,height 0.05s;display:flex;align-items:center;justify-content:center;font-size:20px;';
      balloon.textContent='\uD83C\uDF88';
      var dangerBar = mjGauge(70);
      var btn = mjBtn('\uD83C\uDF88 GONFLER', '#e74c3c', 'white'); btn.style.width='100%';
      btn.addEventListener('mousedown',function(e){e.preventDefault();if(!done)inflating=true;});
      btn.addEventListener('mouseup',function(){inflating=false;checkBalloon();});
      btn.addEventListener('touchstart',function(e){e.preventDefault();if(!done)inflating=true;},{passive:false});
      btn.addEventListener('touchend',function(){inflating=false;checkBalloon();});
      zone.appendChild(msg); zone.appendChild(balloon); zone.appendChild(dangerBar.el); zone.appendChild(btn);
      var tickBallons=function(){
        if(done)return;
        if(inflating){size+=1.5;var s=40+size*0.8;balloon.style.width=s+'px';balloon.style.height=s+'px';
          dangerBar.fill.style.width=size+'%';dangerBar.txt.textContent=Math.round(size)+'%';
          if(size>=100){inflating=false;done=true;balloon.textContent='\uD83D\uDCA5';msg.textContent='Eclate ! Recommencez...';
            setTimeout(function(){done=false;size=0;balloon.style.width='40px';balloon.style.height='40px';balloon.textContent='\uD83C\uDF88';dangerBar.fill.style.width='0%';dangerBar.txt.textContent='0%';msg.textContent='Maintenez pour gonfler, relachez avant que ca eclate ! ('+current+'/'+total+')';},1000);
          }
        }
      };
      miniJeuInterval=setInterval(tickBallons,50);
      miniJeuResumeFn=function(){ miniJeuInterval=setInterval(tickBallons,50); };
      function checkBalloon(){
        if(done)return; var t=targets[current];
        if(size>=t-10&&size<=t+5){current++;balloon.textContent='\u2705';
          if(current>=total){done=true;completerMiniJeu();}
          else{setTimeout(function(){size=0;balloon.style.width='40px';balloon.style.height='40px';balloon.textContent='\uD83C\uDF88';dangerBar.fill.style.width='0%';dangerBar.txt.textContent='0%';msg.textContent='Maintenez pour gonfler ! ('+current+'/'+total+')';},600);}
        }else if(size<t-10){msg.textContent='Pas assez gonfle ! Continuez...';}
      }
    }

    // ============================
    // SYSTEME DE CAMERAS DE SECURITE
    // ============================
    var CAMERAS = [
      { nom: 'CAM 1 - FONTAINE', x: 3500, y: 2500, w: 600, h: 600 },
      { nom: 'CAM 2 - BIJOUTERIE', x: 7300, y: 0, w: 700, h: 500 },
      { nom: 'CAM 3 - ARCADE', x: 2300, y: 3600, w: 800, h: 600 },
      { nom: 'CAM 4 - SUPERMARCHE', x: 0, y: 3000, w: 900, h: 700 },
      { nom: 'CAM 5 - LIBRAIRIE', x: 0, y: 800, w: 700, h: 600 },
      { nom: 'CAM 6 - CAFE', x: 3600, y: 0, w: 650, h: 400 }
    ];
    var camerasOuvertes = false;
    var camerasInterval = null;
    var SECURITE_RECT = { x: 2800, y: 60, w: 450, h: 300 };

    var sonConnect = new Audio('Connect.mp3');
    var sonDisconnect = new Audio('Disconnect.mp3');

    function ouvrirCameras() {
      camerasOuvertes = true;
      sonConnect.currentTime = 0;
      sonConnect.play().catch(function(){});
      var overlay = document.getElementById('cameras-overlay');
      overlay.classList.add('visible');
      // Generer les panneaux
      var grille = document.getElementById('cameras-grille');
      var html = '';
      for (var c = 0; c < CAMERAS.length; c++) {
        html += '<div class="camera-panel" id="cam-panel-' + c + '">' +
          '<div class="camera-panel-header">' +
            '<span class="camera-panel-nom">' + CAMERAS[c].nom + '</span>' +
            '<span class="camera-panel-rec"> REC</span>' +
          '</div>' +
          '<div class="camera-panel-vue" id="cam-vue-' + c + '"></div>' +
          '<div class="camera-dots-layer" id="cam-dots-' + c + '"></div>' +
          '<div class="camera-scanlines"></div>' +
        '</div>';
      }
      grille.innerHTML = html;
      // Cloner la vraie map HTML dans chaque camera
      var mallMap = document.getElementById('mall-map');
      setTimeout(function() {
        for (var c = 0; c < CAMERAS.length; c++) {
          var vue = document.getElementById('cam-vue-' + c);
          if (!vue || !mallMap) continue;
          var cam = CAMERAS[c];
          var pw = vue.offsetWidth || 220;
          var ph = vue.offsetHeight || 165;
          // Echelle pour que la zone camera remplisse le panel
          var scaleX = pw / cam.w;
          var scaleY = ph / cam.h;
          var scale = Math.max(scaleX, scaleY);
          // Cloner la map
          var clone = mallMap.cloneNode(true);
          clone.removeAttribute('id');
          clone.className = 'camera-map-clone';
          clone.style.width = '8000px';
          clone.style.height = '6000px';
          // Utiliser left/top au lieu de translate pour eviter le clipping du navigateur
          clone.style.left = (-cam.x * scale) + 'px';
          clone.style.top = (-cam.y * scale) + 'px';
          clone.style.transform = 'scale(' + scale + ')';
          clone.style.transformOrigin = '0 0';
          vue.appendChild(clone);
        }
        updateCameras();
      }, 50);
      camerasInterval = setInterval(updateCameras, 100);
    }

    function fermerCameras() {
      camerasOuvertes = false;
      sonDisconnect.currentTime = 0;
      sonDisconnect.play().catch(function(){});
      document.getElementById('cameras-overlay').classList.remove('visible');
      if (camerasInterval) { clearInterval(camerasInterval); camerasInterval = null; }
    }

    function updateCameras() {
      var pseudo = getPseudo() || t('player');
      var joueurSkin = getSkinFichier(getSkin());
      for (var c = 0; c < CAMERAS.length; c++) {
        var cam = CAMERAS[c];
        var dotsLayer = document.getElementById('cam-dots-' + c);
        if (!dotsLayer) continue;
        var html = '';
        // Verifier le joueur
        if (joueurX >= cam.x && joueurX <= cam.x + cam.w && joueurY >= cam.y && joueurY <= cam.y + cam.h) {
          var px = ((joueurX - cam.x) / cam.w) * 100;
          var py = ((joueurY - cam.y) / cam.h) * 100;
          html += '<div class="camera-perso" style="left:' + px + '%;top:' + py + '%;">' +
            '<img src="' + joueurSkin + '" alt="joueur">' +
            '<div class="camera-perso-pseudo">' + pseudo + '</div></div>';
        }
        // Verifier les bots vivants
        for (var b = 0; b < bots.length; b++) {
          if (joueursElimines.indexOf(bots[b].pseudo) >= 0) continue;
          if (bots[b].x >= cam.x && bots[b].x <= cam.x + cam.w && bots[b].y >= cam.y && bots[b].y <= cam.y + cam.h) {
            var bx = ((bots[b].x - cam.x) / cam.w) * 100;
            var by = ((bots[b].y - cam.y) / cam.h) * 100;
            html += '<div class="camera-perso" style="left:' + bx + '%;top:' + by + '%;">' +
              '<img src="' + bots[b].skin + '" alt="bot">' +
              '<div class="camera-perso-pseudo">' + bots[b].pseudo + '</div></div>';
          }
        }
        // Verifier les cadavres
        for (var cd = 0; cd < cadavres.length; cd++) {
          var cad = cadavres[cd];
          if (cad.x >= cam.x && cad.x <= cam.x + cam.w && cad.y >= cam.y && cad.y <= cam.y + cam.h) {
            var cx = ((cad.x - cam.x) / cam.w) * 100;
            var cy = ((cad.y - cam.y) / cam.h) * 100;
            html += '<div class="camera-cadavre" style="left:' + cx + '%;top:' + cy + '%;">' +
              '<span class="camera-cadavre-x">X</span>' +
              '<img src="' + cad.skin + '" alt="cadavre"></div>';
          }
        }
        dotsLayer.innerHTML = html;
      }
    }

    function gameLoop() {
      if (!jeuActif) return;

      var moved = false;
      var dx = 0, dy = 0;

      // Bloquer le mouvement joueur si cameras ouvertes ou mini-jeu ouvert
      var cachedSkinImg = document.getElementById('joueur-skin-img');
      if (!camerasOuvertes && !miniJeuOuvert) {
        // ZQSD + Fleches
        if (keys['z'] || keys['Z'] || keys['ArrowUp']) { dy -= vitesse; }
        if (keys['s'] || keys['S'] || keys['ArrowDown']) { dy += vitesse; }
        if (keys['q'] || keys['Q'] || keys['ArrowLeft']) {
          dx -= vitesse;
          if (cachedSkinImg) cachedSkinImg.style.transform = 'scaleX(-1)';
        }
        if (keys['d'] || keys['D'] || keys['ArrowRight']) {
          dx += vitesse;
          if (cachedSkinImg) cachedSkinImg.style.transform = 'scaleX(1)';
        }
        // Deplacement mobile : vers le doigt
        if (touchActif) {
          var tdx = touchTargetX - joueurX;
          var tdy = touchTargetY - joueurY;
          var tdist = Math.sqrt(tdx * tdx + tdy * tdy);
          if (tdist > 8) {
            dx += (tdx / tdist) * vitesse;
            dy += (tdy / tdist) * vitesse;
            if (tdx < -0.5) {
              if (cachedSkinImg) cachedSkinImg.style.transform = 'scaleX(-1)';
            } else if (tdx > 0.5) {
              if (cachedSkinImg) cachedSkinImg.style.transform = 'scaleX(1)';
            }
          }
        }
      }

      // Fantomes se deplacent 1.5x plus vite
      var estFantome = joueursElimines.indexOf(getPseudo() || t('player')) >= 0;
      if (estFantome) { dx *= 1.5; dy *= 1.5; }

      if (dx !== 0 || dy !== 0) moved = true;
      if (dx !== 0) {
        var newX = joueurX + dx;
        if (estFantome || collisionRects.length === 0 || !checkCollision(newX, joueurY)) {
          joueurX = newX;
        }
      }
      // Collision Y
      if (dy !== 0) {
        var newY = joueurY + dy;
        if (estFantome || collisionRects.length === 0 || !checkCollision(joueurX, newY)) {
          joueurY = newY;
        }
      }

      // Limites de la map
      if (joueurX < 25) joueurX = 25;
      if (joueurX > MAP_W - 40) joueurX = MAP_W - 40;
      if (joueurY < 25) joueurY = 25;
      if (joueurY > MAP_H - 40) joueurY = MAP_H - 40;

      if (moved) {
        updateJoueur();
        // Envoyer position via Firebase en mode multijoueur (throttle 200ms)
        if (partieActuelleId && !modeHorsLigne && myPartyPlayerDocId && Date.now() - lastPositionSend > 200) {
          lastPositionSend = Date.now();
          var dir = cachedSkinImg && cachedSkinImg.style.transform === 'scaleX(-1)' ? -1 : 1;
          db.collection('partyPlayers').doc(myPartyPlayerDocId).update({
            x: joueurX, y: joueurY, direction: dir
          }).catch(function() {});
        }
      }

      // Mettre a jour les joueurs distants en mode multiplayer
      if (!modeHorsLigne && partieActuelleId) {
        updateRemotePlayers();
      }

      // Proximite fontaine -> bouton reunion
      var fontCX = 3800, fontCY = 2800;
      var distFontaine = Math.sqrt((joueurX - fontCX) * (joueurX - fontCX) + (joueurY - fontCY) * (joueurY - fontCY));
      var btnReunion = document.getElementById('btn-reunion');
      if (btnReunion) {
        btnReunion.style.display = (distFontaine < 150 && !killProtection && !reunionCooldown) ? 'block' : 'none';
      }

      // Proximite mission -> bouton faire la tache (distance a la caisse)
      var btnMission = document.getElementById('btn-mission');
      var ancienMissionProche = missionProche;
      missionProche = -1;
      if (btnMission) {
        var distSeuil = 80;
        for (var mi = 0; mi < mesMissions.length; mi++) {
          if (mesMissions[mi].faite) continue;
          var dcx = joueurX - mesMissions[mi].caisseX;
          var dcy = joueurY - mesMissions[mi].caisseY;
          var distCaisse = Math.sqrt(dcx * dcx + dcy * dcy);
          if (distCaisse < distSeuil) {
            missionProche = mi;
            break;
          }
        }
        if (!missionEnCours) {
          btnMission.style.display = (missionProche >= 0) ? 'block' : 'none';
        } else if (missionProche < 0 && !miniJeuOuvert) {
          // Le joueur s'est eloigne pendant le timer -> annuler
          if (missionTimer) { clearTimeout(missionTimer); missionTimer = null; }
          missionEnCours = false;
          resetBtnMission(btnMission);
          btnMission.style.display = 'none';
        }
      }

      // Proximite poste de securite -> bouton cameras
      var btnCam = document.getElementById('btn-cameras');
      if (btnCam) {
        var sr = SECURITE_RECT;
        var margeCam = 80;
        var dansSecurite = joueurX >= sr.x - margeCam && joueurX <= sr.x + sr.w + margeCam &&
                           joueurY >= sr.y - margeCam && joueurY <= sr.y + sr.h + margeCam;
        btnCam.style.display = (dansSecurite && !camerasOuvertes && !reunionEnCours) ? 'block' : 'none';
      }

      // Mise a jour des bots
      if (bots.length > 0) {
        updateBots();
        botsVirusTuent();
        botsDetectentCadavres();
      }

      // Fantomes se voient entre eux
      if (botsMorts.length > 0) {
        var joueurEstMort = joueursElimines.indexOf(getPseudo() || t('player')) >= 0;
        for (var fm = 0; fm < botsMorts.length; fm++) {
          if (botsMorts[fm].element) {
            if (joueurEstMort) {
              botsMorts[fm].element.classList.add('fantome-visible');
            } else {
              botsMorts[fm].element.classList.remove('fantome-visible');
            }
          }
        }
      }

      // Detection allies virus proches
      if (bots.length > 0 && monRole === 'virus') {
        detecterVirusProches();
      }

      // Bouton KILL pour le joueur virus
      if (bots.length > 0 && monRole === 'virus') {
        detecterCibleKill();
        var btnKill = document.getElementById('btn-kill');
        if (btnKill) {
          btnKill.style.display = (killCibleIndex >= 0 && !killCooldown && !killProtection) ? 'block' : 'none';
        }
      }

      // Bouton SIGNALER pour cadavres
      if (bots.length > 0) {
        detecterCadavreProche();
        var btnSignaler = document.getElementById('btn-signaler');
        if (btnSignaler) {
          btnSignaler.style.display = (cadavreProche >= 0) ? 'block' : 'none';
        }
      }

      // Bouton ENQUETER pour le journaliste
      if (bots.length > 0 && monRole === 'journaliste') {
        detecterCibleEnquete();
        var btnEnqueter = document.getElementById('btn-enqueter');
        if (btnEnqueter) {
          btnEnqueter.style.display = (enqueteCibleIndex >= 0) ? 'block' : 'none';
        }
      }

      requestAnimationFrame(gameLoop);
    }

    function updateJoueur() {
      var joueur = document.getElementById('joueur');
      if (!joueur) return;
      joueur.style.left = joueurX + 'px';
      joueur.style.top = joueurY + 'px';

      // Camera - centrer la vue sur le joueur
      var viewport = document.getElementById('jeu-viewport');
      if (!viewport) return;
      var vw = viewport.clientWidth;
      var vh = viewport.clientHeight;

      var camX = joueurX - vw / 2 + 14;
      var camY = joueurY - vh / 2 + 14;

      // Limiter la camera aux bords de la map
      if (camX < 0) camX = 0;
      if (camY < 0) camY = 0;
      if (camX > MAP_W - vw) camX = MAP_W - vw;
      if (camY > MAP_H - vh) camY = MAP_H - vh;

      var map = document.getElementById('mall-map');
      map.style.left = -camX + 'px';
      map.style.top = -camY + 'px';

      // Minimap
      var miniPt = document.getElementById('minimap-point');
      if (miniPt) {
        miniPt.style.left = (joueurX / MAP_W * 157) + 'px';
        miniPt.style.top = (joueurY / MAP_H * 117) + 'px';
      }
    }

    // Quitter le jeu
    function quitterJeu() {
      jeuActif = false;
      keys = {};
      touchActif = false;
      if (miniJeuOuvert) fermerMiniJeu();
      if (camerasOuvertes) fermerCameras();
      // Retirer le visuel fantome du joueur
      var joueurEl = document.getElementById('joueur');
      if (joueurEl) joueurEl.classList.remove('bot-mort');
      // Nettoyer les timers de reunion (si quitter pendant une reunion)
      if (reunionTimer) { clearInterval(reunionTimer); reunionTimer = null; }
      for (var ct = 0; ct < botsChatTimers.length; ct++) clearTimeout(botsChatTimers[ct]);
      botsChatTimers = [];
      reunionEnCours = false;
      // Nettoyer cadavres du DOM
      for (var ci = 0; ci < cadavres.length; ci++) {
        if (cadavres[ci].element && cadavres[ci].element.parentNode) {
          cadavres[ci].element.parentNode.removeChild(cadavres[ci].element);
        }
      }
      cadavres = [];
      // Reset kill state
      killCooldown = false;
      botKillCooldowns = {};
      if (killCountdownInterval) { clearInterval(killCountdownInterval); killCountdownInterval = null; }
      // Reset mission en cours
      if (missionTimer) { clearTimeout(missionTimer); missionTimer = null; }
      missionEnCours = false;
      var btnM = document.getElementById('btn-mission');
      if (btnM) { resetBtnMission(btnM); btnM.style.display = 'none'; }
      // Retirer highlights caisse
      document.querySelectorAll('.caisse-cible').forEach(function(c) { c.classList.remove('caisse-cible'); });
      // Arreter la simulation de missions
      arreterSimulationMissions();
      if (modeHorsLigne) {
        nettoyerBots();
        modeHorsLigne = false;
        showScreen('menu-principal');
      } else {
        // En mode online, le joueur qui quitte est considere comme mort
        var pseudoQuitte = getPseudo() || t('player');
        if (joueursElimines.indexOf(pseudoQuitte) < 0) {
          joueursElimines.push(pseudoQuitte);
        }
        nettoyerBots();
        showScreen('salle-attente');
      }
    }

    // ============================
    // DEPLACEMENT SALLE D'ATTENTE
    // ============================
    var saJoueurX = 50; // % depuis la gauche
    var saJoueurY = 70; // % depuis le haut
    var salleActif = false;
    var SA_VITESSE = 0.5;
    var saDirection = 1; // 1 = droite, -1 = gauche
    var salleAnimFrame = null;

    function updateSallePosition() {
      var avatar = document.getElementById('sa-mon-avatar');
      if (!avatar) return;
      avatar.style.left = saJoueurX + '%';
      avatar.style.top = saJoueurY + '%';
      avatar.style.bottom = 'auto';
      // Retourner le skin selon la direction
      var skinImg = document.getElementById('sa-avatar-skin-img');
      if (skinImg) {
        skinImg.style.transform = saDirection === -1 ? 'scaleX(-1)' : 'scaleX(1)';
      }
    }

    function salleLoop() {
      if (!salleActif) { salleAnimFrame = null; return; }

      var moved = false;
      if (keys['z'] || keys['Z'] || keys['ArrowUp']) { saJoueurY -= SA_VITESSE; moved = true; }
      if (keys['s'] || keys['S'] || keys['ArrowDown']) { saJoueurY += SA_VITESSE; moved = true; }
      if (keys['q'] || keys['Q'] || keys['ArrowLeft']) { saJoueurX -= SA_VITESSE; moved = true; saDirection = -1; }
      if (keys['d'] || keys['D'] || keys['ArrowRight']) { saJoueurX += SA_VITESSE; moved = true; saDirection = 1; }

      // Limites
      if (saJoueurX < 2) saJoueurX = 2;
      if (saJoueurX > 95) saJoueurX = 95;
      if (saJoueurY < 10) saJoueurY = 10;
      if (saJoueurY > 85) saJoueurY = 85;

      if (moved) {
        updateSallePosition();
        // Envoyer la position via Firebase (throttle 200ms)
        if (partieActuelleId && !modeHorsLigne && myPartyPlayerDocId && Date.now() - lastSaPositionSend > 200) {
          lastSaPositionSend = Date.now();
          db.collection('partyPlayers').doc(myPartyPlayerDocId).update({
            saX: saJoueurX, saY: saJoueurY
          }).catch(function() {});
        }
      }
      salleAnimFrame = requestAnimationFrame(salleLoop);
    }

    // ============================
    // SYSTEME D'AMIS - Fonctions
    // ============================

    function togglePanelAmis() {
      panelAmisOuvert = !panelAmisOuvert;
      var panel = document.getElementById('panel-amis');
      if (panelAmisOuvert) {
        panel.classList.remove('panel-amis-ferme');
        panel.classList.add('panel-amis-ouvert');
        rafraichirPanelAmis();
      } else {
        panel.classList.remove('panel-amis-ouvert');
        panel.classList.add('panel-amis-ferme');
      }
    }

    function switchTabAmi(tab) {
      tabAmiActif = tab;
      document.querySelectorAll('.tab-ami').forEach(function(t) { t.classList.remove('active'); });
      var tabEl = document.getElementById('tab-' + tab);
      if (tabEl) tabEl.classList.add('active');
      rafraichirPanelAmis();
    }

    function rafraichirPanelAmis() {
      if (tabAmiActif === 'demandes') {
        afficherDemandes();
      } else {
        afficherAmis();
      }
    }

    function afficherAmis() {
      var contenu = document.getElementById('panel-amis-contenu');
      if (!contenu) return;
      var filtreOnline = (tabAmiActif === 'en-ligne');
      var html = '';
      var amisFiltres = mesAmis.filter(function(a) {
        var statut = amisStatuts[a.uid];
        if (filtreOnline) return statut && statut.online;
        return !statut || !statut.online;
      });

      if (amisFiltres.length === 0) {
        html = '<div class="panel-amis-vide">' +
          (filtreOnline ? t('noFriendsOnline') : t('noFriendsOffline')) +
          '</div>';
      } else {
        amisFiltres.forEach(function(ami) {
          var isOnline = amisStatuts[ami.uid] && amisStatuts[ami.uid].online;
          html += '<div class="ami-item">';
          html += '<div class="ami-statut-dot ' + (isOnline ? 'online' : 'offline') + '"></div>';
          html += '<span class="ami-pseudo ' + (isOnline ? '' : 'offline-text') + '">' + escapeHtml(ami.pseudo) + '</span>';
          if (isOnline) {
            html += '<button class="ami-btn-inviter" onclick="inviterAmi(\'' + escapeOnclick(ami.uid) + '\', \'' + escapeOnclick(ami.pseudo) + '\')">INVITER</button>';
          }
          html += '</div>';
        });
      }
      contenu.innerHTML = html;
    }

    function afficherDemandes() {
      var contenu = document.getElementById('panel-amis-contenu');
      if (!contenu) return;
      if (demandesEnAttente.length === 0) {
        contenu.innerHTML = '<div class="panel-amis-vide">' + t('noPendingRequests') + '</div>';
        return;
      }
      var html = '';
      demandesEnAttente.forEach(function(demande) {
        html += '<div class="demande-item">';
        html += '<span class="demande-pseudo">' + escapeHtml(demande.fromPseudo) + '</span>';
        html += '<button class="demande-btn-accepter" onclick="accepterDemande(\'' + escapeOnclick(demande.id) + '\', \'' + escapeOnclick(demande.from) + '\', \'' + escapeOnclick(demande.fromPseudo) + '\')">ACCEPTER</button>';
        html += '<button class="demande-btn-refuser" onclick="refuserDemande(\'' + escapeOnclick(demande.id) + '\')">REFUSER</button>';
        html += '</div>';
      });
      contenu.innerHTML = html;
    }

    function escapeHtml(str) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    // Echapper pour utilisation dans un onclick="func('...')"
    function escapeOnclick(str) {
      return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function updateBadgeAmis() {
      var badge = document.getElementById('badge-amis');
      var countEl = document.getElementById('count-demandes');
      if (badge) {
        if (demandesEnAttente.length > 0) {
          badge.style.display = 'flex';
          badge.textContent = demandesEnAttente.length;
        } else {
          badge.style.display = 'none';
        }
      }
      if (countEl) {
        countEl.textContent = demandesEnAttente.length > 0 ? demandesEnAttente.length : '';
      }
    }

    function envoyerDemandeAmi() {
      var input = document.getElementById('input-recherche-ami');
      var pseudo = input.value.trim();
      if (!pseudo) { showNotif(t('enterPseudo'), 'warn'); return; }
      if (pseudo === getPseudo()) {
        showNotif(t('cantAddSelf'), 'warn');
        return;
      }
      var dejaAmi = mesAmis.some(function(a) { return a.pseudo === pseudo; });
      if (dejaAmi) {
        showNotif(t('alreadyFriend'), 'warn');
        return;
      }
      // Chercher le joueur cible par pseudo
      db.collection('players').where('pseudo', '==', pseudo).limit(1).get().then(function(snap) {
        if (snap.empty) { showNotif(t('pseudoNotFound'), 'error'); return; }
        var target = snap.docs[0].data();
        if (target.playerId === monPlayerId) { showNotif(t('cantAddSelf'), 'warn'); return; }
        // Verifier si deja amis
        return db.collection('friends').where('playerId', '==', monPlayerId).where('friendPlayerId', '==', target.playerId).limit(1).get().then(function(friendSnap) {
          if (!friendSnap.empty) { showNotif(t('alreadyFriend'), 'warn'); return; }
          // Verifier si demande deja envoyee
          return db.collection('friendRequests').where('fromPlayerId', '==', monPlayerId).where('toPlayerId', '==', target.playerId).limit(1).get().then(function(reqSnap) {
            if (!reqSnap.empty) { showNotif(t('requestAlreadySent'), 'warn'); return; }
            // Envoyer la demande
            return db.collection('friendRequests').add({
              fromPlayerId: monPlayerId,
              fromPseudo: getPseudo(),
              toPlayerId: target.playerId,
              toPseudo: pseudo,
              status: 'pending'
            }).then(function() {
              showNotif(t('requestSentTo', pseudo), 'info');
              input.value = '';
            });
          });
        });
      }).catch(function() {
        showNotif(t('connectionError'), 'error');
      });
    }

    function accepterDemande(requestId, fromPlayerId, fromPseudo) {
      db.collection('friendRequests').doc(requestId).update({ status: 'accepted' }).then(function() {
        // Creer la relation bidirectionnelle
        var myPseudo = getPseudo();
        db.collection('friends').add({ playerId: monPlayerId, friendPlayerId: fromPlayerId, friendPseudo: fromPseudo });
        db.collection('friends').add({ playerId: fromPlayerId, friendPlayerId: monPlayerId, friendPseudo: myPseudo });
        showNotif(t('nowYourFriend', fromPseudo), 'info');
      }).catch(function() {});
    }

    function refuserDemande(requestId) {
      db.collection('friendRequests').doc(requestId).delete().then(function() {
        showNotif(t('requestRefused'), 'warn');
      }).catch(function() {});
    }

    function chargerStatutAmis() {
      if (panelAmisOuvert && tabAmiActif !== 'demandes') {
        afficherAmis();
      }
    }

    // ============================
    // SYSTEME D'AMIS - Listeners Firebase
    // ============================

    var amisUnsubscribers = [];

    function initAmisListeners() {
      // Nettoyer les anciens listeners
      amisUnsubscribers.forEach(function(unsub) { if (unsub) unsub(); });
      amisUnsubscribers = [];

      // Demandes d'amis entrantes
      amisUnsubscribers.push(
        db.collection('friendRequests').where('toPlayerId', '==', monPlayerId).where('status', '==', 'pending').onSnapshot(function(snapshot) {
          demandesEnAttente = [];
          snapshot.forEach(function(doc) {
            var r = doc.data();
            demandesEnAttente.push({ id: doc.id, from: r.fromPlayerId, fromPseudo: r.fromPseudo, to: r.toPlayerId, toPseudo: r.toPseudo, status: r.status });
          });
          updateBadgeAmis();
          if (panelAmisOuvert && tabAmiActif === 'demandes') afficherDemandes();
          if (demandesEnAttente.length > ancienNbDemandes && !panelAmisOuvert) {
            var derniere = demandesEnAttente[demandesEnAttente.length - 1];
            showNotif(t('friendRequestFrom', derniere.fromPseudo), 'info');
          }
          ancienNbDemandes = demandesEnAttente.length;
        })
      );

      // Liste d'amis
      amisUnsubscribers.push(
        db.collection('friends').where('playerId', '==', monPlayerId).onSnapshot(function(snapshot) {
          mesAmis = [];
          var friendIds = [];
          snapshot.forEach(function(doc) {
            var f = doc.data();
            mesAmis.push({ uid: f.friendPlayerId, pseudo: f.friendPseudo, online: false });
            friendIds.push(f.friendPlayerId);
          });
          // Charger les statuts en ligne
          friendIds.forEach(function(fid) {
            db.collection('players').doc(fid).get().then(function(pDoc) {
              if (pDoc.exists) {
                var pData = pDoc.data();
                var ami = mesAmis.find(function(a) { return a.uid === fid; });
                if (ami) ami.online = pData.online || false;
                amisStatuts[fid] = { online: pData.online || false, pseudo: pData.pseudo };
              }
              if (panelAmisOuvert && tabAmiActif !== 'demandes') afficherAmis();
            });
          });
          if (friendIds.length === 0 && panelAmisOuvert && tabAmiActif !== 'demandes') afficherAmis();
        })
      );

      // Invitations de partie
      amisUnsubscribers.push(
        db.collection('gameInvites').where('toPlayerId', '==', monPlayerId).where('status', '==', 'pending').onSnapshot(function(snapshot) {
          snapshot.forEach(function(doc) {
            var inv = doc.data();
            if (!invitationsAffichees[doc.id]) {
              invitationsAffichees[doc.id] = true;
              afficherInvitation(doc.id, inv.fromPseudo, inv.partyId);
            }
          });
        })
      );
    }

    // ============================
    // SYSTEME D'INVITATION EN PARTIE
    // ============================
    var invitationActuelle = null;

    function inviterAmi(amiPlayerId, amiPseudo) {
      if (!partieActuelleId) {
        showNotif(t('mustBeInGame'), 'warn');
        return;
      }
      db.collection('gameInvites').add({
        fromPlayerId: monPlayerId,
        fromPseudo: getPseudo(),
        toPlayerId: amiPlayerId,
        partyId: partieActuelleId,
        status: 'pending'
      }).then(function() {
        showNotif(t('inviteSentTo', amiPseudo), 'info');
      }).catch(function() {});
    }

    function afficherInvitation(inviteId, fromPseudo, partyId) {
      invitationActuelle = { id: inviteId, partyId: partyId };
      var popup = document.getElementById('popup-invitation');
      var texte = document.getElementById('invitation-texte');
      if (popup && texte) {
        texte.textContent = t('inviteToJoin', fromPseudo);
        popup.style.display = 'block';
      }
    }

    function accepterInvitation() {
      if (!invitationActuelle) return;
      db.collection('gameInvites').doc(invitationActuelle.id).update({ status: 'accepted' }).then(function() {
        rejoindrePartie(invitationActuelle.partyId);
      }).catch(function() {});
      document.getElementById('popup-invitation').style.display = 'none';
      invitationActuelle = null;
    }

    function refuserInvitation() {
      if (!invitationActuelle) return;
      db.collection('gameInvites').doc(invitationActuelle.id).update({ status: 'declined' }).catch(function() {});
      document.getElementById('popup-invitation').style.display = 'none';
      invitationActuelle = null;
    }

    // Son SELECT sur les boutons de menu
    document.addEventListener('click', function(e) {
      var el = e.target.closest('button, .btn, .btn-retour, .lang-btn, .boutique-tab, .toggle-role, .btn-rejoindre, .btn-demarrer, .skin-carte-btn');
      if (!el) return;
      // Ne pas jouer dans le jeu (sauf reunion)
      var ecranJeu = document.getElementById('jeu');
      if (ecranJeu && ecranJeu.classList.contains('active') && !reunionEnCours) return;
      try { var sSelect = new Audio('SELECT.mp3'); sSelect.volume = 0.35; sSelect.play(); } catch(e) {}
    });
  </script>

<!-- ============================== -->
<!-- OVERLAY CHOIX DE CAMP ESPION -->
<!-- ============================== -->
<div id="espion-choix-overlay">
  <h2 data-i18n="spyChooseTitle">TU ES L'ESPION</h2>
  <p data-i18n="spyChooseDesc">Choisis ton camp ! Tu gagneras avec le camp que tu choisis.</p>
  <div>
    <button class="espion-btn-camp espion-btn-innocent" onclick="choisirCampEspion('innocent')" data-i18n="spyBtnInnocent">INNOCENT</button>
    <button class="espion-btn-camp espion-btn-virus" onclick="choisirCampEspion('virus')" data-i18n="spyBtnVirus">VIRUS</button>
  </div>
</div>

<!-- ============================== -->
<!-- BOUTON AMIS (toujours visible sauf hors ligne) -->
<!-- ============================== -->
<div id="btn-amis" onclick="togglePanelAmis()" style="display:none;">
  <svg viewBox="0 0 24 24" fill="none" stroke="#ecf0f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
    <circle cx="9" cy="7" r="4"/>
    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
  </svg>
  <span id="badge-amis" style="display:none;">0</span>
</div>

<!-- ============================== -->
<!-- PANNEAU AMIS (1/4 ecran droite) -->
<!-- ============================== -->
<div id="panel-amis" class="panel-amis-ferme">
  <div class="panel-amis-header">
    <span data-i18n="friends">AMIS</span>
    <button onclick="togglePanelAmis()">&#10005;</button>
  </div>
  <div class="panel-amis-recherche">
    <input id="input-recherche-ami" type="text" placeholder="Pseudo du joueur..." maxlength="20" onkeydown="if(event.key==='Enter')envoyerDemandeAmi()" data-i18n="phFriendSearch" data-i18n-attr="placeholder">
    <button onclick="envoyerDemandeAmi()" data-i18n="add">AJOUTER</button>
  </div>
  <div class="panel-amis-tabs">
    <button class="tab-ami active" id="tab-en-ligne" onclick="switchTabAmi('en-ligne')" data-i18n="onlineLabel">En ligne</button>
    <button class="tab-ami" id="tab-hors-ligne" onclick="switchTabAmi('hors-ligne')" data-i18n="offlineLabel">Hors ligne</button>
    <button class="tab-ami" id="tab-demandes" onclick="switchTabAmi('demandes')"><span data-i18n="requestsLabel">Demandes</span> <span class="count-demandes" id="count-demandes"></span></button>
  </div>
  <div id="panel-amis-contenu" class="panel-amis-liste">
    <div class="panel-amis-vide" data-i18n="noFriendsYet" data-i18n-html>Aucun ami pour le moment.<br>Ajoute des joueurs avec leur pseudo !</div>
  </div>
</div>

<!-- ============================== -->
<!-- POPUP INVITATION RECUE -->
<!-- ============================== -->
<div id="popup-invitation">
  <h3>INVITATION</h3>
  <p id="invitation-texte">Un ami t'invite a rejoindre sa partie !</p>
  <div class="popup-btns">
    <button class="demande-btn-accepter" onclick="accepterInvitation()">ACCEPTER</button>
    <button class="demande-btn-refuser" onclick="refuserInvitation()">REFUSER</button>
  </div>
</div>

<div class="notif-container" id="notif-container"></div>
<script>
// Afficher le bouton amis si le joueur a un compte (apres que le DOM est pret)
(function() {
  var pseudo = getPseudo();
  var btnAmis = document.getElementById('btn-amis');
  if (pseudo && btnAmis) btnAmis.style.display = 'flex';
  // Re-traduire toute la page maintenant que tous les elements existent
  translatePage();
})();
</script>
</body>
</html>